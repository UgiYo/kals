<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>循序樣式探勘工具  Sequential Pattern Mining Tool</title>
<script type="text/javascript" src="jquery.js"></script>
</head>

<body>

<!--more--><span class="disable-post-catalog"></span>    <script type="text/javascript">

// --------
// JSON與AJAX
// --------

jQuery.json_encode = function (_json)
{
    if (this.is_number(_json) || this.is_boolean(_json) || this.is_null(_json))
        return _json;
    else if(this.is_string(_json))
        return this.serialize_string(_json);
    else if (this.is_array(_json))
        return this.serialize_array(_json);
    else
        return this.serialize_json(_json);
};

/**
 * 將JSON轉換成字串
 * @memberOf {jQuery}
 * @method serialize_json
 * @param {Object} _json
 * @type {string}
 */
jQuery.serialize_json = function (_json)
{
    if (this.is_number(_json) || this.is_boolean(_json) || this.is_null(_json))
        return _json;
    else if(this.is_string(_json))
        return this.serialize_string(_json);
    else if (this.is_array(_json))
        return this.serialize_array(_json);

    var _output = '';

    for (var _key in _json)
    {
        var _attr = '"'+_key+'":';
        var _value = _json[_key];
        if (this.is_number(_value) || this.is_boolean(_value) || this.is_null(_value))
            _attr += _value;
        else if (this.is_string(_value))
            _attr += this.serialize_string(_value);
        else if (this.is_array(_value))
            _attr += this.serialize_array(_value);
        else if (this.is_object(_value))
        {
            if (typeof(_value.to_string) == 'function') {
                _attr += _value.to_string();
            }
            else
            {
                var _class_name = $.get_class(_value);
                if (_class_name == 'Object')
                    _attr += this.serialize_json(_value);
                else
                    _attr += '[Object: '+_class_name+']';
            }
        }

        _output = this.combine_comma(_output);
        _output += _attr;
    }

    _output = '{' + _output + '}';
    return _output;
};

jQuery.serialize_array = function (_array)
{
    if (this.is_number(_array) || this.is_boolean(_array) || this.is_null(_array))
        return _array;
    else if(this.is_string(_array))
        return this.serialize_string(_array);
    else if (this.is_object(_array))
        return this.serialize_json(_array);

    var _output = '';

    for (var _key in _array)
    {
        var _attr = "";
        var _value = _array[_key];
        if (this.is_number(_value) || this.is_boolean(_value) || this.is_null(_value))
            _attr += _value;
        else if (this.is_string(_value))
            _attr += this.serialize_string(_value);
        else if (this.is_array(_value))
            _attr += this.serialize_array(_value);
        else if (this.is_object(_value))
            _attr += this.serialize_json(_value);

        _output = this.combine_comma(_output);
        _output += _attr;
    }

    _output = '[' + _output + ']';
    return _output;
};

jQuery.serialize_string = function (_str)
{
    if (this.is_number(_str) || this.is_boolean(_str) || this.is_null(_str))
        return _str;
    else if (this.is_array(_str))
        return this.serialize_array(_str);
    else if (this.is_object(_str))
        return this.serialize_json(_str);

    _str = this.addslashes(_str);
    return '"'+_str+'"';
};

jQuery.addslashes = function (_str) {
    // http://kevin.vanzonneveld.net
    // +   original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   improved by: Ates Goral (http://magnetiq.com)
    // +   improved by: marrtins
    // +   improved by: Nate
    // +   improved by: Onno Marsman
    // +   input by: Denny Wardhana
    // +   improved by: Brett Zamir (http://brett-zamir.me)
    // +   improved by: Oskar Larsson Högfeldt (http://oskar-lh.name/)
    // *     example 1: addslashes("kevin's birthday");
    // *     returns 1: 'kevin\'s birthday'

    return (_str+'').replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0');
};

jQuery.combine_comma = function (_str)
{
    if (_str != '')
        _str += ',';
    return _str;
};


jQuery.is_string = function (_obj)
{
    return (typeof(_obj) == 'string');
};

jQuery.is_number = function (_obj)
{
    return (typeof(_obj) == 'number');
};


jQuery.is_null = function (_obj)
{
    if (typeof(_obj) == 'undefined'
        || (typeof(_obj) == 'string' && _obj == 'null'))
        return true;
    else
        return (_obj == null);
};

jQuery.is_class = function(_obj, _class_name)
{
    if ($.is_null(_class_name))
        return false;
    
    try
    {
        return (typeof(_obj) == 'object' 
            && _obj != null 
            //&& (_obj instanceof _class_name));
            && $.get_class(_obj) == _class_name);
    }
    catch (e) {
        return false;
    }
};

jQuery.is_boolean = function(_obj)
{
    return (typeof(_obj) == 'boolean');
};

/**
 * 驗證是否為陣列
 *
 * @param _obj
 * @return 驗證結果
 * @type boolean
 */
jQuery.is_array = function(_obj)
{
    return (typeof(_obj) == 'object' && (_obj instanceof Array));
};

jQuery.filter_array = function (_obj)
{
    var _is_array = (typeof(_obj) == 'object' && (_obj instanceof Array));
    if (false == _is_array)
        return [_obj];
    else
        return _obj;
};

jQuery.is_object = function (_obj)
{
    return (typeof(_obj) == 'object' && !(_obj instanceof Array));
};

jQuery.is_function = function (_obj)
{
    return (typeof(_obj) == 'function');
};

/**
 * 驗證是否物件為jQuery物件
 * @param {Object} _obj
 */
jQuery.is_jquery = function (_obj)
{
    return (typeof(_obj) == 'object' && (_obj instanceof jQuery));
};

/**
 * 驗證是否物件_element為HTML物件
 * @param {Object} _element
 */
jQuery.is_html_element = function (_element)
{
    var _class_name = this.get_class(_element);
    
    //$.test_msg([_class_name, _element.constructor]);
    if (_class_name == false)
        return false;
    if (this.starts_with(_class_name, 'HTML')
        && (this.ends_with(_class_name, 'Element') || this.ends_with(_class_name, 'ElementConstructor')))
    // 2010.9.3 Android會把HTML元素判斷為「HTMLDivElementConstructor」之類的
    {
        return true;
    }   
    else
        return false;
};

/**
 * 檢測變數是否存在，如果是null，也作為不存在
 * @param {Object} _obj
 */
jQuery.isset = function (_obj)
{
    if (typeof(_obj) == "undefined"
        || this.is_null(_obj) == true)
        return false;
    else
        return true;
};

</script>

<!--more--><span class="disable-post-catalog"></span>    <script type="text/javascript">

apriori_all_tool = {
    config: null,
    config_selector: '.aa-config',
    create_template_obs: function () {
        //var _temp = 'ABBDC(CA)ABCB(DB)CBBB(BC)DDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBC';
        
        var _temp = '(AB)C(DE) (AB)CF CF (ABC) C(EF)';
        
        if (apriori_all_tool.config == null)
        {
            apriori_all_tool.config = $(apriori_all_tool.config_selector);
        }
        apriori_all_tool.config.find('.obs:first').val(_temp);
    },
    create_template_obs2: function () {
        //var _temp = 'ABBDC(CA)ABCB(DB)CBBB(BC)DDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBCABBDCCAABCBDBCBBBBCDDBCBCBCBBDBCDB BCBBDBCBAABCDDBCBAABAAABBBAA BDBABABBBCBBDBDBBCDBC';
        
        var _temp = '04444444558ADE'
                    + '\n' + '04440040000044444444100044000111111(01)4011(12)2222222333445557775556666880888(5678)5444455556678888880(012345678)8888(89A)AAABBBBBBBBBABABBBBBBBBBBBBBBBBBB5601124244445(5678)AABBBBBBBBBBBBBBBCCCCF02234444444588BBBBBCBBBBB(BC)BCCCBBCBBBBBCDDDDEEBCBC(0123456789ABC)C44EEEE(0123456789ABCDE)(456789ABCDE)4555663578ABBBBBBBB8DEFBBBBBABABBBBB(BCDE)45800555'
                    + '\n' + '0(123456789)33444488(3456789A)A'
                    + '\n' + '00000000000(01)000000011111111122223344422333111144444444444444445554555555555566778888888889999999999AAAAAACCCCCCCCBBBDEEDE'
                    + '\n' + '40000001111117778888888AABCDEEEEEEEEEEEE0000011112234444444555555666778858888899999999AAAAABBCCCCCDEEEEEE01123444599AB(BC)BCC0123444445567888999(9A)AAAAABB6BCCCCCCCD(DE)DDEEEF000000(012345)'
                    + '\n' + 'A4ACC0EEB000111444'
                    + '\n' + '1113130011111111(234)4004444445000444444444457777888855555667700FEEE4446888999AAAAAAACB'
                    + '\n' + '000000004444444557777EEE(45)55'
                    + '\n' + '00(01)000111111114444445555677688889AACCD0045'
                    + '\n' + '00000000000000000044444444444444444488CCCEE'
                    + '\n' + '000000014440001444448CCC000067AC0000011114444CA'
                    + '\n' + '0044444455555C0(123456789ABC)000000(0123456789ABCDE)EEEEE'
                    + '\n' + '010048E'
                    + '\n' + '0400014CC444CC0018888E'
                    + '\n' + '0000448BCDDE000BBB0C00000114C'
                    + '\n' + '011112344445588(89)9C0CDDEEEFFFFFFFF'
                    + '\n' + '00040440400000444EE4018EDDD44000001123774446';
        
        if (apriori_all_tool.config == null)
        {
            apriori_all_tool.config = $(apriori_all_tool.config_selector);
        }
        apriori_all_tool.config.find('.obs:first').val(_temp);
    },
    /**
     * 取得HTML中的設定，並作驗證後回傳
     * @lazyloop true
     * @log true
     * @type Object|Null 如果是Null，表示驗證失敗
     * {
     *     obs: '原始數列',
     *     serial: [[['A'], ['B', 'C']]],    //'格式化之後的陣列'
     *     sup: 0.5    //最小支持度
     * }
     */
    get_config: function (_callback) {
        
        apriori_all_tool.log.heading('取得參數');
        
        if (apriori_all_tool.config == null)
        {
            apriori_all_tool.config = $(apriori_all_tool.config_selector);
        }
        
        var _config = {};
        
        _config.obs = $.trim(apriori_all_tool.config.find('[name="observed_pattern"]').val());
        if (_config.obs == '')
        {
            apriori_all_tool.config.find('[name="observed_pattern"]').focus();
            alert('請輸入觀察樣本。');
            return null;
        }
        else
        {
            _config.sup = $.trim(apriori_all_tool.config.find('[name="minimum_support"]').val());
            
            try
            {
                _config.sup = parseFloat(_config.sup);
            }
            catch (e)
            {
                apriori_all_tool.config.find('[name="minimum_support"]').select();
                alert('請設定最小支持度，數值為0到1之間，例如0.5。');
                return null;
            }
            
            //轉換成數列
            apriori_all_tool.convert_serial(_config.obs, function (_serial_data) {
                
                _config.serial = _serial_data.output;
                _config.code_stat = _serial_data.code_stat;
                _config.number = _config.serial.length;
                
                _config.sup_number = Math.ceil(_config.number * _config.sup);
                
                _callback(_config);
                
            });    //apriori_all_tool.convert_serial(_config.obs, function (_serial_data) {
        }
    },
    /**
     * 將觀察樣本字串轉換成陣列
     * @lazyloop true 做得很徹底
     * @log true
     * @param {String} _obs
     * @type {Array|Array|String}
     */
    convert_serial: function (_obs, _callback) {
        
        apriori_all_tool.log.heading('將觀察樣本字串轉換成陣列');
        
        var _output = [];
        var _code_stat = {
            list: [],
            index: {},
            count: []
        }; 
        
        var _complete = function () {
            
            //apriori_all_tool.log.text('轉換完畢: ' + $.json_encode(_output));
            
            apriori_all_tool.log.percent_value(1);
            
            _callback({
                output: _output,
                code_stat: _code_stat 
            });
        };
    
        var _break_list = [' ', '\t', '\n'];
        var _single_serial = [];
        var _multi_code;
        
        apriori_all_tool.log.percent_title('處理進度');
        
        var _next_loop = function (_i) {
            _i++;
            
            setTimeout(function () {
                _loop(_i);
            }, 0);
        };
        
        var _exception = {};
        var _loop = function (_i) {
            if (_i < _obs.length)
            {
                var _code = _obs.substr(_i, 1);
                
                apriori_all_tool.log.percent_value(_i/_obs.length, _code);
                
                //apriori_all_tool.log.text('處理字元：[' + _code + ']');
                
                if ($.inArray(_code, _break_list) > -1)
                {
                    if (_single_serial.length > 0)
                    {
                        //把舊的single_serial丟到output去
                        _output.push(_single_serial);
                        
                        //然後重置
                        _single_serial = [];
                    }
                    
                    //apriori_all_tool.log.text('exception清空');
                    _exception = {};
                    _next_loop(_i);
                }
                else if (_code == '(')
                {
                    _multi_code = [];
                    _i++;
                    while (_obs.substr(_i, 1) != ')')
                    {
                        _code = _obs.substr(_i, 1);
                        
                        //apriori_all_tool.log.text('處理同時發生字元：(' + _code + ')');
                        
                        _multi_code.push(_code);
                        _i++; 
                    }
                    _single_serial.push(_multi_code);
                    
                    
                    var _multi_code_arrange = apriori_all_tool.arrange_multi_code(_multi_code);
                    //apriori_all_tool.log.text('同時編碼組合種類: ' + _multi_code_arrange.length);
                    
                    //apriori_all_tool.log.text('處理重複字串' +  $.json_encode(_multi_code_arrange));
                    apriori_all_tool.loop(0, _multi_code_arrange.length, function (_m, _m_next_loop) {
                        
                        _multi_code = _multi_code_arrange[_m];
                        //apriori_all_tool.log.text('輸入編碼: ' + $.json_encode(_multi_code));
                        
                        apriori_all_tool.log.percent_value(_i/_obs.length, _m + '/' + _multi_code_arrange.length + ': ' + _multi_code.join(''));
                        
                        if (apriori_all_tool.find_exception(_exception, _multi_code) == false)
                        {
                            apriori_all_tool.push_code_stat(_code_stat, _multi_code, function (_code_stat) {
                                    
                                _exception = apriori_all_tool.push_exception(_exception, _multi_code);
                                
                                _m_next_loop();
                            });
                        }
                        else
                        {
                            _m_next_loop();  
                        }
                                                                                
                    }, function () {
                        
                        //apriori_all_tool.log.text('重複字串處理完畢，準備進入下一迴圈' +  $.json_encode(_multi_code_arrange) + ' :' + _i);
                        _next_loop(_i);
                        
                    });    //apriori_all_tool.loop(0, _multi_code_arrange.length, function (_m, _m_next_loop) {
                }
                else
                {
                    _multi_code = [_code];
                    _single_serial.push(_multi_code);
                    
                    if (apriori_all_tool.find_exception(_exception, _multi_code) == false)
                    {
                        apriori_all_tool.push_code_stat(_code_stat, _multi_code, function (_code_stat) {
                                
                            _exception = apriori_all_tool.push_exception(_exception, _multi_code);
                            
                            _next_loop(_i);
                        });
                    }
                    else
                    {
                        _next_loop(_i); 
                    }
                }
            }
            else
            {
                if (_single_serial.length > 0)
                {
                    //把舊的single_serial丟到output去
                    _output.push(_single_serial);
                }
                
                _complete();
            }
        };    //var _loop = function (_i) {
        
        _loop(0);
    },
    /**
     * 加入例外
     * 僅用於編碼階段的例外
     * 
     * @param {Array} _exception
     * @param {Array} _multi_code
     */
    push_exception: function (_exception, _multi_code) {
        
        _multi_code.sort();
        
        var _multi_code_string = _multi_code.join('');
        
        _exception[_multi_code_string] = true;
        return _exception;
    },
    find_exception: function (_exception, _multi_code) {
        
        _multi_code.sort();
        
        var _multi_code_string = _multi_code.join('');
        
        var _result = (typeof(_exception[_multi_code_string]) == 'boolean');
        
        return _result;
    },
    /**
     * 檢查是否是陣列
     * @param {Object} _obj
     */
    is_array: function (_obj)
    {
        return (typeof(_obj) == 'object' && (_obj instanceof Array));
    },
    /**
     * 兩個陣列的比較，無關順序
     * @lazyloop false
     * @param {Array|Object} _ary1
     * @param {Array|Object} _ary2
     */
    array_equal: function(_ary1, _ary2)
    {
        if (apriori_all_tool.is_array(_ary1) == false)
            _ary1 = [_ary1];
        if (apriori_all_tool.is_array(_ary2) == false)
            _ary2 = [_ary2];
            
        if (_ary1.length != _ary2.length)
            return false
        else
        {
            _ary1.sort();
            _ary2.sort();
            for (_i in _ary1)
            {
                if (_ary1[_i] != _ary2[_i])
                    return false;
            }
            return true;
        }
    },
    /**
     * 兩個陣列的比較，有關順序
     * @lazyloop false
     * @param {Array|Object} _ary1
     * @param {Array|Object} _ary2
     */
    array_sort_equal: function(_ary1, _ary2)
    {
        if (apriori_all_tool.is_array(_ary1) == false)
            _ary1 = [_ary1];
        if (apriori_all_tool.is_array(_ary2) == false)
            _ary2 = [_ary2];
            
        if (_ary1.length != _ary2.length)
            return false
        else
        {
            for (_i in _ary1)
            {
                if (_ary1[_i] != _ary2[_i])
                    return false;
            }
            return true;
        }
    },
    /**
     * 檢查陣列中是否有該陣列，無關順序
     * @lazyloop true
     * @param {Array} _needle 搜尋的陣列
     * @param {Array} _hash 被搜尋的陣列
     * @param {Function} _callback = function (_index) {}
     */
    array_in_array: function (_needle, _hash, _callback) {
        
        var _index = -1;
        
        var _complete = function () {
            _callback(_index);
        };
        
        var _next_loop = function (_i) {
            _i++;
            setTimeout(function () {
                _loop(_i);
            }, 0);
        }; 
        
        var _loop = function (_i) {
            if (_i < _hash.length)
            {
                if (apriori_all_tool.array_equal(_hash[_i], _needle))
                {
                    _index = _i;
                    _complete();
                    return;
                }
                else
                {
                    _next_loop(_i);
                }
            }
            else
            {
                _complete();
            }
        };
        _loop(0);
    },
    /**
     * 檢查陣列中是否有該陣列，有關順序
     * @lazyloop true
     * @param {Array} _needle 搜尋的陣列
     * @param {Array} _hash 被搜尋的陣列
     * @param {Function} _callback = function (_index) {}
     */
    array_sort_in_array: function (_needle, _hash, _callback) {
        
        var _index = -1;
        
        var _complete = function () {
            _callback(_index);
        };
        
        var _next_loop = function (_i) {
            _i++;
            setTimeout(function () {
                _loop(_i);
            }, 0);
        }; 
        
        var _loop = function (_i) {
            if (_i < _hash.length)
            {
                if (apriori_all_tool.array_sort_equal(_hash[_i], _needle))
                {
                    _index = _i;
                    _complete();
                    return;
                }
                else
                {
                    _next_loop(_i);
                }
            }
            else
            {
                _complete();
            }
        };
        _loop(0);
    },
    /**
     * 將_multi_code丟進_code_stat
     * @lazyloop true
     * @log false 不做log
     * @param {Object} _code_stat = {
     *     list: [],
     *     count: []
     * }
     * @param {Array|Array|String} _multi_code 準備要丟進去的資料
     * @param {Function} _callback = function (_code_stat) { }
     */
    push_code_stat: function (_code_stat, _multi_code, _callback)
    {        
        _multi_code = _multi_code.sort();
        
        var _index_string = apriori_all_tool.serial_array_to_string(_multi_code);
        
        var _index;
        if (typeof(_code_stat.index[_index_string]) == 'undefined')
        {
            _index = _code_stat.list.length;
            
            _code_stat.list.push(_multi_code);
            _code_stat.count.push(1);
            _code_stat.index[_index_string] = _index;
        }
        else
        {
            _index = _code_stat.index[_index_string];
            _code_stat.count[_index]++;
        }
        _callback(_code_stat);
        
        /*
        var _index = null;
        
        var _complete = function () {
            
            if (_index == null)
            {
                _code_stat.list.push(_multi_code);
                _index = _code_stat.list.length - 1;
            }
            
            if (typeof(_code_stat.count[_index]) == 'undefined')
                _code_stat.count[_index] = 0;
            _code_stat.count[_index]++;
                        
            _callback(_code_stat);
            
        };
        
        apriori_all_tool.loop(0, _code_stat.list.length, function (_i, _next_loop) {
            
            if (apriori_all_tool.array_equal(_code_stat.list[_i], _multi_code))
            {
                _index = _i;
                _complete();
                return;
            }
            _next_loop();
            
        }, function () {
            _complete();
        });
        */
    },
    /**
     * 列出陣列元素所有不重複組合
     * @lazyloop false 因為太複雜，不做lazyloop
     * @param {Array|String} _multi_code
     * @type {Array|Array|String} _arrange
     */
    arrange_multi_code: function (_multi_code) {
        var _arrange = [];
        
        var _length = _multi_code.length;
                
        var _parse_arrange = function (_multi_code, _output, _length, _length_pos, _length_ang)
        {
            if (_length_pos == null)
                _length_pos = 1;
            if (_length_ang == null)
                _length_ang = [];
            
            //初始化的部份
            if (_length_ang.length < _length_pos)
            {
                if (_length_pos == 1)
                {
                    _length_ang.push(1);
                }
                else
                {
                    var _prev_index = _length_ang[(_length_ang.length-1)];
                    _length_ang.push(_prev_index+1);
                }
            }
            
            var _index = 0;
            if (_length_pos > 1)
            {
                var _prev_index = _length_ang[(_length_pos-2)];
                _index = _prev_index+1;
            }
            
            if (_length_ang.length < _length_pos)
            {
                _length_ang.push(_index);
            }
            
            for (var _i = _index; _i < _multi_code.length - (_length - _length_pos); _i++)
            {
                if (_length_ang.length > _length_pos)
                {
                    //避免受到傳址影響，必須重整
                    var _temp = [];
                    for (var _p = 0; _p < _length_pos; _p++)
                        _temp.push(_length_ang[_p]);
                    _length_ang = _temp;
                }
                
                _length_ang[(_length_pos-1)] = _i;
                
                //如果抵達這個長度的話
                if (_length_ang.length == _length)
                {
                    //輸出
                    var _output_ang = [];
                    for (var _a in _length_ang)
                    {
                        _index = _length_ang[_a];
                        var _code = _multi_code[_index];
                        _output_ang.push(_code);
                    }
                    _output.push(_output_ang);
                }
                else    //如果尚未抵達這個長度
                {
                    _output = _parse_arrange(_multi_code, _output, _length, (_length_pos+1), _length_ang);
                }
            }
            
            return _output;
        };
        
        for (var _l = 1; _l < _length; _l++)
        {
            _arrange = _parse_arrange(_multi_code, _arrange, _l);
        }
        _arrange.push(_multi_code);
        
        return _arrange;
    },
    /**
     * 過濾出大型序列
     * @lazyloop true
     * @log true
     * @param {Object} _code_stat = {
     *     list: [],
     *     count: []
     * }
     * @param {number} _sup_number 最小支持個數
     * @param {function} _callback = function (_large_item_set) {}
     */
    filter_large_item_set: function (_code_stat, _sup_number, _callback)
    {
        apriori_all_tool.log.heading('過濾大型序列集合 (最小支持個數: ' + _sup_number + ', 共有' + _code_stat.list.length + '個序列需要過濾)');
        
        var _large_item_set = {
            list: [],
            count: []
        };
        
        var _complete = function () {
            
            if (_large_item_set.list.length > 0)
            {
                if (_code_stat.list.length != _large_item_set.list.length)
                    apriori_all_tool.log.text('過濾完畢，從' + _code_stat.list.length + '縮減到<strong>' + _large_item_set.list.length + '個集合</strong>');
                else
                    apriori_all_tool.log.text('過濾完畢，並沒有縮減，總共<strong>' + _large_item_set.list.length + '個集合</strong>');
            }   
            else
                apriori_all_tool.log.heading('序列是空集合');    
            _callback(_large_item_set);
        };
        
        
        if (_code_stat.list.length == 0)
        {   
            _complete();
            return;
        }
        
        apriori_all_tool.log.percent_title('處理進度');
        
        apriori_all_tool.loop(0, _code_stat.list.length, function (_i, _next_loop) {
            
            var _item = _code_stat.list[_i];
            var _count = _code_stat.count[_i];
            
            apriori_all_tool.log.percent_value(_i / _code_stat.list.length, '序列長度: ' + _item.length + ', 支持個數:' + _count);
            
            if (_count > _sup_number || _count == _sup_number)
            {
                _large_item_set.list.push(_item);
                _large_item_set.count.push(_count);
            }
            
            _next_loop();
            
        }, function () {
            
            apriori_all_tool.log.percent_value(1);
            
            _complete();
        });
    },
    alert: function (_data) {
        //alert($.json_encode(_data));
        alert(_data);
    },
    /**
     * 將序列編碼取代成為數字指標
     * 
     * @lazyloop true
     * @log true
     * @param {Array|Array|String} _serial
     * @param {Object} _large_item_set = {
     *     list: [],
     *     count: []
     * }
     * @param {Object} _callback = function (_coded_serial) {}
     */
    coding_serial: function (_serial, _large_item_set, _callback) {
        
        apriori_all_tool.log.heading('編碼序列');
        
        var _coded_serial = [];
        var _serial_index = [];
        
        apriori_all_tool.log.percent_title('編碼進度');
        
        apriori_all_tool.loop(0, _serial.length, function (_i, _next_loop) {
            
            var _s = _serial[_i];
            
            var _coded = [];
            var _index_list = {};
            //for (var _j in _s)
            
            apriori_all_tool.loop(0, _s.length, function (_j, _s_next_loop) {
                
                apriori_all_tool.log.percent_value(_i/_serial.length, _j + '/' + _s.length);
            
                var _multi_code = _s[_j];
                var _coded_multi_code = [];
                var _index = null;
                if (_multi_code.length == 1)
                {
                    _index = null;
                    for (var _in in _large_item_set.list)
                    {
                        if (apriori_all_tool.array_equal(_large_item_set.list[_in], _multi_code))
                        {
                            _index = parseInt(_in);
                            break;
                        }
                    }
                    
                    if (_index != null && _index > -1)
                    {
                        _coded_multi_code = [_index];
                        
                        //將這個索引加入倒置索引檔，_j表示位於字串序列_s的位置
                        var _index_string = _index+'';
                        if (typeof(_index_list[_index_string]) == 'undefined')
                            _index_list[_index_string] = [_j];
                        else
                            _index_list[_index_string].push(_j);
                    }
                }
                else if (_multi_code.length > 1)
                {
                    
                    _multi_code.sort();
                    _multi_code = apriori_all_tool.arrange_multi_code(_multi_code);
                    
                    for (var _k in _multi_code)
                    {
                        var _code = _multi_code[_k];
                        //_code = [_code];
                        
                        _index = null;
                        for (var _in in _large_item_set.list)
                        {
                            if (apriori_all_tool.array_equal(_large_item_set.list[_in], _code))
                            {
                                _index = parseInt(_in);
                                break;
                            }
                        }
                        
                        if (_index != null && _index > -1)
                        {
                            _coded_multi_code.push(_index);
                            
                            //將這個索引加入倒置索引檔，_j表示位於字串序列_s的位置
                            var _index_string = _index+'';
                            if (typeof(_index_list[_index_string]) == 'undefined')
                                _index_list[_index_string] = [_j];
                            else
                                _index_list[_index_string].push(_j);
                        }
                    }
                }
                
                if (_coded_multi_code.length > 0)
                {
                    _coded.push(_coded_multi_code);
                }
                
                _s_next_loop();
                
            }, function () {
                
                if (_coded.length > 0)
                {
                    _coded_serial.push(_coded);
                    
                    //apriori_all_tool.log.text('索引檔: ' + $.json_encode(_index_list));
                    
                    _serial_index.push(_index_list);
                }
                
                _next_loop();
                
            });    //apriori_all_tool.loop(0, _s.length, function (_j, _s_next_loop) {
                
        }, function () {
            
            apriori_all_tool.log.percent_value(1);
            
            //apriori_all_tool.log.text('編碼完畢 ' + $.json_encode(_coded_serial));
            
            _callback(_coded_serial, _serial_index);
            
        });
    },
    /**
     * 計算最大數量序列
     * 
     * @lazyloop true
     * @log true
     * @param {Object} _serial
     * @param {Object} _callback
     */
    count_maximum_serial_length: function (_serial, _callback) {
        
        apriori_all_tool.log.heading('計算最大數量序列');
        
        //apriori_all_tool.log.percent_title('處理進度');
        
        var _max = 0;
        
        var _loop = function (_i, _serial, _max, _c) {
            
            //apriori_all_tool.log.percent_value(_i/_serial.length);
            
            if (_i < _serial.length)
            {
                var _length = _serial[_i].length;
            
                if (_length > _max)
                    _max = _length;
                    
                _i++;
                
                setTimeout(function () {
                    _loop(_i, _serial, _max, _c);
                }, 0);
            }
            else
            {
                _c(_max);
            }
        };
        
        _loop(0, _serial, _max, _callback);
    },
    
    process_n_serial: function (_serial, _coding_serial_index, _large_item_set, _config, _callback) {
        
        apriori_all_tool.log.heading('開始計算n-序列');
        
        apriori_all_tool.initialize_n_serial(_large_item_set, function (_n_serial) {
        
            var _complete = function () {
                _callback(_n_serial);
            };
            
            
            
            apriori_all_tool.print_table(_n_serial[0], _serial, function () {
                
                apriori_all_tool.count_maximum_serial_length(_serial, function (_maximum_serial_length) {
                
                    var _next_loop = function (_i) {
                        _i++;
                        setTimeout(function () {
                            _loop(_i);
                        }, 0);
                    };
                    
                    var _loop = function (_i)
                    {
                        if (_i < _maximum_serial_length)
                        {
                            //產生n組合
                            apriori_all_tool.log.heading('開始計算' + (_i+1) + '-序列');
                            
                            var _prev_serial = _n_serial[(_i-1)];
                             
                            apriori_all_tool.count_n_large_serial_set(_config, _serial, _coding_serial_index, _n_serial, _prev_serial.list, _large_item_set.list, function (_n_large_serial_set) {
                                
                                if (_n_large_serial_set.list.length > 0)
                                {
                                    
                                    apriori_all_tool.print_table(_n_large_serial_set, _serial, function () {
                                        
                                        _n_serial.push(_n_large_serial_set);
                                    
                                        _next_loop(_i);
                                    });
                                    
                                        
                                }
                                else
                                {
                                    _complete();
                                }
                            });    //apriori_all_tool.(_prev_serial.list, _large_item_set.list, function (_n_large_serial_set) {
                        }
                        else
                        {
                            _complete();
                        }
                    };
                    
                    _loop(1);
                    
                });    //apriori_all_tool.count_maximum_serial_length(_coding_serial, function (_maximum_serial_length) {
                
             });    //apriori_all_tool.print_table(_n_serial[0], _serial, function () {
                
        });    //apriori_all_tool.initialize_n_serial(_large_item_set, function (_n_serial) {
    },
    /**
     * 初始化n-序列
     * 
     * @param {Object} _large_item_set = {
     *     list: [],
     *     count: []
     * }
     * @param {function} _callback = function (_n_serial) {}
     */
    initialize_n_serial: function (_large_item_set, _callback) {
        
        apriori_all_tool.log.heading('初始化n-序列');
        
        var _serial_set = {
            list: [],
            count: []
        }; 
        var _n_serial = [];
        
        var _complete = function () {
            _n_serial.push(_serial_set);
            _callback(_n_serial);
        };
        
        var _next_loop = function (_i) {
            _i++;
            setTimeout(function () {_loop(_i)}, 0);
        };
        
        var _loop = function (_i) {
            if (_i < _large_item_set.list.length)
            {
                var _item = _large_item_set.list[_i];
                var _count = _large_item_set.count[_i];
                
                _serial_set.list.push([_item]);
                _serial_set.count.push(_count);
                
                _next_loop(_i);
            }
            else
            {
                _complete();
            }
        };
        
        _loop(0);
    },
    combination_serial: function (_prev_list, _large_list, _callback) {
        
        var _combination = [];
        
        var _complete = function () {
            _callback(_combination);
        };
        
        var _next_loop = function (_i) {
            _i++;
            setTimeout(function () {_loop(_i)}, 0);
        };
        
        var _loop = function (_i) {
            if (_i < _prev_list.length)
            {
                var _list = _prev_list[_i];
                
                //apriori_all_tool.alert(_list);
                apriori_all_tool.combination_single_serial(_list, _large_list, _combination, function (_combination) {                    
                    _next_loop(_i);
                    
                });
            }
            else
            {
                _complete();
            }
        };
        _loop(0);
    },
    combination_single_serial: function (_list, _large_list, _combination, _callback) {
        
        var _complete = function () {
            _callback(_combination);
        };
        
        var _next_loop = function (_i) {
            _i++;
            setTimeout(function () {_loop(_i)}, 0);
        };
        
        var _loop = function (_i) {
            if (_i < _large_list.length)
            {
                var _item = _large_list[_i];
                
                apriori_all_tool.combination_list_item(_list, _item, _large_list, function (_new_serial) {
                    _combination.push(_new_serial);
                    
                    _next_loop(_i);
                });
            }
            else
            {
                _complete();
            }
        };
        _loop(0);
    },
    combination_list_item: function (_list, _item, _large_list, _callback) {
        
        var _new_serial = [];
        
        var _complete = function () {
            
            var _index = 0;
            for (var _j = 0; _j < _large_list.length; _j++)
            {
                if (apriori_all_tool.array_equal(_large_list[_j], _item))
                {
                    _index = _j;
                    break;
                }
            }
            
            _new_serial.push(_index);
            _callback(_new_serial);
        };
        
        var _next_loop = function (_i) {
            _i++;
            setTimeout(function () {_loop(_i)}, 0);
        };
        
        var _loop = function (_i) {
            if (_i < _list.length)
            {
                var _l = _list[_i];
                
                var _index = 0;
                for (var _j = 0; _j < _large_list.length; _j++)
                {
                    if (apriori_all_tool.array_equal(_large_list[_j], _l))
                    {
                        _index = _j;
                        break;
                    }
                }
                
                _new_serial.push(_index);
                _next_loop(_i);
            }
            else
            {
                _complete();
            }
        };
        _loop(0);
    },
    loop: function (_index, _maximum, _action, _complete) {
        
        var _next_loop = function (_i) {
            _i++;
            setTimeout(function () {
                _loop(_i);
            }, 0);
        };
        
        var _loop = function (_i) {
            if (_i < _maximum)
            {
                _action(_i, function () {
                    _next_loop(_i);
                });
            }
            else
            {
                _complete();
            }
        };
        
        _loop(_index);
    },
    /**
     * 計算大型N序列集合
     * 
     * @lazyloop true
     * @param {Object} _config
     * @param {Object} _total_serial
     * @param {Object} _n_serial
     * @param {Object} _prev_list
     * @param {Object} _large_list
     * @param {Object} _callback
     */
    count_n_large_serial_set: function (_config, _total_serial, _coding_serial_index, _n_serial, _prev_list, _large_list, _callback) {
        
        var _n_serial_set = {
            list: [],
            index: {},
            count: []
        };
        
        apriori_all_tool.combination_serial(_prev_list, _large_list, function (_combination_serial) {
            
            apriori_all_tool.log.text('共有' + _combination_serial.length + '種可能的組合，開始計算次數');
            //apriori_all_tool.log.text($.json_encode(_combination_serial));
            apriori_all_tool.log.percent_title('檢查組合進度');
            
            var _count = 0;
            var _total = _combination_serial.length * _total_serial.length;
                            
            apriori_all_tool.loop(0, _combination_serial.length, function (_c_i, _next_loop) {
                
                var _combination = _combination_serial[_c_i];
                
                apriori_all_tool.loop(0, _total_serial.length, function (_s_i, _s_next_loop) {
                    
                    apriori_all_tool.log.percent_value(_count / _total, '檢查組合: ' + _combination.join(','));
                    _count++;
                    
                    var _serial = _total_serial[_s_i];
                    var _serial_index = _coding_serial_index[_s_i];
                    
                    apriori_all_tool.match_combination_serial(_combination, _serial, _serial_index, function (_matched) {
                        
                        if (_matched == true)
                        {
                            //apriori_all_tool.alert([_combination, '\n', _serial, '\n', _matched]);
                            
                            //將combination轉換成code
                            
                            var _code_combination = [];
                            
                            apriori_all_tool.loop(0, _combination.length, function (_code_i, _code_next_loop) {
                                var _code_index = _combination[_code_i];
                                var _code = _large_list[_code_index];
                                _code_combination.push(_code);
                                
                                _code_next_loop();
                                
                            }, function () {
                                
                                /*
                                apriori_all_tool.array_sort_in_array(_code_combination, _n_serial_set.list, function (_index) {
                                    if (_index == -1)
                                    {
                                        _n_serial_set.list.push(_code_combination);
                                        _n_serial_set.count.push(1);
                                    }
                                    else
                                    {
                                        _n_serial_set.count[_index]++;
                                    }
                                                                        
                                    _s_next_loop();
                                    
                                });    //apriori_all_tool.array_in_array(_code_combination, _n_serial_set.list, function (_index) {
                                */
                                _n_serial_set = apriori_all_tool.push_n_serial_set(_n_serial_set, _code_combination);
                                _s_next_loop();
                                
                            });    //apriori_all_tool.loop(0, _combination.length, function (_code_i, _code_next_loop) {
                                
                        }
                        else
                        {
                            _s_next_loop();
                        }
                    });
                }, function () {
                    
                    
                    _next_loop();
                    
                }); 
                
            }, function () {
                
                apriori_all_tool.log.percent_value(1);
                apriori_all_tool.filter_large_item_set(_n_serial_set, _config.sup_number, function(_n_large_serial) {
                    
                    _callback(_n_large_serial);
                        
                });
            });    //apriori_all_tool.loop(0, _combination_serial.length, function (_c_i, _next_loop) {
            
        });    //apriori_all_tool.combination_serial(_prev_serial.list, _large_item_set.list, function (_combination_serial) {
        
    },
    serial_array_to_string: function (_serial) {
        var _serial_text = '';
        
        for (var _s in _serial)
        {
            var _s_item = _serial[_s];
            if (_s_item.length == 1)
            {
                _serial_text = _serial_text + _s_item[0];
            }
            else if (_s_item.length > 1)
            {
                var _sub_serial = '';
                for (var _sub_i in _s_item)
                {
                    var _sub_item = _s_item[_sub_i];
                    _sub_serial = _sub_serial + _sub_item;
                }
                _sub_serial = '(' + _sub_serial + ')';
                
                _serial_text = _serial_text + _sub_serial;
            }
        }
        return _serial_text;
    },
    push_n_serial_set: function (_n_serial_set, _code_combination) {
        
        //先做編碼
        var _index = apriori_all_tool.serial_array_to_string(_code_combination);
        
        var _i;
        if (typeof(_n_serial_set.index[_index]) == 'undefined')
        {
            _i = _n_serial_set.list.length;
            
            _n_serial_set.list.push(_code_combination);
            _n_serial_set.count.push(1);
            _n_serial_set.index[_index] = _i;
            
            //apriori_all_tool.log.text('加入index: ' + _index);
        }
        else
        {
            _i = _n_serial_set.index[_index];
            _n_serial_set.count[_i]++;
        }
        return _n_serial_set;
    },
    /**
     * 比對組合序列
     * @lazyloop false 無法做到完整的lazyloop
     * @param {Array|number} _combination 要組合而成的序列，是以index編碼，例如[1, 3]
     * @param {Array|number} _serial 要檢查的序列，是以index編碼，例如[1,2,3]
     * @param {function} _callback = function(_match) {}
     */
    match_combination_serial: function (_combination, _serial, _serial_index, _callback) {
        
        var _matched = false;
        
        var _complete = function () {
            _callback(_matched);
        };
        
        //先將_combination裡面的每個元素都取出index
        var _combination_index = {};
        
        for (var _i in _combination)
        {
            var _c = _combination[_i] + '';
            
            if (typeof(_serial_index[_c]) != 'undefined')
                _combination_index[_i] = _serial_index[_c];
            else
            {
                _complete();
                return false;
            }   
        }
        
        //apriori_all_tool.log.text('比對序列：' + $.json_encode(_combination_index));
        
        var _last_index = -1;
        for (var _i in _combination_index)
        {
            var _passed = false;
            var _index_list = _combination_index[_i];
            
            for (var _j in _index_list)
            {
                var _index = _index_list[_j];
                if (_index > _last_index)
                {
                    _last_index = _index;
                    _passed = true;
                    break;
                }
            }
            
            if (_passed == false)
            {
                _complete();
                return false;
            }
                
        }
        _matched = true;
        _complete();
        return true;
        
        /*
        var _s_i = -1;
        for (var _c_i in _combination)
        {
            _s_i++;
            var _c_item = _combination[_c_i];
            var _c_matched = false;
            
            while (_s_i < _serial.length)
            {
                var _list = _serial[_s_i];
                
                for (var _l = 0; _l < _list.length; _l++)
                {
                    var _s_item = _list[_l];
                    
                    if (_s_item == _c_item)
                    {
                        _c_matched = true;
                        break;
                    }
                }
                
                if (_c_matched == true)
                {
                    if (_c_i == _combination.length - 1)
                    {
                        _matched = true;
                        _complete();
                        return;
                    }
                    else
                    {
                        //跳出迴圈，找下一個
                        break;
                    }
                }
                else
                {
                    _s_i++;
                }
            }
            
            if (_c_matched == false)
            {
                //光第一個都找不到了
                _complete();
                return;
            }
        }
        */
    },
    /**
     * log相關工具集
     */
    log: {
        /**
         * @type {jQuery}
         */
        selector: null,
        /**
         * 初始化log
         */
        initialize: function () {
            
            if (apriori_all_tool.log.selector == null)
                apriori_all_tool.log.selector = $('.aa-log');
            
        },
        /**
         * 設置進log區
         * @param {jQuery|String} _content
         */
        set: function (_content) {
            var _item = $('<div class="item"></div>')
                .append(apriori_all_tool.log.time)
                .append(_content)
                .prependTo(apriori_all_tool.log.selector);
        },
        /**
         * @type {jQuery} 回傳一個帶有時間戳記的標籤
         */
        time: function () {
            return $('<div class="timestamp">' + apriori_all_tool.log.time_text() + '</div>');
        },
        /**
         * @type {String} 時:分
         */
        time_text: function () {
            
            var _date = new Date;
            var _hour = _date.getHours();
            var _minute = _date.getMinutes();
            if (_minute < 10)
                _minute = '0' + _minute;
                
            return _hour + ':' + _minute;
        },
        /**
         * log標題
         * @param {String} _text
         */
        heading: function (_text) {
            apriori_all_tool.log.set('<strong>' + _text + '</strong>');
        },
        /**
         * log文字
         * @param {String} _text
         */
        text: function (_text) {
            apriori_all_tool.log.set('<span>' + _text + '</span>');
        },
        /**
         * 進度百分比
         * @param {String} _text
         */
        percent_title: function (_text) {
            apriori_all_tool.log.set('<span>' + _text + '</span> <span class="percent-value">0</span><span>%</span> <span class="note"></span>');
        },
        /**
         * 找到最後一個percent_title，更新其percent_value以及timestamp
         * @param {float} _value 進度
         */
        percent_value: function (_value, _note) {
            _percent = Math.round( (_value*100 ));
            
            //找到log區最後一個percent的位置
            var _percent_value = apriori_all_tool.log.selector.find('.percent-value:first');
            _percent_value.html(_percent);
            
            //更新該區的timestamp
            var _time_text = apriori_all_tool.log.time_text();
            
            _percent_value.parents('div.item:first').find('.timestamp:first').html( _time_text );
            
            if (_note == null)
                _note = '';
            _percent_value.parents('div.item:first').find('.note:first').html( _note );
        },
    },
    /**
     * 輸出表格
     * @param {Object} _n_serial
     */
    print_table: function (_n_serial, _coding_serial, _callback) {
        
        apriori_all_tool.log.heading('輸出表格');
        
        var _result_selector = $('.aa-result');
        
        //_result_selector.empty();
        
        var _serial_number = _coding_serial.length;
        
        
        var _table = $('<table border="1" align="center"><thead><tr><th>' + (_n_serial.list[0].length) + '-序列' + '</th><th>' + '支持度 (n/' + _serial_number + ')' + '</th></tr></thead><tbody></tbody></table>')
            .appendTo(_result_selector);
        
        var _tbody = _table.find('tbody');
        
        //apriori_all_tool.loop(0, _n_serial.length, function (_n_i, _n_next) {
            
            var _list = _n_serial.list;
            var _count = _n_serial.count;
            
            apriori_all_tool.loop(0, _list.length, function(_l_i, _l_next) {
                
                //轉換成序列
                var _serial = _list[_l_i];
                var _serial_text = '';
                
                for (var _s in _serial)
                {
                    var _s_item = _serial[_s];
                    if (_s_item.length == 1)
                    {
                        _serial_text = _serial_text + _s_item[0];
                    }
                    else
                    {
                        var _sub_serial = '';
                        for (var _sub_i in _s_item)
                        {
                            var _sub_item = _s_item[_sub_i];
                            _sub_serial = _sub_serial + _sub_item;
                        }
                        _sub_serial = '(' + _sub_serial + ')';
                        
                        _serial_text = _serial_text + _sub_serial;
                    }
                }
                
                //計算支持度
                var _c = _count[_l_i];
                var _support = _c / _serial_number;
                _support = _support.toFixed(2);
                
                //輸出tr
                var _tr = $('<tr><td>' + _serial_text + '</td><td>' + _support + '</td></tr>')
                    .appendTo(_tbody);
                
                _l_next();
                
            }, function () {
                
                //_n_next();
                _callback();
                
            });
            
        //}, function () {
        //    _callback();
        //});    //apriori_all_tool.loop(0, _n_serial.length, function (_n_i, _n_next) {
    },
    /**
     * 主要執行的程式
     */
    main: function (_button_ele) {
        
        apriori_all_tool.log.initialize();
        
        var _button = $(_button_ele);
        _button.attr('disabled', true)
            .html('處理中');
        
        //alert($.json_encode(apriori_all_tool.arrange_multi_code(['A', 'B', 'C', 'D'])));
        
        var _result_selector = $('.aa-result');
        _result_selector.empty();
        
        apriori_all_tool.get_config(function (_config) {
            
            //計算大型項目集
            apriori_all_tool.filter_large_item_set(_config.code_stat, _config.sup_number, function (_large_item_set) {
                
                apriori_all_tool.coding_serial(_config.serial, _large_item_set, function (_coding_serial, _coding_serial_index) {
                    
                    apriori_all_tool.process_n_serial(_coding_serial, _coding_serial_index, _large_item_set, _config, function (_n_serial) {
                    
                        apriori_all_tool.log.heading('完成');
                            
                        _button.attr('disabled', false)
                            .html('開始計算');
                        //apriori_all_tool.alert(_n_serial);
                        
                    });    //apriori_all_tool.process_n_serial(_coding_serial, _large_item_set, _config, function (_n_serail) {
                    
                });    //apriori_all_tool.coding_serial(_config.serial, _large_item_set, function (_coding_serial) {
                
            });    //apriori_all_tool.filter_large_item_set(_config.code_stat, _config.sup_number, function (_large_item_set) {
                
        });    //apriori_all_tool.get_config(function (_config) {
        
        //alert(apriori_all_tool.array_equal(['A', 'B'], ['A', 'B', 'C']));
        //alert($.json_encode([_config.coding_serial, '\n', _config.serial]));
        
    }
};

$(document).ready(function () {
    $('.aa-config .main_button').attr('disabled', false);
});

</script> <style type="text/css">
.aa-table caption {
	font-weight: bold;
	text-align:left;
}
.aa-table th, .aa-table td {
    vertical-align: top;
}
.aa-config.aa-table th {
    text-align:right;
}

.aa-table thead th {
    text-align:center;
}

.aa-table .textarea {
    width: 90%;
    height: 10em;
}
.aa-table .sign {
    font-weight:bold;
    color:red;
}
.aa-table.aa-result td {
    text-align:center;
}
.aa-div {
    margin-bottom: 1em;
}
.aa-div {
	max-width: 640px;
	overflow-x: auto;
}

.aa-log {
    font-size:small;
    color: #333;
    margin: 1em;
    max-height: 120px;
    overflow-y:auto;
}

.aa-log .note {
    margin-left: 1em;
    color: gray;
    font-weight: bold;
}

.aa-log .timestamp {
    display:block;
    float:right;
    padding-left: 1em;
    color: gray;
}
.aa-result table {
    margin-bottom: 1em;
    text-align:center;
}

</style> 
<form class="aa-config-form"> 
    <table class="aa-config aa-table" width="90%" align="center"> 
        <tbody> 
            <tr> 
                <th>觀察樣本</th> 
                <td>
                    <textarea class="obs textarea" name="observed_pattern"></textarea>
                    <!-- (AB)C(DE) (AB)C(DE)F CF(DE) (ABC)(DE) C(EF)(DE) -->  
                    <ul> 
                        <li>每一個字都表示一個編碼記錄，請用空格、斷行來切割不同使用者的序列，用括弧表示同時發生的不同編碼。</li>
                        <li>舉例1 「ABDC CBBD」：表示有兩個使用者的序列，他們所做的行為依時間排序為「ABDC」、「CBBD」。</li>
                        <li>舉例2 「A(BD)C(CB)BD」：表示有一個使用者的序列，而他的序列中(BD)表示同時發生B跟D這兩個事件、(CB)表示同時發生了C跟B這兩個事件。</li>
                        <li>使用者的序列越多，越容易找出循序樣式。</li>  
                        <li><button class="create-template" type='button' onclick="apriori_all_tool.create_template_obs()" type="button">輸入範例觀察樣本1</button> (Google Chrome不到1分鐘即可計算完畢)</li>
                        <li><button class="create-template" type='button' onclick="apriori_all_tool.create_template_obs2()" type="button">輸入範例觀察樣本2</button> (Google Chrome大約要跑10分鐘)</li>
                    </ul>
                </td>
            </tr> 
            <tr> 
                <th>最小支持度</th> 
                <td>
                    <label><input value="0.6" size="4" name="minimum_support"> 請輸入0到1之間的數值，例如0.5。</label> 
                </td>
            </tr>
        </tbody> 
        <tfoot> 
            <tr> 
                <td colspan="2" align="center">
                    <button onclick="apriori_all_tool.main(this)" type='button' class="main_button" type="button">開始計算</button> 
                </td>
            </tr>
        </tfoot>
    </table>
</form> 
<div class="aa-log" onclick='$(this).select()'></div> 
<div class="aa-result"></div>
<hr>  
<h4>說明</h4>
<p>
    <a href="http://www.slidefinder.net/c/ch08/11685875">AprioriAll循序樣式探勘演算法</a>的目的是探勘出多位使用者的共通循序行為樣式。循序的意思是有考慮到順序先後，但並不一定會是相鄰的動作。</p>
 <p>
     在輸入觀察樣本資料，使用者每一個動作都是一個「編碼」，請利用單一文字來表示使用者的行為，例如0表示登入、1表示閱讀、2表示撰寫資料。並以空格或換行來區隔不同的使用者。
</p>
<p>
    接著請設定最小支持度，值為0到1之間，表示你想要探勘的樣式至少佔總人數的多少比例。舉例來說，0.6表示至少要有六成的使用者都有共同的循序樣式。最小支持度越低，運算時間越長、能找出來的樣式越多，但這些樣式不一定是很多人共通的；最小支持度越大，運算速度越快，而且能篩選出大部分的人都有的共通循序行為樣式。當你的觀察樣本中，每位使用者的行為都完全不相同時，最小支持度要設較低才能看出共同的循序行為樣式；當大部分使用者的行為都相同時，最小支持度可以設高一點，以加快運算的速度、篩選出最頻繁的循序行為樣式。
</p>
<p>
    開始計算之後請稍待，此工具會幫你找出觀察樣本中出現次數高於最小支持度的樣式。此工具會盡量地探勘到最長的序列，而越長的序列也越有參考價值。
</p>
 <p>
     總歸來說，使用者人數越多，探勘出來的結果越有代表性，表示大部分的人都有這樣的行為。
 </p>
<hr>  
<h4>感想</h4>
<p>此方法是使用AprioriAll演算法實作而成，方便大家計算。但實際上這隻程式運算速度並不快，測試好玩用即可，<span style="color: red; font-weight: bold">不建議進行大量資料分析。</span></p>
<p>用來實作的程式語言是JavaScript，一如所料的，效率並不高。即使是用Google Chrome這種處理JavaScript很快速的瀏覽器，處理資料的速度依然很慢。除了JavaScript本來就不是講求高運算效率的程式語言之外，也這可能是我的演算法複雜度太高所致。</p>
<p>先不論演算法好壞什麼的，至少完成這隻程式能夠訓練邏輯。資料探勘果然是需要好的演算法跟資料結構的高度複雜方法，當運算結果能正確地探勘出來之後，就讓人感到非常興奮。雖然距離一個真正好用的工具還有很大的一段距離，不過至少實作出來還蠻自我感覺良好的吧。</p>
<p>這次考量到大量資料的處理，我用了非常多setTimeout()的延遲迴圈，避免程式在執行中造成視窗結凍，然而這樣的缺點是速度稍微會慢一點，但總比看起來就像是當機的視窗結凍來得好得多。此外也加入了「記錄」的功能，所以大家可以看得到處理的過程。後來覺得陣列搜尋速度太慢，所以應用倒置索引檔的資料結構概念，利用索引加快搜尋的速度。</p>
<p>作為小工具來說，這是一個對我來說是個完成度頗高的JavaScript程式。不僅僅只是實作一個資料探勘的方法，而是使用到多種JavaScript技巧、應用到資料結構與演算法的理論、<a href="http://pulipuli.blogspot.com/2011/01/print-all-unique-combination-of-array.html">挑戰基礎邏輯問題</a>等等，都讓人感到身心舒暢，就像是做運動做得滿身大汗一樣的爽快感。</p>
<p>範例觀察樣本1是曾憲雄老師書中的例子，範例觀察樣本2則是手邊再處理的資料，預先丟進來跑跑看。至於各個編碼代表什麼意思，就請各位自行想像並應用了。</p>
<p>最後要說的是，<span style="color: red; font-weight: bold">計算過程如有任何問題或錯誤，請務必在下面留言告知，感謝。</span></p>
<h4>參考文獻</h4>
<ul>
<li>曾憲雄, 蔡秀滿, 蘇東興, 曾秋蓉, &amp; 王慶堯. (2005). 資料探勘. 臺北市: 旗標. </li></ul>
<hr>

<h4>修改記事</h4>
<ul>
<li><strong>2011/1/8:</strong> 撰寫完成。
<li><strong>2011/1/5: </strong>開始撰寫。 </li></ul>
</body>
</html>
