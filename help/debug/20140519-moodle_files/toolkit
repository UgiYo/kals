(function(c){function p(e,b,a){var d=this,l=e.add(this),h=e.find(a.tabs),i=b.jquery?b:e.children(b),j;h.length||(h=e.children());i.length||(i=e.parent().find(b));i.length||(i=c(b));c.extend(this,{click:function(f,g){var k=h.eq(f);if(typeof f=="string"&&f.replace("#","")){k=h.filter("[href*="+f.replace("#","")+"]");f=Math.max(h.index(k),0)}if(a.rotate){var n=h.length-1;if(f<0)return d.click(n,g);if(f>n)return d.click(0,g)}if(!k.length){if(j>=0)return d;f=a.initialIndex;k=h.eq(f)}if(f===j)return d;
g=g||c.Event();g.type="onBeforeClick";l.trigger(g,[f]);if(!g.isDefaultPrevented()){o[a.effect].call(d,f,function(){g.type="onClick";l.trigger(g,[f])});j=f;h.removeClass(a.current);k.addClass(a.current);return d}},getConf:function(){return a},getTabs:function(){return h},getPanes:function(){return i},getCurrentPane:function(){return i.eq(j)},getCurrentTab:function(){return h.eq(j)},getIndex:function(){return j},next:function(){return d.click(j+1)},prev:function(){return d.click(j-1)},destroy:function(){h.unbind(a.event).removeClass(a.current);
i.find("a[href^=#]").unbind("click.T");return d}});c.each("onBeforeClick,onClick".split(","),function(f,g){c.isFunction(a[g])&&c(d).bind(g,a[g]);d[g]=function(k){c(d).bind(g,k);return d}});if(a.history&&c.fn.history){c.tools.history.init(h);a.event="history"}h.each(function(f){c(this).bind(a.event,function(g){d.click(f,g);return g.preventDefault()})});i.find("a[href^=#]").bind("click.T",function(f){d.click(c(this).attr("href"),f)});if(location.hash)d.click(location.hash);else if(a.initialIndex===
0||a.initialIndex>0)d.click(a.initialIndex)}c.tools=c.tools||{version:"1.2.3"};c.tools.tabs={conf:{tabs:"a",current:"current",onBeforeClick:null,onClick:null,effect:"default",initialIndex:0,event:"click",rotate:false,history:false},addEffect:function(e,b){o[e]=b}};var o={"default":function(e,b){this.getPanes().hide().eq(e).show();b.call()},fade:function(e,b){var a=this.getConf(),d=a.fadeOutSpeed,l=this.getPanes();d?l.fadeOut(d):l.hide();l.eq(e).fadeIn(a.fadeInSpeed,b)},slide:function(e,b){this.getPanes().slideUp(200);
this.getPanes().eq(e).slideDown(400,b)},ajax:function(e,b){this.getPanes().eq(0).load(this.getTabs().eq(e).attr("href"),b)}},m;c.tools.tabs.addEffect("horizontal",function(e,b){m||(m=this.getPanes().eq(0).width());this.getCurrentPane().animate({width:0},function(){c(this).hide()});this.getPanes().eq(e).animate({width:m},function(){c(this).show();b.call()})});c.fn.tabs=function(e,b){var a=this.data("tabs");if(a){a.destroy();this.removeData("tabs")}if(c.isFunction(b))b={onBeforeClick:b};b=c.extend({},
c.tools.tabs.conf,b);this.each(function(){a=new p(c(this),e,b);c(this).data("tabs",a)});return b.api?a:this}})(jQuery);
(function(d){function r(g,a){function p(f){var e=d(f);return e.length<2?e:g.parent().find(f)}var c=this,j=g.add(this),b=g.data("tabs"),h,l,m,n=false,o=p(a.next).click(function(){b.next()}),k=p(a.prev).click(function(){b.prev()});d.extend(c,{getTabs:function(){return b},getConf:function(){return a},play:function(){if(!h){var f=d.Event("onBeforePlay");j.trigger(f);if(f.isDefaultPrevented())return c;n=false;h=setInterval(b.next,a.interval);j.trigger("onPlay");b.next()}},pause:function(){if(!h)return c;
var f=d.Event("onBeforePause");j.trigger(f);if(f.isDefaultPrevented())return c;h=clearInterval(h);m=clearInterval(m);j.trigger("onPause")},stop:function(){c.pause();n=true}});d.each("onBeforePlay,onPlay,onBeforePause,onPause".split(","),function(f,e){d.isFunction(a[e])&&c.bind(e,a[e]);c[e]=function(s){return c.bind(e,s)}});if(a.autopause){var t=b.getTabs().add(o).add(k).add(b.getPanes());t.hover(function(){c.pause();l=clearInterval(l)},function(){n||(l=setTimeout(c.play,a.interval))})}if(a.autoplay)m=
setTimeout(c.play,a.interval);else c.stop();a.clickable&&b.getPanes().click(function(){b.next()});if(!b.getConf().rotate){var i=a.disabledClass;b.getIndex()||k.addClass(i);b.onBeforeClick(function(f,e){if(e){k.removeClass(i);e==b.getTabs().length-1?o.addClass(i):o.removeClass(i)}else k.addClass(i)})}}var q;q=d.tools.tabs.slideshow={conf:{next:".forward",prev:".backward",disabledClass:"disabled",autoplay:false,autopause:true,interval:3E3,clickable:true,api:false}};d.fn.slideshow=function(g){var a=
this.data("slideshow");if(a)return a;g=d.extend({},q.conf,g);this.each(function(){a=new r(d(this),g);d(this).data("slideshow",a)});return g.api?a:this}})(jQuery);
(function(f){function p(a,b,c){var h=c.relative?a.position().top:a.offset().top,e=c.relative?a.position().left:a.offset().left,i=c.position[0];h-=b.outerHeight()-c.offset[0];e+=a.outerWidth()+c.offset[1];var j=b.outerHeight()+a.outerHeight();if(i=="center")h+=j/2;if(i=="bottom")h+=j;i=c.position[1];a=b.outerWidth()+a.outerWidth();if(i=="center")e-=a/2;if(i=="left")e-=a;return{top:h,left:e}}function t(a,b){var c=this,h=a.add(c),e,i=0,j=0,m=a.attr("title"),q=n[b.effect],k,r=a.is(":input"),u=r&&a.is(":checkbox, :radio, select, :button, :submit"),
s=a.attr("type"),l=b.events[s]||b.events[r?u?"widget":"input":"def"];if(!q)throw'Nonexistent effect "'+b.effect+'"';l=l.split(/,\s*/);if(l.length!=2)throw"Tooltip: bad events configuration for "+s;a.bind(l[0],function(d){clearTimeout(i);if(b.predelay)j=setTimeout(function(){c.show(d)},b.predelay);else c.show(d)}).bind(l[1],function(d){clearTimeout(j);if(b.delay)i=setTimeout(function(){c.hide(d)},b.delay);else c.hide(d)});if(m&&b.cancelDefault){a.removeAttr("title");a.data("title",m)}f.extend(c,{show:function(d){if(!e){if(m)e=
f(b.layout).addClass(b.tipClass).appendTo(document.body).hide().append(m);else if(b.tip)e=f(b.tip).eq(0);else{e=a.next();e.length||(e=a.parent().next())}if(!e.length)throw"Cannot find tooltip for "+a;}if(c.isShown())return c;e.stop(true,true);var g=p(a,e,b);d=d||f.Event();d.type="onBeforeShow";h.trigger(d,[g]);if(d.isDefaultPrevented())return c;g=p(a,e,b);e.css({position:"absolute",top:g.top,left:g.left});k=true;q[0].call(c,function(){d.type="onShow";k="full";h.trigger(d)});g=b.events.tooltip.split(/,\s*/);
e.bind(g[0],function(){clearTimeout(i);clearTimeout(j)});g[1]&&!a.is("input:not(:checkbox, :radio), textarea")&&e.bind(g[1],function(o){o.relatedTarget!=a[0]&&a.trigger(l[1].split(" ")[0])});return c},hide:function(d){if(!e||!c.isShown())return c;d=d||f.Event();d.type="onBeforeHide";h.trigger(d);if(!d.isDefaultPrevented()){k=false;n[b.effect][1].call(c,function(){d.type="onHide";k=false;h.trigger(d)});return c}},isShown:function(d){return d?k=="full":k},getConf:function(){return b},getTip:function(){return e},
getTrigger:function(){return a}});f.each("onHide,onBeforeShow,onShow,onBeforeHide".split(","),function(d,g){f.isFunction(b[g])&&f(c).bind(g,b[g]);c[g]=function(o){f(c).bind(g,o);return c}})}f.tools=f.tools||{version:"1.2.3"};f.tools.tooltip={conf:{effect:"toggle",fadeOutSpeed:"fast",predelay:0,delay:30,opacity:1,tip:0,position:["top","center"],offset:[0,0],relative:false,cancelDefault:true,events:{def:"mouseenter,mouseleave",input:"focus,blur",widget:"focus mouseenter,blur mouseleave",tooltip:"mouseenter,mouseleave"},
layout:"<div/>",tipClass:"tooltip"},addEffect:function(a,b,c){n[a]=[b,c]}};var n={toggle:[function(a){var b=this.getConf(),c=this.getTip();b=b.opacity;b<1&&c.css({opacity:b});c.show();a.call()},function(a){this.getTip().hide();a.call()}],fade:[function(a){var b=this.getConf();this.getTip().fadeTo(b.fadeInSpeed,b.opacity,a)},function(a){this.getTip().fadeOut(this.getConf().fadeOutSpeed,a)}]};f.fn.tooltip=function(a){var b=this.data("tooltip");if(b)return b;a=f.extend(true,{},f.tools.tooltip.conf,a);
if(typeof a.position=="string")a.position=a.position.split(/,?\s/);this.each(function(){b=new t(f(this),a);f(this).data("tooltip",b)});return a.api?b:this}})(jQuery);
(function(d){var i=d.tools.tooltip;d.extend(i.conf,{direction:"up",bounce:false,slideOffset:10,slideInSpeed:200,slideOutSpeed:200,slideFade:!d.browser.msie});var e={up:["-","top"],down:["+","top"],left:["-","left"],right:["+","left"]};i.addEffect("slide",function(g){var a=this.getConf(),f=this.getTip(),b=a.slideFade?{opacity:a.opacity}:{},c=e[a.direction]||e.up;b[c[1]]=c[0]+"="+a.slideOffset;a.slideFade&&f.css({opacity:0});f.show().animate(b,a.slideInSpeed,g)},function(g){var a=this.getConf(),f=a.slideOffset,
b=a.slideFade?{opacity:0}:{},c=e[a.direction]||e.up,h=""+c[0];if(a.bounce)h=h=="+"?"-":"+";b[c[1]]=h+"="+f;this.getTip().animate(b,a.slideOutSpeed,function(){d(this).hide();g.call()})})})(jQuery);
(function(g){function j(a){var c=g(window),d=c.width()+c.scrollLeft(),h=c.height()+c.scrollTop();return[a.offset().top<=c.scrollTop(),d<=a.offset().left+a.width(),h<=a.offset().top+a.height(),c.scrollLeft()>=a.offset().left]}function k(a){for(var c=a.length;c--;)if(a[c])return false;return true}var i=g.tools.tooltip;i.dynamic={conf:{classNames:"top right bottom left"}};g.fn.dynamic=function(a){if(typeof a=="number")a={speed:a};a=g.extend({},i.dynamic.conf,a);var c=a.classNames.split(/\s/),d;this.each(function(){var h=
g(this).tooltip().onBeforeShow(function(e,f){e=this.getTip();var b=this.getConf();d||(d=[b.position[0],b.position[1],b.offset[0],b.offset[1],g.extend({},b)]);g.extend(b,d[4]);b.position=[d[0],d[1]];b.offset=[d[2],d[3]];e.css({visibility:"hidden",position:"absolute",top:f.top,left:f.left}).show();f=j(e);if(!k(f)){if(f[2]){g.extend(b,a.top);b.position[0]="top";e.addClass(c[0])}if(f[3]){g.extend(b,a.right);b.position[1]="right";e.addClass(c[1])}if(f[0]){g.extend(b,a.bottom);b.position[0]="bottom";e.addClass(c[2])}if(f[1]){g.extend(b,
a.left);b.position[1]="left";e.addClass(c[3])}if(f[0]||f[2])b.offset[0]*=-1;if(f[1]||f[3])b.offset[1]*=-1}e.css({visibility:"visible"}).hide()});h.onBeforeShow(function(){var e=this.getConf();this.getTip();setTimeout(function(){e.position=[d[0],d[1]];e.offset=[d[2],d[3]]},0)});h.onHide(function(){var e=this.getTip();e.removeClass(a.classNames)});ret=h});return a.api?ret:this}})(jQuery);
(function(e){function n(f,c){var a=e(c);return a.length<2?a:f.parent().find(c)}function t(f,c){var a=this,l=f.add(a),g=f.children(),k=0,m=c.vertical;j||(j=a);if(g.length>1)g=e(c.items,f);e.extend(a,{getConf:function(){return c},getIndex:function(){return k},getSize:function(){return a.getItems().size()},getNaviButtons:function(){return o.add(p)},getRoot:function(){return f},getItemWrap:function(){return g},getItems:function(){return g.children(c.item).not("."+c.clonedClass)},move:function(b,d){return a.seekTo(k+
b,d)},next:function(b){return a.move(1,b)},prev:function(b){return a.move(-1,b)},begin:function(b){return a.seekTo(0,b)},end:function(b){return a.seekTo(a.getSize()-1,b)},focus:function(){return j=a},addItem:function(b){b=e(b);if(c.circular){e(".cloned:last").before(b);e(".cloned:first").replaceWith(b.clone().addClass(c.clonedClass))}else g.append(b);l.trigger("onAddItem",[b]);return a},seekTo:function(b,d,h){if(c.circular&&b===0&&k==-1&&d!==0)return a;if(!c.circular&&b<0||b>a.getSize()||b<-1)return a;
var i=b;if(b.jquery)b=a.getItems().index(b);else i=a.getItems().eq(b);var q=e.Event("onBeforeSeek");if(!h){l.trigger(q,[b,d]);if(q.isDefaultPrevented()||!i.length)return a}i=m?{top:-i.position().top}:{left:-i.position().left};k=b;j=a;if(d===undefined)d=c.speed;g.animate(i,d,c.easing,h||function(){l.trigger("onSeek",[b])});return a}});e.each(["onBeforeSeek","onSeek","onAddItem"],function(b,d){e.isFunction(c[d])&&e(a).bind(d,c[d]);a[d]=function(h){e(a).bind(d,h);return a}});if(c.circular){var r=a.getItems().slice(-1).clone().prependTo(g),
s=a.getItems().eq(1).clone().appendTo(g);r.add(s).addClass(c.clonedClass);a.onBeforeSeek(function(b,d,h){if(!b.isDefaultPrevented())if(d==-1){a.seekTo(r,h,function(){a.end(0)});return b.preventDefault()}else d==a.getSize()&&a.seekTo(s,h,function(){a.begin(0)})});a.seekTo(0,0)}var o=n(f,c.prev).click(function(){a.prev()}),p=n(f,c.next).click(function(){a.next()});!c.circular&&a.getSize()>1&&a.onBeforeSeek(function(b,d){setTimeout(function(){if(!b.isDefaultPrevented()){o.toggleClass(c.disabledClass,
d<=0);p.toggleClass(c.disabledClass,d>=a.getSize()-1)}},1)});c.mousewheel&&e.fn.mousewheel&&f.mousewheel(function(b,d){if(c.mousewheel){a.move(d<0?1:-1,c.wheelSpeed||50);return false}});c.keyboard&&e(document).bind("keydown.scrollable",function(b){if(!(!c.keyboard||b.altKey||b.ctrlKey||e(b.target).is(":input")))if(!(c.keyboard!="static"&&j!=a)){var d=b.keyCode;if(m&&(d==38||d==40)){a.move(d==38?-1:1);return b.preventDefault()}if(!m&&(d==37||d==39)){a.move(d==37?-1:1);return b.preventDefault()}}});
e(a).trigger("onBeforeSeek",[c.initialIndex])}e.tools=e.tools||{version:"1.2.3"};e.tools.scrollable={conf:{activeClass:"active",circular:false,clonedClass:"cloned",disabledClass:"disabled",easing:"swing",initialIndex:0,item:null,items:".items",keyboard:true,mousewheel:false,next:".next",prev:".prev",speed:400,vertical:false,wheelSpeed:0}};var j;e.fn.scrollable=function(f){var c=this.data("scrollable");if(c)return c;f=e.extend({},e.tools.scrollable.conf,f);this.each(function(){c=new t(e(this),f);e(this).data("scrollable",
c)});return f.api?c:this}})(jQuery);
(function(c){var g=c.tools.scrollable;g.autoscroll={conf:{autoplay:true,interval:3E3,autopause:true}};c.fn.autoscroll=function(d){if(typeof d=="number")d={interval:d};var b=c.extend({},g.autoscroll.conf,d),h;this.each(function(){var a=c(this).data("scrollable");if(a)h=a;var e,i,f=true;a.play=function(){if(!e){f=false;e=setInterval(function(){a.next()},b.interval);a.next()}};a.pause=function(){e=clearInterval(e)};a.stop=function(){a.pause();f=true};b.autopause&&a.getRoot().add(a.getNaviButtons()).hover(function(){a.pause();
clearInterval(i)},function(){f||(i=setTimeout(a.play,b.interval))});b.autoplay&&setTimeout(a.play,b.interval)});return b.api?h:this}})(jQuery);
(function(d){function p(c,g){var h=d(g);return h.length<2?h:c.parent().find(g)}var m=d.tools.scrollable;m.navigator={conf:{navi:".navi",naviItem:null,activeClass:"active",indexed:false,idPrefix:null,history:false}};d.fn.navigator=function(c){if(typeof c=="string")c={navi:c};c=d.extend({},m.navigator.conf,c);var g;this.each(function(){function h(a,b,i){e.seekTo(b);if(j){if(location.hash)location.hash=a.attr("href").replace("#","")}else return i.preventDefault()}function f(){return k.find(c.naviItem||
"> *")}function n(a){var b=d("<"+(c.naviItem||"a")+"/>").click(function(i){h(d(this),a,i)}).attr("href","#"+a);a===0&&b.addClass(l);c.indexed&&b.text(a+1);c.idPrefix&&b.attr("id",c.idPrefix+a);return b.appendTo(k)}function o(a,b){a=f().eq(b.replace("#",""));a.length||(a=f().filter("[href="+b+"]"));a.click()}var e=d(this).data("scrollable"),k=p(e.getRoot(),c.navi),q=e.getNaviButtons(),l=c.activeClass,j=c.history&&d.fn.history;if(e)g=e;e.getNaviButtons=function(){return q.add(k)};f().length?f().each(function(a){d(this).click(function(b){h(d(this),
a,b)})}):d.each(e.getItems(),function(a){n(a)});e.onBeforeSeek(function(a,b){setTimeout(function(){if(!a.isDefaultPrevented()){var i=f().eq(b);!a.isDefaultPrevented()&&i.length&&f().removeClass(l).eq(b).addClass(l)}},1)});e.onAddItem(function(a,b){b=n(e.getItems().index(b));j&&b.history(o)});j&&f().history(o)});return c.api?g:this}})(jQuery);
(function(a){function t(d,b){var c=this,i=d.add(c),o=a(window),k,f,m,g=a.tools.expose&&(b.mask||b.expose),n=Math.random().toString().slice(10);if(g){if(typeof g=="string")g={color:g};g.closeOnClick=g.closeOnEsc=false}var p=b.target||d.attr("rel");f=p?a(p):d;if(!f.length)throw"Could not find Overlay: "+p;d&&d.index(f)==-1&&d.click(function(e){c.load(e);return e.preventDefault()});a.extend(c,{load:function(e){if(c.isOpened())return c;var h=q[b.effect];if(!h)throw'Overlay: cannot find effect : "'+b.effect+
'"';b.oneInstance&&a.each(s,function(){this.close(e)});e=e||a.Event();e.type="onBeforeLoad";i.trigger(e);if(e.isDefaultPrevented())return c;m=true;g&&a(f).expose(g);var j=b.top,r=b.left,u=f.outerWidth({margin:true}),v=f.outerHeight({margin:true});if(typeof j=="string")j=j=="center"?Math.max((o.height()-v)/2,0):parseInt(j,10)/100*o.height();if(r=="center")r=Math.max((o.width()-u)/2,0);h[0].call(c,{top:j,left:r},function(){if(m){e.type="onLoad";i.trigger(e)}});g&&b.closeOnClick&&a.mask.getMask().one("click",
c.close);b.closeOnClick&&a(document).bind("click."+n,function(l){a(l.target).parents(f).length||c.close(l)});b.closeOnEsc&&a(document).bind("keydown."+n,function(l){l.keyCode==27&&c.close(l)});return c},setOpened:function(z){m=z},close:function(e){if(!c.isOpened())return c;e=e||a.Event();e.type="onBeforeClose";i.trigger(e);if(!e.isDefaultPrevented()){m=false;q[b.effect][1].call(c,function(){e.type="onClose";i.trigger(e)});a(document).unbind("click."+n).unbind("keydown."+n);g&&a.mask.close();return c}},getOverlay:function(){return f},
getTrigger:function(){return d},getClosers:function(){return k},isOpened:function(){return m},getConf:function(){return b}});a.each("onBeforeLoad,onStart,onLoad,onBeforeClose,onClose".split(","),function(e,h){a.isFunction(b[h])&&a(c).bind(h,b[h]);c[h]=function(j){a(c).bind(h,j);return c}});k=f.find(b.close||".close");if(!k.length&&!b.close){k=a('<a class="close"></a>');f.prepend(k)}k.click(function(e){c.close(e)});b.load&&c.load()}a.tools=a.tools||{version:"1.2.3"};a.tools.overlay={addEffect:function(d,
b,c){q[d]=[b,c]},conf:{close:null,closeOnClick:true,closeOnEsc:true,closeSpeed:"fast",effect:"default",fixed:!a.browser.msie||a.browser.version>6,left:"center",load:false,mask:null,oneInstance:true,speed:"normal",target:null,top:"10%"}};var s=[],q={};a.tools.overlay.addEffect("default",function(d,b){var c=this.getConf(),i=a(window);if(!c.fixed){d.top+=i.scrollTop();d.left+=i.scrollLeft()}d.position=c.fixed?"fixed":"absolute";this.getOverlay().css(d).fadeIn(c.speed,b)},function(d){this.getOverlay().fadeOut(this.getConf().closeSpeed,
d)});a.fn.overlay=function(d){var b=this.data("overlay");if(b)return b;if(a.isFunction(d))d={onBeforeLoad:d};d=a.extend(true,{},a.tools.overlay.conf,d);this.each(function(){b=new t(a(this),d);s.push(b);a(this).data("overlay",b)});return d.api?b:this}})(jQuery);
(function(i){function j(b){var d=b.offset();return{top:d.top+b.height()/2,left:d.left+b.width()/2}}var k=i.tools.overlay,f=i(window);i.extend(k.conf,{start:{top:null,left:null},fadeInSpeed:"fast",zIndex:9999});function n(b,d){var a=this.getOverlay(),c=this.getConf(),g=this.getTrigger(),o=this,l=a.outerWidth({margin:true}),h=a.data("img");if(!h){var e=a.css("backgroundImage");if(!e)throw"background-image CSS property not set for overlay";e=e.slice(e.indexOf("(")+1,e.indexOf(")")).replace(/\"/g,"");
a.css("backgroundImage","none");h=i('<img src="'+e+'"/>');h.css({border:0,display:"none"}).width(l);i("body").append(h);a.data("img",h)}e=c.start.top||Math.round(f.height()/2);var m=c.start.left||Math.round(f.width()/2);if(g){g=j(g);e=g.top;m=g.left}h.css({position:"absolute",top:e,left:m,width:0,zIndex:c.zIndex}).show();b.top+=f.scrollTop();b.left+=f.scrollLeft();b.position="absolute";a.css(b);h.animate({top:a.css("top"),left:a.css("left"),width:l},c.speed,function(){if(c.fixed){b.top-=f.scrollTop();
b.left-=f.scrollLeft();b.position="fixed";h.add(a).css(b)}a.css("zIndex",c.zIndex+1).fadeIn(c.fadeInSpeed,function(){o.isOpened()&&!i(this).index(a)?d.call():a.hide()})})}function p(b){var d=this.getOverlay().hide(),a=this.getConf(),c=this.getTrigger();d=d.data("img");var g={top:a.start.top,left:a.start.left,width:0};c&&i.extend(g,j(c));a.fixed&&d.css({position:"absolute"}).animate({top:"+="+f.scrollTop(),left:"+="+f.scrollLeft()},0);d.animate(g,a.closeSpeed,b)}k.addEffect("apple",n,p)})(jQuery);
(function(d){function R(b,c){return 32-(new Date(b,c,32)).getDate()}function S(b,c){b=""+b;for(c=c||2;b.length<c;)b="0"+b;return b}function T(b,c,j){var m=b.getDate(),h=b.getDay(),t=b.getMonth();b=b.getFullYear();var f={d:m,dd:S(m),ddd:B[j].shortDays[h],dddd:B[j].days[h],m:t+1,mm:S(t+1),mmm:B[j].shortMonths[t],mmmm:B[j].months[t],yy:String(b).slice(2),yyyy:b};c=c.replace(X,function(o){return o in f?f[o]:o.slice(1,o.length-1)});return Y.html(c).html()}function y(b){return parseInt(b,10)}function U(b,
c){return b.getFullYear()===c.getFullYear()&&b.getMonth()==c.getMonth()&&b.getDate()==c.getDate()}function C(b){if(b){if(b.constructor==Date)return b;if(typeof b=="string"){var c=b.split("-");if(c.length==3)return new Date(y(c[0]),y(c[1])-1,y(c[2]));if(!/^-?\d+$/.test(b))return;b=y(b)}c=new Date;c.setDate(c.getDate()+b);return c}}function Z(b,c){function j(a,e,g){l=a;D=a.getFullYear();E=a.getMonth();G=a.getDate();g=g||d.Event("api");g.type="change";H.trigger(g,[a]);if(!g.isDefaultPrevented()){b.val(T(a,
e.format,e.lang));b.data("date",a);h.hide(g)}}function m(a){a.type="onShow";H.trigger(a);d(document).bind("keydown.d",function(e){var g=e.keyCode;if(g==8){b.val("");return h.hide(e)}if(g==27)return h.hide(e);if(d(V).index(g)>=0){if(!u){h.show(e);return e.preventDefault()}var i=d("#"+f.weeks+" a"),p=d("."+f.focus),q=i.index(p);p.removeClass(f.focus);if(g==74||g==40)q+=7;else if(g==75||g==38)q-=7;else if(g==76||g==39)q+=1;else if(g==72||g==37)q-=1;if(q==-1){h.addMonth(-1);p=d("#"+f.weeks+" a:last")}else if(q==
35){h.addMonth();p=d("#"+f.weeks+" a:first")}else p=i.eq(q);p.addClass(f.focus);return e.preventDefault()}if(g==34)return h.addMonth();if(g==33)return h.addMonth(-1);if(g==36)return h.today();if(g==13)d(e.target).is("select")||d("."+f.focus).click();return d([16,17,18,9]).index(g)>=0});d(document).bind("click.d",function(e){var g=e.target;if(!d(g).parents("#"+f.root).length&&g!=b[0]&&(!K||g!=K[0]))h.hide(e)})}var h=this,t=new Date,f=c.css,o=B[c.lang],k=d("#"+f.root),L=k.find("#"+f.title),K,I,J,D,
E,G,l=b.attr("data-value")||c.value||b.val(),r=b.attr("min")||c.min,s=b.attr("max")||c.max,u;l=C(l)||t;r=C(r||c.yearRange[0]*365);s=C(s||c.yearRange[1]*365);if(!o)throw"Dateinput: invalid language: "+c.lang;if(b.attr("type")=="date"){var M=d("<input/>");d.each("name,readonly,disabled,value,required".split(","),function(a,e){M.attr(e,b.attr(e))});b.replaceWith(M);b=M}b.addClass(f.input);var H=b.add(h);if(!k.length){k=d("<div><div><a/><div/><a/></div><div><div/><div/></div></div>").hide().css({position:"absolute"}).attr("id",
f.root);k.children().eq(0).attr("id",f.head).end().eq(1).attr("id",f.body).children().eq(0).attr("id",f.days).end().eq(1).attr("id",f.weeks).end().end().end().find("a").eq(0).attr("id",f.prev).end().eq(1).attr("id",f.next);L=k.find("#"+f.head).find("div").attr("id",f.title);if(c.selectors){var z=d("<select/>").attr("id",f.month),A=d("<select/>").attr("id",f.year);L.append(z.add(A))}for(var $=k.find("#"+f.days),N=0;N<7;N++)$.append(d("<span/>").text(o.shortDays[(N+c.firstDay)%7]));b.after(k)}if(c.trigger)K=
d("<a/>").attr("href","#").addClass(f.trigger).click(function(a){h.show();return a.preventDefault()}).insertAfter(b);var O=k.find("#"+f.weeks);A=k.find("#"+f.year);z=k.find("#"+f.month);d.extend(h,{show:function(a){if(!(b.is("[readonly]")||u)){a=a||d.Event();a.type="onBeforeShow";H.trigger(a);if(!a.isDefaultPrevented()){d.each(W,function(){this.hide()});u=true;z.unbind("change").change(function(){h.setValue(A.val(),d(this).val())});A.unbind("change").change(function(){h.setValue(d(this).val(),z.val())});
I=k.find("#"+f.prev).unbind("click").click(function(){I.hasClass(f.disabled)||h.addMonth(-1);return false});J=k.find("#"+f.next).unbind("click").click(function(){J.hasClass(f.disabled)||h.addMonth();return false});h.setValue(l);var e=b.position();k.css({top:e.top+b.outerHeight({margins:true})+c.offset[0],left:e.left+c.offset[1]});if(c.speed)k.show(c.speed,function(){m(a)});else{k.show();m(a)}return h}}},setValue:function(a,e,g){var i;if(parseInt(e,10)>=-1){a=y(a);e=y(e);g=y(g);i=new Date(a,e,g)}else{i=
a||l;a=i.getFullYear();e=i.getMonth();g=i.getDate()}if(e==-1){e=11;a--}else if(e==12){e=0;a++}if(!u){j(i,c);return h}E=e;D=a;i=new Date(a,e,1-c.firstDay);g=i.getDay();var p=R(a,e),q=R(a,e-1),P;if(c.selectors){z.empty();d.each(o.months,function(v,F){r<new Date(a,v+1,-1)&&s>new Date(a,v,0)&&z.append(d("<option/>").html(F).attr("value",v))});A.empty();for(i=a+c.yearRange[0];i<a+c.yearRange[1];i++)r<new Date(i+1,-1,0)&&s>new Date(i,0,0)&&A.append(d("<option/>").text(i));z.val(e);A.val(a)}else L.html(o.months[e]+
" "+a);O.empty();I.add(J).removeClass(f.disabled);for(var w=0,n,x;w<42;w++){n=d("<a/>");if(w%7===0){P=d("<div/>").addClass(f.week);O.append(P)}if(w<g){n.addClass(f.off);x=q-g+w+1;i=new Date(a,e-1,x)}else if(w>=g+p){n.addClass(f.off);x=w-p-g+1;i=new Date(a,e+1,x)}else{x=w-g+1;i=new Date(a,e,x);if(U(l,i))n.attr("id",f.current).addClass(f.focus);else U(t,i)&&n.attr("id",f.today)}r&&i<r&&n.add(I).addClass(f.disabled);s&&i>s&&n.add(J).addClass(f.disabled);n.attr("href","#"+x).text(x).data("date",i);P.append(n);
n.click(function(v){var F=d(this);if(!F.hasClass(f.disabled)){d("#"+f.current).removeAttr("id");F.attr("id",f.current);j(F.data("date"),c,v)}return false})}f.sunday&&O.find(f.week).each(function(){var v=c.firstDay?7-c.firstDay:0;d(this).children().slice(v,v+1).addClass(f.sunday)});return h},setMin:function(a,e){r=C(a);e&&l<r&&h.setValue(r);return h},setMax:function(a,e){s=C(a);e&&l>s&&h.setValue(s);return h},today:function(){return h.setValue(t)},addDay:function(a){return this.setValue(D,E,G+(a||
1))},addMonth:function(a){return this.setValue(D,E+(a||1),G)},addYear:function(a){return this.setValue(D+(a||1),E,G)},hide:function(a){if(u){a=a||d.Event();a.type="onHide";H.trigger(a);d(document).unbind("click.d").unbind("keydown.d");if(a.isDefaultPrevented())return;k.hide();u=false}return h},getConf:function(){return c},getInput:function(){return b},getCalendar:function(){return k},getValue:function(a){return a?T(l,a,c.lang):l},isOpen:function(){return u}});d.each(["onBeforeShow","onShow","change",
"onHide"],function(a,e){d.isFunction(c[e])&&d(h).bind(e,c[e]);h[e]=function(g){d(h).bind(e,g);return h}});b.bind("focus click",h.show).keydown(function(a){var e=a.keyCode;if(!u&&d(V).index(e)>=0){h.show(a);return a.preventDefault()}return a.shiftKey||a.ctrlKey||a.altKey||e==9?true:a.preventDefault()});C(b.val())&&j(l,c)}d.tools=d.tools||{version:"1.2.3"};var W=[],Q,V=[75,76,38,39,74,72,40,37],B={};Q=d.tools.dateinput={conf:{format:"mm/dd/yy",selectors:false,yearRange:[-5,5],lang:"en",offset:[0,0],
speed:0,firstDay:0,min:0,max:0,trigger:false,css:{prefix:"cal",input:"date",root:0,head:0,title:0,prev:0,next:0,month:0,year:0,days:0,body:0,weeks:0,today:0,current:0,week:0,off:0,sunday:0,focus:0,disabled:0,trigger:0}},localize:function(b,c){d.each(c,function(j,m){c[j]=m.split(",")});B[b]=c}};Q.localize("en",{months:"January,February,March,April,May,June,July,August,September,October,November,December",shortMonths:"Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec",days:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday",
shortDays:"Sun,Mon,Tue,Wed,Thu,Fri,Sat"});var X=/d{1,4}|m{1,4}|yy(?:yy)?|"[^"]*"|'[^']*'/g,Y=d("<a/>");d.expr[":"].date=function(b){var c=b.getAttribute("type");return c&&c=="date"||!!d(b).data("dateinput")};d.fn.dateinput=function(b){if(this.data("dateinput"))return this;b=d.extend(true,{},Q.conf,b);d.each(b.css,function(j,m){if(!m&&j!="prefix")b.css[j]=(b.css.prefix||"")+(m||j)});var c;this.each(function(){var j=new Z(d(this),b);W.push(j);j=j.getInput().data("dateinput",j);c=c?c.add(j):j});return c?
c:this}})(jQuery);
(function(e){function F(d,a){a=Math.pow(10,a);return Math.round(d*a)/a}function p(d,a){if(a=parseInt(d.css(a),10))return a;return(d=d[0].currentStyle)&&d.width&&parseInt(d.width,10)}function C(d){return(d=d.data("events"))&&d.onSlide}function G(d,a){function h(c,b,f,j){if(f===undefined)f=b/k*z;else if(j)f-=a.min;if(r)f=Math.round(f/r)*r;if(b===undefined||r)b=f*k/z;if(isNaN(f))return g;b=Math.max(0,Math.min(b,k));f=b/k*z;if(j||!n)f+=a.min;if(n)if(j)b=k-b;else f=a.max-f;f=F(f,t);var q=c.type=="click";
if(D&&l!==undefined&&!q){c.type="onSlide";A.trigger(c,[f,b]);if(c.isDefaultPrevented())return g}j=q?a.speed:0;q=q?function(){c.type="change";A.trigger(c,[f])}:null;if(n){m.animate({top:b},j,q);a.progress&&B.animate({height:k-b+m.width()/2},j)}else{m.animate({left:b},j,q);a.progress&&B.animate({width:b+m.width()/2},j)}l=f;H=b;d.val(f);return g}function s(){if(n=a.vertical||p(i,"height")>p(i,"width")){k=p(i,"height")-p(m,"height");u=i.offset().top+k}else{k=p(i,"width")-p(m,"width");u=i.offset().left}}
function v(){s();g.setValue(a.value||a.min)}var g=this,o=a.css,i=e("<div><div/><a href='#'/></div>").data("rangeinput",g),n,l,u,k,H;d.before(i);var m=i.addClass(o.slider).find("a").addClass(o.handle),B=i.find("div").addClass(o.progress);e.each("min,max,step,value".split(","),function(c,b){c=d.attr(b);if(parseFloat(c))a[b]=parseFloat(c,10)});var z=a.max-a.min,r=a.step=="any"?0:a.step,t=a.precision;if(t===undefined)try{t=r.toString().split(".")[1].length}catch(I){t=0}if(d.attr("type")=="range"){var w=
e("<input/>");e.each("name,readonly,disabled,required".split(","),function(c,b){w.attr(b,d.attr(b))});w.val(a.value);d.replaceWith(w);d=w}d.addClass(o.input);var A=e(g).add(d),D=true;e.extend(g,{getValue:function(){return l},setValue:function(c,b){return h(b||e.Event("api"),undefined,c,true)},getConf:function(){return a},getProgress:function(){return B},getHandle:function(){return m},getInput:function(){return d},step:function(c,b){b=b||e.Event();var f=a.step=="any"?1:a.step;g.setValue(l+f*(c||1),
b)},stepUp:function(c){return g.step(c||1)},stepDown:function(c){return g.step(-c||-1)}});e.each("onSlide,change".split(","),function(c,b){e.isFunction(a[b])&&e(g).bind(b,a[b]);g[b]=function(f){e(g).bind(b,f);return g}});m.drag({drag:false}).bind("dragStart",function(){D=C(e(g))||C(d)}).bind("drag",function(c,b,f){if(d.is(":disabled"))return false;h(c,n?b:f)}).bind("dragEnd",function(c){if(!c.isDefaultPrevented()){c.type="change";A.trigger(c,[l])}}).click(function(c){return c.preventDefault()});i.click(function(c){if(d.is(":disabled")||
c.target==m[0])return c.preventDefault();s();var b=m.width()/2;h(c,n?k-u-b+c.pageY:c.pageX-u-b)});a.keyboard&&d.keydown(function(c){if(!d.attr("readonly")){var b=c.keyCode,f=e([75,76,38,33,39]).index(b)!=-1,j=e([74,72,40,34,37]).index(b)!=-1;if((f||j)&&!(c.shiftKey||c.altKey||c.ctrlKey)){if(f)g.step(b==33?10:1,c);else if(j)g.step(b==34?-10:-1,c);return c.preventDefault()}}});d.blur(function(c){var b=e(this).val();b!==l&&g.setValue(b,c)});e.extend(d[0],{stepUp:g.stepUp,stepDown:g.stepDown});v();k||
e(window).load(v)}e.tools=e.tools||{version:"1.2.3"};var E;E=e.tools.rangeinput={conf:{min:0,max:100,step:"any",steps:0,value:0,precision:undefined,vertical:0,keyboard:true,progress:false,speed:100,css:{input:"range",slider:"slider",progress:"progress",handle:"handle"}}};var x,y;e.fn.drag=function(d){document.ondragstart=function(){return false};d=e.extend({x:true,y:true,drag:true},d);x=x||e(document).bind("mousedown mouseup",function(a){var h=e(a.target);if(a.type=="mousedown"&&h.data("drag")){var s=
h.position(),v=a.pageX-s.left,g=a.pageY-s.top,o=true;x.bind("mousemove.drag",function(i){var n=i.pageX-v;i=i.pageY-g;var l={};if(d.x)l.left=n;if(d.y)l.top=i;if(o){h.trigger("dragStart");o=false}d.drag&&h.css(l);h.trigger("drag",[i,n]);y=h});a.preventDefault()}else try{y&&y.trigger("dragEnd")}finally{x.unbind("mousemove.drag");y=null}});return this.data("drag",true)};e.expr[":"].range=function(d){var a=d.getAttribute("type");return a&&a=="range"||!!e(d).filter("input").data("rangeinput")};e.fn.rangeinput=
function(d){if(this.data("rangeinput"))return this;d=e.extend(true,{},E.conf,d);var a;this.each(function(){var h=new G(e(this),e.extend(true,{},d));h=h.getInput().data("rangeinput",h);a=a?a.add(h):h});return a?a:this}})(jQuery);
(function(d){function v(a,b,c){var k=a.offset().top,f=a.offset().left,l=c.position.split(/,?\s+/),g=l[0];l=l[1];k-=b.outerHeight()-c.offset[0];f+=a.outerWidth()+c.offset[1];c=b.outerHeight()+a.outerHeight();if(g=="center")k+=c/2;if(g=="bottom")k+=c;a=a.outerWidth();if(l=="center")f-=(a+b.outerWidth())/2;if(l=="left")f-=a;return{top:k,left:f}}function w(a){function b(){return this.getAttribute("type")==a}b.key="[type="+a+"]";return b}function s(a,b,c){function k(g,e,j){if(!(!c.grouped&&g.length)){var h;
if(j===false||d.isArray(j)){h=i.messages[e.key||e]||i.messages["*"];h=h[c.lang]||i.messages["*"].en;(e=h.match(/\$\d/g))&&d.isArray(j)&&d.each(e,function(n){h=h.replace(this,j[n])})}else h=j[c.lang]||j;g.push(h)}}var f=this,l=b.add(f);a=a.not(":button, :image, :reset, :submit");d.extend(f,{getConf:function(){return c},getForm:function(){return b},getInputs:function(){return a},invalidate:function(g,e){if(!e){var j=[];d.each(g,function(h,n){h=a.filter("[name="+h+"]");if(h.length){h.trigger("OI",[n]);
j.push({input:h,messages:[n]})}});g=j;e=d.Event()}e.type="onFail";l.trigger(e,[g]);e.isDefaultPrevented()||q[c.effect][0].call(f,g,e);return f},reset:function(g){g=g||a;g.removeClass(c.errorClass).each(function(){var e=d(this).data("msg.el");if(e){e.remove();d(this).data("msg.el",null)}}).unbind(c.errorInputEvent||"");return f},destroy:function(){b.unbind(c.formEvent).unbind("reset.V");a.unbind(c.inputEvent||"").unbind("change.V");return f.reset()},checkValidity:function(g,e){g=g||a;g=g.not(":disabled");
if(!g.length)return true;e=e||d.Event();e.type="onBeforeValidate";l.trigger(e,[g]);if(e.isDefaultPrevented())return e.result;var j=[],h=c.errorInputEvent+".v";g.each(function(){var p=[],m=d(this).unbind(h).data("messages",p);d.each(t,function(){var o=this,r=o[0];if(m.filter(r).length){o=o[1].call(f,m,m.val());if(o!==true){e.type="onBeforeFail";l.trigger(e,[m,r]);if(e.isDefaultPrevented())return false;var u=m.attr(c.messageAttr);if(u){p=[u];return false}else k(p,r,o)}}});if(p.length){j.push({input:m,
messages:p});m.trigger("OI",[p]);c.errorInputEvent&&m.bind(h,function(o){f.checkValidity(m,o)})}if(c.singleError&&j.length)return false});var n=q[c.effect];if(!n)throw'Validator: cannot find effect "'+c.effect+'"';if(j.length){f.invalidate(j,e);return false}else{n[1].call(f,g,e);e.type="onSuccess";l.trigger(e,[g]);g.unbind(h)}return true}});d.each("onBeforeValidate,onBeforeFail,onFail,onSuccess".split(","),function(g,e){d.isFunction(c[e])&&d(f).bind(e,c[e]);f[e]=function(j){d(f).bind(e,j);return f}});
c.formEvent&&b.bind(c.formEvent,function(g){if(!f.checkValidity(null,g))return g.preventDefault()});b.bind("reset.V",function(){f.reset()});a[0]&&a[0].validity&&a.each(function(){this.oninvalid=function(){return false}});if(b[0])b[0].checkValidity=f.checkValidity;c.inputEvent&&a.bind(c.inputEvent,function(g){f.checkValidity(d(this),g)});a.filter(":checkbox, select").filter("[required]").bind("change.V",function(g){var e=d(this);if(this.checked||e.is("select")&&d(this).val())q[c.effect][1].call(f,
e,g)})}d.tools=d.tools||{version:"1.2.3"};var x=/\[type=([a-z]+)\]/,y=/^-?[0-9]*(\.[0-9]+)?$/,z=/^([a-z0-9_\.\-\+]+)@([\da-z\.\-]+)\.([a-z\.]{2,6})$/i,A=/^(https?:\/\/)?([\da-z\.\-]+)\.([a-z\.]{2,6})([\/\w \.\-]*)*\/?$/i,i;i=d.tools.validator={conf:{grouped:false,effect:"default",errorClass:"invalid",inputEvent:null,errorInputEvent:"keyup",formEvent:"submit",lang:"en",message:"<div/>",messageAttr:"data-message",messageClass:"error",offset:[0,0],position:"center right",singleError:false,speed:"normal"},
messages:{"*":{en:"Please correct this value"}},localize:function(a,b){d.each(b,function(c,k){i.messages[c]=i.messages[c]||{};i.messages[c][a]=k})},localizeFn:function(a,b){i.messages[a]=i.messages[a]||{};d.extend(i.messages[a],b)},fn:function(a,b,c){if(d.isFunction(b))c=b;else{if(typeof b=="string")b={en:b};this.messages[a.key||a]=b}if(b=x.exec(a))a=w(b[1]);t.push([a,c])},addEffect:function(a,b,c){q[a]=[b,c]}};var t=[],q={"default":[function(a){var b=this.getConf();d.each(a,function(c,k){c=k.input;
c.addClass(b.errorClass);var f=c.data("msg.el");if(!f){f=d(b.message).addClass(b.messageClass).appendTo(document.body);c.data("msg.el",f)}f.css({visibility:"hidden"}).find("span").remove();d.each(k.messages,function(l,g){d("<span/>").html(g).appendTo(f)});f.outerWidth()==f.parent().width()&&f.add(f.find("p")).css({display:"inline"});k=v(c,f,b);f.css({visibility:"visible",position:"absolute",top:k.top,left:k.left}).fadeIn(b.speed)})},function(a){var b=this.getConf();a.removeClass(b.errorClass).each(function(){var c=
d(this).data("msg.el");c&&c.css({visibility:"hidden"})})}]};d.each("email,url,number".split(","),function(a,b){d.expr[":"][b]=function(c){return c.getAttribute("type")===b}});d.fn.oninvalid=function(a){return this[a?"bind":"trigger"]("OI",a)};i.fn(":email","Please enter a valid email address",function(a,b){return!b||z.test(b)});i.fn(":url","Please enter a valid URL",function(a,b){return!b||A.test(b)});i.fn(":number","Please enter a numeric value.",function(a,b){return y.test(b)});i.fn("[max]","Please enter a value smaller than $1",
function(a,b){if(d.tools.dateinput&&a.is(":date"))return true;a=a.attr("max");return parseFloat(b)<=parseFloat(a)?true:[a]});i.fn("[min]","Please enter a value larger than $1",function(a,b){if(d.tools.dateinput&&a.is(":date"))return true;a=a.attr("min");return parseFloat(b)>=parseFloat(a)?true:[a]});i.fn("[required]","Please complete this mandatory field.",function(a,b){if(a.is(":checkbox"))return a.is(":checked");return!!b});i.fn("[pattern]",function(a){var b=new RegExp("^"+a.attr("pattern")+"$");
return b.test(a.val())});d.fn.validator=function(a){var b=this.data("validator");if(b){b.destroy();this.removeData("validator")}a=d.extend(true,{},i.conf,a);if(this.is("form"))return this.each(function(){var c=d(this);b=new s(c.find(":input"),c,a);c.data("validator",b)});else{b=new s(this,this.eq(0).closest("form"),a);return this.data("validator",b)}}})(jQuery);
(function(){function f(a,b){if(b)for(key in b)if(b.hasOwnProperty(key))a[key]=b[key];return a}function l(a,b){var c=[];for(var d in a)if(a.hasOwnProperty(d))c[d]=b(a[d]);return c}function m(a,b,c){if(e.isSupported(b.version))a.innerHTML=e.getHTML(b,c);else if(b.expressInstall&&e.isSupported([6,65]))a.innerHTML=e.getHTML(f(b,{src:b.expressInstall}),{MMredirectURL:location.href,MMplayerType:"PlugIn",MMdoctitle:document.title});else{if(!a.innerHTML.replace(/\s/g,"")){a.innerHTML="<h2>Flash version "+
b.version+" or greater is required</h2><h3>"+(g[0]>0?"Your version is "+g:"You have no flash plugin installed")+"</h3>"+(a.tagName=="A"?"<p>Click here to download latest version</p>":"<p>Download latest version from <a href='"+k+"'>here</a></p>");if(a.tagName=="A")a.onclick=function(){location.href=k}}if(b.onFail){var d=b.onFail.call(this);if(typeof d=="string")a.innerHTML=d}}if(h)window[b.id]=document.getElementById(b.id);f(this,{getRoot:function(){return a},getOptions:function(){return b},getConf:function(){return c},
getApi:function(){return a.firstChild}})}var h=document.all,k="http://www.adobe.com/go/getflashplayer",n=typeof jQuery=="function",o=/(\d+)[^\d]+(\d+)[^\d]*(\d*)/,i={width:"100%",height:"100%",id:"_"+(""+Math.random()).slice(9),allowfullscreen:true,allowscriptaccess:"always",quality:"high",version:[3,0],onFail:null,expressInstall:null,w3c:false,cachebusting:false};window.attachEvent&&window.attachEvent("onbeforeunload",function(){__flash_unloadHandler=function(){};__flash_savedUnloadHandler=function(){}});
window.flashembed=function(a,b,c){if(typeof a=="string")a=document.getElementById(a.replace("#",""));if(a){if(typeof b=="string")b={src:b};return new m(a,f(f({},i),b),c)}};var e=f(window.flashembed,{conf:i,getVersion:function(){var a;try{a=navigator.plugins["Shockwave Flash"].description.slice(16)}catch(b){try{var c=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.7");a=c&&c.GetVariable("$version")}catch(d){}}return(a=o.exec(a))?[a[1],a[3]]:[0,0]},asString:function(a){if(a===null||a===undefined)return null;
var b=typeof a;if(b=="object"&&a.push)b="array";switch(b){case "string":a=a.replace(new RegExp('(["\\\\])',"g"),"\\$1");a=a.replace(/^\s?(\d+\.?\d+)%/,"$1pct");return'"'+a+'"';case "array":return"["+l(a,function(d){return e.asString(d)}).join(",")+"]";case "function":return'"function()"';case "object":b=[];for(var c in a)a.hasOwnProperty(c)&&b.push('"'+c+'":'+e.asString(a[c]));return"{"+b.join(",")+"}"}return String(a).replace(/\s/g," ").replace(/\'/g,'"')},getHTML:function(a,b){a=f({},a);var c='<object width="'+
a.width+'" height="'+a.height+'" id="'+a.id+'" name="'+a.id+'"';if(a.cachebusting)a.src+=(a.src.indexOf("?")!=-1?"&":"?")+Math.random();c+=a.w3c||!h?' data="'+a.src+'" type="application/x-shockwave-flash"':' classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"';c+=">";if(a.w3c||h)c+='<param name="movie" value="'+a.src+'" />';a.width=a.height=a.id=a.w3c=a.src=null;a.onFail=a.version=a.expressInstall=null;for(var d in a)if(a[d])c+='<param name="'+d+'" value="'+a[d]+'" />';a="";if(b){for(var j in b)if(b[j]){d=
b[j];a+=j+"="+(/function|object/.test(typeof d)?e.asString(d):d)+"&"}a=a.slice(0,-1);c+='<param name="flashvars" value=\''+a+"' />"}c+="</object>";return c},isSupported:function(a){return g[0]>a[0]||g[0]==a[0]&&g[1]>=a[1]}}),g=e.getVersion();if(n){jQuery.tools=jQuery.tools||{version:"1.2.3"};jQuery.tools.flashembed={conf:i};jQuery.fn.flashembed=function(a,b){return this.each(function(){$(this).data("flashembed",flashembed(this,a,b))})}}})();
(function(b){function h(c){if(c){var a=d.contentWindow.document;a.open().close();a.location.hash=c}}var g,d,f,i;b.tools=b.tools||{version:"1.2.3"};b.tools.history={init:function(c){if(!i){if(b.browser.msie&&b.browser.version<"8"){if(!d){d=b("<iframe/>").attr("src","javascript:false;").hide().get(0);b("body").append(d);setInterval(function(){var a=d.contentWindow.document;a=a.location.hash;g!==a&&b.event.trigger("hash",a)},100);h(location.hash||"#")}}else setInterval(function(){var a=location.hash;
a!==g&&b.event.trigger("hash",a)},100);f=!f?c:f.add(c);c.click(function(a){var e=b(this).attr("href");d&&h(e);if(e.slice(0,1)!="#"){location.href="#"+e;return a.preventDefault()}});i=true}}};b(window).bind("hash",function(c,a){a?f.filter(function(){var e=b(this).attr("href");return e==a||e==a.replace("#","")}).trigger("history",[a]):f.eq(0).trigger("history",[a]);g=a;window.location.hash=g});b.fn.history=function(c){b.tools.history.init(this);return this.bind("history",c)}})(jQuery);
(function(b){function k(){if(b.browser.msie){var a=b(document).height(),d=b(window).height();return[window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a-d<20?d:a]}return[b(document).width(),b(document).height()]}function h(a){if(a)return a.call(b.mask)}b.tools=b.tools||{version:"1.2.3"};var l;l=b.tools.expose={conf:{maskId:"exposeMask",loadSpeed:"slow",closeSpeed:"fast",closeOnClick:true,closeOnEsc:true,zIndex:9998,opacity:0.8,startOpacity:0,color:"#fff",onLoad:null,
onClose:null}};var c,i,f,g,j;b.mask={load:function(a,d){if(f)return this;if(typeof a=="string")a={color:a};a=a||g;g=a=b.extend(b.extend({},l.conf),a);c=b("#"+a.maskId);if(!c.length){c=b("<div/>").attr("id",a.maskId);b("body").append(c)}var m=k();c.css({position:"absolute",top:0,left:0,width:m[0],height:m[1],display:"none",opacity:a.startOpacity,zIndex:a.zIndex});a.color&&c.css("backgroundColor",a.color);if(h(a.onBeforeLoad)===false)return this;a.closeOnEsc&&b(document).bind("keydown.mask",function(e){e.keyCode==
27&&b.mask.close(e)});a.closeOnClick&&c.bind("click.mask",function(e){b.mask.close(e)});b(window).bind("resize.mask",function(){b.mask.fit()});if(d&&d.length){j=d.eq(0).css("zIndex");b.each(d,function(){var e=b(this);/relative|absolute|fixed/i.test(e.css("position"))||e.css("position","relative")});i=d.css({zIndex:Math.max(a.zIndex+1,j=="auto"?0:j)})}c.css({display:"block"}).fadeTo(a.loadSpeed,a.opacity,function(){b.mask.fit();h(a.onLoad)});f=true;return this},close:function(){if(f){if(h(g.onBeforeClose)===
false)return this;c.fadeOut(g.closeSpeed,function(){h(g.onClose);i&&i.css({zIndex:j})});b(document).unbind("keydown.mask");c.unbind("click.mask");b(window).unbind("resize.mask");f=false}return this},fit:function(){if(f){var a=k();c.css({width:a[0],height:a[1]})}},getMask:function(){return c},isLoaded:function(){return f},getConf:function(){return g},getExposed:function(){return i}};b.fn.mask=function(a){b.mask.load(a);return this};b.fn.expose=function(a){b.mask.load(a,this);return this}})(jQuery);
(function(b){function c(a){switch(a.type){case "mousemove":return b.extend(a.data,{clientX:a.clientX,clientY:a.clientY,pageX:a.pageX,pageY:a.pageY});case "DOMMouseScroll":b.extend(a,a.data);a.delta=-a.detail/3;break;case "mousewheel":a.delta=a.wheelDelta/120;break}a.type="wheel";return b.event.handle.call(this,a,a.delta)}b.fn.mousewheel=function(a){return this[a?"bind":"trigger"]("wheel",a)};b.event.special.wheel={setup:function(){b.event.add(this,d,c,{})},teardown:function(){b.event.remove(this,
d,c)}};var d=!b.browser.mozilla?"mousewheel":"DOMMouseScroll"+(b.browser.version<"1.9"?" mousemove":"")})(jQuery);

/*
 * jQuery BBQ: Back Button & Query Library - v1.2.1 - 2/17/2010
 * http://benalman.com/projects/jquery-bbq-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($,p){var i,m=Array.prototype.slice,r=decodeURIComponent,a=$.param,c,l,v,b=$.bbq=$.bbq||{},q,u,j,e=$.event.special,d="hashchange",A="querystring",D="fragment",y="elemUrlAttr",g="location",k="href",t="src",x=/^.*\?|#.*$/g,w=/^.*\#/,h,C={};function E(F){return typeof F==="string"}function B(G){var F=m.call(arguments,1);return function(){return G.apply(this,F.concat(m.call(arguments)))}}function n(F){return F.replace(/^[^#]*#?(.*)$/,"$1")}function o(F){return F.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function f(H,M,F,I,G){var O,L,K,N,J;if(I!==i){K=F.match(H?/^([^#]*)\#?(.*)$/:/^([^#?]*)\??([^#]*)(#?.*)/);J=K[3]||"";if(G===2&&E(I)){L=I.replace(H?w:x,"")}else{N=l(K[2]);I=E(I)?l[H?D:A](I):I;L=G===2?I:G===1?$.extend({},I,N):$.extend({},N,I);L=a(L);if(H){L=L.replace(h,r)}}O=K[1]+(H?"#":L||!K[1]?"?":"")+L+J}else{O=M(F!==i?F:p[g][k])}return O}a[A]=B(f,0,o);a[D]=c=B(f,1,n);c.noEscape=function(G){G=G||"";var F=$.map(G.split(""),encodeURIComponent);h=new RegExp(F.join("|"),"g")};c.noEscape(",/");$.deparam=l=function(I,F){var H={},G={"true":!0,"false":!1,"null":null};$.each(I.replace(/\+/g," ").split("&"),function(L,Q){var K=Q.split("="),P=r(K[0]),J,O=H,M=0,R=P.split("]["),N=R.length-1;if(/\[/.test(R[0])&&/\]$/.test(R[N])){R[N]=R[N].replace(/\]$/,"");R=R.shift().split("[").concat(R);N=R.length-1}else{N=0}if(K.length===2){J=r(K[1]);if(F){J=J&&!isNaN(J)?+J:J==="undefined"?i:G[J]!==i?G[J]:J}if(N){for(;M<=N;M++){P=R[M]===""?O.length:R[M];O=O[P]=M<N?O[P]||(R[M+1]&&isNaN(R[M+1])?{}:[]):J}}else{if($.isArray(H[P])){H[P].push(J)}else{if(H[P]!==i){H[P]=[H[P],J]}else{H[P]=J}}}}else{if(P){H[P]=F?i:""}}});return H};function z(H,F,G){if(F===i||typeof F==="boolean"){G=F;F=a[H?D:A]()}else{F=E(F)?F.replace(H?w:x,""):F}return l(F,G)}l[A]=B(z,0);l[D]=v=B(z,1);$[y]||($[y]=function(F){return $.extend(C,F)})({a:k,base:k,iframe:t,img:t,input:t,form:"action",link:k,script:t});j=$[y];function s(I,G,H,F){if(!E(H)&&typeof H!=="object"){F=H;H=G;G=i}return this.each(function(){var L=$(this),J=G||j()[(this.nodeName||"").toLowerCase()]||"",K=J&&L.attr(J)||"";L.attr(J,a[I](K,H,F))})}$.fn[A]=B(s,A);$.fn[D]=B(s,D);b.pushState=q=function(I,F){if(E(I)&&/^#/.test(I)&&F===i){F=2}var H=I!==i,G=c(p[g][k],H?I:{},H?F:2);p[g][k]=G+(/#/.test(G)?"":"#")};b.getState=u=function(F,G){return F===i||typeof F==="boolean"?v(F):v(G)[F]};b.removeState=function(F){var G={};if(F!==i){G=u();$.each($.isArray(F)?F:arguments,function(I,H){delete G[H]})}q(G,2)};e[d]=$.extend(e[d],{add:function(F){var H;function G(J){var I=J[D]=c();J.getState=function(K,L){return K===i||typeof K==="boolean"?l(I,K):l(I,L)[K]};H.apply(this,arguments)}if($.isFunction(F)){H=F;return G}else{H=F.handler;F.handler=G}}})})(jQuery,this);
/*
 * jQuery hashchange event - v1.2 - 2/11/2010
 * http://benalman.com/projects/jquery-hashchange-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($,i,b){var j,k=$.event.special,c="location",d="hashchange",l="href",f=$.browser,g=document.documentMode,h=f.msie&&(g===b||g<8),e="on"+d in i&&!h;function a(m){m=m||i[c][l];return m.replace(/^[^#]*#?(.*)$/,"$1")}$[d+"Delay"]=100;k[d]=$.extend(k[d],{setup:function(){if(e){return false}$(j.start)},teardown:function(){if(e){return false}$(j.stop)}});j=(function(){var m={},r,n,o,q;function p(){o=q=function(s){return s};if(h){n=$('<iframe src="javascript:0"/>').hide().insertAfter("body")[0].contentWindow;q=function(){return a(n.document[c][l])};o=function(u,s){if(u!==s){var t=n.document;t.open().close();t[c].hash="#"+u}};o(a())}}m.start=function(){if(r){return}var t=a();o||p();(function s(){var v=a(),u=q(t);if(v!==t){o(t=v,u);$(i).trigger(d)}else{if(u!==t){i[c][l]=i[c][l].replace(/#.*/,"")+"#"+u}}r=setTimeout(s,$[d+"Delay"])})()};m.stop=function(){if(!n){r&&clearTimeout(r);r=0}};return m})()})(jQuery,this);
(function($){$.Jcrop=function(obj,opt){var obj=obj,opt=opt;if(typeof(obj)!=='object')obj=$(obj)[0];if(typeof(opt)!=='object')opt={};if(!('trackDocument'in opt)){opt.trackDocument=$.browser.msie?false:true;if($.browser.msie&&$.browser.version.split('.')[0]=='8')opt.trackDocument=true;}if(!('keySupport'in opt))opt.keySupport=$.browser.msie?false:true;var defaults={trackDocument:false,baseClass:'jcrop',addClass:null,bgColor:'black',bgOpacity:.6,borderOpacity:.4,handleOpacity:.5,handlePad:5,handleSize:9,handleOffset:5,edgeMargin:14,aspectRatio:0,keySupport:true,cornerHandles:true,sideHandles:true,drawBorders:true,dragEdges:true,boxWidth:0,boxHeight:0,boundary:8,animationDelay:20,swingSpeed:3,allowSelect:true,allowMove:true,allowResize:true,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){}};var options=defaults;setOptions(opt);var $origimg=$(obj);var $img=$origimg.clone().removeAttr('id').css({position:'absolute'});$img.width($origimg.width());$img.height($origimg.height());$origimg.after($img).hide();presize($img,options.boxWidth,options.boxHeight);var boundx=$img.width(),boundy=$img.height(),$div=$('<div />').width(boundx).height(boundy).addClass(cssClass('holder')).css({position:'relative',backgroundColor:options.bgColor}).insertAfter($origimg).append($img);;if(options.addClass)$div.addClass(options.addClass);var $img2=$('<img />').attr('src',$img.attr('src')).css('position','absolute').width(boundx).height(boundy);var $img_holder=$('<div />').width(pct(100)).height(pct(100)).css({zIndex:310,position:'absolute',overflow:'hidden'}).append($img2);var $hdl_holder=$('<div />').width(pct(100)).height(pct(100)).css('zIndex',320);var $sel=$('<div />').css({position:'absolute',zIndex:300}).insertBefore($img).append($img_holder,$hdl_holder);var bound=options.boundary;var $trk=newTracker().width(boundx+(bound*2)).height(boundy+(bound*2)).css({position:'absolute',top:px(-bound),left:px(-bound),zIndex:290}).mousedown(newSelection);var xlimit,ylimit,xmin,ymin;var xscale,yscale,enabled=true;var docOffset=getPos($img),btndown,lastcurs,dimmed,animating,shift_down;var Coords=function(){var x1=0,y1=0,x2=0,y2=0,ox,oy;function setPressed(pos){var pos=rebound(pos);x2=x1=pos[0];y2=y1=pos[1];};function setCurrent(pos){var pos=rebound(pos);ox=pos[0]-x2;oy=pos[1]-y2;x2=pos[0];y2=pos[1];};function getOffset(){return[ox,oy];};function moveOffset(offset){var ox=offset[0],oy=offset[1];if(0>x1+ox)ox-=ox+x1;if(0>y1+oy)oy-=oy+y1;if(boundy<y2+oy)oy+=boundy-(y2+oy);if(boundx<x2+ox)ox+=boundx-(x2+ox);x1+=ox;x2+=ox;y1+=oy;y2+=oy;};function getCorner(ord){var c=getFixed();switch(ord){case'ne':return[c.x2,c.y];case'nw':return[c.x,c.y];case'se':return[c.x2,c.y2];case'sw':return[c.x,c.y2];}};function getFixed(){if(!options.aspectRatio)return getRect();var aspect=options.aspectRatio,min_x=options.minSize[0]/xscale,min_y=options.minSize[1]/yscale,max_x=options.maxSize[0]/xscale,max_y=options.maxSize[1]/yscale,rw=x2-x1,rh=y2-y1,rwa=Math.abs(rw),rha=Math.abs(rh),real_ratio=rwa/rha,xx,yy;if(max_x==0){max_x=boundx*10}if(max_y==0){max_y=boundy*10}if(real_ratio<aspect){yy=y2;w=rha*aspect;xx=rw<0?x1-w:w+x1;if(xx<0){xx=0;h=Math.abs((xx-x1)/aspect);yy=rh<0?y1-h:h+y1;}
else if(xx>boundx){xx=boundx;h=Math.abs((xx-x1)/aspect);yy=rh<0?y1-h:h+y1;}}else{xx=x2;h=rwa/aspect;yy=rh<0?y1-h:y1+h;if(yy<0){yy=0;w=Math.abs((yy-y1)*aspect);xx=rw<0?x1-w:w+x1;}else if(yy>boundy){yy=boundy;w=Math.abs(yy-y1)*aspect;xx=rw<0?x1-w:w+x1;}}if(xx>x1){if(xx-x1<min_x){xx=x1+min_x;}else if(xx-x1>max_x){xx=x1+max_x;}if(yy>y1){yy=y1+(xx-x1)/aspect;}else{yy=y1-(xx-x1)/aspect;}}else if(xx<x1){if(x1-xx<min_x){xx=x1-min_x}else if(x1-xx>max_x){xx=x1-max_x;}if(yy>y1){yy=y1+(x1-xx)/aspect;}else{yy=y1-(x1-xx)/aspect;}}if(xx<0){x1-=xx;xx=0;}else if(xx>boundx){x1-=xx-boundx;xx=boundx;}if(yy<0){y1-=yy;yy=0;}else if(yy>boundy){y1-=yy-boundy;yy=boundy;}return last=makeObj(flipCoords(x1,y1,xx,yy));};function rebound(p){if(p[0]<0)p[0]=0;if(p[1]<0)p[1]=0;if(p[0]>boundx)p[0]=boundx;if(p[1]>boundy)p[1]=boundy;return[p[0],p[1]];};function flipCoords(x1,y1,x2,y2){var xa=x1,xb=x2,ya=y1,yb=y2;if(x2<x1){xa=x2;xb=x1;}if(y2<y1){ya=y2;yb=y1;}return[Math.round(xa),Math.round(ya),Math.round(xb),Math.round(yb)];};function getRect(){var xsize=x2-x1;var ysize=y2-y1;if(xlimit&&(Math.abs(xsize)>xlimit))x2=(xsize>0)?(x1+xlimit):(x1-xlimit);if(ylimit&&(Math.abs(ysize)>ylimit))y2=(ysize>0)?(y1+ylimit):(y1-ylimit);if(ymin&&(Math.abs(ysize)<ymin))y2=(ysize>0)?(y1+ymin):(y1-ymin);if(xmin&&(Math.abs(xsize)<xmin))x2=(xsize>0)?(x1+xmin):(x1-xmin);if(x1<0){x2-=x1;x1-=x1;}
if(y1<0){y2-=y1;y1-=y1;}if(x2<0){x1-=x2;x2-=x2;}if(y2<0){y1-=y2;y2-=y2;}if(x2>boundx){var delta=x2-boundx;x1-=delta;x2-=delta;}if(y2>boundy){var delta=y2-boundy;y1-=delta;y2-=delta;}if(x1>boundx){var delta=x1-boundy;y2-=delta;y1-=delta;}if(y1>boundy){var delta=y1-boundy;y2-=delta;y1-=delta;}return makeObj(flipCoords(x1,y1,x2,y2));};function makeObj(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]};};return{flipCoords:flipCoords,setPressed:setPressed,setCurrent:setCurrent,getOffset:getOffset,moveOffset:moveOffset,getCorner:getCorner,getFixed:getFixed};}();var Selection=function(){var start,end,dragmode,awake,hdep=370;var borders={};var handle={};var seehandles=false;var hhs=options.handleOffset;if(options.drawBorders){borders={top:insertBorder('hline').css('top',$.browser.msie?px(-1):px(0)),bottom:insertBorder('hline'),left:insertBorder('vline'),right:insertBorder('vline')};}if(options.dragEdges){handle.t=insertDragbar('n');handle.b=insertDragbar('s');handle.r=insertDragbar('e');handle.l=insertDragbar('w');}options.sideHandles&&createHandles(['n','s','e','w']);options.cornerHandles&&createHandles(['sw','nw','ne','se']);function insertBorder(type){var jq=$('<div />').css({position:'absolute',opacity:options.borderOpacity}).addClass(cssClass(type));$img_holder.append(jq);return jq;};function dragDiv(ord,zi){var jq=$('<div />').mousedown(createDragger(ord)).css({cursor:ord+'-resize',position:'absolute',zIndex:zi});$hdl_holder.append(jq);return jq;};function insertHandle(ord) {return dragDiv(ord,hdep++).css({top:px(-hhs+1),left:px(-hhs+1),opacity:options.handleOpacity}).addClass(cssClass('handle'));};function insertDragbar(ord){var s=options.handleSize,o=hhs,h=s,w=s,t=o,l=o;switch(ord) {case'n':case's':w=pct(100);break;case'e':case'w':h=pct(100);break;}return dragDiv(ord,hdep++).width(w).height(h).css({top:px(-t+1),left:px(-l+1)});};function createHandles(li){for(i in li)handle[li[i]]=insertHandle(li[i]);};function moveHandles(c){var midvert=Math.round((c.h/2)-hhs),midhoriz=Math.round((c.w/2)-hhs),north=west=-hhs+1,east=c.w-hhs,south=c.h-hhs,x,y;'e'in handle&&handle.e.css({top:px(midvert),left:px(east)})&&handle.w.css({top:px(midvert)})&&handle.s.css({top:px(south),left:px(midhoriz)})&&handle.n.css({left:px(midhoriz)});'ne'in handle&&handle.ne.css({left:px(east)})&&handle.se.css({top:px(south),left:px(east)})&&handle.sw.css({top:px(south)});'b'in handle&&handle.b.css({top:px(south)})&&handle.r.css({left:px(east)});};function moveto(x,y){$img2.css({top:px(-y),left:px(-x)});$sel.css({top:px(y),left:px(x)});};function resize(w,h){$sel.width(w).height(h);};function refresh(){var c=Coords.getFixed();Coords.setPressed([c.x,c.y]);Coords.setCurrent([c.x2,c.y2]);updateVisible();};function updateVisible(){if(awake)return update();};function update(){var c=Coords.getFixed();resize(c.w,c.h);moveto(c.x,c.y);options.drawBorders&&borders['right'].css({left:px(c.w-1)})&&borders['bottom'].css({top:px(c.h-1)});seehandles&&moveHandles(c);awake||show();options.onChange(unscale(c));};function show(){$sel.show();$img.css('opacity',options.bgOpacity);awake=true;};function release(){disableHandles();$sel.hide();$img.css('opacity',1);awake=false;};function showHandles() {if(seehandles){moveHandles(Coords.getFixed());$hdl_holder.show();}};function enableHandles(){seehandles=true;if(options.allowResize){moveHandles(Coords.getFixed());$hdl_holder.show();return true;}};function disableHandles(){seehandles=false;$hdl_holder.hide();};function animMode(v) {(animating=v)?disableHandles():enableHandles();};function done(){animMode(false);refresh();};var $track=newTracker().mousedown(createDragger('move')).css({cursor:'move',position:'absolute',zIndex:360});$img_holder.append($track);disableHandles();return{updateVisible:updateVisible,update:update,release:release,refresh:refresh,setCursor:function(cursor){$track.css('cursor',cursor);},enableHandles:enableHandles,enableOnly:function(){seehandles=true;},showHandles:showHandles,disableHandles:disableHandles,animMode:animMode,done:done};}();var Tracker=function() {var onMove=function(){},onDone=function(){},trackDoc=options.trackDocument;if(!trackDoc) {$trk.mousemove(trackMove).mouseup(trackUp).mouseout(trackUp);}
function toFront() {$trk.css({zIndex:450});if(trackDoc) {$(document).mousemove(trackMove).mouseup(trackUp);}}
function toBack() {$trk.css({zIndex:290});if(trackDoc) {$(document).unbind('mousemove',trackMove).unbind('mouseup',trackUp);}}
function trackMove(e) {onMove(mouseAbs(e));};function trackUp(e) {e.preventDefault();e.stopPropagation();if(btndown) {btndown=false;onDone(mouseAbs(e));options.onSelect(unscale(Coords.getFixed()));toBack();onMove=function(){};onDone=function(){};}
return false;};function activateHandlers(move,done) {btndown=true;onMove=move;onDone=done;toFront();return false;};function setCursor(t){$trk.css('cursor',t);};$img.before($trk);return{activateHandlers:activateHandlers,setCursor:setCursor};}();var KeyManager=function() {var $keymgr=$('<input type="radio" />').css({position:'absolute',left:'-30px'}).keypress(parseKey).blur(onBlur),$keywrap=$('<div />').css({position:'absolute',overflow:'hidden'}).append($keymgr);function watchKeys() {if(options.keySupport) {$keymgr.show();$keymgr.focus();}};function onBlur(e) {$keymgr.hide();};function doNudge(e,x,y) {if(options.allowMove){Coords.moveOffset([x,y]);Selection.updateVisible();};e.preventDefault();e.stopPropagation();};function parseKey(e) {if(e.ctrlKey)return true;shift_down=e.shiftKey?true:false;var nudge=shift_down?10:1;switch(e.keyCode) {case 37:doNudge(e,-nudge,0);break;case 39:doNudge(e,nudge,0);break;case 38:doNudge(e,0,-nudge);break;case 40:doNudge(e,0,nudge);break;case 27:Selection.release();break;case 9:return true;}
return nothing(e);};if(options.keySupport)$keywrap.insertBefore($img);return{watchKeys:watchKeys};}();function px(n){return''+parseInt(n)+'px';};function pct(n){return''+parseInt(n)+'%';};function cssClass(cl){return options.baseClass+'-'+cl;};function getPos(obj) {var pos=$(obj).offset();return[pos.left,pos.top];};function mouseAbs(e) {return[(e.pageX-docOffset[0]),(e.pageY-docOffset[1])];};function myCursor(type) {if(type!=lastcurs) {Tracker.setCursor(type);lastcurs=type;}};function startDragMode(mode,pos) {docOffset=getPos($img);Tracker.setCursor(mode=='move'?mode:mode+'-resize');if(mode=='move')
return Tracker.activateHandlers(createMover(pos),doneSelect);var fc=Coords.getFixed();var opp=oppLockCorner(mode);var opc=Coords.getCorner(oppLockCorner(opp));Coords.setPressed(Coords.getCorner(opp));Coords.setCurrent(opc);Tracker.activateHandlers(dragmodeHandler(mode,fc),doneSelect);};function dragmodeHandler(mode,f) {return function(pos){if(!options.aspectRatio)switch(mode) {case'e':pos[1]=f.y2;break;case'w':pos[1]=f.y2;break;case'n':pos[0]=f.x2;break;case's':pos[0]=f.x2;break;}
else switch(mode) {case'e':pos[1]=f.y+1;break;case'w':pos[1]=f.y+1;break;case'n':pos[0]=f.x+1;break;case's':pos[0]=f.x+1;break;}
Coords.setCurrent(pos);Selection.update();};};function createMover(pos) {var lloc=pos;KeyManager.watchKeys();return function(pos) {Coords.moveOffset([pos[0]-lloc[0],pos[1]-lloc[1]]);lloc=pos;Selection.update();};};function oppLockCorner(ord) {switch(ord) {case'n':return'sw';case's':return'nw';case'e':return'nw';case'w':return'ne';case'ne':return'sw';case'nw':return'se';case'se':return'nw';case'sw':return'ne';};};function createDragger(ord) {return function(e){if(options.disabled)return false;if((ord=='move')&&!options.allowMove)return false;btndown=true;startDragMode(ord,mouseAbs(e));e.stopPropagation();e.preventDefault();return false;};};function presize($obj,w,h) {var nw=$obj.width(),nh=$obj.height();if((nw>w)&&w>0) {nw=w;nh=(w/$obj.width())*$obj.height();}
if((nh>h)&&h>0) {nh=h;nw=(h/$obj.height())*$obj.width();}
xscale=$obj.width()/nw;yscale=$obj.height()/nh;$obj.width(nw).height(nh);};function unscale(c) {return{x:parseInt(c.x*xscale),y:parseInt(c.y*yscale),x2:parseInt(c.x2*xscale),y2:parseInt(c.y2*yscale),w:parseInt(c.w*xscale),h:parseInt(c.h*yscale)};};function doneSelect(pos) {var c=Coords.getFixed();if(c.w>options.minSelect[0]&&c.h>options.minSelect[1]) {Selection.enableHandles();Selection.done();}
else {Selection.release();}
Tracker.setCursor(options.allowSelect?'crosshair':'default');};function newSelection(e) {if(options.disabled)return false;if(!options.allowSelect)return false;btndown=true;docOffset=getPos($img);Selection.disableHandles();myCursor('crosshair');var pos=mouseAbs(e);Coords.setPressed(pos);Tracker.activateHandlers(selectDrag,doneSelect);KeyManager.watchKeys();Selection.update();e.stopPropagation();e.preventDefault();return false;};function selectDrag(pos) {Coords.setCurrent(pos);Selection.update();};function newTracker() {var trk=$('<div></div>').addClass(cssClass('tracker'));$.browser.msie&&trk.css({opacity:0,backgroundColor:'white'});return trk;};function animateTo(a) {var x1=a[0]/xscale,y1=a[1]/yscale,x2=a[2]/xscale,y2=a[3]/yscale;if(animating)return;var animto=Coords.flipCoords(x1,y1,x2,y2);var c=Coords.getFixed();var animat=initcr=[c.x,c.y,c.x2,c.y2];var interv=options.animationDelay;var x=animat[0];var y=animat[1];var x2=animat[2];var y2=animat[3];var ix1=animto[0]-initcr[0];var iy1=animto[1]-initcr[1];var ix2=animto[2]-initcr[2];var iy2=animto[3]-initcr[3];var pcent=0;var velocity=options.swingSpeed;Selection.animMode(true);var animator=function() {return function() {pcent+=(100-pcent)/velocity;animat[0]=x+((pcent/100)*ix1);animat[1]=y+((pcent/100)*iy1);animat[2]=x2+((pcent/100)*ix2);animat[3]=y2+((pcent/100)*iy2);if(pcent<100)animateStart();else Selection.done();if(pcent>=99.8)pcent=100;setSelectRaw(animat);};}();function animateStart() {window.setTimeout(animator,interv);};animateStart();};function setSelect(rect) {setSelectRaw([rect[0]/xscale,rect[1]/yscale,rect[2]/xscale,rect[3]/yscale]);};function setSelectRaw(l) {Coords.setPressed([l[0],l[1]]);Coords.setCurrent([l[2],l[3]]);Selection.update();};function setOptions(opt) {if(typeof(opt)!='object')opt={};options=$.extend(options,opt);if(typeof(options.onChange)!=='function')
options.onChange=function(){};if(typeof(options.onSelect)!=='function')
options.onSelect=function(){};};function tellSelect() {return unscale(Coords.getFixed());};function tellScaled() {return Coords.getFixed();};function setOptionsNew(opt) {setOptions(opt);interfaceUpdate();};function disableCrop() {options.disabled=true;Selection.disableHandles();Selection.setCursor('default');Tracker.setCursor('default');};function enableCrop() {options.disabled=false;interfaceUpdate();};function cancelCrop() {Selection.done();Tracker.activateHandlers(null,null);};function destroy() {$div.remove();$origimg.show();};function interfaceUpdate(alt) {options.allowResize?alt?Selection.enableOnly():Selection.enableHandles():Selection.disableHandles();Tracker.setCursor(options.allowSelect?'crosshair':'default');Selection.setCursor(options.allowMove?'move':'default');$div.css('backgroundColor',options.bgColor);if('setSelect'in options){setSelect(opt.setSelect);Selection.done();delete(options.setSelect);}
if('trueSize'in options){xscale=options.trueSize[0]/boundx;yscale=options.trueSize[1]/boundy;}
xlimit=options.maxSize[0]||0;ylimit=options.maxSize[1]||0;xmin=options.minSize[0]||0;ymin=options.minSize[1]||0;if('outerImage'in options) {$img.attr('src',options.outerImage);delete(options.outerImage);}
Selection.refresh();};$hdl_holder.hide();interfaceUpdate(true);var api={animateTo:animateTo,setSelect:setSelect,setOptions:setOptionsNew,tellSelect:tellSelect,tellScaled:tellScaled,disable:disableCrop,enable:enableCrop,cancel:cancelCrop,focus:KeyManager.watchKeys,getBounds:function(){return[boundx*xscale,boundy*yscale];},getWidgetSize:function(){return[boundx,boundy];},release:Selection.release,destroy:destroy};$origimg.data('Jcrop',api);return api;};$.fn.Jcrop=function(options) {function attachWhenDone(from) {var loadsrc=options.useImg||from.src;var img=new Image();img.onload=function(){$.Jcrop(from,options);};img.src=loadsrc;};if(typeof(options)!=='object')options={};this.each(function() {if($(this).data('Jcrop')) {if(options=='api')return $(this).data('Jcrop');else $(this).data('Jcrop').setOptions(options);}
else attachWhenDone(this);});return this;};})(jQuery);
(function($,e,b){var c="hashchange",h=document,f,g=$.event.special,i=h.documentMode,d="on"+c in e&&(i===b||i>7);function a(j){j=j||location.href;return"#"+j.replace(/^[^#]*#?(.*)$/,"$1")}$.fn[c]=function(j){return j?this.bind(c,j):this.trigger(c)};$.fn[c].delay=50;g[c]=$.extend(g[c],{setup:function(){if(d){return false}$(f.start)},teardown:function(){if(d){return false}$(f.stop)}});f=(function(){var j={},p,m=a(),k=function(q){return q},l=k,o=k;j.start=function(){p||n()};j.stop=function(){p&&clearTimeout(p);p=b};function n(){var r=a(),q=o(m);if(r!==m){l(m=r,q);$(e).trigger(c)}else{if(q!==m){location.href=location.href.replace(/#.*/,"")+q}}p=setTimeout(n,$.fn[c].delay)}$.browser.msie&&!d&&(function(){var q,r;j.start=function(){if(!q){r=$.fn[c].src;r=r&&r+a();q=$('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){r||l(a());n()}).attr("src",r||"javascript:0").insertAfter("body")[0].contentWindow;h.onpropertychange=function(){try{if(event.propertyName==="title"){q.document.title=h.title}}catch(s){}}}};j.stop=k;o=function(){return a(q.location.href)};l=function(v,s){var u=q.document,t=$.fn[c].domain;if(v!==s){u.title=h.title;u.open();t&&u.write('<script>document.domain="'+t+'"<\/script>');u.close();q.location.hash=v}}})();return j})()})(jQuery,this);
(function(a){a.placeHeld=function(c,b){var d=this;d.$el=a(c);d.el=c;d.$el.data("placeHeld",d);d.placeholderText=d.$el.attr("placeholder");d.init=function(){d.options=a.extend({},a.placeHeld.defaultOptions,b);d.$el.bind("blur",d.holdPlace).bind("focus",d.releasePlace).trigger("blur");d.$el.parents("form").bind("submit",d.clearPlace)};d.holdPlace=function(){var e=d.$el.val();if(!e){d.$el.val(d.placeholderText).addClass(d.options.className)}};d.releasePlace=function(){var e=d.$el.val();if(e==d.placeholderText){d.$el.val("").removeClass(d.options.className)}};d.clearPlace=function(){var e=d.$el.val();if(e==d.placeholderText&&d.$el.hasClass(d.options.className)){d.$el.val("")}};d.init()};a.placeHeld.defaultOptions={className:"placeheld"};a.fn.placeHeld=function(b){if(!!("placeholder" in a("<input>")[0])){return}return this.each(function(){(new a.placeHeld(this,b))})}})(jQuery);
(function(a){a.fn.endlessScroll=function(c){var f={bottomPixels:50,fireOnce:true,fireDelay:150,loader:"<br />Loading...<br />",data:"",insertAfter:"div:last",resetCounter:function(){return false},callback:function(){return true},ceaseFire:function(){return false}};var c=a.extend(f,c);var d=true;var e=false;var b=0;if(c.ceaseFire.apply(this)===true){d=false}if(d===true){a(this).scroll(function(){var h=a(".endless_scroll_inner_wrap",this);if(h.length==0){a(this).wrapInner('<div class="endless_scroll_inner_wrap" />')}if(h.length>0&&(h.height()-a(this).height()<=a(this).scrollTop()+c.bottomPixels)){if((c.fireOnce==false||(c.fireOnce==true&&e!=true))){if(c.resetCounter.apply(this)===true){b=0}e=true;b++;a(c.insertAfter).after('<div id="endless_scroll_loader">'+c.loader+"</div>");if(typeof c.data=="function"){data=c.data.apply(this)}else{data=c.data}if(data!==false){a("div#endless_scroll_loader").remove();a(c.insertAfter).after('<div id="endless_scroll_data">'+data+"</div>");a("div#endless_scroll_data").hide().fadeIn();a("div#endless_scroll_data").removeAttr("id");var g=new Array();g[0]=b;c.callback.apply(this,g);if(c.fireDelay!==false||c.fireDelay!==0){a("body").after('<div id="endless_scroll_marker"></div>');a("div#endless_scroll_marker").fadeTo(c.fireDelay,1,function(){a(this).remove();e=false})}else{e=false}}}}})}}})(jQuery);
if(typeof YUI==='undefined'){var YUI=function(){var Y=this,a=arguments,i,l=a.length,globalConfig=(typeof YUI_config!=='undefined')&&YUI_config;if(!(Y instanceof YUI)){Y=new YUI();for(i=0;i<l;i++){Y._config(a[i])}return Y}else{Y._init();if(globalConfig){Y._config(globalConfig)}for(i=0;i<l;i++){Y._config(a[i])}Y._setup();return Y}}}(function(){var p,prop,VERSION='3.1.1',BASE='http://yui.yahooapis.com/',DOC_LABEL='yui3-js-enabled',NOOP=function(){},SLICE=Array.prototype.slice,APPLY_TO_AUTH={'io.xdrReady':1,'io.xdrResponse':1,'SWF.eventHandler':1},hasWin=(typeof window!='undefined'),win=(hasWin)?window:null,doc=(hasWin)?win.document:null,docEl=doc&&doc.documentElement,docClass=docEl&&docEl.className,instances={},time=new Date().getTime(),add=function(a,b,c,d){if(a&&a.addEventListener){a.addEventListener(b,c,d)}else if(a&&a.attachEvent){a.attachEvent("on"+b,c)}},remove=function(a,b,c,d){if(a&&a.removeEventListener){try{a.removeEventListener(b,c,d)}catch(ex){}}else if(a&&a.detachEvent){a.detachEvent("on"+b,c)}},handleLoad=function(){YUI.Env.windowLoaded=true;YUI.Env.DOMReady=true;if(hasWin){remove(window,'load',handleLoad)}};if(docEl&&docClass.indexOf(DOC_LABEL)==-1){if(docClass){docClass+=' '}docClass+=DOC_LABEL;docEl.className=docClass}if(VERSION.indexOf('@')>-1){VERSION='3.0.0'}YUI.prototype={_config:function(o){o=o||{};var a,name,detail,config=this.config,mods=config.modules,groups=config.groups;for(name in o){a=o[name];if(mods&&name=='modules'){for(detail in a){mods[detail]=a[detail]}}else if(groups&&name=='groups'){for(detail in a){groups[detail]=a[detail]}}else if(name=='win'){config[name]=a.contentWindow||a;config.doc=config[name].document}else{config[name]=a}}},_init:function(){var d,Y=this,G_ENV=YUI.Env,Env=Y.Env;Y.version=VERSION;if(!Env){Y.Env={mods:{},base:BASE,cdn:BASE+VERSION+'/build/',bootstrapped:false,_idx:0,_used:{},_attached:{},_yidx:0,_uidx:0,_guidp:'y',_loaded:{},getBase:function(a,c){var b,nodes,i,src,match;nodes=(doc&&doc.getElementsByTagName('script'))||[];for(i=0;i<nodes.length;i=i+1){src=nodes[i].src;if(src){match=src.match(a);b=match&&match[1];if(b){d=match[2];match=src.match(c);if(match&&match[3]){b=match[1]+match[3]}break}}}return b||Env.cdn}};Env=Y.Env;Env._loaded[VERSION]={};if(G_ENV&&Y!==YUI){Env._yidx=++G_ENV._yidx;Env._guidp=('yui_'+VERSION+'_'+Env._yidx+'_'+time).replace(/\./g,'_')}Y.id=Y.stamp(Y);instances[Y.id]=Y}Y.constructor=YUI;Y.config=Y.config||{win:win,doc:doc,debug:true,useBrowserConsole:true,throwFail:true,bootstrap:true,fetchCSS:true};Y.config.base=YUI.config.base||Y.Env.getBase(/^(.*)yui\/yui([\.\-].*)js(\?.*)?$/,/^(.*\?)(.*\&)(.*)yui\/yui[\.\-].*js(\?.*)?$/);Y.config.loaderPath=YUI.config.loaderPath||'loader/loader'+(d||'-min.')+'js'},_setup:function(o){var i,Y=this,core=[],mods=YUI.Env.mods,extras=Y.config.core||['get','intl-base','loader','yui-log','yui-later','yui-throttle'];for(i=0;i<extras.length;i++){if(mods[extras[i]]){core.push(extras[i])}}Y.use('yui-base');Y.use.apply(Y,core)},applyTo:function(a,b,c){if(!(b in APPLY_TO_AUTH)){this.log(b+': applyTo not allowed','warn','yui');return null}var d=instances[a],nest,m,i;if(d){nest=b.split('.');m=d;for(i=0;i<nest.length;i=i+1){m=m[nest[i]];if(!m){this.log('applyTo not found: '+b,'warn','yui')}}return m.apply(d,c)}return null},add:function(a,b,c,d){d=d||{};YUI.Env.mods[a]={name:a,fn:b,version:c,details:d};return this},_attach:function(r,a){var i,name,mod,details,req,use,mods=YUI.Env.mods,done=this.Env._attached,len=r.length;for(i=0;i<len;i++){name=r[i];mod=mods[name];if(!done[name]&&mod){done[name]=true;details=mod.details;req=details.requires;use=details.use;if(req&&req.length){this._attach(this.Array(req))}if(mod.fn){mod.fn(this,name)}if(use&&use.length){this._attach(this.Array(use))}}}},use:function(){if(!this.Array){this._attach(['yui-base'])}var c,loader,handleBoot,Y=this,G_ENV=YUI.Env,args=SLICE.call(arguments,0),mods=G_ENV.mods,Env=Y.Env,used=Env._used,queue=G_ENV._loaderQueue,firstArg=args[0],callback=args[args.length-1],YArray=Y.Array,config=Y.config,boot=config.bootstrap,missing=[],r=[],fetchCSS=config.fetchCSS,process=function(a){r.push(a);if(used[a]){return}var m=mods[a],req,use;if(m){used[a]=true;req=m.details.requires;use=m.details.use}else{if(!G_ENV._loaded[VERSION][a]){missing.push(a)}else{used[a]=true}}if(req){YArray.each(YArray(req),process)}if(use){YArray.each(YArray(use),process)}},handleLoader=function(a){var b=a||{success:true,msg:'not dynamic'},newData,redo,origMissing,data=b.data;Y._loading=false;if(data){origMissing=missing.concat();missing=[];Y.Array.each(data,process);redo=missing.length;if(redo){if(missing.sort().join()==origMissing.sort().join()){redo=false}}}if(redo&&data){newData=data.concat();newData.push(function(){Y._attach(data);if(callback){callback(Y,b)}});Y._loading=false;Y.use.apply(Y,newData)}else{if(data){Y._attach(data)}if(callback){callback(Y,b)}}if(Y._useQueue&&Y._useQueue.size()&&!Y._loading){Y.use.apply(Y,Y._useQueue.next())}};if(Y._loading){Y._useQueue=Y._useQueue||new Y.Queue();Y._useQueue.add(args);return Y}if(typeof callback==='function'){args.pop()}else{callback=null}if(firstArg==="*"){args=Y.Object.keys(mods)}if(Y.Loader){loader=new Y.Loader(config);loader.require(args);loader.ignoreRegistered=true;loader.calculate(null,(fetchCSS)?null:'js');args=loader.sorted}YArray.each(args,process);c=missing.length;if(c){missing=Y.Object.keys(YArray.hash(missing));c=missing.length}if(boot&&c&&Y.Loader){Y._loading=true;loader=new Y.Loader(config);loader.onEnd=handleLoader;loader.context=Y;loader.attaching=args;loader.data=args;loader.require((fetchCSS)?missing:args);loader.insert(null,(fetchCSS)?null:'js')}else if(boot&&c&&Y.Get&&!Env.bootstrapped){Y._loading=true;args=YArray(arguments,0,true);handleBoot=function(){Y._loading=false;queue.running=false;Env.bootstrapped=true;Y._attach(['loader']);Y.use.apply(Y,args)};if(G_ENV._bootstrapping){queue.add(handleBoot)}else{G_ENV._bootstrapping=true;Y.Get.script(config.base+config.loaderPath,{onEnd:handleBoot})}}else{if(c){Y.message('Requirement NOT loaded: '+missing,'warn','yui')}Y._attach(r);handleLoader()}return Y},namespace:function(){var a=arguments,o=null,i,j,d;for(i=0;i<a.length;i=i+1){d=(""+a[i]).split(".");o=this;for(j=(d[0]=="YAHOO")?1:0;j<d.length;j=j+1){o[d[j]]=o[d[j]]||{};o=o[d[j]]}}return o},log:NOOP,message:NOOP,error:function(a,e){if(this.config.throwFail){throw(e||new Error(a));}else{this.message(a,"error")}return this},guid:function(a){var b=this.Env._guidp+(++this.Env._uidx);return(a)?(a+b):b},stamp:function(o,a){if(!o){return o}var b=(typeof o==='string')?o:o._yuid;if(!b){b=this.guid();if(!a){try{o._yuid=b}catch(e){b=null}}}return b}};p=YUI.prototype;for(prop in p){YUI[prop]=p[prop]}YUI._init();if(hasWin){add(window,'load',handleLoad)}else{handleLoad()}YUI.Env.add=add;YUI.Env.remove=remove;if(typeof exports=='object'){exports.YUI=YUI}})();YUI.add('yui-base',function(Y){(function(){Y.Lang=Y.Lang||{};var L=Y.Lang,ARRAY='array',BOOLEAN='boolean',DATE='date',ERROR='error',FUNCTION='function',NUMBER='number',NULL='null',OBJECT='object',REGEX='regexp',STRING='string',TOSTRING=Object.prototype.toString,UNDEFINED='undefined',TYPES={'undefined':UNDEFINED,'number':NUMBER,'boolean':BOOLEAN,'string':STRING,'[object Function]':FUNCTION,'[object RegExp]':REGEX,'[object Array]':ARRAY,'[object Date]':DATE,'[object Error]':ERROR},TRIMREGEX=/^\s+|\s+$/g,EMPTYSTRING='';L.isArray=function(o){return L.type(o)===ARRAY};L.isBoolean=function(o){return typeof o===BOOLEAN};L.isFunction=function(o){return L.type(o)===FUNCTION};L.isDate=function(o){return L.type(o)===DATE&&o.toString()!=='Invalid Date'&&!isNaN(o)};L.isNull=function(o){return o===null};L.isNumber=function(o){return typeof o===NUMBER&&isFinite(o)};L.isObject=function(o,a){var t=typeof o;return(o&&(t===OBJECT||(!a&&(t===FUNCTION||L.isFunction(o)))))||false};L.isString=function(o){return typeof o===STRING};L.isUndefined=function(o){return typeof o===UNDEFINED};L.trim=function(s){try{return s.replace(TRIMREGEX,EMPTYSTRING)}catch(e){return s}};L.isValue=function(o){var t=L.type(o);switch(t){case NUMBER:return isFinite(o);case NULL:case UNDEFINED:return false;default:return!!(t)}};L.type=function(o){return TYPES[typeof o]||TYPES[TOSTRING.call(o)]||(o?OBJECT:NULL)}})();(function(){var L=Y.Lang,Native=Array.prototype,LENGTH='length',YArray=function(o,b,c){var t=(c)?2:YArray.test(o),l,a,start=b||0;if(t){try{return Native.slice.call(o,start)}catch(e){a=[];l=o.length;for(;start<l;start++){a.push(o[start])}return a}}else{return[o]}};Y.Array=YArray;YArray.test=function(o){var r=0;if(L.isObject(o)){if(L.isArray(o)){r=1}else{try{if((LENGTH in o)&&!o.tagName&&!o.alert&&!o.apply){r=2}}catch(e){}}}return r};YArray.each=(Native.forEach)?function(a,f,o){Native.forEach.call(a||[],f,o||Y);return Y}:function(a,f,o){var l=(a&&a.length)||0,i;for(i=0;i<l;i=i+1){f.call(o||Y,a[i],i,a)}return Y};YArray.hash=function(k,v){var o={},l=k.length,vl=v&&v.length,i;for(i=0;i<l;i=i+1){if(k[i]){o[k[i]]=(vl&&vl>i)?v[i]:true}}return o};YArray.indexOf=(Native.indexOf)?function(a,b){return Native.indexOf.call(a,b)}:function(a,b){for(var i=0;i<a.length;i=i+1){if(a[i]===b){return i}}return-1};YArray.numericSort=function(a,b){return(a-b)};YArray.some=(Native.some)?function(a,f,o){return Native.some.call(a,f,o)}:function(a,f,o){var l=a.length,i;for(i=0;i<l;i=i+1){if(f.call(o,a[i],i,a)){return true}}return false}})();function Queue(){this._init();this.add.apply(this,arguments)}Queue.prototype={_init:function(){this._q=[]},next:function(){return this._q.shift()},last:function(){return this._q.pop()},add:function(){Y.Array.each(Y.Array(arguments,0,true),function(a){this._q.push(a)},this);return this},size:function(){return this._q.length}};Y.Queue=Queue;YUI.Env._loaderQueue=YUI.Env._loaderQueue||new Queue();(function(){var L=Y.Lang,DELIMITER='__',_iefix=function(r,s){var a=s.toString;if(L.isFunction(a)&&a!=Object.prototype.toString){r.toString=a}};Y.merge=function(){var a=arguments,o={},i,l=a.length;for(i=0;i<l;i=i+1){Y.mix(o,a[i],true)}return o};Y.mix=function(r,s,a,b,c,d){if(!s||!r){return r||Y}if(c){switch(c){case 1:return Y.mix(r.prototype,s.prototype,a,b,0,d);case 2:Y.mix(r.prototype,s.prototype,a,b,0,d);break;case 3:return Y.mix(r,s.prototype,a,b,0,d);case 4:return Y.mix(r.prototype,s,a,b,0,d);default:}}var i,l,p,type;if(b&&b.length){for(i=0,l=b.length;i<l;++i){p=b[i];type=L.type(r[p]);if(s.hasOwnProperty(p)){if(d&&type=="object"){Y.mix(r[p],s[p])}else if(a||!(p in r)){r[p]=s[p]}}}}else{for(i in s){if(s.hasOwnProperty(i)){if(d&&L.isObject(r[i],true)){Y.mix(r[i],s[i],a,b,0,true)}else if(a||!(i in r)){r[i]=s[i]}}}if(Y.UA.ie){_iefix(r,s)}}return r};Y.cached=function(c,d,e){d=d||{};return function(a,b){var k=(b)?Array.prototype.join.call(arguments,DELIMITER):a;if(!(k in d)||(e&&d[k]==e)){d[k]=c.apply(c,arguments)}return d[k]}}})();(function(){Y.Object=function(o){var F=function(){};F.prototype=o;return new F()};var O=Y.Object,owns=function(o,k){return o&&o.hasOwnProperty&&o.hasOwnProperty(k)},UNDEFINED=undefined,_extract=function(o,a){var b=(a===2),out=(b)?0:[],i;for(i in o){if(owns(o,i)){if(b){out++}else{out.push((a)?o[i]:i)}}}return out};O.keys=function(o){return _extract(o)};O.values=function(o){return _extract(o,1)};O.size=function(o){return _extract(o,2)};O.hasKey=owns;O.hasValue=function(o,v){return(Y.Array.indexOf(O.values(o),v)>-1)};O.owns=owns;O.each=function(o,f,c,a){var s=c||Y,i;for(i in o){if(a||owns(o,i)){f.call(s,o[i],i,o)}}return Y};O.some=function(o,f,c,a){var s=c||Y,i;for(i in o){if(a||owns(o,i)){if(f.call(s,o[i],i,o)){return true}}}return false};O.getValue=function(o,a){if(!Y.Lang.isObject(o)){return UNDEFINED}var i,p=Y.Array(a),l=p.length;for(i=0;o!==UNDEFINED&&i<l;i++){o=o[p[i]]}return o};O.setValue=function(o,a,b){var i,p=Y.Array(a),leafIdx=p.length-1,ref=o;if(leafIdx>=0){for(i=0;ref!==UNDEFINED&&i<leafIdx;i++){ref=ref[p[i]]}if(ref!==UNDEFINED){ref[p[i]]=b}else{return UNDEFINED}}return o}})();Y.UA=function(){var a=function(s){var c=0;return parseFloat(s.replace(/\./g,function(){return(c++==1)?'':'.'}))},win=Y.config.win,nav=win&&win.navigator,o={ie:0,opera:0,gecko:0,webkit:0,chrome:0,mobile:null,air:0,caja:nav&&nav.cajaVersion,secure:false,os:null},ua=nav&&nav.userAgent,loc=win&&win.location,href=loc&&loc.href,m;o.secure=href&&(href.toLowerCase().indexOf("https")===0);if(ua){if((/windows|win32/i).test(ua)){o.os='windows'}else if((/macintosh/i).test(ua)){o.os='macintosh'}else if((/rhino/i).test(ua)){o.os='rhino'}if((/KHTML/).test(ua)){o.webkit=1}m=ua.match(/AppleWebKit\/([^\s]*)/);if(m&&m[1]){o.webkit=a(m[1]);if(/ Mobile\//.test(ua)){o.mobile="Apple"}else{m=ua.match(/NokiaN[^\/]*|Android \d\.\d|webOS\/\d\.\d/);if(m){o.mobile=m[0]}}m=ua.match(/Chrome\/([^\s]*)/);if(m&&m[1]){o.chrome=a(m[1])}else{m=ua.match(/AdobeAIR\/([^\s]*)/);if(m){o.air=m[0]}}}if(!o.webkit){m=ua.match(/Opera[\s\/]([^\s]*)/);if(m&&m[1]){o.opera=a(m[1]);m=ua.match(/Opera Mini[^;]*/);if(m){o.mobile=m[0]}}else{m=ua.match(/MSIE\s([^;]*)/);if(m&&m[1]){o.ie=a(m[1])}else{m=ua.match(/Gecko\/([^\s]*)/);if(m){o.gecko=1;m=ua.match(/rv:([^\s\)]*)/);if(m&&m[1]){o.gecko=a(m[1])}}}}}}return o}()},'3.1.1');YUI.add('get',function(Y){(function(){var k=Y.UA,L=Y.Lang,TYPE_JS="text/javascript",TYPE_CSS="text/css",STYLESHEET="stylesheet";Y.Get=function(){var j,_purge,_track,queues={},qidx=0,purging,_node=function(a,b,c){var w=c||Y.config.win,d=w.document,n=d.createElement(a),i;for(i in b){if(b[i]&&b.hasOwnProperty(i)){n.setAttribute(i,b[i])}}return n},_linkNode=function(a,b,c){var o={id:Y.guid(),type:TYPE_CSS,rel:STYLESHEET,href:a};if(c){Y.mix(o,c)}return _node("link",o,b)},_scriptNode=function(a,b,c){var o={id:Y.guid(),type:TYPE_JS};if(c){Y.mix(o,c)}o.src=a;return _node("script",o,b)},_returnData=function(q,a,b){return{tId:q.tId,win:q.win,data:q.data,nodes:q.nodes,msg:a,statusText:b,purge:function(){_purge(this.tId)}}},_end=function(a,b,c){var q=queues[a],sc;if(q&&q.onEnd){sc=q.context||q;q.onEnd.call(sc,_returnData(q,b,c))}},_fail=function(a,b){var q=queues[a],sc;if(q.timer){clearTimeout(q.timer)}if(q.onFailure){sc=q.context||q;q.onFailure.call(sc,_returnData(q,b))}_end(a,b,'failure')},_finish=function(a){var q=queues[a],msg,sc;if(q.timer){clearTimeout(q.timer)}q.finished=true;if(q.aborted){msg="transaction "+a+" was aborted";_fail(a,msg);return}if(q.onSuccess){sc=q.context||q;q.onSuccess.call(sc,_returnData(q))}_end(a,msg,'OK')},_timeout=function(a){var q=queues[a],sc;if(q.onTimeout){sc=q.context||q;q.onTimeout.call(sc,_returnData(q))}_end(a,'timeout','timeout')},_next=function(a,b){var q=queues[a],msg,w,d,h,n,url,s;if(q.timer){clearTimeout(q.timer)}if(q.aborted){msg="transaction "+a+" was aborted";_fail(a,msg);return}if(b){q.url.shift();if(q.varName){q.varName.shift()}}else{q.url=(L.isString(q.url))?[q.url]:q.url;if(q.varName){q.varName=(L.isString(q.varName))?[q.varName]:q.varName}}w=q.win;d=w.document;h=d.getElementsByTagName("head")[0];if(q.url.length===0){_finish(a);return}url=q.url[0];if(!url){q.url.shift();return _next(a)}if(q.timeout){q.timer=setTimeout(function(){_timeout(a)},q.timeout)}if(q.type==="script"){n=_scriptNode(url,w,q.attributes)}else{n=_linkNode(url,w,q.attributes)}_track(q.type,n,a,url,w,q.url.length);q.nodes.push(n);if(q.insertBefore){s=j(q.insertBefore,a);if(s){s.parentNode.insertBefore(n,s)}}else{h.appendChild(n)}if((k.webkit||k.gecko)&&q.type==="css"){_next(a,url)}},_autoPurge=function(){if(purging){return}purging=true;var i,q;for(i in queues){if(queues.hasOwnProperty(i)){q=queues[i];if(q.autopurge&&q.finished){_purge(q.tId);delete queues[i]}}}purging=false},_queue=function(a,b,c){c=c||{};var d="q"+(qidx++),q,thresh=c.purgethreshold||Y.Get.PURGE_THRESH;if(qidx%thresh===0){_autoPurge()}queues[d]=Y.merge(c,{tId:d,type:a,url:b,finished:false,nodes:[]});q=queues[d];q.win=q.win||Y.config.win;q.context=q.context||q;q.autopurge=("autopurge"in q)?q.autopurge:(a==="script")?true:false;q.attributes=q.attributes||{};q.attributes.charset=c.charset||q.attributes.charset||'utf-8';setTimeout(function(){_next(d)},0);return{tId:d}};_track=function(b,n,c,d,g,h,i){var f=i||_next;if(k.ie){n.onreadystatechange=function(){var a=this.readyState;if("loaded"===a||"complete"===a){n.onreadystatechange=null;f(c,d)}}}else if(k.webkit){if(b==="script"){n.addEventListener("load",function(){f(c,d)})}}else{n.onload=function(){f(c,d)};n.onerror=function(e){_fail(c,e+": "+d)}}};j=function(a,b){var q=queues[b],n=(L.isString(a))?q.win.document.getElementById(a):a;if(!n){_fail(b,"target node not found: "+a)}return n};_purge=function(a){var n,l,d,h,s,i,node,attr,q=queues[a];if(q){n=q.nodes;l=n.length;d=q.win.document;h=d.getElementsByTagName("head")[0];if(q.insertBefore){s=j(q.insertBefore,a);if(s){h=s.parentNode}}for(i=0;i<l;i=i+1){node=n[i];if(node.clearAttributes){node.clearAttributes()}else{for(attr in node){if(node.hasOwnProperty(attr)){delete node[attr]}}}h.removeChild(node)}}q.nodes=[]};return{PURGE_THRESH:20,_finalize:function(a){setTimeout(function(){_finish(a)},0)},abort:function(o){var a=(L.isString(o))?o:o.tId,q=queues[a];if(q){q.aborted=true}},script:function(a,b){return _queue("script",a,b)},css:function(a,b){return _queue("css",a,b)}}}()})()},'3.1.1');YUI.add('intl-base',function(Y){var d=/[, ]/;Y.mix(Y.namespace("Intl"),{lookupBestLang:function(b,c){var i,language,result,index;function scan(a){var i;for(i=0;i<c.length;i+=1){if(a.toLowerCase()===c[i].toLowerCase()){return c[i]}}}if(Y.Lang.isString(b)){b=b.split(d)}for(i=0;i<b.length;i+=1){language=b[i];if(!language||language==="*"){continue}while(language.length>0){result=scan(language);if(result){return result}else{index=language.lastIndexOf("-");if(index>=0){language=language.substring(0,index);if(index>=2&&language.charAt(index-2)==="-"){language=language.substring(0,index-2)}}else{break}}}}return""}})},'3.1.1',{requires:['yui-base']});YUI.add('yui-log',function(Y){(function(){var h,INSTANCE=Y,LOGEVENT='yui:log',UNDEFINED='undefined',LEVELS={debug:1,info:1,warn:1,error:1};INSTANCE.log=function(a,b,d,e){var g,excl,incl,m,f,Y=INSTANCE,c=Y.config;if(c.debug){if(d){excl=c.logExclude;incl=c.logInclude;if(incl&&!(d in incl)){g=1}else if(excl&&(d in excl)){g=1}}if(!g){if(c.useBrowserConsole){m=(d)?d+': '+a:a;if(Y.Lang.isFunction(c.logFn)){c.logFn(a,b,d)}else if(typeof console!=UNDEFINED&&console.log){f=(b&&console[b]&&(b in LEVELS))?b:'log';console[f](m)}else if(typeof opera!=UNDEFINED){opera.postError(m)}}if(Y.fire&&!e){if(!h){Y.publish(LOGEVENT,{broadcast:2});h=1}Y.fire(LOGEVENT,{msg:a,cat:b,src:d})}}}return Y};INSTANCE.message=function(){return INSTANCE.log.apply(INSTANCE,arguments)}})()},'3.1.1',{requires:['yui-base']});YUI.add('yui-later',function(Y){(function(){var L=Y.Lang,later=function(a,o,b,c,e){a=a||0;o=o||{};var m=b,d=Y.Array(c),f,r;if(L.isString(b)){m=o[b]}if(!m){}f=function(){m.apply(o,d)};r=(e)?setInterval(f,a):setTimeout(f,a);return{id:r,interval:e,cancel:function(){if(this.interval){clearInterval(r)}else{clearTimeout(r)}}}};Y.later=later;L.later=later})()},'3.1.1',{requires:['yui-base']});YUI.add('yui-throttle',function(Y){var e=function(b,c){c=(c)?c:(Y.config.throttleTime||150);if(c===-1){return(function(){b.apply(null,arguments)})}var d=(new Date()).getTime();return(function(){var a=(new Date()).getTime();if(a-d>c){d=a;b.apply(null,arguments)}})};Y.throttle=e},'3.1.1',{requires:['yui-base']});YUI.add('yui',function(Y){},'3.1.1',{use:['yui-base','get','intl-base','yui-log','yui-later','yui-throttle']});
jQuery.fn.extend({mousewheel:function(a,b,c){return this.hover(function(){jQuery.event.mousewheel.giveFocus(this,a,b,c)},function(){jQuery.event.mousewheel.removeFocus(this)})},mousewheeldown:function(a,b){return this.mousewheel(function(){},a,b)},mousewheelup:function(a,b){return this.mousewheel(a,function(){},b)},unmousewheel:function(){return this.each(function(){jQuery(this).unmouseover().unmouseout();jQuery.event.mousewheel.removeFocus(this)})},unmousewheeldown:jQuery.fn.unmousewheel,unmousewheelup:jQuery.fn.unmousewheel});jQuery.event.mousewheel={giveFocus:function(c,d,e,f){if(c._handleMousewheel)jQuery(c).unmousewheel();if(f==window.undefined&&e&&e.constructor!=Function){f=e;e=null}c._handleMousewheel=function(a){if(!a)a=window.event;if(f)if(a.preventDefault)a.preventDefault();else a.returnValue=false;var b=0;if(a.wheelDelta){b=a.wheelDelta/120;if(window.opera)b=-b}else if(a.detail){b=-a.detail/3}if(d&&(b>0||!e))d.apply(c,[a,b]);else if(e&&b<0)e.apply(c,[a,b])};if(window.addEventListener)window.addEventListener('DOMMouseScroll',c._handleMousewheel,false);window.onmousewheel=document.onmousewheel=c._handleMousewheel},removeFocus:function(a){if(!a._handleMousewheel)return;if(window.removeEventListener)window.removeEventListener('DOMMouseScroll',a._handleMousewheel,false);window.onmousewheel=document.onmousewheel=null;a._handleMousewheel=null}};
jQuery.fn.scrollIntoView=function(){var a=window.pageYOffset;var b=window.pageXOffset;var c=this.get(0);if(c.scrollIntoView){c.scrollIntoView()}window.scrollTo(b,a);var d=KALS_toolbar.get_ui().height()+window.pageYOffset;if($(c).offset().top<d){window.scrollTo(b,d)}return this};
/* jQuery Storage API Plugin 1.7.0 https://github.com/julien-maurel/jQuery-Storage-API */
!function(e){function t(t){var r,n,i,o=arguments.length,s=window[t],a=arguments,u=a[1];if(2>o)throw Error("Minimum 2 arguments must be given");if(e.isArray(u)){n={};for(var f in u){r=u[f];try{n[r]=JSON.parse(s.getItem(r))}catch(c){n[r]=s.getItem(r)}}return n}if(2!=o){try{n=JSON.parse(s.getItem(u))}catch(c){throw new ReferenceError(u+" is not defined in this storage")}for(var f=2;o-1>f;f++)if(n=n[a[f]],void 0===n)throw new ReferenceError([].slice.call(a,1,f+1).join(".")+" is not defined in this storage");if(e.isArray(a[f])){i=n,n={};for(var m in a[f])n[a[f][m]]=i[a[f][m]];return n}return n[a[f]]}try{return JSON.parse(s.getItem(u))}catch(c){return s.getItem(u)}}function n(t){var r,n,i=arguments.length,o=window[t],s=arguments,a=s[1],u=s[2],f={};if(2>i||!e.isPlainObject(a)&&3>i)throw Error("Minimum 3 arguments must be given or second parameter must be an object");if(e.isPlainObject(a)){for(var c in a)r=a[c],e.isPlainObject(r)?o.setItem(c,JSON.stringify(r)):o.setItem(c,r);return a}if(3==i)return"object"==typeof u?o.setItem(a,JSON.stringify(u)):o.setItem(a,u),u;try{n=o.getItem(a),null!=n&&(f=JSON.parse(n))}catch(m){}n=f;for(var c=2;i-2>c;c++)r=s[c],n[r]&&e.isPlainObject(n[r])||(n[r]={}),n=n[r];return n[s[c]]=s[c+1],o.setItem(a,JSON.stringify(f)),f}function i(t){var r,n,i=arguments.length,o=window[t],s=arguments,a=s[1];if(2>i)throw Error("Minimum 2 arguments must be given");if(e.isArray(a)){for(var u in a)o.removeItem(a[u]);return!0}if(2==i)return o.removeItem(a),!0;try{r=n=JSON.parse(o.getItem(a))}catch(f){throw new ReferenceError(a+" is not defined in this storage")}for(var u=2;i-1>u;u++)if(n=n[s[u]],void 0===n)throw new ReferenceError([].slice.call(s,1,u).join(".")+" is not defined in this storage");if(e.isArray(s[u]))for(var c in s[u])delete n[s[u][c]];else delete n[s[u]];return o.setItem(a,JSON.stringify(r)),!0}function o(t,r){var n=u(t);for(var o in n)i(t,n[o]);if(r)for(var o in e.namespaceStorages)f(o)}function s(r){var n=arguments.length,i=arguments,o=(window[r],i[1]);if(1==n)return 0==u(r).length;if(e.isArray(o)){for(var a=0;a<o.length;a++)if(!s(r,o[a]))return!1;return!0}try{var f=t.apply(this,arguments);e.isArray(i[n-1])||(f={totest:f});for(var a in f)if(!(e.isPlainObject(f[a])&&e.isEmptyObject(f[a])||e.isArray(f[a])&&!f[a].length)&&f[a])return!1;return!0}catch(c){return!0}}function a(r){var n=arguments.length,i=arguments,o=(window[r],i[1]);if(2>n)throw Error("Minimum 2 arguments must be given");if(e.isArray(o)){for(var s=0;s<o.length;s++)if(!a(r,o[s]))return!1;return!0}try{var u=t.apply(this,arguments);e.isArray(i[n-1])||(u={totest:u});for(var s in u)if(void 0===u[s]||null===u[s])return!1;return!0}catch(f){return!1}}function u(r){var n=arguments.length,i=window[r],o=arguments,s=(o[1],[]),a={};if(a=n>1?t.apply(this,o):i,a._cookie)for(var u in e.cookie())""!=u&&s.push(u.replace(a._prefix,""));else for(var f in a)s.push(f);return s}function f(t){if(!t||"string"!=typeof t)throw Error("First parameter must be a string");window.localStorage.getItem(t)||window.localStorage.setItem(t,"{}"),window.sessionStorage.getItem(t)||window.sessionStorage.setItem(t,"{}");var r={localStorage:e.extend({},e.localStorage,{_ns:t}),sessionStorage:e.extend({},e.sessionStorage,{_ns:t})};return e.cookie&&(window.cookieStorage.getItem(t)||window.cookieStorage.setItem(t,"{}"),r.cookieStorage=e.extend({},e.cookieStorage,{_ns:t})),e.namespaceStorages[t]=r,r}var c="ls_",m="ss_",g={_type:"",_ns:"",_callMethod:function(e,t){var r=[this._type],t=Array.prototype.slice.call(t),n=t[0];return this._ns&&r.push(this._ns),"string"==typeof n&&-1!==n.indexOf(".")&&(t.shift(),[].unshift.apply(t,n.split("."))),[].push.apply(r,t),e.apply(this,r)},get:function(){return this._callMethod(t,arguments)},set:function(){var t=arguments.length,i=arguments,o=i[0];if(1>t||!e.isPlainObject(o)&&2>t)throw Error("Minimum 2 arguments must be given or first parameter must be an object");if(e.isPlainObject(o)&&this._ns){for(var s in o)n(this._type,this._ns,s,o[s]);return o}return r=this._callMethod(n,i),this._ns?r[o.split(".")[0]]:r},remove:function(){if(arguments.length<1)throw Error("Minimum 1 argument must be given");return this._callMethod(i,arguments)},removeAll:function(e){return this._ns?(n(this._type,this._ns,{}),!0):o(this._type,e)},isEmpty:function(){return this._callMethod(s,arguments)},isSet:function(){if(arguments.length<1)throw Error("Minimum 1 argument must be given");return this._callMethod(a,arguments)},keys:function(){return this._callMethod(u,arguments)}};if(e.cookie){window.name||(window.name=Math.floor(1e8*Math.random()));var h={_cookie:!0,_prefix:"",_expires:null,_path:null,_domain:null,setItem:function(t,r){e.cookie(this._prefix+t,r,{expires:this._expires,path:this._path,domain:this._domain})},getItem:function(t){return e.cookie(this._prefix+t)},removeItem:function(t){return e.removeCookie(this._prefix+t)},clear:function(){for(var t in e.cookie())""!=t&&(!this._prefix&&-1===t.indexOf(c)&&-1===t.indexOf(m)||this._prefix&&0===t.indexOf(this._prefix))&&e.removeCookie(t)},setExpires:function(e){return this._expires=e,this},setPath:function(e){return this._path=e,this},setDomain:function(e){return this._domain=e,this},setConf:function(e){return e.path&&(this._path=e.path),e.domain&&(this._domain=e.domain),e.expires&&(this._expires=e.expires),this},setDefaultConf:function(){this._path=this._domain=this._expires=null}};window.localStorage||(window.localStorage=e.extend({},h,{_prefix:c,_expires:3650}),window.sessionStorage=e.extend({},h,{_prefix:m+window.name+"_"})),window.cookieStorage=e.extend({},h),e.cookieStorage=e.extend({},g,{_type:"cookieStorage",setExpires:function(e){return window.cookieStorage.setExpires(e),this},setPath:function(e){return window.cookieStorage.setPath(e),this},setDomain:function(e){return window.cookieStorage.setDomain(e),this},setConf:function(e){return window.cookieStorage.setConf(e),this},setDefaultConf:function(){return window.cookieStorage.setDefaultConf(),this}})}e.initNamespaceStorage=function(e){return f(e)},e.localStorage=e.extend({},g,{_type:"localStorage"}),e.sessionStorage=e.extend({},g,{_type:"sessionStorage"}),e.namespaceStorages={},e.removeAllStorages=function(t){e.localStorage.removeAll(t),e.sessionStorage.removeAll(t),e.cookieStorage&&e.cookieStorage.removeAll(t),t||(e.namespaceStorages={})}}(jQuery);
var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(e){if(e==null)return"";var t="";var n,r,i,s,o,u,a;var f=0;e=LZString.compress(e);while(f<e.length*2){if(f%2==0){n=e.charCodeAt(f/2)>>8;r=e.charCodeAt(f/2)&255;if(f/2+1<e.length)i=e.charCodeAt(f/2+1)>>8;else i=NaN}else{n=e.charCodeAt((f-1)/2)&255;if((f+1)/2<e.length){r=e.charCodeAt((f+1)/2)>>8;i=e.charCodeAt((f+1)/2)&255}else r=i=NaN}f+=3;s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+LZString._keyStr.charAt(s)+LZString._keyStr.charAt(o)+LZString._keyStr.charAt(u)+LZString._keyStr.charAt(a)}return t},decompressFromBase64:function(e){if(e==null)return"";var t="",n=0,r,i,s,o,u,a,f,l,c=0,h=LZString._f;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(c<e.length){u=LZString._keyStr.indexOf(e.charAt(c++));a=LZString._keyStr.indexOf(e.charAt(c++));f=LZString._keyStr.indexOf(e.charAt(c++));l=LZString._keyStr.indexOf(e.charAt(c++));i=u<<2|a>>4;s=(a&15)<<4|f>>2;o=(f&3)<<6|l;if(n%2==0){r=i<<8;if(f!=64){t+=h(r|s)}if(l!=64){r=o<<8}}else{t=t+h(r|i);if(f!=64){r=s<<8}if(l!=64){t+=h(r|o)}}n+=3}return LZString.decompress(t)},compressToUTF16:function(e){if(e==null)return"";var t="",n,r,i,s=0,o=LZString._f;e=LZString.compress(e);for(n=0;n<e.length;n++){r=e.charCodeAt(n);switch(s++){case 0:t+=o((r>>1)+32);i=(r&1)<<14;break;case 1:t+=o(i+(r>>2)+32);i=(r&3)<<13;break;case 2:t+=o(i+(r>>3)+32);i=(r&7)<<12;break;case 3:t+=o(i+(r>>4)+32);i=(r&15)<<11;break;case 4:t+=o(i+(r>>5)+32);i=(r&31)<<10;break;case 5:t+=o(i+(r>>6)+32);i=(r&63)<<9;break;case 6:t+=o(i+(r>>7)+32);i=(r&127)<<8;break;case 7:t+=o(i+(r>>8)+32);i=(r&255)<<7;break;case 8:t+=o(i+(r>>9)+32);i=(r&511)<<6;break;case 9:t+=o(i+(r>>10)+32);i=(r&1023)<<5;break;case 10:t+=o(i+(r>>11)+32);i=(r&2047)<<4;break;case 11:t+=o(i+(r>>12)+32);i=(r&4095)<<3;break;case 12:t+=o(i+(r>>13)+32);i=(r&8191)<<2;break;case 13:t+=o(i+(r>>14)+32);i=(r&16383)<<1;break;case 14:t+=o(i+(r>>15)+32,(r&32767)+32);s=0;break}}return t+o(i+32)},decompressFromUTF16:function(e){if(e==null)return"";var t="",n,r,i=0,s=0,o=LZString._f;while(s<e.length){r=e.charCodeAt(s)-32;switch(i++){case 0:n=r<<1;break;case 1:t+=o(n|r>>14);n=(r&16383)<<2;break;case 2:t+=o(n|r>>13);n=(r&8191)<<3;break;case 3:t+=o(n|r>>12);n=(r&4095)<<4;break;case 4:t+=o(n|r>>11);n=(r&2047)<<5;break;case 5:t+=o(n|r>>10);n=(r&1023)<<6;break;case 6:t+=o(n|r>>9);n=(r&511)<<7;break;case 7:t+=o(n|r>>8);n=(r&255)<<8;break;case 8:t+=o(n|r>>7);n=(r&127)<<9;break;case 9:t+=o(n|r>>6);n=(r&63)<<10;break;case 10:t+=o(n|r>>5);n=(r&31)<<11;break;case 11:t+=o(n|r>>4);n=(r&15)<<12;break;case 12:t+=o(n|r>>3);n=(r&7)<<13;break;case 13:t+=o(n|r>>2);n=(r&3)<<14;break;case 14:t+=o(n|r>>1);n=(r&1)<<15;break;case 15:t+=o(n|r);i=0;break}s++}return LZString.decompress(t)},compress:function(e){if(e==null)return"";var t,n,r={},i={},s="",o="",u="",a=2,f=3,l=2,c="",h=0,p=0,d,v=LZString._f;for(d=0;d<e.length;d+=1){s=e.charAt(d);if(!Object.prototype.hasOwnProperty.call(r,s)){r[s]=f++;i[s]=true}o=u+s;if(Object.prototype.hasOwnProperty.call(r,o)){u=o}else{if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}r[o]=f++;u=String(s)}}if(u!==""){if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}}n=2;for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}while(true){h=h<<1;if(p==15){c+=v(h);break}else p++}return c},decompress:function(e){if(e==null)return"";if(e=="")return null;var t=[],n,r=4,i=4,s=3,o="",u="",a,f,l,c,h,p,d,v=LZString._f,m={string:e,val:e.charCodeAt(0),position:32768,index:1};for(a=0;a<3;a+=1){t[a]=a}l=0;h=Math.pow(2,2);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(n=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 2:return""}t[3]=d;f=u=d;while(true){if(m.index>m.string.length){return""}l=0;h=Math.pow(2,s);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(d=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 2:return u}if(r==0){r=Math.pow(2,s);s++}if(t[d]){o=t[d]}else{if(d===i){o=f+f.charAt(0)}else{return null}}u+=o;t[i++]=f+o.charAt(0);r--;f=o;if(r==0){r=Math.pow(2,s);s++}}}};if(typeof module!=="undefined"&&module!=null){module.exports=LZString}
/**
 * KALS_CONFIG
 * 
 * 只有跨越不同程式而需要同一個參數時，才到此設定
 *
 * @package         KALS
 * @category        Webpage Application Libraries
 * @author          Pudding Chen <puddingchen.35@gmail.com>
 * @copyright       Copyright (c) 2010, Pudding Chen
 * @license         http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link            https://github.com/pulipulichen/kals
 * @version		1.5 2014/4/28 下午 07:50:21
 */

DEFAULT_KALS_CONFIG = {
    
    /**
     * 是否啟用KALS
     * @type Boolean
     */
    enable_kals: true,
    
    /**
     * 標註範圍指定區塊
     * @type {string,null} jQuery的指定語法(selector)
     *     請盡量以ID為指定區塊。
     *     例如指定ID名為「annotation_scope」的區塊，請輸入「#annotation_scope」
     *     如果是指定區有多個區塊，那麼只有第一個區塊能夠進行標註。
     *     預設是選擇全部的網頁。
     */
    annotation_scope_selector: null,
    
    /**
     * 標題圖示
     * 工具列左方的顯示內容
     * @type {string} HTML語法
     */
    logo: "KALS",
    
    /**
     * 預設登入的帳號
     * @type {string} = null E-mail郵件地址
     *     也可以使用網址，該網址應該要回傳使用者的email，例如 "http://localhost/user.txt"
     *     不使用預設登入時則是null 
     */
    user_email: null,
    
    /**
     * 預設權限
     * @type {string} = "public" 權限 
     *     公開： default_policy: "public"
     *     私密： default_policy: "private" 
     */
    default_policy_type: "public",
    
    /**
     * @type {boolean} = true 可否調整權限
     */
    policy_changable: true,
    
    /**
     * @type {boolean} = false 阻止註冊
     */
    deny_register: false,
    
    /**
     * @{type} string 登入時顯示的訊息，如果不使用的話，值填入null
     *     如果要使用的話，則填入字串
     */
    login_hint: null,
    
    /**
     * 顯示其他人的標註
     * @version 20111106 Pudding Chen
     *     2009年的舊稱呼是「navigation_annotation」，2011年改成「anchor_navigation_type」
     * @type {string} = "all" | "recommend" | "none" | null 預設使用all
     *     "all": 顯示所有標註
     *     "recommend": 顯示推薦標註。但並不準確，通常系統找不出推薦的標註。
     *     "none" | null：不顯示標註
     */
    anchor_navigation_type: "all",
    
    /**
     * @type {boolean} = false 是否啟用標註建議，預設關閉。
     */
    enable_annotation_recommend: false,
    
    /**
     * 使用的標註類型
     * 標註類型的順序會照以下設定排列。
     * 
     * 20140425 Pulipuli Chen
     * 舊名稱「annotation_type_option」，新名稱「annotation_type_basic_enable」
     * 20140505 Pulipuli Chen
     * 舊名稱「annotation_type_basic_enable」，新名稱「annotation_type_basic」
     * 
     * 基本的標註類型如下：
     *     importance: 重要
     *     concept: 概念
     *     confusion: 困惑
     *     question: 疑問
     *     example: 舉例
     *     summary: 摘要
     *     custon: 自訂
     *     
     *  請自行調整各標註類型的啟用範圍與順序
     */
    annotation_type_basic: {
        'importance' : {
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        },
        'concept' : {
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        },
        'confusion' : {
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        },
        'question' : {
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        },
        'example' : {
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        },
        'summary' : {
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        },
        'custom' : {
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        }
    },
    
    /**
     * 是否讓「自訂」選項可供使用者自由填入資料
     * 
     * 如果是true，就會顯示「自訂」
     * 如果是false，就會顯示「其他」
     * @type {boolean} = false
     */
    enable_custom_name: true,
    
    /**
     * 預先定義標註類型。
     * 
     * 注意，這個設定不會覆蓋annotation_type_option設定的標註類型
     * 而是會加在原本的標註類型下面。
     * 如果你要取消原本的標註類型，請修改annotation_type_option
     * 
     * 20140425 Pulipuli Chen
     * 舊名稱「annotation_custom_type」，新名稱「annotation_type_predefined」
     */
    /*
    annotation_type_predefined: {
        "預先定義1": {
            //type_id: 15,
            hint: '測試的說明',
            option: {
                background_color: 'blue',
                font_color: 'white'
            },
            anchor: {
                style: 'dottedline',
                color: 'blue'    
            },
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        },
        '預先定義2': {
            //type_id: 16,
            hint: '在測試的說明在測試的說明在測試的說明在測試的說明在測試的說明在測試的說明',
            option: {
                background_color: 'red',
                font_color: 'blue'
            },
            anchor: {
                style: 'background',
                color: '#F53004',
                font_color: 'white'
            },
            enable: {   // 啟用範圍
                topic: true,    // 新標註
                respond: true   // 回應標註
            },
            order: 1    // 數字越大，排序越上面
        }
    },
     */
   
    /**
     * KALS操作說明的網址
     * 
     * @type {string|null} help_base_url = 'help/' 網址
     *     也可以用http開頭的絕對網址，例如'http://www.google.com.tw/'
     */
    help_base_url: 'help/',
	
    /**
     * 預設標註類型
     *
     * @copyright 20130603 Pudding Chen
     * @type {string} = "importance" 重要，也可以寫上自訂的名字
     */
    default_annotation_type: "importance",

    /**
     * 網頁搜尋
     * 
     * @copyright 20130603 Pudding Chen
     * 可以設定網頁搜尋的網址。要搜尋的參數請設成{query}
     * 
     * @type {String} web_search_url = "http://www.google.com/search?q={query}"; 不想開放網頁搜尋功能時，請設成"disable"
     */
    web_search_url: "http://www.google.com/search?q={query}",
    //web_search_url: "disable",

    /**
     * 獨立模式
     * @type {boolean} isolation_mode: false，預設不開啟
     * 
     * 開啟之後，所有人都只能看到自己的標註，無法看到別人的標註。
     * 但是關閉之後，所有人又能看到別人的標註
     */
    isolation_mode: false,
	
    //----------------------------
    
    //以下是版面調整
    anchor_length_max: 144,
    ckeditor_config: {
        autoGrow_maxHeight: false,
        autoGrow_maxWidth: false,
        extraPlugins: 'kals_maximize,youtube',
        toolbar: [
			//最大化的時候顯示的工具列
            ['Maximize','Source','Preview','-'],
            ['Cut','Copy','Paste','PasteText','PasteFromWord'],
            ['Undo','Redo','-','Find','Replace','-','SelectAll','RemoveFormat'],
            '/',
            ['Bold','Italic','Underline','Strike','-','Subscript','Superscript'],
            ['NumberedList','BulletedList','-','Outdent','Indent','Blockquote','CreateDiv'],
            ['JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'],
            ['Link','Unlink','Anchor'],
            ['Image','Youtube','Table','HorizontalRule','Smiley','SpecialChar'],
            '/',
            ['Styles','Format','Font','FontSize'],
            ['TextColor','BGColor'],
			
			//最小化的時候顯示的工具列
            ['Maximize','Source','-','Bold', 'Italic', '-', 'NumberedList', 'BulletedList', '-', 'Link', 'Unlink', '-', 'Image','Youtube']	
        ],
        height: '50px',
        //width: '261px',
        resize_enabled: false,
        startupFocus: false,
        uiColor : '#CB842E'
    },
    //標註列表設定
    annotation_list: {
        //筆記顯示設定
        note: {
            simple_max_length: 150,
            //允許顯示的HTML標籤
            allow_html_tags: ["a", "img", "iframe"]
        }
    },
    
    // --------------------------
    // KALS framework
    // --------------------------
    
    /**
     * 需要初始化的事件名稱
     */
    view: {
        init_attrs: [
            'class',
            'value',
            //'style',
            'src',
            'height',
            'width',
            'alt',
            'title',
            'kals-style'
        ],
        event_names: [
            'click',
            'mouseover',
            'mouseout',
            'mouseenter',
            'blur',
            'focus',
            'change',
            'dblclick',
            'submit'
        ],
        kals_events: {
            'field_set': 'kals-event-field-set',
            'field_reset': 'kals-event-field-reset'
        },
        kals_attrs: {
            'field': 'kals-field',
            'field_parent': 'kals-field-parent',
            'field_repeat': 'kals-field-repeat',
            'repeat_index': 'kals-field-repeat-index',
            'attr_prefix': 'kals-attr-',
            'origin_value_postfix': '-origin-value',
            'event_prefix': 'kals-event-'
        },
        /**
         * 找尋變數的規則
         * @type {RegExp}
         */
        regular_expression: /\{\{([\w]|\-|\:|\.|\(|\))*\}\}/g
    },   //view: {
    /**
     * 是否啟用選取文字快取
     * @type Boolean
     */
    //selectable_text_cache: true,
    
    /**
     * 偵錯用設定
     * @type JSON
     */
    debug: {
        /**
         * 是否顯示ajax_get的連接訊息
         * @type Boolean
         */
        ajax_get_message: false,
        
        /**
         * 開啟ajax_post設定
         * 設定檔案為 [VIEW]/helpers/KALS_util.js
         * @type Boolean
         */
        ajax_post: false, 
        
        /**
         * 取消載入KALS_context的後續動作
         * 等於不初始化其他元件
         * @type Boolean
         */
        kals_context_disable: false
    },
    
    /**
     * 模組設定
     * @type {JSON}
     */
    modules: {
        /**
         * 模組名稱: 模組設定內容
         * @type {JSON}
         */
        /**
         * 資訊區
         * @type {Object}
         */
        Dashboard: {
            /**
             * 是否啟用模組
             * @type Boolean
             */
            "enable": true,
            "nav_config": {
                /**
                 * 顯示資料
                 * @type Boolean
                 */
                display: true,

                /**
                 * 決定顯示導覽列的位置
                 * 
                 * 類型包括：
                 * - common: 不管什麼類型都會顯示(在以下三種類型中都會顯示)
                 * - login: 已經登入的使用者就會顯示
                 * - profile: 以手動登入的使用者才會顯示
                 * - embed: 以內嵌登入的使用者才會顯示
                 * - anonymous: 未登入的使用者才會顯示
                 * @type String
                 */
                nav_type: "common",

                /**
                 * 排序順序
                 * 
                 * 數字越大，越往左邊靠
                 * 數字最小的是1
                 * @type Number
                 */
                order: 1
            }
        },
        /**
         * 標註小地圖
         * @type {Object}
         */
        Annotation_navigation_map: {
            /**
             * 是否啟用模組
             * @type Boolean
             */
            "enable": true,
            "nav_config": {
                display: true,
                nav_type: "common",
                order: 1
            },
            /**
             * 安照原本的章節順序排序
             * @type boolean
             */
            order_by_article: true
        },
        /**
         * 零碎時間
         * @type type
         */
        Frag_reading: {
            /**
             * 是否啟用模組
             * @type Boolean
             */
            "enable": true,
            "nav_config": {
                display: false,
                nav_type: "login",
                order: 1
            },
            /**
             * 設定自動save_reading_progress的時間頻率
             * @type Number
             */
            "interval_span": 10,
            /**
             * 頁面停止時延遲的增加時間
             * @type Number
             */
            "increase_interval_span": 10
        },
        /**
         * 搜尋功能
         */
        Window_search: {
            "enable": false
        },
        /**
         * 章節地圖
         */
        Window_map: {
            "enable": false
        },
        /**
         * 標註顯示
         */
        Window_filter: {
            "enable": true
        },
        /**
         * 導讀功能
         */
        Reading_guide: {
            "enable": false
        },
        /**
         * 回報功能
         */
        Feedback_manager: {
            "enable": true
            /**
             * 回報接收者的電子郵件信箱
             * 
             * 可以設定很多位，用陣列組成
             * @type String|Array<String>
             */
            //,"receiver_email": "pudding@nccu.edu.tw"
            //,"receiver_email": ["puddingchen.35@gmail.com", "pudding@nccu.edu.tw", "pulipuli.chen@gmail.com"]
        },
        /**
         * 獎章功能
         */
        KALS_stamp: {
        "enable": false,
            /**
             * 獎章資格設定
             */
            "stamps": [
                {
                    /**
                     * 獎章稱號
                     * @types {String}
                     */
                    "title": "獎章1",
                    /**
                     * 如何獲得獎章的訊息
                     * @types {String}
                     */
                    "qualification_message": "如何獲得這個獎章",
                    /**
                     * 獲得獎章時候的通知 
                     * @types {String}
                     */
                    "quailfy_message": "通知您獲得了獎章",
                    /**
                     * 已經獲得獎章的訊息 
                     * @types {String}
                     */
                    "qualified_message": "您已經獲得了這個獎章",
                    /**
                     * 獎章資格
                     * @types {JSON}
                     */
                    "qualifier": {
                        
                    },
                    /**
                     * 權限設定
                     * @types {JSON}
                     */
                    "policy": {
                        
                    }
                }
            ]
        },
        /**
         * 開啟行動版網頁
         * @type type
         */
        Open_mobile_apps: {
            enable: true
        }
    }
};

/**
 * 偵測是否有參數，否則直接覆蓋
 */
if (typeof(KALS_CONFIG) !== 'undefined') {
    for (var _i in KALS_CONFIG) {
        DEFAULT_KALS_CONFIG[_i] = KALS_CONFIG[_i];
    }
}

KALS_CONFIG = DEFAULT_KALS_CONFIG;

/* End of file KALS_CONFIG */
/* Location: ./system/application/views/web_apps/KALS_CONFIG.js *//**
 * KALS_SITE_REFORM_CONFIG
 * 
 * 在讀取完成時，去修改網站的作法
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <pulipuli.chen@gmail.com>
 * @copyright  Copyright (c) 2013, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       https://github.com/pulipulichen/kals
 * @version    1.0 2013/12/27 下午 08:10:10
 * @extends {Event_dispatcher}
 */

KALS_SITE_REFORM_CONFIG = [
    {
        /**
         * 標題，只有偵錯訊息會用到
         * @type String
         */
        title: "pdf2htmlEx",
        
        /**
         * 該網站的特徵，請以jQuery Selector輸入
         * @type {Array|String}
         */
        feature: [
            "#sidebar",
            "#page-container",
            "#pf1:first",
            //".t:first",
            //".m0:first",
            //".ls0:first",
            //"._0:first",
        ],
        
        /**
         * 符合特徵時做的事情
         * @type {Function}
         */
        reform: {
            before_init: function (_callback) {
                //pdf2htmlEX = KALS_pdf2htmlEX();
                setTimeout(function () {
                    
                    //先記錄目前的瀏覽進度
                    var _now_top = $("#page-container").attr("scrollTop");
                    
                    /*
                    $("body .pf").each(function (_index, _pf) {
                        var _top = $(_pf).offset().top;
                        setTimeout(function () {
                            $("#page-container").scrollTop(_top);
                        }, 0);
                        $.test_msg("簽到 " + _index, _top);
                    });
                    */
                    //$.test_msg("pdf2htmlEx ", typeof(pdf2htmlEX.Viewer));
                    //window.scrollTo(0, 1000);
                    // 最後一定要callback
                    
                    //$.test_msg("簽到 ", $("#page-container").attr("scrollHeight"));
                    var _top = $("#page-container").attr("scrollHeight");
                    $("#page-container").scrollTop(_top);
                    /*
                    setTimeout(function () {
                        //$("#page-container").scrollTop(0);
                    }, 10000);
                    */
                    setTimeout(function () {
                        $("#page-container").scrollTop(1);
                    }, 1);
                    _callback();
                }, 0);
                    
            },
            after_init: function () {
                $("body").css("background-color", "#2f3236");
                $("#page-container").css("position", "relative");
                
                //$.test_msg("完成？222");
            }
        }
                
    }   //site_title: "pdf2html",
];

/* End of file KALS_SITE_REFORM.js */
/* Location: ./system/application/views/web_apps/../KALS_SITE_REFORM.js *//**
 * KALS_language_param
 * 語系參數
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/26 下午 09:53:28
 * @param {string} _msg 預設顯示值
 * @param {string|null} _line 語系索引，可以省略
 * @param {Array|null} _arg 語系索引參數，除了是字串之外，也可以是jQuery元素。
 * 可以在create_listener的參數中再插入一個listener
 */
function KALS_language_param (_msg, _line, _arg) {
    
    if ($.is_array(_line)
        && $.is_null(_arg)) {
        _arg = _line;
        _line = _msg;
        _msg = null;
    }
    
    this.msg = _msg;
    this.line = _line;
    
    if ($.isset(_arg) 
          && false === $.is_array) {
        _arg = [_arg];
    }
    this.arg = _arg;
}

/**
 * 預設顯示的值
 * @type {string}
 */
KALS_language_param.prototype.msg = null;

/**
 * 語系索引
 * @type {string}
 */
KALS_language_param.prototype.line = null;

/**
 * 語系索引參數
 * @type {Array}
 */
KALS_language_param.prototype.arg = [];
   
/* End of file KALS_language_param */
/* Location: ./system/application/views/web_apps/KALS_language_param.js *//*
 feedback.js <http://experiments.hertzen.com/jsfeedback/>
 Copyright (c) 2012 Niklas von Hertzen. All rights reserved.
 http://www.twitter.com/niklasvh

 Released under MIT License
*/
(function( window, document, undefined ) {
if ( window.Feedback !== undefined ) { 
    return; 
}

// log proxy function
var log = function( msg ) {
    window.console.log( msg );
},
// function to remove elements, input as arrays
removeElements = function( remove ) {
    for (var i = 0, len = remove.length; i < len; i++ ) {
        var item = Array.prototype.pop.call( remove );
        if ( item !== undefined ) {
            if (item.parentNode !== null ) { // check that the item was actually added to DOM
                item.parentNode.removeChild( item );
            }
        }
    }
},
loader = function() {
    var div = document.createElement("div"), i = 3;
    div.className = "feedback-loader";
    
    while (i--) { div.appendChild( document.createElement( "span" )); }
    return div;
},
getBounds = function( el ) {
    return el.getBoundingClientRect();
},
emptyElements = function( el ) {
    var item;
    while( (( item = el.firstChild ) !== null ? el.removeChild( item ) : false) ) {}
},
element = function( name, text ) {
    var el = document.createElement( name );
    el.appendChild( document.createTextNode( text ) );
    return el;
},
// script onload function to provide support for IE as well
scriptLoader = function( script, func ){

    if (script.onload === undefined) {
        // IE lack of support for script onload

        if( script.onreadystatechange !== undefined ) {

            var intervalFunc = function() {
                if (script.readyState !== "loaded" && script.readyState !== "complete") {
                    window.setTimeout( intervalFunc, 250 );
                } else {
                    // it is loaded
                    func();
                }
            };

            window.setTimeout( intervalFunc, 250 );

        } else {
            log("ERROR: We can't track when script is loaded");
        }

    } else {
        return func;
    }

},
nextButton,
H2C_IGNORE = "data-html2canvas-ignore",
currentPage,
modalBody = document.createElement("div");

window.Feedback = function( options ) {

    options = options || {};
    //$.test_msg("window.Feedback", options);
    // default properties
    options.label = options.label || "Send Feedback";
    options.header = options.header || "Send Feedback";
    options.url = options.url || "/";
    options.adapter = options.adapter || new window.Feedback.XHR( options.url );
    
    options.nextLabel = options.nextLabel || "Continue";
    options.reviewLabel = options.reviewLabel || "Review";
    options.sendLabel = options.sendLabel || "Send";
    options.closeLabel = options.closeLabel || "Close";
    
    options.messageSuccess = options.messageSuccess || "Your feedback was sent succesfully.";
    options.messageError = options.messageError || "There was an error sending your feedback to the server.";
    
  
    if (options.pages === undefined ) {
        options.pages = [
            new window.Feedback.Form(),
            new window.Feedback.Screenshot( options ),
            new window.Feedback.Review()
        ];
    }

    var button,
    modal,
    currentPage,
    glass = document.createElement("div"),
    returnMethods = {

        // open send feedback modal window
        open: function() {
            var len = options.pages.length;
            currentPage = 0;
            for (; currentPage < len; currentPage++) {
                // create DOM for each page in the wizard
                if ( !(options.pages[ currentPage ] instanceof window.Feedback.Review) ) {
                    options.pages[ currentPage ].render();
                }
            }

            var a = element("a", "×"),
            modalHeader = document.createElement("div"),
            // modal container
            modalFooter = document.createElement("div");

            modal = document.createElement("div");
            document.body.appendChild( glass );

            // modal close button
            a.className =  "feedback-close";
            a.onclick = returnMethods.close;
            a.href = "#";

            button.disabled = true;

            // build header element
            modalHeader.appendChild( a );
            modalHeader.appendChild( element("h3", options.header ) );
            modalHeader.className =  "feedback-header";

            modalBody.className = "feedback-body";

            emptyElements( modalBody );
            currentPage = 0;
            modalBody.appendChild( options.pages[ currentPage++ ].dom );


            // Next button
            nextButton = element( "button", options.nextLabel );

            nextButton.className =  "feedback-btn";
            nextButton.onclick = function() {
                
                if (currentPage > 0 ) {
                    if ( options.pages[ currentPage - 1 ].end( modal ) === false ) {
                        // page failed validation, cancel onclick
                        return;
                    }
                }
                
                emptyElements( modalBody );

                if ( currentPage === len ) {
                    returnMethods.send( options.adapter );
                } else {

                    options.pages[ currentPage ].start( modal, modalHeader, modalFooter, nextButton );
                    
                    if ( options.pages[ currentPage ] instanceof window.Feedback.Review ) {
                        // create DOM for review page, based on collected data
                        options.pages[ currentPage ].render( options.pages );
                    }
                    
                    // add page DOM to modal
                    modalBody.appendChild( options.pages[ currentPage++ ].dom );

                    // if last page, change button label to send
                    if ( currentPage === len ) {
                        nextButton.firstChild.nodeValue = options.sendLabel;
                    }
                    
                    // if next page is review page, change button label
                    if ( options.pages[ currentPage ] instanceof window.Feedback.Review ) {   
                        nextButton.firstChild.nodeValue = options.reviewLabel;
                    }
                        

                }

            };

            modalFooter.className = "feedback-footer";
            modalFooter.appendChild( nextButton );


            modal.className =  "feedback-modal";
            modal.setAttribute(H2C_IGNORE, true); // don't render in html2canvas


            modal.appendChild( modalHeader );
            modal.appendChild( modalBody );
            modal.appendChild( modalFooter );

            document.body.appendChild( modal );
        },


        // close modal window
        close: function() {

            button.disabled = false;

            // remove feedback elements
            removeElements( [ modal, glass ] );

            // call end event for current page
            if (currentPage > 0 ) {
                options.pages[ currentPage - 1 ].end( modal );
            }
                
            // call close events for all pages    
            for (var i = 0, len = options.pages.length; i < len; i++) {
                options.pages[ i ].close();
            }

            return false;

        },
        
        // send data
        send: function( adapter ) {
            
            // make sure send adapter is of right prototype
            if ( !(adapter instanceof window.Feedback.Send) ) {
                throw new Error( "Adapter is not an instance of Feedback.Send" );
            }
            
            // fetch data from all pages   
            for (var i = 0, len = options.pages.length, data = [], p = 0, tmp; i < len; i++) {
                if ( (tmp = options.pages[ i ].data()) !== false ) {
                    data[ p++ ] = tmp;
                }
            }

            nextButton.disabled = true;
                
            emptyElements( modalBody );
            modalBody.appendChild( loader() );

            // send data to adapter for processing
            adapter.send( data, function( success ) {
                
                emptyElements( modalBody );
                nextButton.disabled = false;
                
                nextButton.firstChild.nodeValue = options.closeLabel;
                
                nextButton.onclick = function() {
                    returnMethods.close();
                    return false;  
                };
                
                if ( success === true ) {
                    modalBody.appendChild( document.createTextNode( options.messageSuccess ) );
                } else {
                    modalBody.appendChild( document.createTextNode( options.messageError ) );
                }
                
            } );
  
        }
    };

    glass.className = "feedback-glass";
    glass.style.pointerEvents = "none";
    glass.setAttribute(H2C_IGNORE, true);

    options = options || {};

    button = element( "button", options.label );
    button.className = "feedback-btn feedback-bottom-right KALS";

    button.setAttribute(H2C_IGNORE, true);

    button.onclick = returnMethods.open;
    
    if ( options.appendTo !== null ) {
        ((options.appendTo !== undefined) ? options.appendTo : document.body).appendChild( button );
    }
    
    return returnMethods;
};
window.Feedback.Page = function() {};
window.Feedback.Page.prototype = {

    render: function( dom ) {
        this.dom = dom;
    },
    start: function() {},
    close: function() {},
    data: function() {
        // don't collect data from page by default
        return false;
    },
    review: function() {
        return null;
    },
    end: function() { return true; }

};
window.Feedback.Send = function() {};
window.Feedback.Send.prototype = {

    send: function() {}

};

window.Feedback.Form = function( elements ) {

    var _issue_label = "Please describe the issue you are experiencing";
    if (typeof(KALS_context) === "object" 
            && typeof(KALS_context.lang) === "object" 
            && typeof(KALS_context.lang.line) === "function" ) {
        _issue_label = KALS_context.lang.line("feedback.ui.issueLabel");
    }

    this.elements = elements || [{
        type: "textarea",
        name: "Issue",
        label: _issue_label,
        required: false
    }];

    this.dom = document.createElement("div");

};

window.Feedback.Form.prototype = new window.Feedback.Page();

window.Feedback.Form.prototype.render = function() {

    var i = 0, len = this.elements.length, item;
    emptyElements( this.dom );
    for (; i < len; i++) {
        item = this.elements[ i ];

        switch( item.type ) {
            case "textarea":
                this.dom.appendChild( element("label", item.label + ":" + (( item.required === true ) ? " *" : "")) );
                this.dom.appendChild( ( item.element = document.createElement("textarea")) );
                break;
        }
    }

    return this;

};

window.Feedback.Form.prototype.end = function() {
    // form validation  
    var i = 0, len = this.elements.length, item;
    for (; i < len; i++) {
        item = this.elements[ i ];

        // check that all required fields are entered
        if ( item.required === true && item.element.value.length === 0) {
            item.element.className = "feedback-error";
            return false;
        } else {
            item.element.className = "";
        }
    }
    
    return true;
    
};

window.Feedback.Form.prototype.data = function() {
    
    if ( this._data !== undefined ) {
        // return cached value
        return this._data;
    }
    
    var i = 0, len = this.elements.length, item, data = {};
    
    for (; i < len; i++) {
        item = this.elements[ i ];
        data[ item.name ] = item.element.value;
    }
    
    // cache and return data
    return ( this._data = data );
};


window.Feedback.Form.prototype.review = function( dom ) {
  
    var i = 0, item, len = this.elements.length;
      
    for (; i < len; i++) {
        item = this.elements[ i ];
        
        if (item.element.value.length > 0) {
            
            var _item_name = item.name;
            if (_item_name === "Issue") {
                if (typeof(KALS_context) === "object" 
                        && typeof(KALS_context.lang) === "object" 
                        && typeof(KALS_context.lang.line) === "function" ) {
                    _item_name = KALS_context.lang.line("feedback.ui.sendLabel");
                }
            }
            
            dom.appendChild( element("label", _item_name + ":") );
            dom.appendChild( document.createTextNode( item.element.value ) );
            //dom.appendChild( document.createElement( "hr" ) );
            dom.appendChild( document.createElement( "br" ) );
        }
		
        //dom.appendChild( element("label", "Browser" + ":") );
        //dom.appendChild( document.createTextNode( $.browser.version ) );
        //dom.appendChild( document.createElement( "hr" ) );
        
        
        var _client_browser_label = "Client Browser";
        if (typeof(KALS_context) === "object" 
                && typeof(KALS_context.lang) === "object" 
                && typeof(KALS_context.lang.line) === "function" ) {
            _client_browser_label = KALS_context.lang.line("feedback.ui.client_browser");
        }

        
        dom.appendChild( element("label", _client_browser_label + ":") );
        dom.appendChild( element("div", navigator.appVersion) );
        //dom.appendChild( document.createTextNode( navigator.appVersion ) );
        //dom.appendChild( document.createTextNode( navigator.appVersion ) );
        
        dom.appendChild( document.createElement( "br" ) );
        //dom.appendChild( document.createElement( "hr" ) );
        
    }
    
    return dom;
     
};
window.Feedback.Review = function() {

    this.dom = document.createElement("div");
    this.dom.className = "feedback-review";

};

window.Feedback.Review.prototype = new window.Feedback.Page();

window.Feedback.Review.prototype.render = function( pages ) {

    var i = 0, len = pages.length, item;
    emptyElements( this.dom );
    
    for (; i < len; i++) {
        
        // get preview DOM items
        pages[ i ].review( this.dom );

    }

    return this;

};




window.Feedback.Screenshot = function( options ) {
    this.options = options || {};

    this.options.blackoutClass = this.options.blackoutClass || 'feedback-blackedout';
    this.options.highlightClass = this.options.highlightClass || 'feedback-highlighted';

    this.h2cDone = false;
};

window.Feedback.Screenshot.prototype = new window.Feedback.Page();

window.Feedback.Screenshot.prototype.end = function( modal ){
    modal.className = modal.className.replace(/feedback\-animate\-toside/, "");

    // remove event listeners
    document.body.removeEventListener("mousemove", this.mouseMoveEvent, false);
    document.body.removeEventListener("click", this.mouseClickEvent, false);

    removeElements( [this.h2cCanvas] );

    this.h2cDone = false;

};

window.Feedback.Screenshot.prototype.close = function(){
    removeElements( [ this.blackoutBox, this.highlightContainer, this.highlightBox, this.highlightClose ] );

    removeElements( document.getElementsByClassName( this.options.blackoutClass ) );
    removeElements( document.getElementsByClassName( this.options.highlightClass ) );

};

window.Feedback.Screenshot.prototype.start = function( modal, modalHeader, modalFooter, nextButton ) {

    if ( this.h2cDone ) {
        emptyElements( this.dom );
        nextButton.disabled = false;
        
        var $this = this,
        feedbackHighlightElement = "feedback-highlight-element",
        dataExclude = "data-exclude";

        var action = true;
        
        var _blackout_label = "Blackout";
        var _highlight_label = "Highlight";
        if (typeof(KALS_context) === "object" 
                && typeof(KALS_context.lang) === "object" 
                && typeof(KALS_context.lang.line) === "function" ) {
            _blackout_label = KALS_context.lang.line("feedback.ui.blackout");
            _highlight_label = KALS_context.lang.line("feedback.ui.highlight");
        }


        // delegate mouse move event for body
        this.mouseMoveEvent = function( e ) {

            // set close button
            if ( e.target !== previousElement && (e.target.className.indexOf( $this.options.blackoutClass ) !== -1 || e.target.className.indexOf( $this.options.highlightClass ) !== -1)) {

                var left = (parseInt(e.target.style.left, 10) +  parseInt(e.target.style.width, 10));
                left = Math.max( left, 10 );

                left = Math.min( left, window.innerWidth - 15 );

                var top = (parseInt(e.target.style.top, 10));
                top = Math.max( top, 10 );

                highlightClose.style.left = left + "px";
                highlightClose.style.top = top + "px";
                removeElement = e.target;
                clearBox();
                previousElement = undefined;
                return;
            }

            // don't do anything if we are highlighting a close button or body tag
            if (e.target.nodeName === "BODY" ||  e.target === highlightClose || e.target === modal || e.target === nextButton || e.target.parentNode === modal || e.target.parentNode === modalHeader) {
                // we are not gonna blackout the whole page or the close item
                clearBox();
                previousElement = e.target;
                return;
            }

            hideClose();

            if (e.target !== previousElement ) {
                previousElement = e.target;

                window.clearTimeout( timer );

                timer = window.setTimeout(function(){
                    var bounds = getBounds( previousElement ),
                    item;

                    if ( action === false ) {
                        item = blackoutBox;
                    } else {
                        item = highlightBox;
                        item.width = bounds.width;
                        item.height = bounds.height;
                        ctx.drawImage($this.h2cCanvas, window.pageXOffset + bounds.left, window.pageYOffset + bounds.top, bounds.width, bounds.height, 0, 0, bounds.width, bounds.height );
                    }

                    // we are only targetting IE>=9, so window.pageYOffset works fine
                    item.setAttribute(dataExclude, false);
                    item.style.left = window.pageXOffset + bounds.left + "px";
                    item.style.top = window.pageYOffset + bounds.top + "px";
                    item.style.width = bounds.width + "px";
                    item.style.height = bounds.height + "px";
                }, 100);



            }


        };


        // delegate event for body click
        this.mouseClickEvent = function( e ){

            e.preventDefault();


            if ( action === false) {
                if ( blackoutBox.getAttribute(dataExclude) === "false") {
                    var blackout = document.createElement("div");
                    blackout.className = $this.options.blackoutClass;
                    blackout.style.left = blackoutBox.style.left;
                    blackout.style.top = blackoutBox.style.top;
                    blackout.style.width = blackoutBox.style.width;
                    blackout.style.height = blackoutBox.style.height;

                    document.body.appendChild( blackout );
                    previousElement = undefined;
                }
            } else {
                if ( highlightBox.getAttribute(dataExclude) === "false") {

                    highlightBox.className += " " + $this.options.highlightClass;
                    highlightBox.className = highlightBox.className.replace(/feedback\-highlight\-element/g,"");
                    $this.highlightBox = highlightBox = document.createElement('canvas');

                    ctx = highlightBox.getContext("2d");

                    highlightBox.className += " " + feedbackHighlightElement;

                    document.body.appendChild( highlightBox );
                    clearBox();
                    previousElement = undefined;
                }
            }



        };

        this.highlightClose = element("div", "×");
        this.blackoutBox = document.createElement('div');
        this.highlightBox = document.createElement( "canvas" );
        this.highlightContainer = document.createElement('div');
        var timer,
        highlightClose = this.highlightClose,
        highlightBox = this.highlightBox,
        blackoutBox = this.blackoutBox,
        highlightContainer = this.highlightContainer,
        removeElement,
        ctx = highlightBox.getContext("2d"),
        buttonClickFunction = function( e ) {
            e.preventDefault();
            
            if (blackoutButton.className.indexOf("active") === -1) {
                blackoutButton.className += " active";
                highlightButton.className = highlightButton.className.replace(/active/g,"");
            } else {
                highlightButton.className += " active";
                blackoutButton.className = blackoutButton.className.replace(/active/g,"");
            }

            action = !action;
        },
        clearBox = function() {
            
            clearBoxEl(blackoutBox);
            clearBoxEl(highlightBox);

            window.clearTimeout( timer );
        },
        clearBoxEl = function( el ) {
            el.style.left =  "-5px";
            el.style.top =  "-5px";
            el.style.width = "0px";
            el.style.height = "0px";
            el.setAttribute(dataExclude, true);
        },
        hideClose = function() {
            highlightClose.style.left =  "-50px";
            highlightClose.style.top =  "-50px";

        },
        blackoutButton = element("a", _blackout_label),
        highlightButton = element("a", _highlight_label),
        previousElement;


        modal.className += ' feedback-animate-toside';


        highlightClose.id = "feedback-highlight-close";


        highlightClose.addEventListener("click", function(){
            removeElement.parentNode.removeChild( removeElement );
            hideClose();
        }, false);

        document.body.appendChild( highlightClose );


        this.h2cCanvas.className = 'feedback-canvas';
        document.body.appendChild( this.h2cCanvas);


        var buttonItem = [ highlightButton, blackoutButton ];

        var _draw_label = "Highlight or blackout important information";
        if (typeof(KALS_context) === "object" 
                && typeof(KALS_context.lang) === "object" 
                && typeof(KALS_context.lang.line) === "function" ) {
            _draw_label = KALS_context.lang.line("feedback.ui.screenshot_hint");
        }
        this.dom.appendChild( element("p", _draw_label) );

        // add highlight and blackout buttons
        for (var i = 0; i < 2; i++ ) {
            buttonItem[ i ].className = 'feedback-btn feedback-btn-small ' + (i === 0 ? 'active' : 'feedback-btn-inverse');

            buttonItem[ i ].href = "#";
            buttonItem[ i ].onclick = buttonClickFunction;

            this.dom.appendChild( buttonItem[ i ] );

            this.dom.appendChild( document.createTextNode(" ") );

        }



        highlightContainer.id = "feedback-highlight-container";
        highlightContainer.style.width = this.h2cCanvas.width + "px";
        highlightContainer.style.height = this.h2cCanvas.height + "px";

        this.highlightBox.className += " " + feedbackHighlightElement;
        this.blackoutBox.id = "feedback-blackout-element";
        document.body.appendChild( this.highlightBox );
        highlightContainer.appendChild( this.blackoutBox );

        document.body.appendChild( highlightContainer );

        // bind mouse delegate events
        document.body.addEventListener("mousemove", this.mouseMoveEvent, false);
        document.body.addEventListener("click", this.mouseClickEvent, false);

    } else {
        // still loading html2canvas
        var args = arguments,
        $this = this;

        if ( nextButton.disabled !== true) {
            this.dom.appendChild( loader() );
        }

        nextButton.disabled = true;

        window.setTimeout(function(){
            $this.start.apply( $this, args );
        }, 500);
    }

};

window.Feedback.Screenshot.prototype.render = function() {

    this.dom = document.createElement("div");

    // execute the html2canvas script
    var script,
    $this = this,
    options = this.options,
    runH2c = function(){
        try {

            options.onrendered = options.onrendered || function( canvas ) {
                $this.h2cCanvas = canvas;
                $this.h2cDone = true;
            };

            window.html2canvas([ document.body ], options);

        } catch( e ) {

            $this.h2cDone = true;
            log("Error in html2canvas: " + e.message);
        }
    };

    if ( window.html2canvas === undefined && script === undefined ) {

        // let's load html2canvas library while user is writing message

        script = document.createElement("script");
        script.src = options.h2cPath || "libs/html2canvas.js";
        script.onerror = function() {
            log("Failed to load html2canvas library, check that the path is correctly defined");
        };

        script.onload = (scriptLoader)(script, function() {

            if (window.html2canvas === undefined) {
                log("Loaded html2canvas, but library not found");
                return;
            }

            window.html2canvas.logging = window.Feedback.debug;
            runH2c();


        });

        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(script, s);

    } else {
        // html2canvas already loaded, just run it then
        runH2c();
    }

    return this;
};

window.Feedback.Screenshot.prototype.data = function() {

    if ( this._data !== undefined ) {
        return this._data;
    }

    if ( this.h2cCanvas !== undefined ) {
      
        var ctx = this.h2cCanvas.getContext("2d"),
        canvasCopy,
        copyCtx,
        radius = 5;
        ctx.fillStyle = "#000";

        // draw blackouts
        Array.prototype.slice.call( document.getElementsByClassName('feedback-blackedout'), 0).forEach( function( item ) {
            var bounds = getBounds( item );
            ctx.fillRect( bounds.left, bounds.top, bounds.width, bounds.height );
        });

        // draw highlights
        var items = Array.prototype.slice.call( document.getElementsByClassName('feedback-highlighted'), 0);

        if (items.length > 0 ) {

            // copy canvas
            canvasCopy = document.createElement( "canvas" );
            copyCtx = canvasCopy.getContext('2d');
            canvasCopy.width = this.h2cCanvas.width;
            canvasCopy.height = this.h2cCanvas.height;

            copyCtx.drawImage( this.h2cCanvas, 0, 0 );

            ctx.fillStyle = "#777";
            ctx.globalAlpha = 0.5;
            ctx.fillRect( 0, 0, this.h2cCanvas.width, this.h2cCanvas.height );

            ctx.beginPath();

            items.forEach( function( item ) {

                var x = parseInt(item.style.left, 10),
                y = parseInt(item.style.top, 10),
                width = parseInt(item.style.width, 10),
                height = parseInt(item.style.height, 10);

                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                ctx.lineTo(x + radius, y + height);
                ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
               
            });
            ctx.closePath();
            ctx.clip();

            ctx.globalAlpha = 1;

            ctx.drawImage(canvasCopy, 0,0);
   
        }
        
        // to avoid security error break for tainted canvas   
        try {
            // cache and return data
            return ( this._data = this.h2cCanvas.toDataURL() );
        } catch( e ) {}
        
    }
};


window.Feedback.Screenshot.prototype.review = function( dom ) {
  
    var data = this.data();
    if ( data !== undefined ) {
        var img = new Image();
        img.src = data;
        img.style.width = "300px";
        
        dom.insertBefore(img,dom.childNodes[0]);
        //dom.appendChild( img );
    }
    
};
window.Feedback.XHR = function( url ) {
    
    this.xhr = new XMLHttpRequest();
    this.url = url;

};

window.Feedback.XHR.prototype = new window.Feedback.Send();

window.Feedback.XHR.prototype.send = function( data, callback ) {
    
    var xhr = this.xhr;
    
    xhr.onreadystatechange = function() {
        if( xhr.readyState === 4 ){
            callback( (xhr.status === 200) );
        }
    };
	
    //data[0].browser = $.browser;
    data[0].browser = navigator.appVersion;
    data[0].receiver_email = null;
    /**
     * @version 20140515 Pulipuli Chen
     * 加上接收者email的設定，只能設定一位
     */
    if (typeof(KALS_CONFIG) === "object" 
            && typeof(KALS_CONFIG.modules) === "object" 
            && typeof(KALS_CONFIG.modules.Feedback_manager) === "object" 
            && typeof(KALS_CONFIG.modules.Feedback_manager.receiver_email) !== "undefined" ) {
        //alert(KALS_CONFIG.modules.Feedback_manager.receiver_email);
        data[0].receiver_email = KALS_CONFIG.modules.Feedback_manager.receiver_email;
    }
    
    //console.log(window.JSON.stringify( data ));
    
    xhr.open( "POST", this.url, true);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhr.send( "data=" + encodeURIComponent( window.JSON.stringify( data ) ) );
     
};
})( window, document );
/**
  @license html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
 */
(function(window, document, undefined){

/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
 */
"use strict";

var _html2canvas = {},
previousElement,
computedCSS,
html2canvas;


function h2clog(a) {
    if (_html2canvas.logging && window.console && window.console.log) {
        window.console.log(a);
    }
}

_html2canvas.Util = {};

_html2canvas.Util.backgroundImage = function (src) {

    if (/data:image\/.*;base64,/i.test( src ) || /^(-webkit|-moz|linear-gradient|-o-)/.test( src )) {
        return src;
    }

    if (src.toLowerCase().substr( 0, 5 ) === 'url("') {
        src = src.substr( 5 );
        src = src.substr( 0, src.length - 2 );
    } else {
        src = src.substr( 4 );
        src = src.substr( 0, src.length - 1 );
    }

    return src;
};

_html2canvas.Util.Bounds = function getBounds (el) {
    var clientRect,
    bounds = {};

    if (el.getBoundingClientRect){
        clientRect = el.getBoundingClientRect();


        // TODO add scroll position to bounds, so no scrolling of window necessary
        bounds.top = clientRect.top;
        bounds.bottom = clientRect.bottom || (clientRect.top + clientRect.height);
        bounds.left = clientRect.left;

        // older IE doesn't have width/height, but top/bottom instead
        bounds.width = clientRect.width || (clientRect.right - clientRect.left);
        bounds.height = clientRect.height || (clientRect.bottom - clientRect.top);

        return bounds;

    }
};

_html2canvas.Util.getCSS = function (el, attribute) {
    // return $(el).css(attribute);

    var val;

    function toPX( attribute, val ) {
        var rsLeft = el.runtimeStyle && el.runtimeStyle[ attribute ],
        left,
        style = el.style;

        // Check if we are not dealing with pixels, (Opera has issues with this)
        // Ported from jQuery css.js
        // From the awesome hack by Dean Edwards
        // http://erik.eae.net/archives/2007/07/27/18.54.15/#comment-102291

        // If we're not dealing with a regular pixel number
        // but a number that has a weird ending, we need to convert it to pixels

        if ( !/^-?[0-9]+\.?[0-9]*(?:px)?$/i.test( val ) && /^-?\d/.test( val ) ) {

            // Remember the original values
            left = style.left;

            // Put in the new values to get a computed value out
            if ( rsLeft ) {
                el.runtimeStyle.left = el.currentStyle.left;
            }
            style.left = attribute === "fontSize" ? "1em" : (val || 0);
            val = style.pixelLeft + "px";

            // Revert the changed values
            style.left = left;
            if ( rsLeft ) {
                el.runtimeStyle.left = rsLeft;
            }

        }

        if (!/^(thin|medium|thick)$/i.test( val )) {
            return Math.round(parseFloat( val )) + "px";
        }

        return val;

    }


    if ( window.getComputedStyle ) {
        if ( previousElement !== el ) {
            computedCSS = document.defaultView.getComputedStyle(el, null);
        }
        val = computedCSS[ attribute ];

        if ( attribute === "backgroundPosition" ) {

            val = (val.split(",")[0] || "0 0").split(" ");

            val[ 0 ] = ( val[0].indexOf( "%" ) === -1 ) ? toPX(  attribute + "X", val[ 0 ] ) : val[ 0 ];
            val[ 1 ] = ( val[1] === undefined ) ? val[0] : val[1]; // IE 9 doesn't return double digit always
            val[ 1 ] = ( val[1].indexOf( "%" ) === -1 ) ? toPX(  attribute + "Y", val[ 1 ] ) : val[ 1 ];
        } else if ( /border(Top|Bottom)(Left|Right)Radius/.test( attribute) ) {
            var arr = val.split(" ");
            if ( arr.length <= 1 ) {
                arr[ 1 ] = arr[ 0 ];
            }
            arr[ 0 ] = parseInt( arr[ 0 ], 10 );
            arr[ 1 ] = parseInt( arr[ 1 ], 10 );
            val = arr;
        }

    } else if ( el.currentStyle ) {
        // IE 9>
        if (attribute === "backgroundPosition") {
            // Older IE uses -x and -y
            val = [ toPX(  attribute + "X", el.currentStyle[ attribute + "X" ]  ), toPX(  attribute + "Y", el.currentStyle[ attribute + "Y" ]  ) ];
        } else {

            val = toPX(  attribute, el.currentStyle[ attribute ]  );

            if (/^(border)/i.test( attribute ) && /^(medium|thin|thick)$/i.test( val )) {
                switch (val) {
                    case "thin":
                        val = "1px";
                        break;
                    case "medium":
                        val = "0px"; // this is wrong, it should be 3px but IE uses medium for no border as well.. TODO find a work around
                        break;
                    case "thick":
                        val = "5px";
                        break;
                }
            }
        }



    }




    return val;



//return $(el).css(attribute);


};


_html2canvas.Util.BackgroundPosition = function ( el, bounds, image ) {
    // TODO add support for multi image backgrounds

    var bgposition =  _html2canvas.Util.getCSS( el, "backgroundPosition" ) ,
    topPos,
    left,
    percentage,
    val;

    if (bgposition.length === 1){
        val = bgposition;

        bgposition = [];

        bgposition[0] = val;
        bgposition[1] = val;
    }



    if (bgposition[0].toString().indexOf("%") !== -1){
        percentage = (parseFloat(bgposition[0])/100);
        left =  ((bounds.width * percentage)-(image.width*percentage));

    }else{
        left = parseInt(bgposition[0],10);
    }

    if (bgposition[1].toString().indexOf("%") !== -1){

        percentage = (parseFloat(bgposition[1])/100);
        topPos =  ((bounds.height * percentage)-(image.height*percentage));
    }else{
        topPos = parseInt(bgposition[1],10);
    }




    return {
        top: topPos,
        left: left
    };

};

_html2canvas.Util.Extend = function (options, defaults) {
    for (var key in options) {
        if (options.hasOwnProperty(key)) {
            defaults[key] = options[key];
        }
    }
    return defaults;
};


/*
 * Derived from jQuery.contents()
 * Copyright 2010, John Resig
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 */
_html2canvas.Util.Children = function( elem ) {


    var children;
    try {

        children = (elem.nodeName && elem.nodeName.toUpperCase() === "IFRAME") ?
        elem.contentDocument || elem.contentWindow.document : (function( array ){
            var ret = [];

            if ( array !== null ) {

                (function( first, second ) {
                    var i = first.length,
                    j = 0;

                    if ( typeof second.length === "number" ) {
                        for ( var l = second.length; j < l; j++ ) {
                            first[ i++ ] = second[ j ];
                        }

                    } else {
                        while ( second[j] !== undefined ) {
                            first[ i++ ] = second[ j++ ];
                        }
                    }

                    first.length = i;

                    return first;
                })( ret, array );

            }

            return ret;
        })( elem.childNodes );

    } catch (ex) {
        h2clog("html2canvas.Util.Children failed with exception: " + ex.message);
        children = [];
    }
    return children;
};

/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Contributor(s):
      Niklas von Hertzen <http://www.twitter.com/niklasvh>
      André Fiedler      <http://www.twitter.com/sonnenkiste>

  Released under MIT License
 */

(function(){

_html2canvas.Generate = {};

var reGradients = [
    /^(-webkit-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,
    /^(-o-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,
    /^(-webkit-gradient)\((linear|radial),\s((?:\d{1,3}%?)\s(?:\d{1,3}%?),\s(?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)-]+)\)$/,
    /^(-moz-linear-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)]+)\)$/,
    /^(-webkit-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z-]+)([\w\d\.\s,%\(\)]+)\)$/,
    /^(-moz-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s?([a-z-]*)([\w\d\.\s,%\(\)]+)\)$/,
    /^(-o-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z-]+)([\w\d\.\s,%\(\)]+)\)$/
];

/*
 * TODO: Add IE10 vendor prefix (-ms) support
 * TODO: Add W3C gradient (linear-gradient) support
 * TODO: Add old Webkit -webkit-gradient(radial, ...) support
 * TODO: Maybe some RegExp optimizations are possible ;o)
 */
_html2canvas.Generate.parseGradient = function(css, bounds) {
    var gradient, i, len = reGradients.length, m1, stop, m2, m2Len, step, m3;

    for(i = 0; i < len; i+=1){
        m1 = css.match(reGradients[i]);
        if(m1) break;
    }

    if(m1) {
        switch(m1[1]) {
            case '-webkit-linear-gradient':
            case '-o-linear-gradient':

                gradient = {
                    type: 'linear',
                    x0: null,
                    y0: null,
                    x1: null,
                    y1: null,
                    colorStops: []
                };

                // get coordinates
                m2 = m1[2].match(/\w+/g);
                if(m2){
                    m2Len = m2.length;
                    for(i = 0; i < m2Len; i+=1){
                        switch(m2[i]) {
                            case 'top':
                                gradient.y0 = 0;
                                gradient.y1 = bounds.height;
                                break;

                            case 'right':
                                gradient.x0 = bounds.width;
                                gradient.x1 = 0;
                                break;

                            case 'bottom':
                                gradient.y0 = bounds.height;
                                gradient.y1 = 0;
                                break;

                            case 'left':
                                gradient.x0 = 0;
                                gradient.x1 = bounds.width;
                                break;
                        }
                    }
                }
                if(gradient.x0 === null && gradient.x1 === null){ // center
                    gradient.x0 = gradient.x1 = bounds.width / 2;
                }
                if(gradient.y0 === null && gradient.y1 === null){ // center
                    gradient.y0 = gradient.y1 = bounds.height / 2;
                }

                // get colors and stops
                m2 = m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);
                if(m2){
                    m2Len = m2.length;
                    step = 1 / Math.max(m2Len - 1, 1);
                    for(i = 0; i < m2Len; i+=1){
                        m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);
                        if(m3[2]){
                            stop = parseFloat(m3[2]);
                            if(m3[3] === '%'){
                                stop /= 100;
                            } else { // px - stupid opera
                                stop /= bounds.width;
                            }
                        } else {
                            stop = i * step;
                        }
                        gradient.colorStops.push({
                            color: m3[1],
                            stop: stop
                        });
                    }
                }
                break;

            case '-webkit-gradient':

                gradient = {
                    type: m1[2] === 'radial' ? 'circle' : m1[2], // TODO: Add radial gradient support for older mozilla definitions
                    x0: 0,
                    y0: 0,
                    x1: 0,
                    y1: 0,
                    colorStops: []
                };

                // get coordinates
                m2 = m1[3].match(/(\d{1,3})%?\s(\d{1,3})%?,\s(\d{1,3})%?\s(\d{1,3})%?/);
                if(m2){
                    gradient.x0 = (m2[1] * bounds.width) / 100;
                    gradient.y0 = (m2[2] * bounds.height) / 100;
                    gradient.x1 = (m2[3] * bounds.width) / 100;
                    gradient.y1 = (m2[4] * bounds.height) / 100;
                }

                // get colors and stops
                m2 = m1[4].match(/((?:from|to|color-stop)\((?:[0-9\.]+,\s)?(?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)\))+/g);
                if(m2){
                    m2Len = m2.length;
                    for(i = 0; i < m2Len; i+=1){
                        m3 = m2[i].match(/(from|to|color-stop)\(([0-9\.]+)?(?:,\s)?((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\)/);
                        stop = parseFloat(m3[2]);
                        if(m3[1] === 'from') stop = 0.0;
                        if(m3[1] === 'to') stop = 1.0;
                        gradient.colorStops.push({
                            color: m3[3],
                            stop: stop
                        });
                    }
                }
                break;

            case '-moz-linear-gradient':

                gradient = {
                    type: 'linear',
                    x0: 0,
                    y0: 0,
                    x1: 0,
                    y1: 0,
                    colorStops: []
                };

                // get coordinates
                m2 = m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);

                // m2[1] == 0%   -> left
                // m2[1] == 50%  -> center
                // m2[1] == 100% -> right

                // m2[2] == 0%   -> top
                // m2[2] == 50%  -> center
                // m2[2] == 100% -> bottom

                if(m2){
                    gradient.x0 = (m2[1] * bounds.width) / 100;
                    gradient.y0 = (m2[2] * bounds.height) / 100;
                    gradient.x1 = bounds.width - gradient.x0;
                    gradient.y1 = bounds.height - gradient.y0;
                }

                // get colors and stops
                m2 = m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}%)?)+/g);
                if(m2){
                    m2Len = m2.length;
                    step = 1 / Math.max(m2Len - 1, 1);
                    for(i = 0; i < m2Len; i+=1){
                        m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%)?/);
                        if(m3[2]){
                            stop = parseFloat(m3[2]);
                            if(m3[3]){ // percentage
                                stop /= 100;
                            }
                        } else {
                            stop = i * step;
                        }
                        gradient.colorStops.push({
                            color: m3[1],
                            stop: stop
                        });
                    }
                }
                break;

            case '-webkit-radial-gradient':
            case '-moz-radial-gradient':
            case '-o-radial-gradient':

                gradient = {
                    type: 'circle',
                    x0: 0,
                    y0: 0,
                    x1: bounds.width,
                    y1: bounds.height,
                    cx: 0,
                    cy: 0,
                    rx: 0,
                    ry: 0,
                    colorStops: []
                };

                // center
                m2 = m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);
                if(m2){
                    gradient.cx = (m2[1] * bounds.width) / 100;
                    gradient.cy = (m2[2] * bounds.height) / 100;
                }

                // size
                m2 = m1[3].match(/\w+/);
                m3 = m1[4].match(/[a-z-]*/);
                if(m2 && m3){
                    switch(m3[0]){
                        case 'farthest-corner':
                        case 'cover': // is equivalent to farthest-corner
                        case '': // mozilla removes "cover" from definition :(
                            var tl = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.cy, 2));
                            var tr = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                            var br = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                            var bl = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.cy, 2));
                            gradient.rx = gradient.ry = Math.max(tl, tr, br, bl);
                            break;
                        case 'closest-corner':
                            var tl = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.cy, 2));
                            var tr = Math.sqrt(Math.pow(gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                            var br = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.y1 - gradient.cy, 2));
                            var bl = Math.sqrt(Math.pow(gradient.x1 - gradient.cx, 2) + Math.pow(gradient.cy, 2));
                            gradient.rx = gradient.ry = Math.min(tl, tr, br, bl);
                            break;
                        case 'farthest-side':
                            if(m2[0] === 'circle'){
                                gradient.rx = gradient.ry = Math.max(
                                    gradient.cx,
                                    gradient.cy,
                                    gradient.x1 - gradient.cx,
                                    gradient.y1 - gradient.cy
                                );
                            } else { // ellipse

                                gradient.type = m2[0];

                                gradient.rx = Math.max(
                                    gradient.cx,
                                    gradient.x1 - gradient.cx
                                );
                                gradient.ry = Math.max(
                                    gradient.cy,
                                    gradient.y1 - gradient.cy
                                );
                            }
                            break;
                        case 'closest-side':
                        case 'contain': // is equivalent to closest-side
                            if(m2[0] === 'circle'){
                                gradient.rx = gradient.ry = Math.min(
                                    gradient.cx,
                                    gradient.cy,
                                    gradient.x1 - gradient.cx,
                                    gradient.y1 - gradient.cy
                                );
                            } else { // ellipse

                                gradient.type = m2[0];

                                gradient.rx = Math.min(
                                    gradient.cx,
                                    gradient.x1 - gradient.cx
                                );
                                gradient.ry = Math.min(
                                    gradient.cy,
                                    gradient.y1 - gradient.cy
                                );
                            }
                            break;

                        // TODO: add support for "30px 40px" sizes (webkit only)
                    }
                }

                // color stops
                m2 = m1[5].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);
                if(m2){
                    m2Len = m2.length;
                    step = 1 / Math.max(m2Len - 1, 1);
                    for(i = 0; i < m2Len; i+=1){
                        m3 = m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);
                        if(m3[2]){
                            stop = parseFloat(m3[2]);
                            if(m3[3] === '%'){
                                stop /= 100;
                            } else { // px - stupid opera
                                stop /= bounds.width;
                            }
                        } else {
                            stop = i * step;
                        }
                        gradient.colorStops.push({
                            color: m3[1],
                            stop: stop
                        });
                    }
                }
                break;
        }
    }

    return gradient;
};

_html2canvas.Generate.Gradient = function(src, bounds) {
    var canvas = document.createElement('canvas'),
    ctx = canvas.getContext('2d'),
    gradient, grad, i, len, img;

    canvas.width = bounds.width;
    canvas.height = bounds.height;

    // TODO: add support for multi defined background gradients (like radial gradient example in background.html)
    gradient = _html2canvas.Generate.parseGradient(src, bounds);

    img = new Image();

    if(gradient){
        if(gradient.type === 'linear'){
            grad = ctx.createLinearGradient(gradient.x0, gradient.y0, gradient.x1, gradient.y1);

            for (i = 0, len = gradient.colorStops.length; i < len; i+=1) {
                try {
                    grad.addColorStop(gradient.colorStops[i].stop, gradient.colorStops[i].color);
                }
                catch(e) {
                    h2clog(['failed to add color stop: ', e, '; tried to add: ', gradient.colorStops[i], '; stop: ', i, '; in: ', src]);
                }
            }

            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, bounds.width, bounds.height);

            img.src = canvas.toDataURL();
        } else if(gradient.type === 'circle'){

            grad = ctx.createRadialGradient(gradient.cx, gradient.cy, 0, gradient.cx, gradient.cy, gradient.rx);

            for (i = 0, len = gradient.colorStops.length; i < len; i+=1) {
                try {
                    grad.addColorStop(gradient.colorStops[i].stop, gradient.colorStops[i].color);
                }
                catch(e) {
                    h2clog(['failed to add color stop: ', e, '; tried to add: ', gradient.colorStops[i], '; stop: ', i, '; in: ', src]);
                }
            }

            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, bounds.width, bounds.height);

            img.src = canvas.toDataURL();
        } else if(gradient.type === 'ellipse'){

            // draw circle
            var canvasRadial = document.createElement('canvas'),
                ctxRadial = canvasRadial.getContext('2d'),
                ri = Math.max(gradient.rx, gradient.ry),
                di = ri * 2, imgRadial;

            canvasRadial.width = canvasRadial.height = di;

            grad = ctxRadial.createRadialGradient(gradient.rx, gradient.ry, 0, gradient.rx, gradient.ry, ri);

            for (i = 0, len = gradient.colorStops.length; i < len; i+=1) {
                try {
                    grad.addColorStop(gradient.colorStops[i].stop, gradient.colorStops[i].color);
                }
                catch(e) {
                    h2clog(['failed to add color stop: ', e, '; tried to add: ', gradient.colorStops[i], '; stop: ', i, '; in: ', src]);
                }
            }

            ctxRadial.fillStyle = grad;
            ctxRadial.fillRect(0, 0, di, di);

            ctx.fillStyle = gradient.colorStops[i - 1].color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            imgRadial = new Image();
            imgRadial.onload = function() { // wait until the image is filled

                // transform circle to ellipse
                ctx.drawImage(imgRadial, gradient.cx - gradient.rx, gradient.cy - gradient.ry, 2 * gradient.rx, 2 * gradient.ry);

                img.src = canvas.toDataURL();

            }
            imgRadial.src = canvasRadial.toDataURL();
        }
    }

    return img;
};

_html2canvas.Generate.ListAlpha = function(number) {
    var tmp = "",
    modulus;

    do {
        modulus = number % 26;
        tmp = String.fromCharCode((modulus) + 64) + tmp;
        number = number / 26;
    }while((number*26) > 26);

    return tmp;
};

_html2canvas.Generate.ListRoman = function(number) {
    var romanArray = ["M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I"],
    decimal = [1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1],
    roman = "",
    v,
    len = romanArray.length;

    if (number <= 0 || number >= 4000) {
        return number;
    }

    for (v=0; v < len; v+=1) {
        while (number >= decimal[v]) {
            number -= decimal[v];
            roman += romanArray[v];
        }
    }

    return roman;

};

})();
/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
 */

/*
 *  New function for traversing elements
 */

_html2canvas.Parse = function ( images, options ) {
    window.scroll(0,0);

    var support = {
        rangeBounds: false,
        svgRendering: options.svgRendering && (function( ){
            var img = new Image(),
            canvas = document.createElement("canvas"),
            ctx = (canvas.getContext === undefined) ? false : canvas.getContext("2d");
            if (ctx === false) {
                // browser doesn't support canvas, good luck supporting SVG on canvas
                return false;
            }
            canvas.width = canvas.height = 10;
            img.src = [
            "data:image/svg+xml,",
            "<svg xmlns='http://www.w3.org/2000/svg' width='10' height='10'>",
            "<foreignObject width='10' height='10'>",
            "<div xmlns='http://www.w3.org/1999/xhtml' style='width:10;height:10;'>",
            "sup",
            "</div>",
            "</foreignObject>",
            "</svg>"
            ].join("");
            try {
                ctx.drawImage(img, 0, 0);
                canvas.toDataURL();
            } catch(e) {
                return false;
            }
            h2clog('html2canvas: Parse: SVG powered rendering available');
            return true;

        })()
    },
    element = (( options.elements === undefined ) ? document.body : options.elements[0]), // select body by default
    needReorder = false,
    numDraws = 0,
    fontData = {},
    doc = element.ownerDocument,
    ignoreElementsRegExp = new RegExp("(" + options.ignoreElements + ")"),
    body = doc.body,
    r,
    testElement,
    rangeBounds,
    rangeHeight,
    stack,
    ctx,
    docDim,
    i,
    children,
    childrenLen;


    function docSize(){

        return {
            width: Math.max(
                Math.max(doc.body.scrollWidth, doc.documentElement.scrollWidth),
                Math.max(doc.body.offsetWidth, doc.documentElement.offsetWidth),
                Math.max(doc.body.clientWidth, doc.documentElement.clientWidth)
                ),
            height: Math.max(
                Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight),
                Math.max(doc.body.offsetHeight, doc.documentElement.offsetHeight),
                Math.max(doc.body.clientHeight, doc.documentElement.clientHeight)
                )
        };

    }

    images = images || {};

    // Test whether we can use ranges to measure bounding boxes
    // Opera doesn't provide valid bounds.height/bottom even though it supports the method.


    if (doc.createRange) {
        r = doc.createRange();
        //this.support.rangeBounds = new Boolean(r.getBoundingClientRect);
        if (r.getBoundingClientRect){
            testElement = doc.createElement('boundtest');
            testElement.style.height = "123px";
            testElement.style.display = "block";
            body.appendChild(testElement);

            r.selectNode(testElement);
            rangeBounds = r.getBoundingClientRect();
            rangeHeight = rangeBounds.height;

            if (rangeHeight === 123) {
                support.rangeBounds = true;
            }
            body.removeChild(testElement);


        }

    }


    /*
    var rootStack = new this.storageContext($(document).width(),$(document).height());
    rootStack.opacity = this.getCSS(this.element,"opacity");
    var stack = this.newElement(this.element,rootStack);


    this.parseElement(this.element,stack);
     */




    var getCSS = _html2canvas.Util.getCSS;
    function getCSSInt(element, attribute) {
        var val = parseInt(getCSS(element, attribute), 10);
        return (isNaN(val)) ? 0 : val; // borders in old IE are throwing 'medium' for demo.html
    }

    // Drawing a rectangle
    function renderRect (ctx, x, y, w, h, bgcolor) {
        if ( bgcolor !== "transparent" ){
            ctx.setVariable("fillStyle", bgcolor);
            ctx.fillRect (x, y, w, h);
            numDraws+=1;
        }
    }


    function textTransform (text, transform) {
        switch(transform){
            case "lowercase":
                return text.toLowerCase();

            case "capitalize":
                return text.replace( /(^|\s|:|-|\(|\))([a-z])/g , function (m, p1, p2) {
                    if (m.length > 0) {
                        return p1 + p2.toUpperCase();
                    }
                } );

            case "uppercase":
                return text.toUpperCase();

            default:
                return text;

        }

    }

    function trimText (text) {
        return text.replace(/^\s*/g, "").replace(/\s*$/g, "");
    }

    function fontMetrics (font, fontSize) {

        if (fontData[font + "-" + fontSize] !== undefined) {
            return fontData[font + "-" + fontSize];
        }


        var container = doc.createElement('div'),
        img = doc.createElement('img'),
        span = doc.createElement('span'),
        baseline,
        middle,
        metricsObj;


        container.style.visibility = "hidden";
        container.style.fontFamily = font;
        container.style.fontSize = fontSize;
        container.style.margin = 0;
        container.style.padding = 0;

        body.appendChild(container);



        // http://probablyprogramming.com/2009/03/15/the-tiniest-gif-ever (handtinywhite.gif)
        img.src = "data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACwAAAAAAQABAAACAkQBADs=";
        img.width = 1;
        img.height = 1;

        img.style.margin = 0;
        img.style.padding = 0;
        img.style.verticalAlign = "baseline";

        span.style.fontFamily = font;
        span.style.fontSize = fontSize;
        span.style.margin = 0;
        span.style.padding = 0;




        span.appendChild(doc.createTextNode('Hidden Text'));
        container.appendChild(span);
        container.appendChild(img);
        baseline = (img.offsetTop - span.offsetTop) + 1;

        container.removeChild(span);
        container.appendChild(doc.createTextNode('Hidden Text'));

        container.style.lineHeight = "normal";
        img.style.verticalAlign = "super";

        middle = (img.offsetTop-container.offsetTop) + 1;
        metricsObj = {
            baseline: baseline,
            lineWidth: 1,
            middle: middle
        };


        fontData[font + "-" + fontSize] = metricsObj;

        body.removeChild(container);

        return metricsObj;

    }


    function drawText(currentText, x, y, ctx){
        if (trimText(currentText).length>0) {
            ctx.fillText(currentText,x,y);
            numDraws+=1;
        }
    }


    function renderText(el, textNode, stack) {
        var ctx = stack.ctx,
        family = getCSS(el, "fontFamily"),
        size = getCSS(el, "fontSize"),
        color = getCSS(el, "color"),
        text_decoration = getCSS(el, "textDecoration"),
        text_align = getCSS(el, "textAlign"),
        letter_spacing = getCSS(el, "letterSpacing"),
        bounds,
        text,
        metrics,
        renderList,
        listLen,
        bold = getCSS(el, "fontWeight"),
        font_style = getCSS(el, "fontStyle"),
        font_variant = getCSS(el, "fontVariant"),
        align = false,
        newTextNode,
        textValue,
        textOffset = 0,
        oldTextNode,
        c,
        range,
        parent,
        wrapElement,
        backupText;

        // apply text-transform:ation to the text



        textNode.nodeValue = textTransform(textNode.nodeValue, getCSS(el, "textTransform"));
        text = trimText(textNode.nodeValue);

        if (text.length>0){

            if (text_decoration !== "none"){
                metrics = fontMetrics(family, size);
            }

            text_align = text_align.replace(["-webkit-auto"],["auto"]);

            if (options.letterRendering === false && /^(left|right|justify|auto)$/.test(text_align) && /^(normal|none)$/.test(letter_spacing)){
                // this.setContextVariable(ctx,"textAlign",text_align);
                renderList = textNode.nodeValue.split(/(\b| )/);

            }else{
                //  this.setContextVariable(ctx,"textAlign","left");
                renderList = textNode.nodeValue.split("");
            }

            switch(parseInt(bold, 10)){
                case 401:
                    bold = "bold";
                    break;
                case 400:
                    bold = "normal";
                    break;
            }

            ctx.setVariable("fillStyle", color);

            /*
              need to be defined in the order as defined in http://www.w3.org/TR/CSS21/fonts.html#font-shorthand
              to properly work in Firefox
             */
            ctx.setVariable("font", font_style+ " " + font_variant  + " " + bold + " " + size + " " + family);

            if (align){
                ctx.setVariable("textAlign", "right");
            }else{
                ctx.setVariable("textAlign", "left");
            }


            /*
        if (stack.clip){
        ctx.rect (stack.clip.left, stack.clip.top, stack.clip.width, stack.clip.height);
        ctx.clip();
        }
             */


            oldTextNode = textNode;


            for ( c=0, listLen = renderList.length; c < listLen; c+=1 ) {
                textValue = null;



                if (support.rangeBounds){
                    // getBoundingClientRect is supported for ranges
                    if (text_decoration !== "none" || trimText(renderList[c]).length !== 0) {
                        textValue = renderList[c];
                        if (doc.createRange){
                            range = doc.createRange();

                            range.setStart(textNode, textOffset);
                            range.setEnd(textNode, textOffset + textValue.length);
                        }else{
                            // TODO add IE support
                            range = body.createTextRange();
                        }

                        if (range.getBoundingClientRect()) {
                            bounds = range.getBoundingClientRect();
                        }else{
                            bounds = {};
                        }

                    }
                }else{
                    // it isn't supported, so let's wrap it inside an element instead and get the bounds there

                    // IE 9 bug
                    if (typeof oldTextNode.nodeValue !== "string" ){
                        continue;
                    }

                    newTextNode = oldTextNode.splitText(renderList[c].length);

                    parent = oldTextNode.parentNode;
                    wrapElement = doc.createElement('wrapper');
                    backupText = oldTextNode.cloneNode(true);

                    wrapElement.appendChild(oldTextNode.cloneNode(true));
                    parent.replaceChild(wrapElement, oldTextNode);

                    bounds = _html2canvas.Util.Bounds(wrapElement);

                    textValue = oldTextNode.nodeValue;

                    oldTextNode = newTextNode;
                    parent.replaceChild(backupText, wrapElement);


                }

                if (textValue !== null){
                    drawText(textValue, bounds.left, bounds.bottom, ctx);
                }

                switch(text_decoration) {
                    case "underline":
                        // Draws a line at the baseline of the font
                        // TODO As some browsers display the line as more than 1px if the font-size is big, need to take that into account both in position and size
                        renderRect(ctx, bounds.left, Math.round(bounds.top + metrics.baseline + metrics.lineWidth), bounds.width, 1, color);
                        break;
                    case "overline":
                        renderRect(ctx, bounds.left, bounds.top, bounds.width, 1, color);
                        break;
                    case "line-through":
                        // TODO try and find exact position for line-through
                        renderRect(ctx, bounds.left, Math.ceil(bounds.top + metrics.middle + metrics.lineWidth), bounds.width, 1, color);
                        break;

                }





                textOffset += renderList[c].length;

            }



        }

    }

    function listPosition (element, val) {
        var boundElement = doc.createElement( "boundelement" ),
        type,
        bounds;

        boundElement.style.display = "inline";
        //boundElement.style.width = "1px";
        //boundElement.style.height = "1px";

        type = element.style.listStyleType;
        element.style.listStyleType = "none";

        boundElement.appendChild( doc.createTextNode( val ) );


        element.insertBefore(boundElement, element.firstChild);


        bounds = _html2canvas.Util.Bounds( boundElement );
        element.removeChild( boundElement );
        element.style.listStyleType = type;
        return bounds;

    }
    

    
    function elementIndex( el ) {
        var i = -1,
        count = 1,
        childs = el.parentNode.childNodes;

        if ( el.parentNode ) {
            while( childs[ ++i ] !== el ) {
                if ( childs[ i ].nodeType === 1 ) {
                    count++;
                }
            }
            return count;
        } else {
            return -1;
        }
       
    }

    function renderListItem(element, stack, elBounds) {


        var position = getCSS(element, "listStylePosition"),
        x,
        y,
        type = getCSS(element, "listStyleType"),
        currentIndex,
        text,
        listBounds,
        bold = getCSS(element, "fontWeight");

        if (/^(decimal|decimal-leading-zero|upper-alpha|upper-latin|upper-roman|lower-alpha|lower-greek|lower-latin|lower-roman)$/i.test(type)) {

            currentIndex = elementIndex( element );

            switch(type){
                case "decimal":
                    text = currentIndex;
                    break;
                case "decimal-leading-zero":
                    if (currentIndex.toString().length === 1){
                        text = currentIndex = "0" + currentIndex.toString();
                    }else{
                        text = currentIndex.toString();
                    }
                    break;
                case "upper-roman":
                    text = _html2canvas.Generate.ListRoman( currentIndex );
                    break;
                case "lower-roman":
                    text = _html2canvas.Generate.ListRoman( currentIndex ).toLowerCase();
                    break;
                case "lower-alpha":
                    text = _html2canvas.Generate.ListAlpha( currentIndex ).toLowerCase();
                    break;
                case "upper-alpha":
                    text = _html2canvas.Generate.ListAlpha( currentIndex );
                    break;
            }


            text += ". ";
            listBounds = listPosition(element, text);



            switch(bold){
                case 401:
                    bold = "bold";
                    break;
                case 400:
                    bold = "normal";
                    break;
            }




            ctx.setVariable( "fillStyle", getCSS(element, "color") );
            ctx.setVariable( "font", getCSS(element, "fontVariant") + " " + bold + " " + getCSS(element, "fontStyle") + " " + getCSS(element, "fontSize") + " " + getCSS(element, "fontFamily") );


            if ( position === "inside" ) {
                ctx.setVariable("textAlign", "left");
                //   this.setFont(stack.ctx, element, false);
                x = elBounds.left;

            }else{
                return;
            /*
                 TODO really need to figure out some more accurate way to try and find the position.
                 as defined in http://www.w3.org/TR/CSS21/generate.html#propdef-list-style-position, it does not even have a specified "correct" position, so each browser
                 may display it whatever way it feels like.
                 "The position of the list-item marker adjacent to floats is undefined in CSS 2.1. CSS 2.1 does not specify the precise location of the marker box or its position in the painting order"

                ctx.setVariable("textAlign", "right");
                //  this.setFont(stack.ctx, element, true);
                x = elBounds.left - 10;
                 */
            }

            y = listBounds.bottom;

            drawText(text, x, y, ctx);


        }


    }

    function loadImage (src){
        var img = images[src];
        if (img && img.succeeded === true) {
            return img.img;
        } else {
            return false;
        }
    }






    function clipBounds(src, dst){

        var x = Math.max(src.left, dst.left),
        y = Math.max(src.top, dst.top),
        x2 = Math.min((src.left + src.width), (dst.left + dst.width)),
        y2 = Math.min((src.top + src.height), (dst.top + dst.height));

        return {
            left:x,
            top:y,
            width:x2-x,
            height:y2-y
        };

    }

    function setZ(zIndex, parentZ){
        // TODO fix static elements overlapping relative/absolute elements under same stack, if they are defined after them
        var newContext;
        if (!parentZ){
            newContext = h2czContext(0);
            return newContext;
        }

        if (zIndex !== "auto"){
            needReorder = true;
            newContext = h2czContext(zIndex);
            parentZ.children.push(newContext);
            return newContext;

        }

        return parentZ;

    }

    function renderBorders(el, ctx, bounds, clip){

        /*
         *  TODO add support for different border-style's than solid
         */

        var x = bounds.left,
        y = bounds.top,
        w = bounds.width,
        h = bounds.height,
        borderSide,
        borderData,
        bx,
        by,
        bw,
        bh,
        rw,
        i,
        borderArgs,
        borderBounds,
        borders = (function(el){
            var borders = [],
            sides = ["Top","Right","Bottom","Left"],
            s;

            for (s = 0; s < 4; s+=1){
                borders.push({
                    width: getCSSInt(el, 'border' + sides[s] + 'Width'),
                    color: getCSS(el, 'border' + sides[s] + 'Color')
                });
            }

            return borders;

        }(el)),
        // http://www.w3.org/TR/css3-background/#the-border-radius
        borderRadius = (function( el ) {
            var borders = [],
            sides = ["TopLeft","TopRight","BottomRight","BottomLeft"],
            s;
            
            for (s = 0; s < 4; s+=1){
                borders.push( getCSS(el, 'border' + sides[s] + 'Radius') );
            }

            return borders;
        })( el );



        for ( borderSide = 0; borderSide < 4; borderSide+=1 ) {
            borderData = borders[ borderSide ];
            borderArgs = [];
            if (borderData.width>0){
                bx = x;
                by = y;
                bw = w;
                bh = h - (borders[2].width);

                switch(borderSide){
                    case 0:
                        // top border
                        bh = borders[0].width;
                        
                        i = 0;
                        borderArgs[ i++ ] = [ "line", bx, by ];  // top left
                        borderArgs[ i++ ] = [ "line", bx + bw, by ]; // top right
                        borderArgs[ i++ ] = [ "line", bx + bw - borders[ 1 ].width, by + bh  ]; // bottom right
                        borderArgs[ i++ ] = [ "line", bx + borders[ 3 ].width, by + bh ]; // bottom left
                        
                        break;
                    case 1:
                        // right border
                        bx = x + w - (borders[1].width);
                        bw = borders[1].width;
                        
                        i = 0;
                        borderArgs[ i++ ] = [ "line", bx, by + borders[ 0 ].width];  // top left
                        borderArgs[ i++ ] = [ "line", bx + bw, by ]; // top right
                        borderArgs[ i++ ] = [ "line", bx + bw, by + bh + borders[ 2 ].width ]; // bottom right
                        borderArgs[ i++ ] = [ "line", bx, by + bh ]; // bottom left
                        
                        break;
                    case 2:
                        // bottom border
                        by = (by + h) - (borders[2].width);
                        bh = borders[2].width;
                                             
                                    
                        i = 0;
                        /*    
                        // top left
                        if ( borderRadius[ 3 ][ 0 ] > 0 ) {
                            
                            borderArgs[ i++ ] = [ "line", 
                            bx + borders[ 3 ].width, 
                            by - (borderRadius[ 3 ][ 1 ]) + borders[ 2 ].width
                            ];  
                            
                            borderArgs[ i++ ] = [ "quadraticCurve", 
                            bx + borders[ 3 ].width,
                            by,
                            bx + borderRadius[ 3 ][ 0 ], 
                            by,    
                            ];  
                            
                        
                            rw = ( borders[ 3 ].width === 0 ) ? 1 : borders[ 2 ].width / (borders[ 3 ].width + borders[ 2 ].width);

                            borderArgs[ i++ ] = [ "line", 
                            bx + (borderRadius[ 3 ][ 0 ] * ( 1-rw )), 
                            by - (borderRadius[ 3 ][ 1 ] - borders[ 2 ].width) + (borderRadius[ 3 ][ 1 ] * ( 1-rw ))
                            ];  
                          
                            borderArgs[ i++ ] = [ "quadraticCurve", 
                            bx + borders[ 3 ].width,
                            by,
                            bx + borders[ 3 ].width + borderRadius[ 3 ][ 0 ], 
                            by,    
                            ];  
                             
                            borderArgs[ i++ ] = [ "bezierCurve", 
                            bx + (borderRadius[ 3 ][ 0 ] * ( 1-rw )),
                            by,
                            bx + (borderRadius[ 3 ][ 0 ] * ( 1-rw )),
                            by,
                            bx + borders[ 3 ].width + borderRadius[ 3 ][ 0 ], 
                            by,    
                            ];   
                            
                        } else {
                             borderArgs[ i++ ] = [ "line", bx + borders[ 3 ].width, by ]; 
                        }
                         */
                        borderArgs[ i++ ] = [ "line", bx + borders[ 3 ].width, by ]; 
                        borderArgs[ i++ ] = [ "line", bx + bw - borders[ 2 ].width, by ]; // top right
                        borderArgs[ i++ ] = [ "line", bx + bw, by + bh ]; // bottom right
                        borderArgs[ i++ ] = [ "line", bx, by + bh ]; // bottom left
                        
                        break;
                    case 3:
                        // left border
                        bw = borders[3].width;
                        
                        i = 0;
                        borderArgs[ i++ ] = [ "line", bx, by ];  // top left
                        borderArgs[ i++ ] = [ "line", bx + bw, by + borders[ 0 ].width ]; // top right
                        borderArgs[ i++ ] = [ "line", bx + bw, by + bh ]; // bottom right
                        borderArgs[ i++ ] = [ "line", bx, by + bh + borders[ 2 ].width ]; // bottom left
                        
                        break;
                }

                borderBounds = {
                    left:bx,
                    top:by,
                    width: bw,
                    height:bh
                };

                if (clip){
                    borderBounds = clipBounds(borderBounds, clip);
                }


                if ( borderBounds.width > 0 && borderBounds.height > 0 ) {
                    
                    if ( borderData.color !== "transparent" ){
                        ctx.setVariable( "fillStyle", borderData.color );
                        
                        var shape = ctx.drawShape(),
                        numBorderArgs = borderArgs.length;
                        
                        for ( i = 0; i < numBorderArgs; i++ ) {
                            shape[( i === 0) ? "moveTo" : borderArgs[ i ][ 0 ] + "To" ].apply( null, borderArgs[ i ].slice(1) );
                        }

                        numDraws+=1;
                    }
                    
                    
            
                    
                //  renderRect(ctx, bx, by, borderBounds.width, borderBounds.height, borderData.color);
                }


            }
        }

        return borders;

    }


    function renderFormValue (el, bounds, stack){

        var valueWrap = doc.createElement('valuewrap'),
        cssArr = ['lineHeight','textAlign','fontFamily','color','fontSize','paddingLeft','paddingTop','width','height','border','borderLeftWidth','borderTopWidth'],
        i,
        textValue,
        textNode,
        arrLen,
        style;

        for (i = 0, arrLen = cssArr.length; i < arrLen; i+=1){
            style = cssArr[i];

            try {
                valueWrap.style[style] = getCSS(el, style);
            } catch( e ) {
                // Older IE has issues with "border"
                h2clog("html2canvas: Parse: Exception caught in renderFormValue: " + e.message);
            }
        }


        valueWrap.style.borderColor = "black";
        valueWrap.style.borderStyle = "solid";
        valueWrap.style.display = "block";
        valueWrap.style.position = "absolute";
        if (/^(submit|reset|button|text|password)$/.test(el.type) || el.nodeName === "SELECT"){
            valueWrap.style.lineHeight = getCSS(el, "height");
        }


        valueWrap.style.top = bounds.top + "px";
        valueWrap.style.left = bounds.left + "px";

        if (el.nodeName === "SELECT"){
            // TODO increase accuracy of text position
            textValue = el.options[el.selectedIndex].text;
        } else{
            textValue = el.value;
        }
        textNode = doc.createTextNode(textValue);

        valueWrap.appendChild(textNode);
        body.appendChild(valueWrap);


        renderText(el, textNode, stack);
        body.removeChild(valueWrap);



    }





    function renderImage (ctx, image, sx, sy, sw, sh, dx, dy, dw, dh) {
        ctx.drawImage(
            image,
            sx, //sx
            sy, //sy
            sw, //sw
            sh, //sh
            dx, //dx
            dy, // dy
            dw, //dw
            dh //dh
            );
        numDraws+=1;

    }


    function renderBackgroundRepeat (ctx, image, x, y, width, height, elx, ely){
        var sourceX = 0,
        sourceY=0;
        if (elx-x>0){
            sourceX = elx-x;
        }

        if (ely-y>0){
            sourceY = ely-y;
        }

        renderImage(
            ctx,
            image,
            sourceX, // source X
            sourceY, // source Y
            width-sourceX, // source Width
            height-sourceY, // source Height
            x+sourceX, // destination X
            y+sourceY, // destination Y
            width-sourceX, // destination width
            height-sourceY // destination height
            );
    }


    function renderBackgroundRepeatY (ctx, image, bgp, x, y, w, h){

        var height,
        width = Math.min(image.width,w),bgy;

        bgp.top = bgp.top-Math.ceil(bgp.top/image.height)*image.height;


        for(bgy=(y+bgp.top);bgy<h+y;){


            if ( Math.floor(bgy+image.height)>h+y){
                height = (h+y)-bgy;
            }else{
                height = image.height;
            }
            renderBackgroundRepeat(ctx,image,x+bgp.left,bgy,width,height,x,y);

            bgy = Math.floor(bgy+image.height);

        }
    }

    function renderBackgroundRepeatX(ctx, image, bgp, x, y, w, h){

        var height = Math.min(image.height,h),
        width,bgx;


        bgp.left = bgp.left-Math.ceil(bgp.left/image.width)*image.width;


        for (bgx=(x+bgp.left);bgx<w+x;) {

            if (Math.floor(bgx+image.width)>w+x){
                width = (w+x)-bgx;
            }else{
                width = image.width;
            }

            renderBackgroundRepeat(ctx,image,bgx,(y+bgp.top),width,height,x,y);

            bgx = Math.floor(bgx+image.width);


        }
    }

    function renderBackground(el,bounds,ctx){

        // TODO add support for multi background-images
        var background_image = getCSS(el, "backgroundImage"),
        background_repeat = getCSS(el, "backgroundRepeat").split(",")[0],
        image,
        bgp,
        bgy,
        bgw,
        bgsx,
        bgsy,
        bgdx,
        bgdy,
        bgh,
        h,
        height,
        add;

        //   if (typeof background_image !== "undefined" && /^(1|none)$/.test(background_image) === false && /^(-webkit|-moz|linear-gradient|-o-)/.test(background_image)===false){

        if ( !/data:image\/.*;base64,/i.test(background_image) && !/^(-webkit|-moz|linear-gradient|-o-)/.test(background_image) ) {
            background_image = background_image.split(",")[0];
        }

        if ( typeof background_image !== "undefined" && /^(1|none)$/.test( background_image ) === false ) {
            background_image = _html2canvas.Util.backgroundImage( background_image );
            image = loadImage( background_image );


            bgp = _html2canvas.Util.BackgroundPosition(el, bounds, image);

            // TODO add support for background-origin
            if ( image ){
                switch ( background_repeat ) {

                    case "repeat-x":
                        renderBackgroundRepeatX( ctx, image, bgp, bounds.left, bounds.top, bounds.width, bounds.height );
                        break;

                    case "repeat-y":
                        renderBackgroundRepeatY( ctx, image, bgp, bounds.left, bounds.top, bounds.width, bounds.height );
                        break;

                    case "no-repeat":
                        /*
                    this.drawBackgroundRepeat(
                        ctx,
                        image,
                        bgp.left+bounds.left, // sx
                        bgp.top+bounds.top, // sy
                        Math.min(bounds.width,image.width),
                        Math.min(bounds.height,image.height),
                        bounds.left,
                        bounds.top
                        );*/


                       
                        bgw = bounds.width - bgp.left;
                        bgh = bounds.height - bgp.top;
                        bgsx = bgp.left;
                        bgsy = bgp.top;
                        bgdx = bgp.left+bounds.left;
                        bgdy = bgp.top+bounds.top;

                        //
                        //     bgw = Math.min(bgw,image.width);
                        //  bgh = Math.min(bgh,image.height);

                        if (bgsx<0){
                            bgsx = Math.abs(bgsx);
                            bgdx += bgsx;
                            bgw = Math.min(bounds.width,image.width-bgsx);
                        }else{
                            bgw = Math.min(bgw,image.width);
                            bgsx = 0;
                        }

                        if (bgsy<0){
                            bgsy = Math.abs(bgsy);
                            bgdy += bgsy;
                            // bgh = bgh-bgsy;
                            bgh = Math.min(bounds.height,image.height-bgsy);
                        }else{
                            bgh = Math.min(bgh,image.height);
                            bgsy = 0;
                        }


                        if (bgh>0 && bgw > 0){
                            renderImage(
                                ctx,
                                image,
                                bgsx, // source X : 0
                                bgsy, // source Y : 1695
                                bgw, // source Width : 18
                                bgh, // source Height : 1677
                                bgdx, // destination X :906
                                bgdy, // destination Y : 1020
                                bgw, // destination width : 18
                                bgh // destination height : 1677
                                );

                        }
                        break;
                    default:



                        bgp.top = bgp.top-Math.ceil(bgp.top/image.height)*image.height;


                        for(bgy=(bounds.top+bgp.top);bgy<bounds.height+bounds.top;){



                            h = Math.min(image.height,(bounds.height+bounds.top)-bgy);


                            if ( Math.floor(bgy+image.height)>h+bgy){
                                height = (h+bgy)-bgy;
                            }else{
                                height = image.height;
                            }
                            // console.log(height);

                            if (bgy<bounds.top){
                                add = bounds.top-bgy;
                                bgy = bounds.top;

                            }else{
                                add = 0;
                            }

                            renderBackgroundRepeatX(ctx,image,bgp,bounds.left,bgy,bounds.width,height);
                            if (add>0){
                                bgp.top += add;
                            }
                            bgy = Math.floor(bgy+image.height)-add;
                        }
                        break;


                }
            }else{
                h2clog("html2canvas: Error loading background:" + background_image);
            //console.log(images);
            }

        }
    }



    function renderElement(el, parentStack){

        var bounds = _html2canvas.Util.Bounds(el),
        x = bounds.left,
        y = bounds.top,
        w = bounds.width,
        h = bounds.height,
        image,
        bgcolor = getCSS(el, "backgroundColor"),
        cssPosition = getCSS(el, "position"),
        zindex,
        opacity = getCSS(el, "opacity"),
        stack,
        stackLength,
        borders,
        ctx,
        bgbounds,
        imgSrc,
        paddingLeft,
        paddingTop,
        paddingRight,
        paddingBottom;

        if (!parentStack){
            docDim = docSize();
            parentStack = {
                opacity: 1
            };
        }else{
            docDim = {};
        }


        //var zindex = this.formatZ(this.getCSS(el,"zIndex"),cssPosition,parentStack.zIndex,el.parentNode);

        zindex = setZ( getCSS( el, "zIndex"), parentStack.zIndex );



        stack = {
            ctx: h2cRenderContext( docDim.width || w , docDim.height || h ),
            zIndex: zindex,
            opacity: opacity * parentStack.opacity,
            cssPosition: cssPosition
        };



        // TODO correct overflow for absolute content residing under a static position

        if (parentStack.clip){
            stack.clip = _html2canvas.Util.Extend( {}, parentStack.clip );
        //stack.clip = parentStack.clip;
        //   stack.clip.height = stack.clip.height - parentStack.borders[2].width;
        }


        if ( options.useOverflow === true && /(hidden|scroll|auto)/.test(getCSS(el, "overflow")) === true && /(BODY)/i.test(el.nodeName) === false ){
            if (stack.clip){
                stack.clip = clipBounds(stack.clip, bounds);
            }else{
                stack.clip = bounds;
            }
        }


        stackLength =  zindex.children.push(stack);

        ctx = zindex.children[stackLength-1].ctx;

        ctx.setVariable("globalAlpha", stack.opacity);

        // draw element borders
        borders = renderBorders(el, ctx, bounds, false);
        stack.borders = borders;


        // let's modify clip area for child elements, so borders dont get overwritten

        /*
    if (stack.clip){
        stack.clip.width = stack.clip.width-(borders[1].width);
        stack.clip.height = stack.clip.height-(borders[2].width);
    }
     */
        if (ignoreElementsRegExp.test(el.nodeName) && options.iframeDefault !== "transparent"){
            if (options.iframeDefault === "default"){
                bgcolor = "#efefef";
            }else{
                bgcolor = options.iframeDefault;
            }
        }

        // draw base element bgcolor

        bgbounds = {
            left: x + borders[3].width,
            top: y + borders[0].width,
            width: w - (borders[1].width + borders[3].width),
            height: h - (borders[0].width + borders[2].width)
        };

        //if (this.withinBounds(stack.clip,bgbounds)){

        if (stack.clip){
            bgbounds = clipBounds(bgbounds, stack.clip);

        //}

        }


        if (bgbounds.height > 0 && bgbounds.width > 0){
            renderRect(
                ctx,
                bgbounds.left,
                bgbounds.top,
                bgbounds.width,
                bgbounds.height,
                bgcolor
                );

            renderBackground(el, bgbounds, ctx);
        }

        switch(el.nodeName){
            case "IMG":
                imgSrc = el.getAttribute('src');
                image = loadImage(imgSrc);
                if (image){

                    paddingLeft = getCSSInt(el, 'paddingLeft');
                    paddingTop = getCSSInt(el, 'paddingTop');
                    paddingRight = getCSSInt(el, 'paddingRight');
                    paddingBottom = getCSSInt(el, 'paddingBottom');


                    renderImage(
                        ctx,
                        image,
                        0, //sx
                        0, //sy
                        image.width, //sw
                        image.height, //sh
                        x + paddingLeft + borders[3].width, //dx
                        y + paddingTop + borders[0].width, // dy
                        bounds.width - (borders[1].width + borders[3].width + paddingLeft + paddingRight), //dw
                        bounds.height - (borders[0].width + borders[2].width + paddingTop + paddingBottom) //dh
                        );

                }else{
                    h2clog("html2canvas: Error loading <img>:" + imgSrc);
                }
                break;
            case "INPUT":
                // TODO add all relevant type's, i.e. HTML5 new stuff
                // todo add support for placeholder attribute for browsers which support it
                if (/^(text|url|email|submit|button|reset)$/.test(el.type) && el.value.length > 0){

                    renderFormValue(el, bounds, stack);


                /*
                 this just doesn't work well enough

                this.newText(el,{
                    nodeValue:el.value,
                    splitText: function(){
                        return this;
                    },
                    formValue:true
                },stack);
                 */
                }
                break;
            case "TEXTAREA":
                if (el.value.length > 0){
                    renderFormValue(el, bounds, stack);
                }
                break;
            case "SELECT":
                if (el.options.length > 0){
                    renderFormValue(el, bounds, stack);
                }
                break;
            case "LI":
                renderListItem(el, stack, bgbounds);
                break;
            case "CANVAS":
                paddingLeft = getCSSInt(el, 'paddingLeft');
                paddingTop = getCSSInt(el, 'paddingTop');
                paddingRight = getCSSInt(el, 'paddingRight');
                paddingBottom = getCSSInt(el, 'paddingBottom');
                renderImage(
                    ctx,
                    el,
                    0, //sx
                    0, //sy
                    el.width, //sw
                    el.height, //sh
                    x + paddingLeft + borders[3].width, //dx
                    y + paddingTop + borders[0].width, // dy
                    bounds.width - (borders[1].width + borders[3].width + paddingLeft + paddingRight), //dw
                    bounds.height - (borders[0].width + borders[2].width + paddingTop + paddingBottom) //dh
                    );
                break;
        }

        return zindex.children[stackLength - 1];
    }



    function parseElement (el, stack) {

        // skip hidden elements and their children
        if (getCSS(el, 'display') !== "none" && getCSS(el, 'visibility') !== "hidden" && !el.hasAttribute("data-html2canvas-ignore") ) {

            stack = renderElement(el, stack) || stack;

            ctx = stack.ctx;

            if ( !ignoreElementsRegExp.test( el.nodeName ) ) {
                var elementChildren = _html2canvas.Util.Children( el ),
                i,
                node,
                childrenLen;
                for (i = 0, childrenLen = elementChildren.length; i < childrenLen; i+=1) {
                    node = elementChildren[i];

                    if ( node.nodeType === 1 ) {
                        parseElement(node, stack);
                    }else if ( node.nodeType === 3 ) {
                        renderText(el, node, stack);
                    }

                }

            }
        } 
    }

    stack = renderElement(element, null);

    /*
    SVG powered HTML rendering, non-tainted canvas available from FF 11+ onwards
 */

    if ( support.svgRendering ) {
        (function( body ){
            var img = new Image(),
            size =  docSize(),
            html = "";

            function parseDOM( el ) {
                var children = _html2canvas.Util.Children( el ),
                len = children.length,
                attr,
                a,
                alen,
                elm,
                i;
                for ( i = 0; i < len; i+=1 ) {
                    elm = children[ i ];
                    if ( elm.nodeType === 3 ) {
                        // Text node

                        html += elm.nodeValue.replace(/\</g,"&lt;").replace(/\>/g,"&gt;");
                    } else if ( elm.nodeType === 1 ) {
                        // Element
                        if ( !/^(script|meta|title)$/.test(elm.nodeName.toLowerCase()) ) {

                            html += "<" + elm.nodeName.toLowerCase();

                            // add attributes
                            if ( elm.hasAttributes() ) {
                                attr = elm.attributes;
                                alen = attr.length;
                                for ( a = 0; a < alen; a+=1 ) {
                                    html += " " + attr[ a ].name + '="' + attr[ a ].value + '"';
                                }
                            }


                            html += '>';

                            parseDOM( elm );


                            html += "</" + elm.nodeName.toLowerCase() + ">";
                        }
                    }

                }

            }

            parseDOM( body );
            img.src = [
            "data:image/svg+xml,",
            "<svg xmlns='http://www.w3.org/2000/svg' version='1.1' width='" + size.width + "' height='" + size.height + "'>",
            "<foreignObject width='" + size.width + "' height='" + size.height + "'>",
            "<html xmlns='http://www.w3.org/1999/xhtml' style='margin:0;'>",
            html.replace(/\#/g,"%23"),
            "</html>",
            "</foreignObject>",
            "</svg>"
            ].join("");




            img.onload = function() {
                stack.svgRender = img;
            };

        })( document.documentElement );

    }


    // parse every child element
    for (i = 0, children = element.children, childrenLen = children.length; i < childrenLen; i+=1){
        parseElement(children[i], stack);
    }


    stack.backgroundColor = getCSS( document.documentElement, "backgroundColor" );

    return stack;

};

function h2czContext(zindex) {
    return {
        zindex: zindex,
        children: []
    };
}

/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
 */

_html2canvas.Preload = function( options ) {

    var images = {
        numLoaded: 0,   // also failed are counted here
        numFailed: 0,
        numTotal: 0,
        cleanupDone: false
    },
    pageOrigin,
    methods,
    i,
    count = 0,
    element = options.elements[0] || document.body,
    doc = element.ownerDocument,
    domImages = doc.images, // TODO probably should limit it to images present in the element only
    imgLen = domImages.length,
    link = doc.createElement("a"),
    supportCORS = (function( img ){
        return (img.crossOrigin !== undefined);
    })(new Image()),
    timeoutTimer;

    link.href = window.location.href;
    pageOrigin  = link.protocol + link.host;



    //$.test_msg("Preload 1");
	


    function isSameOrigin(url){
        link.href = url;
        link.href = link.href; // YES, BELIEVE IT OR NOT, that is required for IE9 - http://jsfiddle.net/niklasvh/2e48b/
        var origin = link.protocol + link.host;
        return (origin === pageOrigin);
    }

    function start(){
        h2clog("html2canvas: start: images: " + images.numLoaded + " / " + images.numTotal + " (failed: " + images.numFailed + ")");
        if (!images.firstRun && images.numLoaded >= images.numTotal){
            h2clog("Finished loading images: # " + images.numTotal + " (failed: " + images.numFailed + ")");

            if (typeof options.complete === "function"){
				try{
					options.complete(images);
				}
				catch (e) {
					//$.test_msg("firstRun 1 ERROR", e);
				}
            }

        }
    }
	
	//$.test_msg("Preload 2");

    // TODO modify proxy to serve images with CORS enabled, where available
    function proxyGetImage(url, img, imageObj){
        var callback_name,
        scriptUrl = options.proxy,
        script;

        link.href = url;
        url = link.href; // work around for pages with base href="" set - WARNING: this may change the url

        callback_name = 'html2canvas_' + (count++);
        imageObj.callbackname = callback_name;

        if (scriptUrl.indexOf("?") > -1) {
            scriptUrl += "&";
        } else {
            scriptUrl += "?";
        }
        scriptUrl += 'url=' + encodeURIComponent(url) + '&callback=' + callback_name;
        script = doc.createElement("script");

        window[callback_name] = function(a){
            if (a.substring(0,6) === "error:"){
                imageObj.succeeded = false;
                images.numLoaded++;
                images.numFailed++;
                start();
            } else {
                setImageLoadHandlers(img, imageObj);
                img.src = a;
            }
            window[callback_name] = undefined; // to work with IE<9  // NOTE: that the undefined callback property-name still exists on the window object (for IE<9)
            try {
                delete window[callback_name];  // for all browser that support this
            } catch(ex) {}
            script.parentNode.removeChild(script);
            script = null;
            delete imageObj.script;
            delete imageObj.callbackname;
        };

        script.setAttribute("type", "text/javascript");
        script.setAttribute("src", scriptUrl);
        imageObj.script = script;
        window.document.body.appendChild(script);

    }

    function getImages (el) {



        // if (!this.ignoreRe.test(el.nodeName)){
        //
        
        var contents = _html2canvas.Util.Children(el),
        i,
        background_image,
        src,
        img,
        elNodeType = false;

        // Firefox fails with permission denied on pages with iframes
        try {
            var contentsLen = contents.length;
            for (i = 0;  i < contentsLen; i+=1 ){
                // var ignRe = new RegExp("("+this.ignoreElements+")");
                // if (!ignRe.test(element.nodeName)){
                getImages(contents[i]);
                // }
            }
        }
        catch( e ) {}


        // }
        try {
            elNodeType = el.nodeType;
        } catch (ex) {
            elNodeType = false;
            h2clog("html2canvas: failed to access some element's nodeType - Exception: " + ex.message);
        }

        if (elNodeType === 1 || elNodeType === undefined){

            // opera throws exception on external-content.html
            try {
                background_image = _html2canvas.Util.getCSS(el, 'backgroundImage');
            }catch(e) {
                h2clog("html2canvas: failed to get background-image - Exception: " + e.message);
            }
            if ( background_image && background_image !== "1" && background_image !== "none" ) {

                // TODO add multi image background support

                if (/^(-webkit|-o|-moz|-ms|linear)-/.test( background_image )) {

                    img = _html2canvas.Generate.Gradient( background_image, _html2canvas.Util.Bounds( el ) );

                    if ( img !== undefined ){
                        images[background_image] = {
                            img: img,
                            succeeded: true
                        };
                        images.numTotal++;
                        images.numLoaded++;
                        start();

                    }

                } else {
                    src = _html2canvas.Util.backgroundImage(background_image.match(/data:image\/.*;base64,/i) ? background_image : background_image.split(",")[0]);
                    methods.loadImage(src);
                }

                /*
            if (background_image && background_image !== "1" && background_image !== "none" && background_image.substring(0,7) !== "-webkit" && background_image.substring(0,3)!== "-o-" && background_image.substring(0,4) !== "-moz"){
                // TODO add multi image background support
                src = _html2canvas.Util.backgroundImage(background_image.split(",")[0]);
                methods.loadImage(src);            */
            }
        }
    }
	
	//$.test_msg("Preload 3");

    function setImageLoadHandlers(img, imageObj) {
        img.onload = function() {
            if ( imageObj.timer !== undefined ) {
                // CORS succeeded
                window.clearTimeout( imageObj.timer );
            }

            images.numLoaded++;
            imageObj.succeeded = true;
            img.onerror = img.onload = null;
            start();
        };
        img.onerror = function() {

            if (img.crossOrigin === "anonymous") {
                // CORS failed
                window.clearTimeout( imageObj.timer );

                // let's try with proxy instead
                if ( options.proxy ) {
                    var src = img.src;
                    img = new Image();
                    imageObj.img = img;
                    img.src = src;

                    proxyGetImage( img.src, img, imageObj );
                    return;
                }
            }


            images.numLoaded++;
            images.numFailed++;
            imageObj.succeeded = false;
            img.onerror = img.onload = null;
            start();

        };

        // TODO Opera has no load/error event for SVG images

        // Opera ninja onload's cached images
        /*
        window.setTimeout(function(){
            if ( img.width !== 0 && imageObj.succeeded === undefined ) {
                img.onload();
            }
        }, 100); // needs a reflow for base64 encoded images? interestingly timeout of 0 doesn't work but 1 does.
         */
    }

    //$.test_msg("Preload 4");

    methods = {
        loadImage: function( src ) {
            var img, imageObj;
            if ( src && images[src] === undefined ) {
                img = new Image();
                if ( src.match(/data:image\/.*;base64,/i) ) {
                    img.src = src.replace(/url\(['"]{0,}|['"]{0,}\)$/ig, '');
                    imageObj = images[src] = {
                        img: img
                    };
                    images.numTotal++;
                    setImageLoadHandlers(img, imageObj);
                } else if ( isSameOrigin( src ) || options.allowTaint ===  true ) {
                    imageObj = images[src] = {
                        img: img
                    };
                    images.numTotal++;
                    setImageLoadHandlers(img, imageObj);
                    img.src = src;
                } else if ( supportCORS && !options.allowTaint && options.useCORS ) {
                    // attempt to load with CORS

                    img.crossOrigin = "anonymous";
                    imageObj = images[src] = {
                        img: img
                    };
                    images.numTotal++;
                    setImageLoadHandlers(img, imageObj);
                    img.src = src;

                    // work around for https://bugs.webkit.org/show_bug.cgi?id=80028
                    img.customComplete = function () {
                        if (!this.img.complete) {
                            this.timer = window.setTimeout(this.img.customComplete, 100);
                        } else {
                            this.img.onerror();
                        }
                    }.bind(imageObj);
                    img.customComplete();

                } else if ( options.proxy ) {
                    imageObj = images[src] = {
                        img: img
                    };
                    images.numTotal++;
                    proxyGetImage( src, img, imageObj );
                }
            }

        },
        cleanupDOM: function(cause) {
            var img, src;
            if (!images.cleanupDone) {
                if (cause && typeof cause === "string") {
                    h2clog("html2canvas: Cleanup because: " + cause);
                } else {
                    h2clog("html2canvas: Cleanup after timeout: " + options.timeout + " ms.");
                }

                for (src in images) {
                    if (images.hasOwnProperty(src)) {
                        img = images[src];
                        if (typeof img === "object" && img.callbackname && img.succeeded === undefined) {
                            // cancel proxy image request
                            window[img.callbackname] = undefined; // to work with IE<9  // NOTE: that the undefined callback property-name still exists on the window object (for IE<9)
                            try {
                                delete window[img.callbackname];  // for all browser that support this
                            } catch(ex) {}
                            if (img.script && img.script.parentNode) {
                                img.script.setAttribute("src", "about:blank");  // try to cancel running request
                                img.script.parentNode.removeChild(img.script);
                            }
                            images.numLoaded++;
                            images.numFailed++;
                            h2clog("html2canvas: Cleaned up failed img: '" + src + "' Steps: " + images.numLoaded + " / " + images.numTotal);
                        }
                    }
                }

                // cancel any pending requests
                if(window.stop !== undefined) {
                    window.stop();
                } else if(document.execCommand !== undefined) {
                    document.execCommand("Stop", false);
                }
                if (document.close !== undefined) {
                    document.close();
                }
                images.cleanupDone = true;
                if (!(cause && typeof cause === "string")) {
                    start();
                }
            }
        },
        renderingDone: function() {
            if (timeoutTimer) {
                window.clearTimeout(timeoutTimer);
            }
        }

    };

    //$.test_msg("Preload 5");

    if (options.timeout > 0) {
        timeoutTimer = window.setTimeout(methods.cleanupDOM, options.timeout);
    }
    h2clog('html2canvas: Preload starts: finding background-images');
    images.firstRun = true;

    //$.test_msg("Preload 6");

    getImages( element );
	
	//$.test_msg("Preload 7", imgLen);

    h2clog('html2canvas: Preload: Finding images');
    // load <img> images
	
    
    for (i = 0; i < imgLen; i+=1){
		//$.test_msg("imgLen " + i, domImages[i].getAttribute( "src" ));
        methods.loadImage( domImages[i].getAttribute( "src" ) );
    }
	//$.test_msg("Preload 8");

    // 關鍵出錯的地方！
	images.firstRun = false;
	
    h2clog('html2canvas: Preload: Done.');
	
    //return;
	//$.test_msg("Preload 9");
    if ( images.numTotal === images.numLoaded ) {
        start();
    }
	
	//$.test_msg("Preload Final");

    return methods;

};




/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
*/
function h2cRenderContext(width, height) {
    var storage = [];
    return {
        storage: storage,
        width: width,
        height: height,
        fillRect: function () {
            storage.push({
                type: "function",
                name: "fillRect",
                'arguments': arguments
            });
        },
        drawShape: function() {
          
            var shape = [];
            
            storage.push({
                type: "function",
                name: "drawShape",
                'arguments': shape
            });
          
            return {
                moveTo: function() {
                    shape.push({
                        name: "moveTo",
                        'arguments': arguments
                    });
                },
                lineTo: function() {
                    shape.push({
                        name: "lineTo",
                        'arguments': arguments
                    });
                },
                bezierCurveTo: function() {
                    shape.push({
                        name: "bezierCurveTo",
                        'arguments': arguments
                    });
                },
                quadraticCurveTo: function() {
                    shape.push({
                        name: "quadraticCurveTo",
                        'arguments': arguments
                    });
                }
            };
          
        },
        drawImage: function () {
            storage.push({
                type: "function",
                name: "drawImage",
                'arguments': arguments
            });
        },
        fillText: function () {
            storage.push({
                type: "function",
                name: "fillText",
                'arguments': arguments
            });
        },
        setVariable: function (variable, value) {
            storage.push({
                type: "variable",
                name: variable,
                'arguments': value
            });
        }
    };
}

/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
*/
_html2canvas.Renderer = function(parseQueue, options){

    //$.test_msg("Renderer 1");
    var queue = [];

    function sortZ(zStack){
        var subStacks = [],
        stackValues = [],
        zStackChildren = zStack.children,
        s,
        i,
        stackLen,
        zValue,
        zLen,
        stackChild,
        b,
        subStackLen;


        for (s = 0, zLen = zStackChildren.length; s < zLen; s+=1){

            stackChild = zStackChildren[s];

            if (stackChild.children && stackChild.children.length > 0){
                subStacks.push(stackChild);
                stackValues.push(stackChild.zindex);
            }else{
                queue.push(stackChild);
            }

        }

        stackValues.sort(function(a, b) {
            return a - b;
        });

        for (i = 0, stackLen = stackValues.length; i < stackLen; i+=1){
            zValue = stackValues[i];
            for (b = 0, subStackLen = subStacks.length; b <= subStackLen; b+=1){

                if (subStacks[b].zindex === zValue){
                    stackChild = subStacks.splice(b, 1);
                    sortZ(stackChild[0]);
                    break;

                }
            }
        }

    }
    //$.test_msg("Renderer 2");

    sortZ(parseQueue.zIndex);
    if ( typeof options._renderer._create !== "function" ) {
		//$.test_msg("Invalid renderer defined");
        throw new Error("Invalid renderer defined");
    }
	
	//$.test_msg("Renderer 3", typeof options._renderer);
	/*
	for (var _i in options) {
		//$.test_msg("Renderer 3 options: " + _i, typeof(options[_i]));
	}
	
	for (var _i in queue) {
        //$.test_msg("Renderer 3 queue: " + _i, typeof(queue[_i]));
    }
	*/
    //return;
	//$.test_msg( "html2canvas", [parseQueue, options, document, queue, _html2canvas]);
    return options._renderer._create( parseQueue, options, document, queue, _html2canvas );

};

/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
*/


html2canvas = function( elements, opts ) {

    var queue,
    canvas,
    options = {
        // general
        logging: false,
        elements: elements,

        // preload options
        proxy: "http://html2canvas.appspot.com/",
        timeout: 0,    // no timeout
        useCORS: false, // try to load images as CORS (where available), before falling back to proxy
        allowTaint: false, // whether to allow images to taint the canvas, won't need proxy if set to true

        // parse options
        svgRendering: true, // use svg powered rendering where available (FF11+)
        iframeDefault: "default",
        ignoreElements: "IFRAME|OBJECT|PARAM",
        useOverflow: true,
        letterRendering: false,

        // render options

        flashcanvas: undefined, // path to flashcanvas
        width: null,
        height: null,
        taintTest: true, // do a taint test with all images before applying to canvas
    renderer: "Canvas"
    }, renderer;

    options = _html2canvas.Util.Extend(opts, options);
	
	for (var _i in options) {
        //$.test_msg("html2canvas options " + _i, typeof(options[_i]));
    }
	

  if (typeof options.renderer === "string" && _html2canvas.Renderer[options.renderer] !== undefined) {
    options._renderer = _html2canvas.Renderer[options.renderer]( options );
  } else if (typeof options.renderer === "function") {
    options._renderer = options.renderer( options );
  } else {
    throw("Unknown renderer");
  }
    _html2canvas.logging = options.logging;
    options.complete = function( images ) {
        if (typeof options.onpreloaded === "function") {
            if ( options.onpreloaded( images ) === false ) {
                return;
            }
        }
        queue = _html2canvas.Parse( images, options );

        
        if (typeof options.onparsed === "function") {
            if ( options.onparsed( queue ) === false ) {
                return;
            }
        }

        var _canvas;
        var _canvas = _html2canvas.Renderer( queue, options );

        if (typeof options.onrendered === "function") {
            options.onrendered( _canvas );
        }


    };

    // for pages without images, we still want this to be async, i.e. return methods before executing
    window.setTimeout( function(){
        _html2canvas.Preload( options );
    }, 0 );

    return {
        render: function( queue, opts ) {
            return _html2canvas.Renderer( queue, _html2canvas.Util.Extend(opts, options) );
        },
        parse: function( images, opts ) {
            return _html2canvas.Parse( images, _html2canvas.Util.Extend(opts, options) );
        },
        preload: function( opts ) {
            return _html2canvas.Preload( _html2canvas.Util.Extend(opts, options) );
        },
        log: h2clog
    };
};  //html2canvas = function( elements, opts ) {

html2canvas.log = h2clog; // for renderers
html2canvas.Renderer = {
    Canvas: undefined // We are assuming this will be used
};

/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
*/


_html2canvas.Renderer.Canvas = function( options ) {

    options = options || {};

    var doc = document,
    canvas = options.canvas || doc.createElement('canvas'),
    usingFlashcanvas = false,
    _createCalled = false,
    canvasReadyToDraw = false,
    methods,
    flashMaxSize = 2880; // flash bitmap limited to 2880x2880px // http://stackoverflow.com/questions/2033792/argumenterror-error-2015-invalid-bitmapdata


    if (canvas.getContext){
        h2clog("html2canvas: Renderer: using canvas renderer");
        canvasReadyToDraw = true;
    } else if ( options.flashcanvas !== undefined ){
        usingFlashcanvas = true;
        h2clog("html2canvas: Renderer: canvas not available, using flashcanvas");
        var script = doc.createElement("script");
        script.src = options.flashcanvas;

        script.onload = (function(script, func){
            var intervalFunc;

            if (script.onload === undefined) {
                // IE lack of support for script onload

                if( script.onreadystatechange !== undefined ) {

                    intervalFunc = function() {
                        if (script.readyState !== "loaded" && script.readyState !== "complete") {
                            window.setTimeout( intervalFunc, 250 );

                        } else {
                            // it is loaded
                            func();

                        }

                    };

                    window.setTimeout( intervalFunc, 250 );

                } else {
                    h2clog("html2canvas: Renderer: Can't track when flashcanvas is loaded");
                }

            } else {
                return func;
            }

        })(script, function(){

            if (typeof window.FlashCanvas !== "undefined") {
                h2clog("html2canvas: Renderer: Flashcanvas initialized");
                window.FlashCanvas.initElement( canvas );

                canvasReadyToDraw = true;
                if ( _createCalled !== false ) {
                    methods._create.apply( null, _createCalled );
                }
            }
        });

        doc.body.appendChild( script );

    }

    methods = {
        _create: function( zStack, options, doc, queue, _html2canvas ) {

            //$.test_msg("_create 0");

            if ( !canvasReadyToDraw ) {
                _createCalled = arguments;
                return canvas;
            }
            
			//$.test_msg("_create 1");
			
            var ctx = canvas.getContext("2d"),
            storageContext,
            i,
            queueLen,
            a,
            newCanvas,
            bounds,
            testCanvas = document.createElement("canvas"),
            hasCTX = ( testCanvas.getContext !== undefined ),
            storageLen,
            renderItem,
            testctx = ( hasCTX ) ? testCanvas.getContext("2d") : {},
            safeImages = [],
            fstyle;

            canvas.width = canvas.style.width = (!usingFlashcanvas) ? options.width || zStack.ctx.width : Math.min(flashMaxSize, (options.width || zStack.ctx.width) );
            canvas.height = canvas.style.height = (!usingFlashcanvas) ? options.height || zStack.ctx.height : Math.min(flashMaxSize, (options.height || zStack.ctx.height) );

            fstyle = ctx.fillStyle;
            ctx.fillStyle = zStack.backgroundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = fstyle;
			
			//$.test_msg("_create 2");

            if ( options.svgRendering && zStack.svgRender !== undefined ) {
                // TODO: enable async rendering to support this
				
				//$.test_msg("_create 2-1");
                ctx.drawImage( zStack.svgRender, 0, 0 );
            } else {
				//$.test_msg("_create 2-2", queue.length);
				//return;
                for ( i = 0, queueLen = queue.length; i < queueLen; i+=1 ) {
					
                    storageContext = queue.splice(0, 1)[0];
                    storageContext.canvasPosition = storageContext.canvasPosition || {};
                    
					
                    //this.canvasRenderContext(storageContext,parentctx);

                    // set common settings for canvas
                    ctx.textBaseline = "bottom";

                    if (storageContext.clip){
                        ctx.save();
                        ctx.beginPath();
                        // console.log(storageContext);
                        ctx.rect(storageContext.clip.left, storageContext.clip.top, storageContext.clip.width, storageContext.clip.height);
                        ctx.clip();

                    }
                    
                    if (storageContext.ctx.storage){
                        //$.test_msg("queue storageContext.ctx.storage.length", storageContext.ctx.storage.length); 
                        for (a = 0, storageLen = storageContext.ctx.storage.length; a < storageLen; a+=1){

                            renderItem = storageContext.ctx.storage[a];

                            switch(renderItem.type){
                                case "variable":
                                    ctx[renderItem.name] = renderItem['arguments'];
                                    break;
                                case "function":
								
								    /**
								     * 為了避免錯誤，關閉drawImage方法
								     * @author Pulipuli Chen 20131116
								     */
								    if (renderItem.name === "drawImage") {
										renderItem.name = "fillRect";
									}
								
                                    if (renderItem.name === "fillRect") {

                                        //continue;
                                        if (!usingFlashcanvas || renderItem['arguments'][0] + renderItem['arguments'][2] < flashMaxSize  && renderItem['arguments'][1] + renderItem['arguments'][3] < flashMaxSize) {
                                            ctx.fillRect.apply( ctx, renderItem['arguments'] );
                                        }
                                    } 
									else if (renderItem.name === "drawShape") {
                                        
                                        //continue;
                                        ( function( args ) {
                                          
                                            var i, len = args.length;
                                            ctx.beginPath();
                                            for ( i = 0; i < len; i++ ) {   
                                                ctx[ args[ i ].name ].apply( ctx, args[ i ]['arguments'] );
                                            }
                                            ctx.closePath();
                                            ctx.fill();
                                        })( renderItem['arguments'] );
                                        
                                    } 
									else if (renderItem.name === "fillText") {
										
                                        //continue;
                                        if (!usingFlashcanvas || renderItem['arguments'][1] < flashMaxSize  && renderItem['arguments'][2] < flashMaxSize) {
                                            ctx.fillText.apply( ctx, renderItem['arguments'] );
                                        }
                                    } 
									else if (renderItem.name === "drawImage") {

                                        if (renderItem['arguments'][8] > 0 && renderItem['arguments'][7]){
                                            if ( hasCTX && options.taintTest ) {
                                                if ( safeImages.indexOf( renderItem['arguments'][ 0 ].src ) === -1 ) {
                                                    testctx.drawImage( renderItem['arguments'][ 0 ], 0, 0 );
													
													//setTimeout(function () {
	                                                    try {
															
															// 發生問題的就是這一行，就只有這一行而已
															testctx.getImageData( 0, 0, 1, 1 );
															
															
	                                                    } catch(e) {
	                                                        testCanvas = doc.createElement("canvas");
	                                                        testctx = testCanvas.getContext("2d");
	                                                        continue;
	                                                    }  
													//}, 1);
                                                    safeImages.push( renderItem['arguments'][ 0 ].src );

                                                }
                                            }
                                            ctx.drawImage.apply( ctx, renderItem['arguments'] );
                                        }
                                    }


                                    break;
                                default:

                            }   //switch(renderItem.type){
                        }

                    }
                    if (storageContext.clip){
                        ctx.restore();
                    }

                }
            }
			
			//$.test_msg("_create 3");

            //h2clog("html2canvas: Renderer: Canvas renderer done - returning canvas obj");

            queueLen = options.elements.length;

            //$.test_msg("_create 4");

            if (queueLen === 1) {
                if (typeof options.elements[ 0 ] === "object" && options.elements[ 0 ].nodeName !== "BODY" && usingFlashcanvas === false) {
                    // crop image to the bounds of selected (single) element
                    bounds = _html2canvas.Util.Bounds( options.elements[ 0 ] );
                    newCanvas = doc.createElement('canvas');
                    newCanvas.width = bounds.width;
                    newCanvas.height = bounds.height;
                    ctx = newCanvas.getContext("2d");

                    ctx.drawImage( canvas, bounds.left, bounds.top, bounds.width, bounds.height, 0, 0, bounds.width, bounds.height );
                    canvas = null;
                    return newCanvas;
                }
            } /*else {
        // TODO clip and resize multiple elements

            for ( i = 0; i < queueLen; i+=1 ) {
                if (options.elements[ i ] instanceof Element) {

                }

            }
        }
        */

            //$.test_msg("_create 5");

            return canvas;
        }
    };

    return methods;

};

/*
  html2canvas v0.34 <http://html2canvas.hertzen.com>
  Copyright (c) 2011 Niklas von Hertzen. All rights reserved.
  http://www.twitter.com/niklasvh

  Released under MIT License
*/


// WARNING THIS file is outdated, and hasn't been tested in quite a while

_html2canvas.Renderer.SVG = function( options ) {

    options = options || {};

    var doc = document,
    svgNS = "http://www.w3.org/2000/svg",
    svg = doc.createElementNS(svgNS, "svg"),
    xlinkNS = "http://www.w3.org/1999/xlink",
    defs = doc.createElementNS(svgNS, "defs"),
    i,
    a,
    queueLen,
    storageLen,
    storageContext,
    renderItem,
    el,
    settings = {},
    text,
    fontStyle,
    clipId = 0,
    methods;


    methods = {
        _create: function( zStack, options, doc, queue, _html2canvas ) {
            svg.setAttribute("version", "1.1");
            svg.setAttribute("baseProfile", "full");

            svg.setAttribute("viewBox", "0 0 " + Math.max(zStack.ctx.width, options.width) + " " + Math.max(zStack.ctx.height, options.height));
            svg.setAttribute("width", Math.max(zStack.ctx.width, options.width) + "px");
            svg.setAttribute("height", Math.max(zStack.ctx.height, options.height) + "px");
            svg.setAttribute("preserveAspectRatio", "none");
            svg.appendChild(defs);



            for (i = 0, queueLen = queue.length; i < queueLen; i+=1){

                storageContext = queue.splice(0, 1)[0];
                storageContext.canvasPosition = storageContext.canvasPosition || {};

                //this.canvasRenderContext(storageContext,parentctx);


                /*
            if (storageContext.clip){
                ctx.save();
                ctx.beginPath();
                // console.log(storageContext);
                ctx.rect(storageContext.clip.left, storageContext.clip.top, storageContext.clip.width, storageContext.clip.height);
                ctx.clip();

            }*/

                if (storageContext.ctx.storage){

                    for (a = 0, storageLen = storageContext.ctx.storage.length; a < storageLen; a+=1){

                        renderItem = storageContext.ctx.storage[a];



                        switch(renderItem.type){
                            case "variable":
                                settings[renderItem.name] = renderItem['arguments'];
                                break;
                            case "function":
                                if (renderItem.name === "fillRect") {

                                    el = doc.createElementNS(svgNS, "rect");
                                    el.setAttribute("x", renderItem['arguments'][0]);
                                    el.setAttribute("y", renderItem['arguments'][1]);
                                    el.setAttribute("width", renderItem['arguments'][2]);
                                    el.setAttribute("height", renderItem['arguments'][3]);
                                    el.setAttribute("fill",  settings.fillStyle);
                                    svg.appendChild(el);

                                } else if(renderItem.name === "fillText") {
                                    el = doc.createElementNS(svgNS, "text");

                                    fontStyle = settings.font.split(" ");

                                    el.style.fontVariant = fontStyle.splice(0, 1)[0];
                                    el.style.fontWeight = fontStyle.splice(0, 1)[0];
                                    el.style.fontStyle = fontStyle.splice(0, 1)[0];
                                    el.style.fontSize = fontStyle.splice(0, 1)[0];

                                    el.setAttribute("x", renderItem['arguments'][1]);
                                    el.setAttribute("y", renderItem['arguments'][2] - (parseInt(el.style.fontSize, 10) + 3));

                                    el.setAttribute("fill", settings.fillStyle);




                                    // TODO get proper baseline
                                    el.style.dominantBaseline = "text-before-edge";
                                    el.style.fontFamily = fontStyle.join(" ");

                                    text = doc.createTextNode(renderItem['arguments'][0]);
                                    el.appendChild(text);


                                    svg.appendChild(el);



                                } else if(renderItem.name === "drawImage") {

                                    if (renderItem['arguments'][8] > 0 && renderItem['arguments'][7]){

                                        // TODO check whether even any clipping is necessary for this particular image
                                        el = doc.createElementNS(svgNS, "clipPath");
                                        el.setAttribute("id", "clipId" + clipId);

                                        text = doc.createElementNS(svgNS, "rect");
                                        text.setAttribute("x",  renderItem['arguments'][5] );
                                        text.setAttribute("y", renderItem['arguments'][6]);

                                        text.setAttribute("width", renderItem['arguments'][3]);
                                        text.setAttribute("height", renderItem['arguments'][4]);
                                        el.appendChild(text);
                                        defs.appendChild(el);

                                        el = doc.createElementNS(svgNS, "image");
                                        el.setAttributeNS(xlinkNS, "xlink:href", renderItem['arguments'][0].src);
                                        el.setAttribute("width", renderItem['arguments'][7]);
                                        el.setAttribute("height", renderItem['arguments'][8]);
                                        el.setAttribute("x", renderItem['arguments'][5]);
                                        el.setAttribute("y", renderItem['arguments'][6]);
                                        el.setAttribute("clip-path", "url(#clipId" + clipId + ")");
                                        // el.setAttribute("xlink:href", );


                                        el.setAttribute("preserveAspectRatio", "none");

                                        svg.appendChild(el);


                                        clipId += 1;
                                    /*
                                    ctx.drawImage(
                                        renderItem['arguments'][0],
                                        renderItem['arguments'][1],
                                        renderItem['arguments'][2],
                                        renderItem['arguments'][3],
                                        renderItem['arguments'][4],
                                        renderItem['arguments'][5],
                                        renderItem['arguments'][6],
                                        renderItem['arguments'][7],
                                        renderItem['arguments'][8]
                                        );
                                        */
                                    }
                                }



                                break;
                            default:

                        }

                    }

                }
            /*
            if (storageContext.clip){
                ctx.restore();
            }
    */



            }










            h2clog("html2canvas: Renderer: SVG Renderer done - returning SVG DOM obj");

            return svg;
        }
    };

    return methods;


};

window.html2canvas = html2canvas;
}(window, document));

/**
 * jquery.extends
 *
 * @package		KALS
 * @category		JavaScript Libraries
 * @author		Pudding Chen <puddingchen.35@gmail.com>
 * @copyright		Copyright (c) 2010, Pudding Chen
 * @license		http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link		http://sites.google.com/site/puddingkals/
 * @version		1.0 2010/7/22 下午 09:25:20
 * @requires jQuery
 * @memberOf {jQUery}
 * @alias $
 */

// Deny defined again.
if (typeof($jquery_extends) === 'undefined') {

/**
 * 顯示測試訊息
 * @version 20130222 Pulipuli Chen 把錯誤訊息改成console.log()輸出
 * @param {string} _title
 * @param {Object} _test
 */
jQuery.test_msg = function (_title, _test) {
	
	//return;
	
	// @20130607 Pudding Chen
	// 加入原本的底層吧XD
    
    var _info_box = this('.KALS.info-box:first');
	
    if (_info_box.length === 0) {   
        var _toggle = $('<div></div>')
            .css('height', '15px')
            .dblclick(function () {
                _info_box.show();
            })
            .appendTo(this('body'));
        
         _info_box = this('<fieldset class="KALS info-box"><legend>Test Message Box</legend></fieldset>')
		    .css("background-color", "white")
            //.prependTo(this('body'));
            .appendTo(this('body'));
        
        //if (location.href.toLowerCase().indexOf('homework') > -1)    
        
		_info_box.hide();
        _info_box.dblclick(function () {
            $(this).hide();
        });
    }
    if (this.isset(_title) && this.is_null(_test)) {
        _test = _title;
        _title = null;
    }
    else if (this.is_null(_title) && this.is_null(_test)) {
        _test = '---------------';
		this('<hr />').appendTo(_info_box);
        return;
    }
    
    if (this.is_object(_test)) {
		
		try {
			_test = '[Object: '+this.json_encode(_test)+']';
		}
        catch (_e) {
			_text = '[Exception: '+_e+']';
		}
		
    }
	
	var _info_test = _test;
	
	if ($.starts_with(_info_test, "http") || $.starts_with(_info_test, "/kals/")) {
		_info_test = '<a href="'+_info_test+'" target="_blank">'+_info_test+'</a>';
	}
	
        //_info_test = $.str_replace(_info_test, 'http', 'htt p');
	
	var _info = this('<pre></pre>')
            .addClass("info")
			.appendTo(_info_box);

	try {
		//_info_test = $(_info_test);
		//_info.text(_info_test);
		//_info.html(_info.text());
		//console.log(_info_test);
		if (_info_test.indexOf('<a') === 0) {
			_info.html(_info_test);
		}
		else {
			_info.text(_info_test);
		}
	}
	catch (_e) {
		
	}
    
    if (this.isset(_title)) {
        console.log('[KALS]' + '[' + _title + '] ' + _test);
        _info.prepend('<strong>' + _title + ': </strong>');
    }
	else {
        console.log('[KALS] ' + _test);
    }
    //加上時間
    var _d = new Date();
    var _time = $('<div></div>')
		.addClass("time")
        .html(_d.getHours() + ':' + _d.getMinutes() + ':' + _d.getSeconds())
        .css('float', 'right')
        .prependTo(_info);
      
	return this;
};

// --------
// 字串處理
// --------

/**
 * 擷取字串
 * @param {string} _str 要被擷取的字串
 * @param {number} _start 起始位置。如果是負數，則從最後面開始算
 * @param {number} _length 長度
 */
jQuery.substr = function(_str, _start, _length) {
    _str = _str + '';
    if (_start < 0) {
		_start = _str.length + _start;
	}
    if (this.isset(_length) === false) {
        return _str.substr(_start);
    }
    else {
        return _str.substr(_start, _length);
    }
};

/**
 * 
 * @memberOf {jQuery}
 * @method ends_with
 * @param {string} _str
 * @param {string} _suffix
 * @type {string}
 */
jQuery.ends_with = function(_str, _suffix) {
    _str = _str + '';
    var _len = _suffix.length;
    var _start = 0 - _len;
    if (this.substr(_str, _start, _len) === _suffix) {
		return true;
	}
	else {
		return false;
	}
};

/**
 * 測試_str的開頭是否為_prefix
 * @memberOf {jQuery}
 * @method starts_with
 * @param {string} _str
 * @param {string} _prefix
 */
jQuery.starts_with = function(_str, _prefix) {
    _str = _str + '';
    var _len = _prefix.length;
    var _start = 0;
    if (_str.substr(_start, _len) == _prefix) {
		return true;
	}
	else {
		return false;
	}
};

/**
 * 
 * @memberOf {jQuery}
 * @method appends_with
 * @param {string} _str
 * @param {string} _suffix
 * @type {string}
 */
jQuery.appends_with = function(_str, _suffix) {
    if (this.ends_with(_str, _suffix) === false) {
		return _str + _suffix;
	}
	else {
		return _str;
	}
};

/**
 * 判斷字首是否是prefix，否則加上prefix
 *
 * @param _str
 * @param _prefix
 * @type boolean
 */
jQuery.prepends_with = function(_str, _prefix) {
    if (this.starts_with(_str, _prefix) === false) {
		return _str + _prefix;
	}
	else {
		return _str;
	}
};

/**
 * 取代字串
 * @param {String} _search 要被取代的字串
 * @param {String} _replace 要取而代之的字串
 * @param {String} _subject 進行處理的字串
 * @param {number} _count 最多的處理次數
 * @returns {String}
 */
jQuery.str_replace = function (_search, _replace, _subject, _count) {
    // http://kevin.vanzonneveld.net
    // +   original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   improved by: Gabriel Paderni
    // +   improved by: Philip Peterson
    // +   improved by: Simon Willison (http://simonwillison.net)
    // +    revised by: Jonas Raoni Soares Silva (http://www.jsfromhell.com)
    // +   bugfixed by: Anton Ongson
    // +      input by: Onno Marsman
    // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +    tweaked by: Onno Marsman
    // +      input by: Brett Zamir (http://brett-zamir.me)
    // +   bugfixed by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   input by: Oleg Eremeev
    // +   improved by: Brett Zamir (http://brett-zamir.me)
    // +   bugfixed by: Oleg Eremeev
    // %          note 1: The count parameter must be passed as a string in order
    // %          note 1:  to find a global variable in which the result will be given
    // *     example 1: str_replace(' ', '.', 'Kevin van Zonneveld');
    // *     returns 1: 'Kevin.van.Zonneveld'
    // *     example 2: str_replace(['{name}', 'l'], ['hello', 'm'], '{name}, lars');
    // *     returns 2: 'hemmo, mars'

    var _i = 0, _j = 0, _temp = '', _repl = '', _sl = 0, _fl = 0,
            _f = [].concat(_search),
            _r = [].concat(_replace),
            _s = _subject,
            _ra = _r instanceof Array, _sa = _s instanceof Array;
    _s = [].concat(_s);
    if (_count) {
        this.window[_count] = 0;
    }

    for (_i=0, _sl=_s.length; _i < _sl; _i++) {
        if (_s[_i] === '') {
            continue;
        }
        for (_j=0, _fl=_f.length; _j < _fl; _j++) {
            _temp = _s[_i]+'';
            _repl = _ra ? (_r[_j] !== undefined ? _r[_j] : '') : _r[0];
            _s[_i] = (_temp).split(_f[_j]).join(_repl);
            if (_count && _s[_i] !== _temp) {
                this.window[_count] += (_temp.length-_s[_i].length)/_f[_j].length;}
        }
    }
    return _sa ? _s : _s[0];
};

// --------
// JSON與AJAX
// --------

jQuery.json_encode = function (_json) {
    if (this.is_number(_json) || this.is_boolean(_json) || this.is_null(_json)) {
        return _json;
    }
    else if (this.is_string(_json)) {
        return this.serialize_string(_json);
    }
    else if (this.is_array(_json)) {
        return this.serialize_array(_json);
    }
    else {
        return this.serialize_json(_json);
    }
};

/**
 * 將json字串還原成為物件
 * @param {String} _string
 * @returns {Object}
 */
jQuery.json_decode = function (_string) {
    return eval(_string);
};

/**
 * 將JSON轉換成字串
 * @memberOf {jQuery}
 * @method serialize_json
 * @param {Object} _json
 * @type {string}
 */
jQuery.serialize_json = function (_json) {
    if (this.is_number(_json) || this.is_boolean(_json) || this.is_null(_json)) {
		return _json;
	}
	else 
		if (this.is_string(_json)) {
			return this.serialize_string(_json);
		}
		else 
			if (this.is_array(_json)) {
				return this.serialize_array(_json);
			}

    var _output = '';

    for (var _key in _json) {
        var _attr = '"'+_key+'":';
        var _value = _json[_key];
        if (this.is_number(_value) || this.is_boolean(_value) || this.is_null(_value)) {
			_attr += _value;
		}
		else 
			if (this.is_string(_value)) {
				_attr += this.serialize_string(_value);
			}
			else 
				if (this.is_array(_value)) {
					_attr += this.serialize_array(_value);
				}
				else 
					if (this.is_object(_value)) {
						if (typeof(_value.to_string) == 'function') {
							_attr += _value.to_string();
						}
						else {
							var _class_name = $.get_class(_value);
							if (_class_name == 'Object') {
								_attr += this.serialize_json(_value);
							}
							else {
								_attr += '[Object: ' + _class_name + ']';
							}
						}
					}

        _output = this.combine_comma(_output);
        _output += _attr;
    }

    _output = '{' + _output + '}';
    return _output;
};

jQuery.serialize_array = function (_array) {
    if (this.is_number(_array) || this.is_boolean(_array) || this.is_null(_array)) {
		return _array;
	}
	else 
		if (this.is_string(_array)) {
			return this.serialize_string(_array);
		}
		else 
			if (this.is_object(_array)) {
				return this.serialize_json(_array);
			}

    var _output = '';

    for (var _key in _array) {
        var _attr = "";
        var _value = _array[_key];
        if (this.is_number(_value) || this.is_boolean(_value) || this.is_null(_value)) {
			_attr += _value;
		}
		else 
			if (this.is_string(_value)) {
				_attr += this.serialize_string(_value);
			}
			else 
				if (this.is_array(_value)) {
					_attr += this.serialize_array(_value);
				}
				else 
					if (this.is_object(_value)) {
						_attr += this.serialize_json(_value);
					}

        _output = this.combine_comma(_output);
        _output += _attr;
    }

    _output = '[' + _output + ']';
    return _output;
};

jQuery.serialize_string = function (_str) {
    if (this.is_number(_str) || this.is_boolean(_str) || this.is_null(_str)) {
		try {
			return _str;
		}
		catch (_e) {
			return 'exception: ' + _e;
		}
	}
	else 
		if (this.is_array(_str)) {
			return this.serialize_array(_str);
		}
		else 
			if (this.is_object(_str)) {
				return this.serialize_json(_str);
			}

    _str = this.addslashes(_str);
    return '"'+_str+'"';
};

jQuery.addslashes = function (_str) {
    // http://kevin.vanzonneveld.net
    // +   original by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)
    // +   improved by: Ates Goral (http://magnetiq.com)
    // +   improved by: marrtins
    // +   improved by: Nate
    // +   improved by: Onno Marsman
    // +   input by: Denny Wardhana
    // +   improved by: Brett Zamir (http://brett-zamir.me)
    // +   improved by: Oskar Larsson Högfeldt (http://oskar-lh.name/)
    // *     example 1: addslashes("kevin's birthday");
    // *     returns 1: 'kevin\'s birthday'

    return (_str+'').replace(/[\\"']/g, '\\$&').replace(/\u0000/g, '\\0');
};

jQuery.combine_comma = function (_str) {
    if (_str !== '') {
		_str += ',';
	}
    return _str;
};

// --------
// 驗證類
// --------

jQuery.get_class = function (_obj) {
    // http://kevin.vanzonneveld.net
    // +   original by: Ates Goral (http://magnetiq.com)
    // +   improved by: David James
    // *     example 1: get_class(new (function MyClass() {}));
    // *     returns 1: "MyClass"
    // *     example 2: get_class({});
    // *     returns 2: "Object"
    // *     example 3: get_class([]);
    // *     returns 3: false
    // *     example 4: get_class(42);
    // *     returns 4: false
    // *     example 5: get_class(window);
    // *     returns 5: false
    // *     example 6: get_class(function MyFunction() {});
    // *     returns 6: false
    
    if ($.is_jquery(_obj)) {
		return 'jQuery';
	}
	else 
		if ($.is_array(_obj)) {
			return 'Array';
		}
    
    var _class_name;
    if (_obj instanceof Object
        && !(_obj instanceof Array)
        && !(_obj instanceof Function)
        && _obj.constructor
        && _obj != this.window) {
        var _arr = _obj.constructor.toString().match(/function\s*(\w+)/);
        if (_arr && _arr.length == 2) {
            return _arr[1];
        }
        else {
            _class_name = _obj.constructor.toString();
            
            //$.test_msg('$.get_class()', _class_name);
    
            if (this.starts_with(_class_name, '[object ')) {
				_class_name = _class_name.substring(8, _class_name.length);
			}
			else {
				return false;
			}
            
            if (this.ends_with(_class_name, ']')) {
				_class_name = _class_name.substring(0, _class_name.length - 1);
			}
            return _class_name;
        }
    }
    
    try {
        var _constructor = _obj.constructor + '';
        
        if ($.starts_with(_constructor, '[object')) {
            //$.test_msg('get_class', [_constructor, typeof(_constructor)]);
            var _space_pos = _constructor.lastIndexOf(' ');
            _class_name = _constructor.substring(_space_pos + 1, _constructor.length -1);
            return _class_name;
        }
    }
    catch (e) {}
    

    return false;
};

jQuery.is_null = function (_obj) {
    if (typeof(_obj) === 'undefined' ||
	(typeof(_obj) === 'string' && _obj === 'null')) {
		return true;
	}
	else {
		return (_obj === null);
	}
};

/**
 * 檢查是否是這個類別
 * @param {Object} _obj
 * @param {String} _class_name
 * @returns {Boolean}
 */
jQuery.is_class = function(_obj, _class_name) {
    if ($.is_null(_class_name)) {
        return false;
    }
    
    try {
        return (typeof(_obj) === 'object' 
            && _obj !== null 
            //&& (_obj instanceof _class_name));
            && $.get_class(_obj) === _class_name);
    }
    catch (e) {
        return false;
    }
};

jQuery.is_boolean = function(_obj) {
    return (typeof(_obj) === 'boolean');
};

/**
 * 驗證是否為陣列
 *
 * @param _obj
 * @return 驗證結果
 * @type boolean
 */
jQuery.is_array = function(_obj) {
    return (typeof(_obj) == 'object' && (_obj instanceof Array));
};

jQuery.filter_array = function (_obj) {
    var _is_array = (typeof(_obj) == 'object' && (_obj instanceof Array));
    if (false == _is_array) {
		return [_obj];
	}
	else {
		return _obj;
	}
};

/**
 * 檢查是否是字串
 * @param {Object} _obj
 * @returns {Boolean}
 */
jQuery.is_string = function (_obj) {
    return (typeof(_obj) === 'string');
};

jQuery.is_number = function (_obj) {
    return (typeof(_obj) === 'number');
};

/**
 * 檢查物件是否屬於整數或是英字、半型標點符號。詳細的範圍請看下面的連結。
 * @see   Wikipedia - ASCII: http://zh.wikipedia.org/zh-tw/Ascii
 * @param {Object} _text
 */
jQuery.is_ascii = function (_text) {
    if ($.is_number(_text)) {
		return true;
	}
	else 
		if ($.is_string(_text)) {
		
			for (var _i = 0; _i < _text.length; _i++) {
				_ascii_num = _text.charCodeAt(_i);
				
				//$.test_msg('$.is_ascii', [_ascii_num, _i, _text, _text.length]);
				
				if (_ascii_num > 32 && _ascii_num < 126) {
				//return true; 
				}
				else {
					return false;
				}
			}
			return true;
		}
		else {
			return false;
		}
};

jQuery.is_object = function (_obj) {
    return (typeof(_obj) == 'object' && !(_obj instanceof Array));
};

/**
 * 檢測變數是否是函式
 * @param {Object} _obj
 * @returns {Boolean}
 */
jQuery.is_function = function (_obj) {
    return (typeof(_obj) === 'function');
};

/**
 * 檢測變數是否是空值
 * @param {Object} _obj
 * @returns {Boolean}
 */
jQuery.is_undefined = function (_obj) {
    return (_obj === undefined);
};

/**
 * 驗證是否物件為jQuery物件
 * @param {Object} _obj
 */
jQuery.is_jquery = function (_obj) {
    return (typeof(_obj) == 'object' && (_obj instanceof jQuery));
};

/**
 * 驗證是否物件_element為HTML物件
 * @param {Object} _element
 */
jQuery.is_html_element = function (_element) {
    var _class_name = this.get_class(_element);
    
    //$.test_msg([_class_name, _element.constructor]);
    if (_class_name === false) {
		return false;
	}
    if (this.starts_with(_class_name, 'HTML') &&
	(this.ends_with(_class_name, 'Element') || this.ends_with(_class_name, 'ElementConstructor'))) {
		// 2010.9.3 Android會把HTML元素判斷為「HTMLDivElementConstructor」之類的
		return true;
	}
	else {
		return false;
	}
};

/**
 * 檢測變數是否存在，如果是null，也作為不存在
 * @param {Object} _obj
 */
jQuery.isset = function (_obj) {
    if (typeof(_obj) == "undefined" ||
	this.is_null(_obj) === true) {
		return false;
	}
	else {
		return true;
	}
};

/**
 * 確認此路徑是否有物件可以使用
 * @memberOf {jQuery}
 * @method object_isset
 * @param {string} _object_path 要偵測的路徑
 * @type {boolean}
 */
jQuery.object_isset = function (_object_path) {
    var _paths = _object_path.split('.');
    var _path_now = '';
    for (var _key in _paths) {
        if (_path_now !== '') {
			_path_now = _path_now + '.';
		}
        _path_now = _path_now + _paths[_key];
        
        var _test_path = _path_now;
        if (this.ends_with(_test_path, '()')) {
			_test_path = _test_path.substr(0, _test_path.length - 2);
		}
        
        var _result = eval('typeof('+_test_path+')');     
        if (_result == 'undefined') {
			return false;
		}
    }
    return true;
};

// --------
// URL類
// --------

/**
 * 檢查字串是否是網址
 * @param {String} _url
 * @returns {Boolean}
 */
jQuery.is_link = function(_url) {
    if (this.starts_with(_url, 'http://') ||
	this.starts_with(_url, 'https://') ||
	this.starts_with(_url, 'ftp://')) {
            return true;
    }
    else {
            return false;
    }
};

/**
 * 檢查字串是否是網址
 * @param {String} _url
 * @returns {Boolean}
 */
jQuery.is_url = function (_url) {
    return this.is_link(_url);
};

jQuery.parse_url = function (_str, _component) {
    // http://kevin.vanzonneveld.net
    // +      original by: Steven Levithan (http://blog.stevenlevithan.com)
    // + reimplemented by: Brett Zamir (http://brett-zamir.me)
    // %          note: Based on http://stevenlevithan.com/demo/parseuri/js/assets/parseuri.js
    // %          note: blog post at http://blog.stevenlevithan.com/archives/parseuri
    // %          note: demo at http://stevenlevithan.com/demo/parseuri/js/assets/parseuri.js
    // %          note: Does not replace invaild characters with '_' as in PHP, nor does it return false with
    // %          note: a seriously malformed URL.
    // %          note: Besides function name, is the same as parseUri besides the commented out portion
    // %          note: and the additional section following, as well as our allowing an extra slash after
    // %          note: the scheme/protocol (to allow file:/// as in PHP)
    // *     example 1: parse_url('http://username:password@hostname/path?arg=value#anchor');
    // *     returns 1: {scheme: 'http', host: 'hostname', user: 'username', pass: 'password', path: '/path', query: 'arg=value', fragment: 'anchor'}

    var  _o   = {
        strictMode: false,
        key: ["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],
        q:   {
            name:   "queryKey",
            parser: /(?:^|&)([^&=]*)=?([^&]*)/g
        },
        parser: {
            strict: /^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
            loose:  /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/\/?)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/ // Added one optional slash to post-protocol to catch file:/// (should restrict this)
        }
    };

    var _m   = _o.parser[_o.strictMode ? "strict" : "loose"].exec(_str),
    uri = {},
    i   = 14;
    while (i--) {uri[_o.key[i]] = _m[i] || "";}
    // Uncomment the following to use the original more detailed (non-PHP) script

    //    uri[o.q.name] = {};
    //    uri[o.key[12]].replace(o.q.parser, function ($0, $1, $2) {
    //    if ($1) uri[o.q.name][$1] = $2;
    //    });
    //    return uri;


    switch (_component) {
        case 'PHP_URL_SCHEME':
            return uri.protocol;
        case 'PHP_URL_HOST':
            return uri.host;
        case 'PHP_URL_PORT':
            return uri.port;
        case 'PHP_URL_USER':
            return uri.user;
        case 'PHP_URL_PASS':
            return uri.password;
        case 'PHP_URL_PATH':
            return uri.path;
        case 'PHP_URL_QUERY':
            return uri.query;
        case 'PHP_URL_FRAGMENT':
            return uri.anchor;
        default:
            var _retArr = {};
            if (uri.protocol !== '') {_retArr.scheme=uri.protocol;}
            if (uri.host !== '') {_retArr.host=uri.host;}
            if (uri.port !== '') {_retArr.port=uri.port;}
            if (uri.user !== '') {_retArr.user=uri.user;}
            if (uri.password !== '') {_retArr.pass=uri.password;}
            if (uri.path !== '') {_retArr.path=uri.path;}
            if (uri.query !== '') {_retArr.query=uri.query;}
            if (uri.anchor !== '') {_retArr.fragment=uri.anchor;}
            return _retArr;
    }
};

/**
 * 連結是圖片
 * @param {String} _url
 * @returns {Boolean}
 */
jQuery.is_image = function(_url) {
    if (false === this.is_link(_url)) {
        return false;
    }
    var _param = this.parse_url(_url);
    if (this.is_null(_param) || this.is_null(_param.path)) {
        return false;
    }
    var _path = _param.path;
    var _ext = this.parse_extension_name(_path);
    if (this.is_null(_ext)) {
        return false;
    }
    var _image_array = ['jpg', 'jpeg', 'gif', 'png'];
    if (this.inArray(_ext, _image_array) !== -1) {
        return true;
    }
    else {
        return false;
    }
};

jQuery.parse_extension_name = function (_path) {
    var _dot = _path.lastIndexOf('.');
    var _slash = _path.lastIndexOf('/');
    if (_dot === -1 || _dot < _slash) {
        return null;
    }
    else {
        var _ext = _path.substr(_dot + 1);
        return _ext;
    }
};

/**
 * 是否存在
 * @memberOf {jQuery}
 * @class {jQuery}
 * @method [exists]
 * @type {boolean}
 */
jQuery.fn.exists = function () {
    return (this.length > 0);
};

/**
 * @memberOf {jQuey}
 * @property
 * @type {string}
 */
jQuery.inited_flag = 'inited';
jQuery.fn.has_inited = function () {
    return this.hasClass(this.inited_flag);
};

/**
 * 設定為已初始化
 * @memberOf {jQuery}
 * @method [set_inited]
 */
jQuery.fn.set_inited = function () {
    return this.addClass(this.inited_flag);
};

jQuery.extend({
    /**
     * 初始化
     * @memberOf {jQuery}
     * @method [init]
     * @param {function} _callback 要初始化的動作
     */
    init: function (_callback) {
        if (false == $(this).hasClass('inited')) {
            if (this.is_function(_callback)) {
				_callback(this);
			}
            $(this).addClass('inited');
        }
        return this;
    }
});

jQuery.fn.extend({
    /**
     * 元素水平對齊
     * @memberOf {jQuery}
     * @method [align]
     * @param {Object} _options
     * 選項有三個
     * - option: 'left', 'middle', 'right'
     * - offset: 位移。會受到scale影響。
     * - scale: 手機模式用的縮放比例
     */
    align: function (_options) {
        if (_options === 'left' || _options === 'center' || _options === 'right') {
            _options = {
                option: _options
            };
        }

        var _option = $.get_parameter(_options, 'option');
        if ($.is_null(_option)) {
            return this;
        }
        var _scale = $.get_parameter(_options, 'scale', 1);
        _scale = 1;
        var _offset = $.get_parameter(_options, 'offset', 0);
        _offset = $.css_scale(_offset, _scale);
        _offset = $.strip_unit(_offset);
        var _speed = $.get_parameter(_options, 'speed', 'normal');
    
        var _this = $(this);
        //var position = _this.css('position');
        
        var _mobile_mode = $.is_mobile_mode();
        //_mobile_mode = false;
        
        if (_this.is_layer()) {
            if (_mobile_mode) {
                _this.css('position', 'absolute');
            }
            else {
                _this.css('position', 'fixed');
            }
            
            var _direction = 'left';
            
            //探測螢幕寬度
            /*
            var _max_width = window.innerWidth;
            if (window.innerWidth > window.outerWidth) {
                _max_width = window.outerWidth;
            }
            */
            var _max_width = $.get_viewport_width();
            _max_width = _max_width * _scale;
            
            
            if (_option === 'left') {
                if (_mobile_mode) {
                    _option = window.pageXOffset;
                    _option = _option + _offset;
                }
                else {
                    _option = _offset;
                }
            }
            else if (_option === 'right') {
               
               _direction = 'right';
               if (_mobile_mode) {
                   _option = window.screen.width 
                       - window.pageXOffset 
                       - _max_width
                       + _offset;
               }
               else {
                   _direction = 'right';
                   _option = _offset;    
               }
            }
            else if (_option === 'center') {
                var _width = _this.width();
                
                var _padding_left = $.strip_unit(_this.css('padding-left'));
                _width = _width + _padding_left;
                var _padding_right = $.strip_unit(_this.css('padding-right'));
                _width = _width + _padding_right;
                
                var _border_left = $.strip_unit(_this.css('border-left-width'));
                _width = _width + _border_left;
                var _border_right = $.strip_unit(_this.css('border-right-width'));
                _width = _width + _border_right;
                
                _option = (_max_width - _width) / 2 
                    + _offset;
                if (_mobile_mode) {
					_option = _option + window.pageXOffset;
				}
    
            }
            
            ALIGN_CHECK = _this.width();
            /*
            if (_mobile_mode) 
                _this.css(_direction, _option + 'px');
            else {
                var _animate_option = {};
                _animate_option[_direction] = _option + 'px';
                _this.animate(_animate_option, {
                    queue:false,
                    complete: function () {
                        if (_this.width() != ALIGN_CHECK) {
                            $(_this).align(_options);
                        }
                    },
                    duration: _speed
                });
            }
            */
            //2010.9.10 取消動畫
            _this.css(_direction, _option + 'px');
            
        }
        else {
            if (_option === 'left') {
                _this.css('margin-left', 0)
                    .css('float', 'none');
            }
            else if (_option === 'right') {
                _this.css('margin-right', 0)
                    .css('float', 'right');
            }
            else if (_option === 'center') {
                _this.css('margin-right', 'auto')
                    .css('margin-left', 'auto')
                    .css('float', 'none');
            }
            else {
                _this.css('margin-left', _option)
                    .css('float', 'none');
            }
        }
        return this;
    },
    /**
     * 元素垂直對齊
     * @memberOf {jQuery}
     * @param {Object} _options
     * 選項有三個
     * - option: 'left', 'middle', 'right'
     * - offset: 位移。會受到scale影響。
     * - scale: 手機模式用的縮放比例
     */
    valign: function (_options) {
        if (_options === 'top' || _options === 'middle' || _options === 'bottom') {
            _options = {
                    option: _options
            };
        }
        
        var _option = $.get_parameter(_options, 'option');
        
        if ($.is_null(_option)) {
            return this;
        }
            
        var _scale = $.get_parameter(_options, 'scale', 1);
        var _offset = $.get_parameter(_options, 'offset', 0);
        _offset = $.css_scale(_offset, _scale);
        _offset = $.strip_unit(_offset);
        var _speed = $.get_parameter(_options, 'speed', 'normal');
        
        var _this = $(this);
        //var _position = _this.css('position');
        
        if ($.is_null(_scale)) {
			_scale = 1;
		}
            
        var _mobile_mode = $.is_mobile_mode();
        
        //if (_position != 'static')
        if (_this.is_layer()) {
            if (_mobile_mode) {
                _this.css('position', 'absolute');
            }
            else {
                _this.css('position', 'fixed');
            }
            
            //探測螢幕高度
            var _max_height = $.get_viewport_height();
            _max_height = _max_height * _scale;
            
            var _direction = 'top';
            
            
            if (_option === 'top') {
                
                if (_mobile_mode) {
                    _option = window.pageYOffset
                        + _offset;
                }
                else {
                    _option = _offset;    
                }
            }
            else if (_option === 'bottom') {
                _direction = 'bottom';
                _option = _offset;
                if (_mobile_mode) {
                    _option = window.screen.height 
                        - window.pageYOffset 
                        - _max_height
                        + _offset;
                }
                
            }
            else if (_option === 'middle') {
                var _height = _this.height();
                
                var _padding_top = $.strip_unit(_this.css('padding-top'));
                _height = _height + _padding_top;
                var _padding_bottom = $.strip_unit(_this.css('padding-bottom'));
                _height = _height + _padding_bottom;
                
                var _border_top = $.strip_unit(_this.css('border-top-width'));
                _height = _height + _border_top;
                var _border_bottom = $.strip_unit(_this.css('border-bottom-width'));
                _height = _height + _border_bottom;
                
                _option = (_max_height - _height) / 2 + _offset;
                
                if (_mobile_mode) {
                    _option = _option + window.pageYOffset;
                }
                //alert([_option, _max_height, _height, window.pageYOffset]);
            }
            
            /*
            if (_mobile_mode) 
                _this.css(_direction, _option + 'px');
            else {
               var _animate_option = {};
               _animate_option[_direction] = _option + 'px';
               _this.animate(_animate_option, {
                   queue:false,
                   duration: _speed
               });
            }
            */
            //2010.9.10 取消動畫
            _this.css(_direction, _option + 'px');
        }
        else {
            if (_option === 'top') {
                _this.css('margin-top', 0);
            }
            else if (_option === 'bottom') {
                _this.css('margin-bottom', 0);
            }
            else if (_option === 'middle') {
                _this.css('margin-top', 0)
                    .css('margin-bottom', 0);
            }
            else {
                _this.css('margin-top', _option);
            }
        }
        
        return this;
    },
    center: function (_scale) {
        var _this = $(this);
        
        _this.valign({
            option: 'middle',
            scale: _scale
        });
        
        _this.align({
            option: 'center',
            scale: _scale
        });
    },
    is_layer: function () {
        var _this = $(this);
        var _position = _this.css('position');
        return (_position !== 'static');
    },
    /**
     * 是否顯示
     * @memberOf {jQuery}
     * @class {jQuery}
     * @method visible
     * @type {boolean}
     */
    visible: function () {
        var _this = $(this);
        /*
        if (_this.css('display') == 'none')
            return false;
        else if (_this.css('visibility') == 'hidden')
            return false;
        return true;
        */
        return (_this.filter(':visible').length > 0);
    },
    /**
     * 將物件寬度成到畫面寬度
     * 
     * @memberOf {jQuery}
     * @class {jQuery}
     * @param {Object} _scale 縮放比率
     */
    fullscreen_width: function (_scale) {
        var _this = $(this);
        
        if ($.is_null(_scale)) {
			_scale = 1;
		}
        //探測螢幕寬度
        //var _max_width = Math.min(window.innerWidth, window.outerWidth, $(document).width());
        var _max_width = $.get_viewport_width();
        //_max_width = _max_width * _scale;
        
        var _padding_left = $.strip_unit(_this.css('padding-left'));
        _max_width = _max_width - _padding_left;
        var _padding_right = $.strip_unit(_this.css('padding-right'));
        _max_width = _max_width - _padding_right;
        var _border_left = $.strip_unit(_this.css('border-left-width'));
        _max_width = _max_width - _border_left;
        var _border_right = $.strip_unit(_this.css('border-right-width'));
        _max_width = _max_width - _border_right;
        
        //保留原本的寬度到屬性去
        _this.attr('restore_width', _max_width + 'px');
        
        _this.css('width', _max_width  + 'px');
            //.css('border-right-width', 0)
            //.css('border-left-width', 0);
        
        return this;
    },
    fullscreen_height: function (_scale) {
        var _this = $(this);
        
        if ($.is_null(_scale)) {
			_scale = 1;
		}
        
        //探測螢幕高度
        var _max_height = $.get_viewport_height();
        //_max_height = _max_height * _scale;
        
        //if ($.is_mobile_mode())
        //    _max_height = _max_height - 20;
        
        var _padding_top = $.strip_unit(_this.css('padding-top'));
        _max_height = _max_height - _padding_top;
        var _padding_bottom = $.strip_unit(_this.css('padding-bottom'));
        _max_height = _max_height - _padding_bottom;
        
        var _border_top = $.strip_unit(_this.css('border-top-width'));
        _max_height = _max_height - _border_top;
        var _border_bottom = $.strip_unit(_this.css('border-bottom-width'));
        _max_height = _max_height - _border_bottom;
        
        //保留原本的高度到屬性去
        _this.attr('restore_height', _max_height + 'px');
        
        _this.css('height', _max_height+'px');
            //.css('border-top-width', 0)
            //.css('border-bottom-width', 0);
            //.css('padding-top', 0)
            //.css('padding-bottom', 0);
        
        return this;
    },
    /**
     * 將元素伸展到螢幕寬度及高度
     * @memberOf {jQuery}
     * @class {jQuery}
     * @param {string} _option "width", "height", "x", "y"
     * @param {number} _scale 比例
     */
    fullscreen: function (_option, _scale) {
        var _this = $(this);
        if ($.is_number(_option) && $.is_null(_scale)) {
            _scale = _option;
            _option = null;
        }
        if ($.is_null(_scale)) {
			_scale = 1;
		}
        if (_option === 'width' || _option === 'x') {
            _this.fullscreen_width(_scale);
        }
        else if (_option === 'height' || _option === 'y') {
                _this.fullscreen_height(_scale);
        }
        else {
                _this.fullscreen_width(_scale);
                _this.fullscreen_height(_scale);

        }
        return this;
    },
    restore: function () {
        var _this = $(this);
        if (_this.hasAttr('restore_width')) {
            //_this.css('width', _this.attr('restore_width'));
            _this.css('width', 'auto');
            _this.removeAttr('restore_width');
        }
        if (_this.hasAttr('restore_height')) {
            //_this.css('width', _this.attr('restore_width'));
            _this.css('width', 'auto');
            _this.removeAttr('restore_height');
        }
    },
    /**
     * 將屬性回存到CSS當中
     * @param {string} _attr 屬性
     * @param {string} _css CSS項目
     * @param {string|null} _reset 回存之後，屬性的值。空值則刪除此屬性 
     */
    attr_to_css: function (_attr, _css, _reset) {
        var _this = $(this);
        var _value = _this.attr(_attr);
        if ($.isset(_value)) {
            _this.css(_css, _value);
            if ($.is_null(_reset)) {
				_this.removeAttr(_attr);
			}
			else {
				_this.attr(_attr, _reset);
			}
        }
        return this;
    },
    css_to_attr: function (_css, _attr, _reset) {
        var _this = $(this);
        if (_this.hasAttr(_attr)) {
			return this;
		}
        
        var _value = _this.css(_css);
        if ($.isset(_value) && _value !== 0 && _value !== '') {
            _this.attr(_attr, _value);
            if ($.isset(_reset)) {
				_this.css(_css, _reset);
			}
        }
        return this;
    },
    css_number: function (_css) {
        return $.strip_unit($(this).css(_css));
    },
    /**
     * 取得物件的寬度
     * @type {number}
     */
    get_width: function () {
        var _this = $(this);
        var _length = _this.css('width');
        if ($.is_null(_length)) {
            _length = _this.width();
            _length = $.append_unit(_length);
        }
        return _length;
    },
    /**
     * 取得物件的高度
     * @type {number}
     */
    get_height: function () {
        var _this = $(this);
        var _length = _this.css('height');
        if ($.is_null(_length)) {
            _length = _this.height();
            _length = $.append_unit(_length);
        }
        return _length;
    },
    /**
     * 是否擁有屬性
     * @param {string} _attr
     * @type {boolean}
     */
    hasAttr: function (_attr) {
        var _this = $(this);
        var _value = _this.attr(_attr);
        return ($.isset(_value));
    },
    /**
     * 按照比例調整jQuery物件本身的CSS值
     * @memberOf {jQuery}
     * @class {jQuery}
     * @param {string} _css 指定CSS項目
     * @param {string|number} _expect 預期值
     * @param {number|null} _scale 比例值
     */
    css_scale: function (_css, _expect, _scale) {   
        if ($.is_object(_css) && $.is_null(_scale)) {
            _scale = _expect;
            _expect = _css.expect;
            _css = _css.css;
        }
    
        if ($.is_array(_css)) {
            for (var _i in _css) {
                this.css_scale(_css[_i], _expect, _scale);
            }
            return this;
        }
        
        if ($.is_null(_scale)) {
			_scale = 1;
		}
        //var _this = $(this);
        
        //var _value = this.css(_css);
        
        if ($.is_null(_expect) ||
		_expect === 0 ||
		_expect === '') {
			return this;
		}
        
        var _scale_length = function (_expect, _scale) {
            if ($.is_number(_expect)) {
                _expect = _expect * _scale;
                if (_expect < 1) {
					_expect = 1;
				}
            }
            else {
                if ($.is_string(_expect)) {
                    if ($.ends_with(_expect, '%')) {
                        _expect = _expect.substr(0, _expect.length - 1);
                        _expect = _expect * _scale;
                        if (_expect < 1) {
							_expect = 1;
						}
                        _expect = _expect + '%';
                    }
                    else {
                        if ($.ends_with(_expect, 'px') ||
						$.ends_with(_expect, 'em') ||
						$.ends_with(_expect, 'cm') ||
						$.ends_with(_expect, 'pt') ||
						$.ends_with(_expect, 'ex') ||
						$.ends_with(_expect, 'px') ||
						$.ends_with(_expect, 'in') ||
						$.ends_with(_expect, 'mm') ||
						$.ends_with(_expect, 'pc')) {
							var _len = _expect.length;
							var _unit = _expect.substr(_len - 2, _len);
							_expect = _expect.substr(0, _len - 2);
							_expect = _expect * _scale;
							
							if (_expect < 1) {
								_expect = 1;
							}
							
							_expect = _expect + _unit;
						}
						else {
							return null;
						}
                    }
                }
            }
            return _expect;
        };
        
        if ($.is_string(_expect) && _expect.indexOf(' ') > -1) {
            var _expects = _expect.split(' ');
            for (var _key in _expects) {
                _expects[_key] = _scale_length(_expects[_key], _scale);
            }
            _expect = _expects.join(' ');
        }
        else {
            _expect = _scale_length(_expect, _scale);
        }
        if ($.is_null(_expect)) {
			return this;
		}
        
        this.css(_css, _expect);
        return this;
    },
    id: function(_set) {
        if ($.isset(_set)) {
			return $(this).attr('id', _set);
		}
		else {
			return $(this).attr('id');
		}
    }
});

/**
 * 將CSS值加入單位。如果已經有單位，則不做調整
 * @param {string|number} _length CSS值
 * @param {string} _default_unit 預設單位
 * @type {type}
 */
jQuery.append_unit = function (_length, _default_unit) {
    if (this.is_null(_default_unit)) {
		_default_unit = 'px';
	}
    
    if (this.is_number(_length)) {
		return _length + _default_unit;
	}
	else {
		if (this.ends_with(_length, 'px') ||
		this.ends_with(_length, '%') ||
		this.ends_with(_length, 'em') ||
		this.ends_with(_length, 'cm') ||
		this.ends_with(_length, 'pt') ||
		this.ends_with(_length, 'ex') ||
		this.ends_with(_length, 'px') ||
		this.ends_with(_length, 'in') ||
		this.ends_with(_length, 'mm') ||
		this.ends_with(_length, 'pc')) {
			return _length;
		}
		else {
			return _length + _default_unit;
		}
	}
};

/**
 * 去除CSS值的單位
 * @param {string|number} _length CSS值
 * @type {number}
 */
jQuery.strip_unit = function (_length) {
    if (this.is_number(_length)) {
		return _length;
	}
	else {
		if (this.ends_with(_length, '%')) {
			_length = _length.substr(0, _length.length - 1);
		}
		if (this.ends_with(_length, 'px') ||
		this.ends_with(_length, 'em') ||
		this.ends_with(_length, 'cm') ||
		this.ends_with(_length, 'pt') ||
		this.ends_with(_length, 'ex') ||
		this.ends_with(_length, 'px') ||
		this.ends_with(_length, 'in') ||
		this.ends_with(_length, 'mm') ||
		this.ends_with(_length, 'pc')) {
			_length = _length.substr(0, _length.length - 2);
		}
		
		//$.test_msg(_length);
		var _output = parseInt(_length,10);
		if (isNaN(_output)) {
			_output = 0;
		}
		return _output;
	}
};

/**
 * 取得CSS值的單位
 * @param {string|number} _length
 * @type {string}
 */
jQuery.get_unit = function (_length) {
    var _unit = null;
    if (this.is_number(_length)) {
		return _unit;
	}
	else {
		var _len = _length.length;
		if (this.ends_with(_length, '%')) {
			_unit = _length.substr(_len - 1, _len);
		}
		if (this.ends_with(_length, 'px') ||
		this.ends_with(_length, 'em') ||
		this.ends_with(_length, 'cm') ||
		this.ends_with(_length, 'pt') ||
		this.ends_with(_length, 'ex') ||
		this.ends_with(_length, 'px') ||
		this.ends_with(_length, 'in') ||
		this.ends_with(_length, 'mm') ||
		this.ends_with(_length, 'pc')) {
			_unit = _length.substr(_len - 2, _len);
		}
		return _unit;
	}
};

/**
 * 縮放CSS單位的數值
 * @param {string|number} _length 要縮放的數值 
 * @param {number} _scale 比例
 */
jQuery.css_scale = function (_length , _scale) {
    if (_scale != 1 && _length !== 0) {
        var _unit = $.get_unit(_length);
        _length = $.strip_unit(_length) * _scale;
        _length = _length + _unit;
    }
    return _length;
};

jQuery.get_viewport_width = function () {
    var _max_width = window.innerWidth;
    if (isNaN(window.innerWidth) || window.innerWidth > window.outerWidth) {
		_max_width = window.outerWidth;
	}
    if (isNaN(_max_width) || _max_width > $(document).width()) {
		_max_width = $(document).width();
	}
    
    if (document.documentElement && document.documentElement.clientWidth) {
        //IE 6+ in 'standards compliant mode'
        _ie_width = document.documentElement.clientWidth;
        if (isNaN(_max_width) || _max_width > _ie_width) {
			_max_width = _ie_width;
		}
    }
    return _max_width;
};

jQuery.get_viewport_height = function () {
    var _max_length = window.innerHeight;
    if (isNaN(_max_length) || _max_length > window.outerHeight) {
		_max_length = window.outerHeight;
	}
    if (isNaN(_max_length) || _max_length > $(document).height()) {
		_max_length = $(document).height();
	}
    
    if (document.documentElement && document.documentElement.clientHeight) {
        //IE 6+ in 'standards compliant mode'
        _ie_height = document.documentElement.clientHeight;
        if (isNaN(_max_length) || _max_length > _ie_height) {
			_max_length = _ie_height;
		}
    }
    
    return _max_length;
};

/**
 * 建立HTML元素，並附加在body之後。
 * @param {string} _html
 * @memberOf {jQuery}
 * @type {jQuery}
 */
jQuery.create_once = function (_html, _append_to) {
    
    if (this.is_null(_append_to)) {
		_append_to = this('body');
	}
    
    var _temp_obj = this(_html);
    var _tag_name = _temp_obj.attr('tagName');

    var _class_name = _temp_obj.attr('class');
    if (_class_name !== '' && _class_name !== null) {
		var _classes = _class_name.split(' ');
		_class_name = '';
		for (var _key in _classes) {
			_class_name += '.' + _classes[_key];
		}
	}
	else {
		_class_name = '';
	}

    var _id = _temp_obj.attr('id');
    if (_id !== '' && _id !== null) {
		_id = '#' + _id;
	}
	else {
		_id = '';
	}


    if (_class_name === '' && _id === '') {
        _temp_obj.appendTo(_append_to);
        return _temp_obj;
    }
    else {
        var _selector = _tag_name+_class_name+_id;
        var _obj = this(_selector);
        if (false === _obj.exists()) {
            _temp_obj.appendTo(_append_to);
            _obj = _temp_obj;
        }
        return _obj;
    }
};

/**
 * 檢查是否符合Interface
 * @param {Object} _theObject
 * @param {Object} _theInterface
 * @type {boolean}
 */
jQuery.check_interface = function(_theObject, _theInterface) {
    for (var _member in _theInterface) {
        if ( (typeof _theObject[_member] != typeof _theInterface[_member]) ) {
            this.test_msg("object failed to implement interface member ", _member);
            return false;
        }
    }
    //if we get here, it passed the test, so return true
    return true;
};

/**
 * 去除HTML標籤
 * @memberOf {jQuery}
 * @param {string} _html 含有HTML標籤的字串
 * @param {string} _except_tags 不要移除的標籤
 * @type {string}
 */
jQuery.strip_html_tag = function(_html, _except_tags) {
    //var _reTag = /<(?:.|\s)*?/g;
    var _reTag = /<[^>].*?>/g;
    
    if (typeof(_except_tags) == "string") {
        _except_tags = [_except_tags];
    }
    if (typeof(_except_tags) != "undefined" 
		&& typeof(_except_tags[0]) == "string") {
		_reTag = "<[^(";
		for (var _i = 0; _i < _except_tags.length; _i++) {
			if (_i > 0) {
				_reTag = _reTag + "|";
			}
			_reTag = _reTag + _except_tags[_i];
		}
		_reTag = _reTag + ")>].*?>";
		_reTag = new RegExp(_reTag, "g");
	}
    
    return _html.replace(_reTag,"");
};

/**
 * CSS框線圓角的名稱區
 */
jQuery.css_border_radius = { 
    moz: [
        '-moz-border-radius-topleft' ,
        '-moz-border-radius-topright' , 
        '-moz-border-radius-bottomleft' ,
        '-moz-border-radius-bottomright'
    ],
    general: [
        'border-top-left-radius' ,
        'border-top-right-radius' ,
        'border-bottom-left-radius' ,
        'border-bottom-right-radius'
    ],
    khtml: [
        '-khtml-border-radius-topleft' ,
        '-khtml-border-radius-topright' , 
        '-khtml-border-radius-bottomleft' ,
        '-khtml-border-radius-bottomright'
    ],
    webkit: [
        '-webkit-border-radius-topleft' ,
        '-webkit-border-radius-topright' , 
        '-webkit-border-radius-bottomleft' ,
        '-webkit-border-radius-bottomright'
    ]
};

/**
 * 適合手指的格式儲存區
 */
jQuery.css_finger_friendly = {
    'button': [
        {css: 'font-size', expect: '30px'},
        {css: 'border-width', expect: '3px'},
        {css: 'padding', expect: '5px'},
        {css: jQuery.css_border_radius.moz, expect: '10px'},
        {css: jQuery.css_border_radius.webkit, expect: '10px 10px'},
        {css: jQuery.css_border_radius.khtml, expect: '10px 10px'},
        {css: jQuery.css_border_radius.general, expect: '10px 10px'}
    ]
};

/**
 * 手機模式的暫存區
 * @type {boolean}
 */
jQuery.mobile_mode = null;

/**
 * 是否為手機模式
 * @type {boolean}
 * @memberOf {jQuery}
 * @method [is_mobile_mode]
 */
jQuery.is_mobile_mode = function () {
    
    //return true;
    
    if (this.mobile_mode === null) {
        var _this = this;
        try {
            var _yui = YUI();
            if (typeof(_yui.use) === "function") {

                _yui.use("", function(Y){
                    var _mode = (!$.is_null(Y.UA.mobile));
                    _this.mobile_mode = _mode;
                    //$.test_msg("行動版", _mode);
                    //alert("行動版:" + _mode);
                });
                
                if (_this.mobile_mode === false) {
                    $.browser.device = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));
                    _this.mobile_mode = $.browser.device;
                }
            }
        }
        catch (_e) {
            _this.mobile_mode = false;
        }
    }
    return this.mobile_mode;
};

/**
 * 是否為小螢幕模式
 * 這邊所指的小螢幕，是指寬小於400，或是高度小於480
 * @param {boolean} _strict = true
 * true：必須要寬度與高度符合才算小螢幕
 * false：寬度或高度其中一個符合就算是小螢幕
 * @type {boolean}
 */
jQuery.is_small_screen = function (_strict) {
    
    if ($.is_null(_strict)) {
		_strict = true;
	}
    
    var _width = $.get_viewport_width();
    var _height = $.get_viewport_height();
    
    if (_strict) {
		return (!(_width > 400 && _height > 480));
	}
	else {
		return (!(_width > 400 || _height > 480));
	}
};

jQuery.is_small_width = function () {
    var _width = $.get_viewport_width();
    return (_width < 400);
};

jQuery.is_small_height = function () {
    var _height = $.get_viewport_height();
    
    return (!(_height > 480));
};

jQuery.touchable = null;
/**
 * 偵測螢幕是否為觸控式
 */
jQuery.is_touchable = function () {
   
   if (this.touchable === null) {
       var _touchable = false;
        try {            
            var _el = document.createElement('div');
            _el.setAttribute('ontouchstart', 'return;');
           if (typeof(_el.ontouchstart) === "function") {
		   	_touchable = true;
		   }
       } catch (_e) { }
       this.touchable = _touchable;
   }
   return this.touchable;
};

// ---------
// 相關介面
// ---------

jQuery.fn.extend({
    /**
     * 對應到Zoom觀察者的方法
     * @param {Zoom_observable} _zoom_observable
     */
    onzoom: function (_zoom_observable) {
        
    },
    /**
     * 對應到Viewport Move事件
     * 
     */
    onviewportmove: function() {
        
    }
});

/**
 * 取得參數
 * @memberOf {jQuery}
 * @memberOf {$}
 * @method [get_paramter]
 * @param {Object} _parameters
 * @param {string} _name
 * @param {Object} _default_value
 */
jQuery.get_parameter = function(_parameters, _name, _default_value) {
    if ($.is_null(_parameters)) {
		return null;
	}
    
    if ($.is_array(_name)) {
		for (var _key in _name) {
			var _n = _name[_key];
			//if (typeof(_parameters[_n])!= 'undefined' && _parameters[_n] != null)
			if (typeof(_parameters[_n]) != 'undefined' && $.isset(_parameters[_n])) {
				//if ($.isset(_parameters[_n])) 
				return _parameters[_n];
			}
		}
	}
	else 
		if (typeof(_parameters[_name]) != 'undefined' && $.isset(_parameters[_name])) {
			//else if ($.isset(_parameters[_name])) 
			return _parameters[_name];
		}
    
    if ($.isset(_default_value)) {
		return _default_value;
	}
	else {
		return null;
	}
};

jQuery._match_config = {
    english: {
        'q':1,'w':1,'e':1,'r':1,'t':1,'y':1,'u':1,'i':1,'o':1,'p':1,'a':1,'s':1,'d':1,'f':1,'g':1,'h':1,'j':1,'k':1,'l':1,'z':1,'x':1,'c':1,'v':1,'b':1,'n':1,'m':1
        ,
        'Q':1,'W':1,'E':1,'R':1,'T':1,'Y':1,'U':1,'I':1,'O':1,'P':1,'A':1,'S':1,'D':1,'F':1,'G':1,'H':1,'J':1,'K':1,'L':1,'Z':1,'X':1,'C':1,'V':1,'B':1,'N':1,'M':1
    },
    upper_english: {
        'Q':1,'W':1,'E':1,'R':1,'T':1,'Y':1,'U':1,'I':1,'O':1,'P':1,'A':1,'S':1,'D':1,'F':1,'G':1,'H':1,'J':1,'K':1,'L':1,'Z':1,'X':1,'C':1,'V':1,'B':1,'N':1,'M':1
    },
    punctuation: {
        '，':1,',':1,'。':1,'.':1,'：':1,':':1,'；':1,';':1,'、':1,'？':1,'?':1,'！':1,'!':1,'-':1
    },
    sentence_punctuation: {
        '。':1,'.':1,'：':1,':':1,'；':1,'？':1,'?':1,'！':1,'!':1
    },
    english_sentence_punctuation: {
        '.':1,':':1,'?':1,'!':1
    }
}; 

/**
 * 檢查是否該文字是英文字
 * @param {String} _text
 * @returns {Boolean}
 */
jQuery.match_english = function(_text) {
	//var _reg = /^([a-z]|[A-Z])$/;
	//return _reg.test(_text);
    if (_text.length > 1) {
        _text = _text.substr(_text.length-2, 1);
    }
    
    return (typeof(jQuery._match_config.english[_text]) === 'number');
};

jQuery.match_upper_english = function(_text) {
	//var _reg = /^([A-Z])$/;
	//return _reg.test(_text);
    return (typeof(jQuery._match_config.upper_english[_text]) === 'number');
};
jQuery.match_number = function(_text) {
	var _reg = /^\d$/;
	return _reg.test(_text);
};
/**
 * 測試是否為標點符號
 * @param {String} _text
 */
jQuery.match_punctuation = function(_text) {
	//var _reg = /^(，|,|。|\.|\'|")$/;
    //var _reg = /^(，|,|。|\.|：|:|；|;|、|？|\?|！|!|-)$/;
	//return _reg.test(_text);
    return (typeof(jQuery._match_config.punctuation[_text]) == 'number');
};

/**
 * 測試是否為斷句的標點符號
 * @param {String} _text
 */
jQuery.match_sentence_punctuation = function(_text) {
	//var _reg = /^(，|,|。|\.|\'|")$/;
    //var _reg = /^(。|\.|：|:|；|？|\?|！|!)$/;
	//return _reg.test(_text);
    return (typeof(jQuery._match_config.sentence_punctuation[_text]) == 'number');
};

/**
 * 測試是否為斷句的標點符號
 * @param {String} _text
 */
jQuery.match_english_sentence_punctuation = function(_text) {
	//var _reg = /^(，|,|。|\.|\'|")$/;
    //var _reg = /^(\.|:|\?|!)$/;
	//return _reg.test(_text);
    return (typeof(jQuery._match_config.english_sentence_punctuation[_text]) == 'number');
};

jQuery.match_space = function(_text) {
	var _reg = /^(\s|　)$/;
	return _reg.test(_text);
};

/**
 * 取消選擇範圍
 */
jQuery.cancel_select = function() {
	if ($.browser.msie === true) {
		top.document.selection.empty();
	}
	else {
		window.getSelection().removeAllRanges();
	}
};

jQuery.lock_viewport = function () {
    var _new_viewport = $('<meta name="viewport" id="kals_viewport_lock" content="width=device-width, maximum-scale=1.0, minimum-scale=1.0, user-scalable=yes" />')
        .appendTo($('head'));
};

jQuery.unlock_viewport = function () {
    $('head meta[name=viewport]#kals_viewport');
};

jQuery.get_prefixed_id = function (_prefixed_id) {
    if ($.is_null(_prefixed_id)) {
		return null;
	}
    
    if ($.is_number(_prefixed_id)) {
		return _prefixed_id;
	}
    if ($.is_object(_prefixed_id)) {
        if ($.is_jquery(_prefixed_id)) {
			_prefixed_id = _prefixed_id.attr('id');
		}
		else 
			if ($.is_null(_prefixed_id)) {
				return null;
			}
			else 
				if (typeof(_prefixed_id) != 'undefined' &&
				typeof(_prefixed_id.id) != 'undefined') {
					_prefixed_id = _prefixed_id.id;
				}
				else {
					return null;
				}
    }
    
    if ($.is_null(_prefixed_id) || $.trim(_prefixed_id) === '') {
        return null;
    }
    _prefixed_id = _prefixed_id + '';
    
    var _parts = _prefixed_id.split('_');
    var _id = _parts[ (_parts.length-1) ];
    _id = parseInt(_id,10);
    if (isNaN(_id)) {
		return null;
	}
	else {
		return _id;
	}
};

jQuery.get_class_prefixed_id = function (_classname, _prefixed) {
	
	if ($.is_jquery(_classname)) {
		_classname = _classname.attr('className');
	}
		
	var _classname_ary = _classname.split(' ');
	var _id = null;
	if (_prefixed === null)
	{
		for (var _i = 0; _i < _classname_ary.length; _i++)
		{
			_id = $.get_prefixed_id(_classname_ary[_i]);
			if (_id !== null) {
				return _id;
			}
		}
	}
	else
	{
		for (_i = 0; _i < _classname_ary.length; _i++)
		{
			var _c = _classname_ary[_i];
			if ($.starts_with(_c, _prefixed))
			{
				_id = $.get_prefixed_id(_c);
				if (_id !== null) {
					return _id;
				}
			}
		}
	}
	return _id;
};

/**
 * 以動畫的方式捲動捲軸
 * @memberOf {jQuery}
 * @param {Object} _position
 * _postion = {
 *     x: 100,    //單位是像素
 *     y: 100,
 *     selector: ".kals-heading-0"
 * }
 * _postion = {
 *     x: +100'    //任一可省略，表示固定原有捲軸位置
 * }
 * @param {number|string|null} _speed 預設為1000
 * _speed = 1000;    //1000毫秒=1秒鐘以內跑完
 * _speed = 'fast';    //fast=200, normal=1000, slow=2000
 * @param {function|null} _callback 回呼函數
 */
jQuery.scroll_to = function (_position, _speed, _callback) {
    
    //$.test_msg('$.scroll_to', [$.json_encode(_position), _speed, _callback]);
    //return;
	
    if (this.scroll_to_lock === true) {
        $.trigger_callback(_callback);
        return;
    }
    this.scroll_to_lock = true;

    var _this = this;
    // 要確認視窗到底讀完了沒有
    if (KALS_context.completed === false) {
        //$.test_msg('$.scroll_to KALS_context not ready', [$.json_encode(_position), _speed, _callback]);
        KALS_context.add_listener(function (_dispatcher, _data) {
            _this.scroll_to_lock = false;
            _this.scroll_to(_position, _speed, _callback);
        });
        $.trigger_callback(_callback);
        return;
    }
	
    //宣告基本資料
    var _target_x, _target_y, _interval_x, _interval_y, _interval_time = 10, _repeat_count
        , _next_x, _next_y;
    
    //確定位置資料
    if (typeof(_position.selector) === "undefined") {
        _target_x = $.get_parameter(_position, ['x', 'left', 'pageXOffset'], window.pageXOffset);
        if ($.starts_with(_target_x, '+') || $.starts_with(_target_x, '-')) {
            _target_x = parseInt(window.pageXOffset, 10) + parseInt(_target_x, 10);
        }
        _target_y = $.get_parameter(_position, ['y', 'top', 'pageYOffset'], window.pageYOffset);
        if ($.starts_with(_target_y, '+') || $.starts_with(_target_y, '-')) {
            _target_y = parseInt(window.pageYOffset, 10) + parseInt(_target_y, 10);
        }
    }
    else {
        _target_y = $.get_offset_top(_position.selector);
        
        $.test_msg("scroll to selector", [_target_y, _position.selector, KALS_toolbar.get_height()]);
        
        if (KALS_text !== undefined) {
            _target_y = _target_y - KALS_toolbar.get_height();
        }
    }
    
    
    
	//$.test_msg('$.scroll_to target', [_target_x, _target_y]);
	
    //if ($.is_number(_target_x) === false || $.is_number(_target_y) === false) {
    //    $.trigger_callback(_callback);
    //    return this;
    //}
    
    //調整_speed跟_callback
    if ($.is_function(_speed) && $.is_null(_callback)) {
        _callback = _speed;
        _speed = 1000;
    }
    
    //取得_speed
    if (_speed === 'fast') {
        _speed = 200;
    }
    else if (_speed === 'slow') {
        _speed = 2000;
    }
    else if ($.is_number(_speed) === false) {
        _speed = 1000;
    }
    
    var _config = {};
    var _config_setted = false;
    if ($.is_number(_target_y)) {
        _config["scrollTop"] = _target_y;
        _config_setted = true;
    }
    if ($.is_number(_target_x)) {
        _config["scrollLeft"] = _target_x;
        _config_setted = true;
    }
    
    //$.test_msg("要準備捲動囉", _config);
    
    if (_config_setted) {
        $('html, body').animate(_config, _speed, function () {
            _this.scroll_to_lock = false;
        });
    }
	
    $.trigger_callback(_callback)
    return this;
     
	/**
	 * 以下寫太差了，不使用
	 * @deprecated 20131115 Pulipuli Chen
	 */
	/*
    //確認要移動的次數
    _repeat_count = parseInt(_speed / _interval_time,10)+1;
    
    //確認要移動的距離
    _interval_x = parseInt((_target_x - window.pageXOffset) / _repeat_count,10)+1;
    _interval_y = parseInt((_target_y - window.pageYOffset) / _repeat_count,10)+1;
    
    
    var _loop = function (_i, _count, _callback) {
        if (_i == _count || _i > _count) {
			
			// 完成
			$.scroll_to_lock = false;
			
            if ($.is_function(_callback)) {
				_callback();
			}
            return;
        }
        else {
            if (_i < _count -1) {
                var _offset_x = window.pageXOffset;
                _next_x = _offset_x + _interval_x;
                if (_next_x > _target_x) {
					_next_x = _target_x;
				}
                
                var _offset_y = window.pageYOffset;
                _next_y = _offset_y + _interval_y;
                if (_next_y > _target_y) {
					_next_y = _target_y;
				}
            }
            else {
                _next_x = _target_x;
                _next_y = _target_y;
            }
            
            window.scrollTo(_next_x, _next_y);
            
            setTimeout(function () {
                _i++;
                _loop(_i, _count, _callback);
            }, _interval_time);
        }
    };
    
    _loop(0, _repeat_count, _callback);
    return this;
    */
};

jQuery.scroll_to_lock = false;

jQuery.save_scroll_position = function () {
    
    this._scroll_position = [window.pageXOffset, window.pageYOffset];
    
};

/**
 * 讀取捲動位置
 * @deprecated 20131115 Pudding Chen
 */
jQuery.load_scroll_position = function () {
    
    if (window.pageXOffset != this._scroll_position[0]) {
        //$.test_msg('X被移動了', [this._scroll_position[0], '->', window.pageXOffset]);
    }
    
    if (window.pageYOffset != this._scroll_position[1]) {
        //$.test_msg('Y被移動了', [this._scroll_position[1], '->', window.pageYOffset]);
        //alert(['Y被移動了', this._scroll_position[1], '->', window.pageYOffset]);
    }
    
    //$.test_msg("$.load_scroll_position");
    window.scrollTo(this._scroll_position[0], this._scroll_position[1]);
};

/**
 * 產生隨機的ID字串
 * @param {String} _prefix 前置字串
 * @returns {String}
 */
jQuery.create_id = function (_prefix) {
    var _id = (new Date()).getTime() + '';
    if (_prefix !== undefined) {
        _id = _prefix + _id;
    }
    return _id;
};

/**
 * 取得根據網址建立的Domain
 * @returns {String}
 */
jQuery.create_namespace = function () {
    var _url = location.href;
    
    //移除 #之後
    if (_url.lastIndexOf('#') > -1) {
        _url = _url.substr(0, _url.lastIndexOf('#'));
    }
    
    // 替換可能出現問題的字串
    _url = $.str_replace('.', '_', _url);
    _url = $.str_replace('/', '_', _url);
    _url = $.str_replace(':', '_', _url);
    _url = $.str_replace('@', '_', _url);
    
    //$.test_msg('KALS_context create_namespace', _url);
    //_url = 'test';
    //_url = 'test22' + _url;
    
    return _url;
};

/**
 * 啟動callback
 * @param {function} _callback
 * @param {Object} _arg1 參數
 * @param {Object} _arg2 參數
 * @param {Object} _arg3 參數
 * @param {Object} _arg4 參數
 * @param {Object} _arg5 參數
 */
jQuery.trigger_callback = function (_callback, _arg1, _arg2, _arg3, _arg4, _arg5) {
    var _delay = 0;
    
    if (typeof(_callback) == 'number') {
        if (typeof(_arg1) == 'function') {
            _delay = _callback;
            _callback = _arg1;
        }
    }
    
    if ($.is_function(_callback)) {
        setTimeout(function () {
            
            if ($.isset(_arg1) && $.isset(_arg2) && $.isset(_arg3) && $.isset(_arg4) && $.isset(_arg5)) {
				_callback(_arg1, _arg2, _arg3, _arg4, _arg5);
			}
			else 
				if ($.isset(_arg1) && $.isset(_arg2) && $.isset(_arg3) && $.isset(_arg4)) {
					_callback(_arg1, _arg2, _arg3, _arg4);
				}
				else 
					if ($.isset(_arg1) && $.isset(_arg2) && $.isset(_arg3)) {
						_callback(_arg1, _arg2, _arg3);
					}
					else 
						if ($.isset(_arg1) && $.isset(_arg2)) {
							_callback(_arg1, _arg2);
						}
						else 
							if ($.isset(_arg1)) {
								_callback(_arg1);
							}
							else {
								_callback();
							}
                
        }, _delay);
    }
};

/**
 * 多重繼承的功能
 * 
 * @example 讓ClassB繼承ClassA
 * 
 * function ClassA { }
 * function ClassB {
 *   $.multi_extend(this, new ClassA());
 * }
 * 
 * @param {Object} _this_class
 * @param {Object} _super_class
 */
jQuery.multi_extend = function (_this_class, _super_class) {
    if ($.is_object(_super_class)) {
        for (var _key in _super_class) {
            _this_class[_key] = _super_class[_key];
        }
    }
    return _this_class;
};

/**
 * 計算_time到現在的間隔秒數
 * @param {number|string} _time 請輸入從1970/01/01到現在秒的格式
 */
jQuery.get_interval_time = function (_time) {
    if ($.is_string(_time)) {
		_time = parseInt(_time, 10);
	}
    
    if ($.is_number(_time)) {
		var _now = parseInt((new Date()).getTime() / 1000, 10);
		return _now - _time;
	}
	else {
		return 0;
	}
};

/**
 * 刪除陣列中指定的索引
 * @param {Array} _ary
 * @param {number} _index
 */
jQuery.array_remove = function (_ary, _index) {
    if(isNaN(_index)||_index>_ary.length){return false;}
    for(var i=0,n=0;i<_ary.length;i++) {
        if(_ary[i]!=_ary[_index]) {
            _ary[n++]=_ary[i];
        }
    }
    _ary.length-=1;
    return _ary;
};

/**
 * 取得從1970/1/1到現在的秒數。注意是秒數，而非毫秒數。
 * 詳細的文件請參考此網頁http://www.epochconverter.com/
 * @type {number}
 */
jQuery.get_epoch_time = function () {
    return parseInt((new Date()).getTime()/1000,10);
};

jQuery.fn.setup_hover = function () {
    return $(this).hover(function () {
        $(this).addClass('hover');
    }, function () {
        $(this).removeClass('hover');
    });
};

jQuery.browser.msie6 = ($.browser.msie && $.browser.version.substr(0,1) < 7);

/**
 * 移除反斜線
 * @param {string} _str
 * @return {string}
 */
jQuery.stripslashes = function (_str) {
	_str=_str.replace(/\\'/g,'\'');
	_str=_str.replace(/\\"/g,'"');
	_str=_str.replace(/\\0/g,'\0');
	_str=_str.replace(/\\\\/g,'\\');
	return _str;
};

/**
 * 改良原本的decodeURIComponent
 * @version 20130222 Pullipuli
 * @param  {String} _str 要轉換的字串
 * @return {String}      轉換完成的字串
 */
jQuery.decodeURIComponent = function (_str) {
    var _result;
    /*
    try {
        _result = decodeURIComponent(_str);
    }
    catch (_e) {
        _str = $.str_replace("%", "%25", _str);
        _result = decodeURIComponent(_str);
    }
    */
    //_str = $.str_replace("%", "%25", _str);
	try {
		_result = decodeURIComponent(_str);
	}
	catch (e) {
		_str = $.str_replace("%", "%25", _str);
		_result = decodeURIComponent(_str);
	}
    return _result;
};

/**
 * 把文字字串轉換成為html
 * @param {String} _text
 */
jQuery.replace_url_with_html_links = function (_text) {
    var _exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    return _text.replace(_exp,"<a href='$1'>$1</a>"); 
};

/**
 * 把文字字串轉換成為YouTube
 * @param {String} _message
 */
jQuery.find_and_replace_youtube_links = function (_message) {
	
    //return _message.replace(/(?:http:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?([^&]+).*/g,
	//   function ($1) {
	//   	   return $.embad_youtube_script($1);
	//   });
   return _message.replace(/(?:http:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)/g, '<iframe width="420" height="345" src="http://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>'); 
};

/**
 * 輸入ID轉換成為YouTube播放介面
 * @param {String} youtube_id
 */
jQuery.embad_youtube_script = function(_youtube_id)
{
    $.test_msg('embed_youtube_script', _youtube_id);
    return '<object height="250" width="300">'
           //+ '<param name="movie" value="http://www.youtube.com/v/' + _youtube_id + '?fs=1&amp;hl=zh_TW">'
           + '<param name="movie" value="' + _youtube_id + '?fs=1&amp;hl=zh_TW">'
           + '<param name="allowFullScreen" value="true">'
           + '<param name="allowscriptaccess" value="always">'
           //+ '<embed allowfullscreen="true" allowscriptaccess="always" src="http://www.youtube.com/v/' + _youtube_id + '?fs=1&amp;hl=zh_TW" type="application/x-shockwave-flash">'
           + '<embed allowfullscreen="true" allowscriptaccess="always" src="' + _youtube_id + '?fs=1&amp;hl=zh_TW" type="application/x-shockwave-flash">'
           + '</object>';   
};

/**
 * 檢查是否是email
 * @param {String} _email
 * @returns {Boolean}
 * @author Pulipuli Chen 20140102
 */
jQuery.is_email = function (_email) {
    var _regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    return _regex.test(_email);
}

/**
 * 取得物件的頂部位置
 * @param {jQuery} _ele
 * @returns {Int}
 */
jQuery.get_offset_top = function(_ele) {
    if ($.is_string(_ele)) {
        _ele = $(_ele);
    }
    
    var _offset;
    
    //$.test_msg("get_offset_top", [_ele.css("position"), _ele.offset().top, _offset, _ele.text()]);
    if (_ele.css("position") === "relative") {
        
        //var _fake = _ele.clone()
        //        .attr("className", "KALS fake absolute")
        //        .insertBefore(_ele);
        
        //_ele.css("position", "absolute");
        //_offset = _ele.attr("offsetTop");
        _offset = _ele.offset().top;
        _offset = parseInt(_offset);
        //_ele.css("position", "relative");
        
        //_fake.remove();
    }
    else {
        _offset = _ele.attr("offsetTop")
    }
    
    return _offset;
};

/**
 * 取得物件的底部位置
 * @param {jQuery} _ele
 * @returns {Int}
 */
jQuery.get_offset_bottom = function(_ele) {
    if ($.is_string(_ele)) {
        _ele = $(_ele);
    }
    var _offset = $.get_offset_top(_ele) + _ele.height();
    return _offset;
};

/**
 * 取得物件的垂直中間位置
 * @param {jQuery} _ele
 * @returns {Int}
 */
jQuery.get_offset_vertical_middle = function(_ele) {
    if ($.is_string(_ele)) {
        _ele = $(_ele);
    }
    var _offset = $.get_offset_top(_ele) + (_ele.height() / 2);
    return _offset;
};

/**
 * 取得物件的左邊位置
 * @param {jQuery} _ele
 * @returns {Int}
 */
jQuery.get_offset_left = function(_ele) {
    if ($.is_string(_ele)) {
        _ele = $(_ele);
    }
    var _offset = _ele.attr("offsetLeft");
    
    if (_ele.css("position") === "relative") {
        
        //var _fake = _ele.clone()
        //        .attr("className", "KALS fake absolute")
        //        .insertBefore(_ele);
        //_ele.css("position", "absolute");
        //_offset = _ele.attr("offsetTop");
        _offset = _ele.offset().left;
        _offset = parseInt(_offset);
        //_ele.css("position", "relative");
        //_fake.remove();
    }
    
    return _offset;
};

/**
 * 取得物件的右邊位置
 * @param {jQuery} _ele
 * @returns {Int}
 */
jQuery.get_offset_right = function(_ele) {
    if ($.is_string(_ele)) {
        _ele = $(_ele);
    }
    var _offset = $.get_offset_left(_ele) + _ele.width();
    return _offset;
};

/**
 * 取得物件的水平中間位置
 * @param {jQuery} _ele
 * @returns {Int}
 */
jQuery.get_offset_horizontal_center = function(_ele) {
    if ($.is_string(_ele)) {
        _ele = $(_ele);
    }
    
    var _offset = $.get_offset_left(_ele) + (_ele.width() / 2);
    return _offset;
};


/**
 * 取得物件的位置資訊
 * @param {jQuery} _ele
 * @returns {json}
 */
jQuery.get_offset = function(_ele) {
    var _top = $.get_offset_top(_ele);
    var _left = $.get_offset_left(_ele);
    var _offset = {
        top: _top,
        left: _left
    };
    return _offset;
};

/**
 * 手動版本調整位置
 * @param {jQuery} _ele 要移動的元素
 * @param {jQuery} _anchor 參考位置的元素
 * @param {type} _config = {
 *   my: "center top",
 *   at: "center bottom"
 * }
 * @returns {jQuery}
 */
jQuery.set_position = function (_ele, _anchor, _config) {
    
    var _my_config = _config.my.split(" ");
    var _my_h = _my_config[0];
    var _my_v = _my_config[1];
    
    var _at_config = _config.at.split(" ");
    var _at_h = _at_config[0];
    var _at_v = _at_config[1];
    
    var _anchor_left, _anchor_top, _ele_left, _ele_top;
    
    // -----------
    
    var _anchor_left = this.get_offset_left(_anchor);
    var _anchor_width = this.get_width_without_transform(_anchor);
    if (_at_h === "center") {
        //_anchor_left = this.get_offset_horizontal_center(_anchor);
        _anchor_left = _anchor_left + (_anchor_width/2);
    }
    //else if (_at_h === "left") {
    //    _anchor_left = this.get_offset_left(_anchor);
    //}
    else if (_at_h === "right") {
        //_anchor_left = this.get_offset_right(_anchor);
        _anchor_left = _anchor_left + _anchor_width;
    }
    
    if (_my_h === "center") {
        _ele_left = _anchor_left - (_ele.width() / 2);
    }
    else if (_my_h === "left") {
        _ele_left = _anchor_left;
    }
    else if (_my_h === "right") {
        _ele_left = _anchor_left - _ele.width();
    }
    
    
    // -----------
    
    var _anchor_height = this.get_height_without_transform(_anchor);
    _anchor_top = this.get_offset_top(_anchor);
    if (_at_v === "center") {
        //_anchor_top = this.get_offset_vertical_middle(_anchor);
        _anchor_top = _anchor_top + (_anchor_height/2);
    }
    //else if (_at_v === "top") {
    //    _anchor_top = this.get_offset_top(_anchor);
    //}
    else if (_at_v === "bottom") {
        //_anchor_top = this.get_offset_bottom(_anchor);
        _anchor_top = _anchor_top + _anchor_height;
    }
    
    if (_my_v === "center") {
        _ele_top = _anchor_top - (_ele.height() / 2);
    }
    else if (_my_v === "top") {
        _ele_top = _anchor_top;
    }
    else if (_my_v === "bottom") {
        _ele_top = _anchor_top - _ele.height();
    }
    
    //$.test_msg("對齊結果", [_anchor_left, _anchor_top, _anchor.width()
    //    , this.get_width_without_transform(_anchor)
    //    , _ele_left, _ele_top, _ele.width()]);
    
    _ele.css("position", "absolute")
            .css("top", _ele_top)
            .css("left", _ele_left);
    
    return this;
};

/**
 * 取得元素的寬度，不受tranform的影響
 * @param {jQuery} _ele
 * @returns {Number}
 */
jQuery.get_width_without_transform = function (_ele) {
    
    //var _fake = _ele.clone().appendTo("body");
    //var _temp = $(document.createDocumentFragment());
    //var _temp = $("<div></div>");
    var _temp = $('body');
    var _fake = _ele.clone()
            //.appendTo(document.createDocumentFragment());
            .hide()
            .appendTo(_temp);
    //_fake.css("transform", "matrix(1,0,0,1,0,0)");
        
    var _width = _fake.width();

    //$.test_msg("get_width", [_ele.css("width")
    //    , _ele.width()
    //    , _ele.attr("offsetWidth")
    //    , _ele.innerWidth()
    //    , _ele.outerWidth()
    //    , _ele.css("transform")
    //    ]);
    
    //$.test_msg("get_width_without_transform", _width);

    //_fake.remove();
    
    setTimeout(function () {
        _fake.remove();
    }, 100);
    
    return _width;
};


/**
 * 取得元素的高度，不受tranform的影響
 * @param {jQuery} _ele
 * @returns {Number}
 */
jQuery.get_height_without_transform = function (_ele) {
    
    var _temp = $('body');
    var _fake = _ele.clone()
            .hide()
            .appendTo(_temp);
    //_fake.css("transform", "matrix(1,0,0,1,0,0)");
        
    var _height = _fake.height();

    setTimeout(function () {
        _fake.remove();
    }, 100);
    
    
    return _height;
};

$.widget("ui.dialog", $.ui.dialog, {
    _allowInteraction: function(event) {
        return !!$(event.target).closest(".cke").length || this._super(event);
    }
});

/**
 * 將jQuery加上append事件
 * 
 * 參考來源 http://stackoverflow.com/questions/7167085/on-append-do-something
 */
(function($) {
    var origAppend = $.fn.append;

    $.fn.append = function () {
        return origAppend.apply(this, arguments).trigger("append");
    };
})(jQuery);

/**
 * 20130222 Pulipuli Chen
 * 不採用
 */
//if (false) {
    /**
     * @type {jQuery}
     * @alias $
     * @constructor
     * @extends {jQuery}
     * @method [$]
     */
    //$ = jQuery;
//}

// ---------
// 防止重複讀取
// ---------
$jquery_extends = true;

}   //if (typeof(...

/* End of file jquery.extends */
/* Location: ./libraries/helpers/jquery.extends.js *//**
 * KALS使用者介面的原形  
 * @memberOf {KALS_user_interface}
 * @class {KALS_user_interface}
 * @return {KALS_user_interface}
 */
function KALS_user_interface() {
    
    this._children = [];
	this._data = {};
    this._default_data = this._data;
}

/**
 * UI的本體
 * @property {jQuery}
 * @memberOf {KALS_user_interface}
 * @private
 */
KALS_user_interface.prototype._ui = null;

/**
 * 父物件
 * @type {KALS_user_interface}
 * @private
 */
KALS_user_interface.prototype._parent = null;

/**
 * 子物件
 * @type {Array}
 * @private
 */
KALS_user_interface.prototype._children = [];

/**
 * 保存資料的欄位
 * @type {JSON}
 */
KALS_user_interface.prototype._data = {};

/**
 * 取得UI
 * @memberOf {KALS_user_interface}
 * @type {jQuery}
 * @param {null|string} _selector 選取UI裡面的特定物件
 */
KALS_user_interface.prototype.get_ui = function (_selector) {
    if (this.has_setup_ui() === false) {
        this._setup_ui();
    }
    
    if (this._initialize_view_flag === false) {
        this._initialize_view_flag = true;
        this._$initialize_view();
    }
    
    if (_selector === undefined  || _selector === null) {
        return this._ui;
    }
    else {
        return this._ui.find(_selector);
    }
};

/**
 * 是否已經建立UI
 * @type {boolean}
 */
KALS_user_interface.prototype.has_setup_ui = function () {
	//$.test_msg('has_setup_ui', (this._ui !== null));
    return (this._ui !== null);
};

/**
 * 建立UI的動作
 */
KALS_user_interface.prototype._setup_ui = function () {
    var _ui = this._$create_ui();
    this._ui = _ui;
    return this;
};

/**
 * 初始化View
 * 
 * 如果要在Controller啟動時為UI做設定，請覆寫這個方法
 * 
 */
KALS_user_interface.prototype._$initialize_view = function () {
};

/**
 * 防止重複初始化的設定
 * @type Boolean
 */
KALS_user_interface.prototype._initialize_view_flag = false;

/**
 * 建立UI的動作，請覆寫它
 * @type {jQuery}
 */
KALS_user_interface.prototype._$create_ui = function () {
    var _ui = this._load_view();
    //$.test_msg('KALS_modal', _ui);
    if (_ui === null) {
        _ui = this._$create_ui_prototype(); 
    }
    return _ui;
};

/**
 * 建立Modal的原形物件
 * @memberOf {KALS_user_interface}
 * @param {string|jQuery|null} _element = div 可以指定原形物件的標籤名稱
 * @type {jQuery}
 */
KALS_user_interface.prototype._$create_ui_prototype = function (_element) {
    
    var _ui;
    if ($.is_null(_element)) {
        _element = 'div';
    }
    
    if ($.is_string(_element)) {
        _ui = $('<' + _element + '></' + _element + '>');
    }
    else {
        _ui =  $(_element);
    }
    
    _ui.addClass(this.class_name)
        .hide()
        .appendTo($('body'));
    
    return _ui;
};

/**
 * 讀取指定的樣板
 * @type {jQuery}
 */
KALS_user_interface.prototype._load_view = function () {
    if (typeof(KALS_context) !== 'undefined' && KALS_context.view_manager !== null
	   && this._$view !== null) {
		var _view = KALS_context.view_manager.get_view(this._$view);
		_view = this._initialize_view(_view);
        return _view;
    }
    else {
        return null;
    }
};

/**
 * 初始化樣板
 * @param {jQuery} _view
 */
KALS_user_interface.prototype._initialize_view = function (_view) {
	_view = this._initialize_events(_view);
	_view = this._initialize_view_data(_view);
	return _view;
};

/**
 * 初始化樣板資料
 * @param {jQuery} _view
 */
KALS_user_interface.prototype._initialize_view_data = function (_view) {
	//$.test_msg('ui, init data');
	
	if ($.is_object(this._data)) {
        for (var _field in this._data) {
            var _value = this._data[_field];
            _view = this.set_sub_field(_field, _value, _view);
        }
    }
	return _view;
};

/**
 * 樣板編號
 * 如果有設定的話，預設就會載入樣板
 * @type {String}
 */
KALS_user_interface.prototype._$view = null;

/**
 * 利用jQuery的toggle()、show()與hide()來切換UI的顯示狀態 
 * @param {boolean} _display
 */
KALS_user_interface.prototype.toggle_ui = function (_display) {
    var _ui = this.get_ui();
    
    if ($.isset(_ui))
    {
        if ($.is_null(_display)) {
			_ui.toggle();
		}
		else 
			if (_display === true) {
				_ui.show();
			}
			else {
				_ui.hide();
			}
    }
    
    return this;
};

/**
 * 檢查UI是否可以看到
 * @type {boolean}
 */
KALS_user_interface.prototype.visible = function () {
    var _ui = this.get_ui();
    
    return _ui.visible();
};

/**
 * 幫UI加上Class Name
 * @param {String} _class_name
 */
KALS_user_interface.prototype.add_class = function (_class_name) {
    if ($.is_string(_class_name))
    {
        var _ui = this.get_ui();
        if ($.isset(_ui)) {
			_ui.addClass(_class_name);
		}
    }        
    return this;
};

KALS_user_interface.prototype.addClass = function (_class_name) {
	return this.add_class(_class_name);
};

/**
 * 幫UI移除Class Name
 * @param {String} _class_name
 */
KALS_user_interface.prototype.remove_class = function (_class_name) {
    if ($.is_string(_class_name))
    {
        var _ui = this.get_ui();
        if ($.isset(_ui)) {
			_ui.removeClass(_class_name);
		}
    }        
    return this;
};

/**
 * ----------------------------------------------------------
 * KALS_user_interface 模仿jQuery的行為
 * ----------------------------------------------------------
 */

KALS_user_interface.prototype.removeClass = function (_class_name) {
    return this.remove_class(_class_name);
};

/**
 * 幫UI切換Class Name
 * @param {String} _class_name
 */
KALS_user_interface.prototype.toggle_class = function (_class_name) {
    if ($.is_string(_class_name))
    {
        var _ui = this.get_ui();
        if ($.isset(_ui)) {
			_ui.toggleClass(_class_name);
		}
    }        
    return this;
};

KALS_user_interface.prototype.toggleClass = function (_class_name) {
    return this.toggle_class(_class_name);
};

/**
 * 是否有子物件
 * @param {string} _name
 * @type {boolean}
 */
KALS_user_interface.prototype.has_child = function (_name) {
    //return (typeof(this._children[_name]) != 'undefined'
    //    && this._children[_name] != null);
    return (typeof(this._children[_name]) !== 'undefined');
};

/**
 * 取得子物件，或是新增子物件
 * @param {string} _name
 * @param {KALS_user_interface|null} _child
 * @type {KALS_user_interface}
 */
KALS_user_interface.prototype.child = function (_name, _child) {
    if (_child !== undefined &&  _child !== null) {
        if (this.has_child(_name) === false) {
            this[_name] = _child;
            this._children[_name] = _child;
            //$.test_msg('child', [_name, $.get_class(_child)]);
            
            if (typeof(_child.parent) === 'function') {
				_child.parent(this);
			}
        }
        return this;
    }
    else {
        _child = null;
        if (this.has_child(_name)) {
            _child = this._children[_name];
        }
        return _child;    
    }
};

/**
 * 取得子物件的UI
 * @class KALS_user_interface
 * @memberOf KALS_user_interface
 * @param {string} _name
 * @type {jQuery}
 */
KALS_user_interface.prototype.child_ui = function (_name) {
    
    var _ui = null;
    if (this.has_child(_name))
    {
        var _child = this.child(_name);
        if ($.is_function(_child.get_ui))
        {
            _ui = _child.get_ui();
        }
    }
    return _ui;
};

/**
 * 移除子物件
 * @param {string} _name
 */
KALS_user_interface.prototype.remove_child = function (_name) {
    if (this.has_child(_name))
    {
        this._children[_name].remove_parent();
        delete this._children[_name];
    }
    return this;
};

/**
 * 建立父物件，或是取得父物件
 * @param {KALS_user_interface|null} _parent
 */
KALS_user_interface.prototype.parent = function (_parent) {
    if (_parent === undefined || _parent === null) {
        return this._parent;
    } else
    {
        this._parent = _parent;
        return this;
    }
};

/**
 * 移除父物件
 */
KALS_user_interface.prototype.remove_parent = function () {
    this._parent = null;
    return this;
};

/**
 * 移除UI元件
 */
KALS_user_interface.prototype.remove = function () {
    if (this._ui !== null)
    {
        if ($.is_jquery(this._ui)) {
			this._ui.remove();
		}
		else {
			delete this._ui;
		}
        
        this._ui = null;
    }
    return this;
};

/**
 * 等同jQuery的Append
 * @param {Object} _element
 */
KALS_user_interface.prototype.append = function(_element) {
	if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
		_element = _element.get_ui();
	}
	this.get_ui().append(_element);
	return this;
};

KALS_user_interface.prototype.appendTo = function(_element) {
	if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
        _element = _element.get_ui();
    }
    this.get_ui().appendTo(_element);
	return this;
};

KALS_user_interface.prototype.prepend = function(_element) {
    if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
        _element = _element.get_ui();
    }
    this.get_ui().prepend(_element);
	return this;
};

KALS_user_interface.prototype.prependTo = function(_element) {
    if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
        _element = _element.get_ui();
    }
    this.get_ui().appendTo(_element);
	return this;
};

KALS_user_interface.prototype.after = function(_element) {
    if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
        _element = _element.get_ui();
    }
    this.get_ui().after(_element);
	return this;
};

KALS_user_interface.prototype.insertAfter = function(_element) {
    if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
        _element = _element.get_ui();
    }
    this.get_ui().after(_element);
	return this;
};

KALS_user_interface.prototype.before = function(_element) {
    if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
        _element = _element.get_ui();
    }
    this.get_ui().after(_element);
	return this;
};

KALS_user_interface.prototype.insertBefore = function(_element) {
    if (typeof(_element) !== 'undefined'
       && typeof(_element.get_ui) === 'function') {
        _element = _element.get_ui();
    }
    this.get_ui().after(_element);
	return this;
};

/**
 * 等同於jQuery的find
 * @param {JSON} _param
 * @returns {jQuery}
 */
KALS_user_interface.prototype.find = function(_param) {
    return this.get_ui().find(_param);
};

/**
 * 等同於jQuery的height()
 * @returns {Int}
 */
KALS_user_interface.prototype.height = function () {
    return this.get_ui().height();
};

KALS_user_interface.prototype.html = function(_param) {
    if (typeof(_param) !== 'undefined'
       && typeof(_param.get_ui) === 'function') {
        _param = _param.get_ui();
    }
    return this.get_ui().html(_param);
};

/**
 * 等同jQuery的test()
 * @param {jQuery|KALS_user_interface} _param
 */
KALS_user_interface.prototype.text = function(_param) {
    if (typeof(_param) !== 'undefined'
	   && typeof(_param.get_ui) === 'function') {
        _param = _param.get_ui().text();
    }
    return this.get_ui().text(_param);
};

/**
 * 等同jQuery的attr()
 * @param {String} _attr_name
 * @param {Object} _param
 */
KALS_user_interface.prototype.attr = function(_attr_name, _param) {
    return this.get_ui().attr(_attr_name, _param);
};

/**
 * 等同jQuery的hide效果
 * @param {Object} _param1
 * @param {Object} _param2
 * @param {Object} _param3
 * @returns {KALS_user_interface.prototype}
 */
KALS_user_interface.prototype.hide = function (_param1, _param2, _param3) {
    this.get_ui().hide(_param1, _param2, _param3);
    return this;
};

/**
 * 等同jQuery的show效果
 * http://api.jquery.com/show/
 * @param {Object} _param1
 * @param {Object} _param2
 * @param {Object} _param3
 * @returns {KALS_user_interface.prototype}
 */
KALS_user_interface.prototype.show = function (_param1, _param2, _param3) {
    this.get_ui().show(_param1, _param2, _param3);
    return this;
};

// -----------------------------

/**
 * 在UI中設定值
 * @param {String} _field
 * @param {String} _value
 * @param {jQuery} _ele
 */
KALS_user_interface.prototype.set_field = function (_field, _value, _ele) {
	
	// 如果是多個欄位，則使用set_fields
	if ($.is_object(_field)) {
		return this.set_fields(_field, _ele);
	}
	
	// 過濾資料
	_value = this._$set_field_filter(_field, _value, _ele);
	
	// 如果是單一欄位，則繼續處理
	this._data[_field] = _value;
	
        this.reset_field_text(_field, _ele);
		
	this.set_field_text(_field, _value, _ele);
	
	//$.test_msg('ui set_field', [_field, _value]);
	this.set_field_attrs(_field, _value, _ele);
	
	return this;
};

/**
 * 過濾資料
 * ※請覆寫
 * @param {String} _field
 * @param {String|Object} _value
 * @param {jQuery} _ele
 */
KALS_user_interface.prototype._$set_field_filter = function (_field, _value, _ele) {
	// 預設不做任何過濾
	return _value;
};

/**
 * 設定下層的值
 * 
 * 下層中不對this._data進行設定
 * @param {String} _field
 * @param {String} _value
 */
KALS_user_interface.prototype.set_sub_field = function (_field, _value, _ele) {
    
    // 如果是多個欄位，則使用set_fields
    if ($.is_object(_field)) {
        return this.set_sub_fields(_field, _ele);
    }
	
	// 過濾資料
    _value = this._$set_field_filter(_field, _value, _ele);
    
	//if ($.is_array(_value)) {
	//	$.test_msg('after filter', _value[0]);
	//}
    // 如果是單一欄位，則繼續處理
    
    this.reset_field_text(_field, _ele);
    this.set_field_text(_field, _value, _ele);
    
    this.set_field_attrs(_field, _value, _ele);
    
    return this;
};

/**
 * 設定多個欄位時使用的方式
 * @param {Object} _fields
 */
KALS_user_interface.prototype.set_fields = function (_fields, _ele) {
	for (var _field_name in _fields) {
		this.set_field(_field_name, _fields[_field_name], _ele);
	}
};

/**
 * 設定多個欄位時使用的方式
 * @param {Object} _fields
 */
KALS_user_interface.prototype.set_sub_fields = function (_fields, _ele) {
	for (var _field_name in _fields) {
        this.set_sub_field(_field_name, _fields[_field_name], _ele);
    }
};

/**
 * 資料過濾語系節點
 * @param {String} _line
 */
KALS_user_interface.prototype._value_filter_lang = function(_line){
	if ($.starts_with(_line, "kals-lang:")) {
        _line = KALS_context.lang.line(_line);
    }
    return _line;
};

/**
 * 需要初始化的屬性
 */
KALS_user_interface.prototype._init_attrs = KALS_CONFIG.view.init_attrs;;

/**
 * KALS自訂的屬性
 */
KALS_user_interface.prototype._kals_attrs = KALS_CONFIG.view.kals_attrs;;

/**
 * KALS自訂的事件
 */
KALS_user_interface.prototype._kals_events = KALS_CONFIG.view.kals_events;


/**
 * 設定文字節點
 * @param {String} _field
 * @param {String} _value
 */
KALS_user_interface.prototype.set_field_text = function (_field, _value, _ui) {
	
	if (_ui === undefined) {
		_ui = this.get_ui();
	}
    
	var _this = this;
	var _selector = '['+this._kals_attrs.field+'="'+_field+'"]';
	
	var _event_field_set = this._kals_events.field_set;
	 
	_ui.find(_selector).each(function (_index, _ele) {
        
        _ele = $(_ele);
        //_ele.attr('kals-original-data', _ele.html());
        
		var _parent = _this._get_field_parent(_field, _ele);
		var _i, _child, _parent_clone;
		
		var _value_class = _this._value_class_filter(_value); 
		//$.test_msg('value class', [_value_class, _value]);
		if (_value_class !== false) {
			
			var _value_object;
			if (_value_class == 'Annotation') {
				_value_object = _this._filter_annotation(_value);
			}
                        else if (_value_class == 'Annotation_type_list') {
				_value_object = _this._filter_annotation_type_list(_value);
			}
			else if (_value_class == 'KALS_user_interface') {
				_value_object = _this._filter_kals_user_interface(_value);
			}
	 		//else if (_value_class == 'Annotation_collection') {
            //    _value_object = _this._create_annotation_collection(_value);
            //} 
			//$.test_msg('value object', _value_object.html());
			//_ele.css('border', '1px solid red');
			
                        
			if (_value_object !== undefined) {
                            
                            
                            //if (typeof(_value.id) !== 'undefined') {
                                   //_value_object = _value.get_ui().get_ui();
                                    //    $.test_msg('create object', _value_object.html());
                                //}
				_ele.html(_value_object);
			}
		}
        else if ($.is_array(_value)) {
			//$.test_msg('is array', _value[0]);
            for (_i in _value) {
                _parent_clone = _parent.clone(true);
				
                //var _v = _this._value_filter_lang(_value[_i]);
                _child = _parent_clone.children().children(_selector);
				//_child.html(_v);
				
				//$.test_msg('set sub field', _value[_i]);
				_this.set_sub_field(_field, _value[_i], _parent_clone);
				
                _child.attr(_this._kals_attrs.repeat_index, _i);
                _parent_clone.insertBefore(_parent); 
            }
            _parent.remove();
        }
		else if ($.is_object(_value)) {
			for (_i in _value) {
                _parent_clone = _parent.clone(true);
                
				//var _v = _this._value_filter_lang(_i);
                _child = _parent_clone.children().children(_selector);
                //_child.html(_v);
				_this.set_sub_field(_field, _i, _parent_clone);
                
				_child.attr(_this._kals_attrs.repeat_index, _i);
                _parent_clone.insertBefore(_parent);
				
				var _sub_value = _value[_i];
				if ($.is_object(_sub_value)) {
					
                    //$.test_msg('is_object', _sub_value);
					for (var _sub_field in _sub_value) {
						//$.test_msg('sub_value', [_sub_field, _sub_value[_sub_field]]);
						_this.set_sub_field(_sub_field, _sub_value[_sub_field], _parent_clone);
					}
				}
				//_this.set_sub_fields(_sub_value, _parent_clone);
            }
                _parent.remove();
            }
        else {
            _value = _this._value_filter_lang(_value);
            //$(_ele).html(_value);
            _ele.html(_value);
			
            if (_parent.hasAttr(_event_field_set)) {
                    //var _controller = _this._parse_event_controller(_ele.attr(_event_field_set));
                    var _event_config = _this._parse_event_config(_parent, _event_field_set);
                    _this._trigger_controller(_ele, _event_config);
            }
        }
    }); 

    return this;
};

/**
 * 要設定資料之前，先過濾一下
 * @param {jQuery} _ele
 * @param {Object} _value
 * @type {String} 回傳Class的名稱
 */
KALS_user_interface.prototype._value_class_filter = function(_value){
	// 判斷是否是Annotation
    if (typeof(_value.annotation_id) !== 'undefined'
	   && $.is_number(_value.annotation_id)) {
	    return 'Annotation';
    }
    else if ($.is_class(_value, 'Annotation_type_param')) {
        return 'KALS_user_interface';
    }
    else if (typeof(_value) === 'object' 
            && typeof(_value['importance']) !== 'undefined' 
            && $.is_class(_value['importance'], 'Annotation_type_param')) {
        return 'Annotation_type_list';
    }
    else if (typeof(_value.get_ui) == 'function') {
            return 'KALS_user_interface';
    }
    // 判斷是否是Annotation_collection
    //else if ($.is_array(_value)
    //   && _value.length > 0
    //   && typeof(_value[0].annotation_id) != 'undefined'
    //   && $.is_number(_value[0].annotation_id) ) {
    //   	return 'Annotation_collection';
    //}
   
    return false;
};

/**
 * 建立View_annotation
 * @param {JSON} _value 是Annotation輸出的JSON
 * @type {jQuery} 
 */
KALS_user_interface.prototype._filter_annotation = function (_value) {
    var _param = _value;
    if ($.is_class(_param, 'Annotation_param') === false) {
            _param = new Annotation_param(_param);
    }
    var _list_item = new View_annotation(_param);
    //$.test_msg('create annotation', _list_item.get_ui().html());
    return _list_item.get_ui();
};

/**
 * 建立Annotation Type List的物件
 * @param {JSON} _value
 * @returns {jQuery}
 */
KALS_user_interface.prototype._filter_annotation_type_list = function (_value) {
    var _container = $('<div></div>');
    
    for (var _i in _value) {
        _value[_i].get_ui().appendTo(_container);
    }
    
    return _container;
};

/**
 * 過濾出KALS_user_interface
 * @param {KALS_user_interface} _value
 * @type {jQuery}
 */
KALS_user_interface.prototype._filter_kals_user_interface = function (_value) {
	return _value.get_ui();
};

/**
 * 取得上層欄位的資料
 * @param {String} _field
 * @param {jQuery} _ele
 */
KALS_user_interface.prototype._get_field_parent = function (_field, _ele) {
	var _field_parent = _ele.parents("."+this._kals_attrs.field_parent+":first");
	
	var _parent = _field_parent.parents('['+this._kals_attrs.field_repeat+'="'+_field+'"]:first');
	if (_parent.length === 0) {
		_parent = _field_parent.parent();
	}
	return _parent;
};

/**
 * 設定屬性
 * @param {String} _field
 * @param {String|Object} _value
 * @param {jQuery} _ele
 */
KALS_user_interface.prototype.set_field_attrs = function (_field, _value, _ele) {
    var _attr_names = this._init_attrs;
    //$.test_msg('ui set_field_attrs', _attr_names);
    for (var _i in _attr_names) {
        var _attr_name = _attr_names[_i];
        //$.test_msg('ui set_field_attrs name', _attr_name);
        this.set_field_attr(_field, _value, _attr_name, _ele);
    }
    return this;
}; 
/**
 * 找尋變數的規則
 * @type {RegExp}
 */
KALS_user_interface.prototype._view_regular_expression = KALS_CONFIG.view.regular_expression;


/**
 * 設定指定的屬性
 * @param {String} _field
 * @param {String} _value
 */
KALS_user_interface.prototype.set_field_attr = function (_field, _value, _attr_name, _ui) {
    if (_ui === undefined) {
		_ui = this.get_ui();
	}
	
    var _this = this;
    var _find = "{{" + _field + "}}";
	var _event_field_set = this._kals_events.field_set;
	
	var _kals_prefix = 'kals-';
	
    //$.test_msg('!!!!ui set_field_attr', '['+this._kals_attrs.attr_prefix+_attr_name+'*="'+_field+'"]');
	var _regexp = this._view_regular_expression;
    _ui.find('['+this._kals_attrs.attr_prefix+_attr_name+'*="'+_field+'"]').each(function (_index, _ele) {
        
        var _jquery_ele = $(_ele);
        //$.test_msg('get');
		
		if ($.is_object(_value)) {
			for (var _i in _value) {
				_this.set_sub_field(_i, _value[_i], _jquery_ele);
			}
		}
		else {
			// 真正設置值
			var _original_value = _jquery_ele.attr(_attr_name);
            
            var _text = _original_value.replace(_regexp, _value);
            //alert(_text);
			//$.test_msg('set_field_attr', [_original_value, _text]);
			
			var _name = _attr_name;
			if (_attr_name.substr(0, _kals_prefix.length) == _kals_prefix) {
				_name = _attr_name.substr(_kals_prefix.length, _attr_name.length - _kals_prefix.length);
			}
            _jquery_ele.attr(_name, _text);
			
			if (_jquery_ele.hasAttr(_event_field_set)) {
                //var _controller = _this._parse_event_controller(_ele.attr(_event_field_set));
                var _event_config = _this._parse_event_config(_jquery_ele, _event_field_set);
                
                // 因為沒有事件參數，所以第二個留空？
                _this._trigger_controller(_jquery_ele, _event_config);
            }
		}
    });
	
    return this;
};

/**
 * 重設欄位
 * @param {String} _field
 * @param {jQuery} _ui
 */
KALS_user_interface.prototype.reset_field = function (_field, _ui) {
	this.reset_field_text(_field, _ui);
	this.reset_field_attr(_field, _ui);
	return this;
};

/**
 * 重設屬性
 * @param {String} _field
 * @param {jQuery} _ui
 */
/*
KALS_user_interface.prototype.set_field_attrs = function (_field, _ui) {
    var _attr_names = this._attr_names;
    for (var _i in _attr_names) {
        this.reset_field_attr(_field, _attr_name, _ui);
    }
    return this;
}; 
*/

/**
 * 重設屬性
 * @param {String} _field
 * @param {String} _value
 */
KALS_user_interface.prototype.reset_field_attr = function (_field, _attr_name, _ui) {
    if (_ui === undefined) {
        _ui = this.get_ui();
    }
    
    var _find = "{{" + _field + "}}";
	var _this = this;
    _ui.find('['+ this._kals_attrs.attr_prefix+_attr_name+'*="'+_field+'"]').each(function (_index, _ele) {
        
        var _jquery_ele = $(_ele);
        
		var _attr_name_origin_value = _this._kals_attrs.attr_prefix 
		  + _attr_name 
		  + _this._kals_attrs.origin_value_postfix;
        var _original_value = _jquery_ele.attr(_attr_name_origin_value);
        
        //alert(_text);
        _jquery_ele.attr(_attr_name, _original_value);
    });
    
    return this;
};

/**
 * 重設欄位資料
 * @param {String} _field
 */
KALS_user_interface.prototype.reset_field_text = function (_field, _ui) {
    if (_ui === undefined) {
        _ui = this.get_ui();
    }

    //$.test_msg('reset: ' + '[kals-field="'+_field+'"', _ui.find('[kals-field="'+_field+'"').length);

    var _repeat_index = this._kals_attrs.repeat_index;
    var _event_field_reset = this._kals_events.field_reset
    var _field_origin_value = this._kals_attrs.field
       + this._kals_attrs.origin_value_postfix;
    var _this = this;
    _ui.find('[kals-field="'+_field+'"]').each(function (_index, _ele) {
        _ele = $(_ele);
        var _parent = _this._get_field_parent(_field, _ele); 
        if (_ele.hasAttr(_repeat_index) && _ele.attr(_repeat_index) !== '0') {
            _parent.remove();
            return;
        }

        _ele.html(_ele.attr(_field_origin_value));

        // 觸發重設事件
        if (_parent.hasAttr(_event_field_reset)) {
            //var _controller = _this._parse_event_controller(_ele.attr(_event_field_set));
            var _event_config = _this._parse_event_config(_parent, _event_field_reset);
            _this._trigger_controller(_ele, _event_config);
        }
    });

    return this;
};

/**
 * 取得UI中的設定值
 * @param {String} _field
 */
KALS_user_interface.prototype.get_field = function (_field) {
	/*
    var _ui = this.get_ui();
    
	var _data;
	var _fields = _ui.find('['+this._kals_attrs.field+'="'+_field+'"]');
	if (_fields.length === 1) {
		_data = _field.eq(0).html();
	}
	else if (_fields.length > 1) {
		_data = [];
		for (var _i = 0; _i < _field.length; _i++) {
			_data.push(_field.eq(_i));
		}
	}
    */
	if (typeof(this._data[_field]) !== undefined) {
		return this._data[_field];
	}
	else {
		return undefined;
	}
};

/**
 * 取得data資料
 * @param {Array} _fields 包含指定欄位的陣列。如果不是陣列，則一律回傳所有_data
 * 
 */
KALS_user_interface.prototype.get_data = function (_fields) {
	
	if (_fields === undefined || $.is_array(_field) === false) {
		return this._data;
	}
	
	var _data = {};
	
	for (var _i in _fields) {
		var _field = _fields[_i];
		var _value = this.get_field(_field);
		if (_value !== undefined) {
			_data[_field] = _value;
		}
	}
	
	return _data;
};

/**
 * ============================
 * 接著處理事件的部份
 * ============================
 */


/**
 * 需要初始化的屬性
 */
KALS_user_interface.prototype._event_names = KALS_CONFIG.view.event_names;

/**
 * 初始化事件名稱
 * @param {jQuery} _view
 */
KALS_user_interface.prototype._initialize_events = function (_view) {
	
	var _event_names = this._event_names;
	//$.test_msg('init events', _event_names);
	for (var _i in _event_names) {
		var _event_name = _event_names[_i];
		
		_view = this._initialize_event(_view, _event_name);
	}
	
	return _view;
};

/**
 * 初始化單一事件
 * @param {jQuery} _view
 * @param {String} _event_name
 */
KALS_user_interface.prototype._initialize_event = function(_view, _event_name){
	var _this = this;
	var _event_prefix = this._kals_attrs.event_prefix;
    var _kals_event_name = _event_prefix + _event_name;
    
	//$.test_msg('init evetn: ' + _event_name, _kals_event_name);
	
	_view.find('['+_kals_event_name+']').each(function (_index, _ele) {
		var _jqele = $(_ele);
		
		var _event_config = _this._parse_event_config(_jqele, _kals_event_name);
		var _controller_name = _event_config.name;
		var _params = _event_config.params;
		
		// 要找到這個controller是有值的
		if (typeof(_this[_controller_name]) == 'function') {
			_jqele.bind(_event_name, function (_e) {
				_jqele = $(this);
				_event_config = _this._parse_event_config(_jqele, _event_prefix + _e.type);
				_controller_name = _event_config.name;
				_params = _event_config.params;
				_params.event = _e;
				//$.test_msg('event trigger', [_controller_name, _params]);
				
				_this[_controller_name](_jqele, _params);
				
			});
		}
	});
	
	return _view;
};

/**
 * 觸動指定事件
 * @param {jQuery} _ele
 * @param {String} _event_name
 */
KALS_user_interface.prototype._parse_event_config = function (_ele, _event_name) {
	
	var _jqele = _ele;
    //var _kals_event_name = this._event_names._event_prefix + _event_name;
    
	if (_jqele.hasAttr(_event_name) === false) {
		return undefined;
	}
	
    var _controller = _jqele.attr(_event_name);
    
    // 先不支援參數輸入，刪除(之後的值
    var _function_point = _controller.indexOf("(");
    var _controller_name = _controller;
    
    var _params = [];
    
    if (_function_point > -1) {
        _controller_name = _controller.substr(0, _function_point);
        
        
        var _param_list = _controller.substr(_function_point, _controller.length - _function_point);
        _param_list = _param_list.substr(1, _param_list.length - 1);
        _param_list = _param_list.split(',');
        
        for (var _i in _param_list) {
            var _param_value = _param_list[_i];
            _param_value = $.trim(_param_value);
            _params.push(_param_value);
        }
    }
    
	return {
		'name': _controller_name,
		'params': _params
	};
};

KALS_user_interface.prototype._trigger_controller = function (_ele, _config) {
	var _controller_name = _config.name;
	
	if (typeof(this[_controller_name]) == 'function') {
		var _params = _config.params;
		return this[_controller_name](_ele, _params);
	}
	return this;
};

/* End of file KALS_user_interface */
/* Location = ./system/application/views/web_apps/toolkit/KALS_user_interface.js *//**
 * KALS_modal
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/26 下午 03:22:46
 * @extends {KALS_user_interface}
 */
function KALS_modal() {
    
    KALS_user_interface.call(this);
    
}

KALS_modal.prototype = new KALS_user_interface();

/**
 * 建立Modal的UI
 * @type {jQuery}
 */
/*
KALS_modal.prototype._$create_ui = function () {
	var _ui = this._load_template();
	$.test_msg('KALS_modal', _ui);
	if (_ui === null) {
		_ui = this._$create_ui_prototype(); 
	}
    return _ui;
};
*/
/**
 * 可否關閉
 * @type {boolean}
 */
KALS_modal.prototype._$closable = true;

/**
 * 檢查是否可關閉
 * @type {boolean} = true
 */
KALS_modal.prototype.is_closable = function () {
    return this._$closable;
};

/**
 * 模組名稱
 * @type {string}
 * @property
 */
KALS_modal.prototype._$modal_name = null;

/**
 * KALS_modal統一會擁有的Class Name
 * @type {string}
 */
KALS_modal.prototype.class_name = 'kals-modal';

/**
 * 建立UI的動作
 * @private
 */
KALS_modal.prototype._setup_ui = function () {
    
    this._ui = this._$create_ui();
    
    if (this._$onviewportmove !== null
        && typeof(KALS_context) !== 'undefined'
        && typeof(KALS_context.view) !== 'undefined') {
    
        var _this = this;
        
        // 設定改變視點時的調整
        KALS_context.view.add_listener(function () {
            var _visible_enable = _this._$viewportmove_visible_enable;
            if (_this.has_setup_ui() && _visible_enable) {
                _this._$onviewportmove(_this._ui);
            }
        });
    }
    
    return this;
};

/**
 * 設定Modal
 * @param {Object} _config = {
 *     modal_name: 'modal_name',
 *     closable: true,
 *     open: true,
 *     onopen: function() {},
 *     onclose: function() {},
 *     onviewportmove: function () {}
 * }
 */
KALS_modal.prototype.setup_modal = function (_config) {
    
    var _get_parameter = function (_name, _default) {
        return $.get_parameter(_config, _name, _default);
    };
    
    var _modal_name = _get_parameter('modal_name');
    if ($.is_string(_modal_name)) {
        this.set_modal_name(_modal_name);
    }
    
    var _closable = _get_parameter('closable');
    if ($.is_boolean(_closable)) {
        this.set_closable(_closable);
    }
    
    var _onopen = _get_parameter('onopen');
    if ($.isset(_onopen)) {
        this.set_onopen(_onopen);
    }
    
    var _onclose = _get_parameter('onclose');
    if ($.isset(_onclose)) {
        this.set_onclose(_onclose);
    }
    
    var _onviewportmove = _get_parameter('onviewportmove');
    if ($.isset(_onviewportmove)) {
        this.set_onviewportmove(_onviewportmove);
    }
    
    var _open = _get_parameter('open', true);
    if (_open) {
        this.open();
    }
    
    return this;
};

/**
 * 設定Modal的名稱
 * @param {Object} _modal_name
 */
KALS_modal.prototype.set_modal_name = function (_modal_name) {
    if ($.is_string(_modal_name)) {
        this._$modal_name = _modal_name;
    }
    return this;
};

/**
 * 設定是否可以關閉
 * @param {boolean} _closable
 */
KALS_modal.prototype.set_closable = function (_closable) {
    if ($.is_boolean(_closable)) {
        this._$closable = _closable;
    }
    else {
        this._$closable = false;
    }
    return this;
};

/**
 * 設定onopen的callback
 * @param {function|boolean} _callback
 */
KALS_modal.prototype.set_onopen = function (_callback) {
    if ($.is_function(_callback)) {
        this._$onopen = _callback;
    }
    else if (_callback === false || _callback === null) {
        this._$onopen = null;
    }
    return this;
};

/**
 * 設定onclose的callback
 * @param {function|boolean} _callback
 */
KALS_modal.prototype.set_onclose = function (_callback) {
    
    if ($.is_function(_callback)) {
        this._$onclose = _callback;
    }
    else if (_callback === false || _callback === null) {
        this._$onclose = null;
    }
        
    return this;
};

/**
 * 設定onviewportmove的callback
 * @param {function|boolean} _callback
 */
KALS_modal.prototype.set_onviewportmove = function (_callback) {
    if ($.is_function(_callback)) {
        this._$onviewportmove = _callback;
    }
    else if (_callback === false || _callback === null) {
        this._$onviewportmove = null;
    }
    return this;
};

/**
 * 開關Modal
 * @param {boolean} _display
 * @param {function} _callback
 */
KALS_modal.prototype.toggle_modal = function (_display, _callback) {
    if ($.is_function(_display) && $.is_null(_callback)) {
        _callback = _display;
        _display = null;
    }
    
    if ($.is_null()) {
        _display = !(this.is_opened());
    }
    
    if (_display === true) {
        this.open(_callback);
    }
    else {
        this.close(_callback);
    }
    return this;
};

/**
 * 檢查Modal是否有開啟
 * @type {boolean}
 */
KALS_modal.prototype.is_opened = function () {
    var _ui = this.get_ui();
    if (_ui !== null) {
        return _ui.visible();
    }
    else {
        return false;
    }
};

/**
 * 開啟UI
 * @param {function|null} _callback
 */
KALS_modal.prototype.open = function (_callback) {
    var _ui = this.get_ui();
    if (_ui !== null) {
        _ui.show();
    }
    
    if ($.is_function(this._$onviewportmove)) {
        this._$onviewportmove(this._ui);
    }
    if ($.is_function(this._$onopen)) {
        this._$onopen(this._ui);
    }
    if ($.is_function(_callback)) {
        _callback(this._ui);
    }
    
    //跟Modal_controller註冊開啟
    if (typeof(KALS_context) === 'object' 
            && typeof(KALS_context.modal) === 'object') {
        KALS_context.modal.add_opened(this);
    }
    
    return this;
};

/**
 * 開啟UI之後的callback
 * 肯定已經完成get_ui()
 * 參數會傳入this._ui。
 * @type {function} = function (_ui) {}
 */
KALS_modal.prototype._$onopen = null;

/**
 * 關閉UI
 * @param {Object} _callback
 */
KALS_modal.prototype.close = function (_callback) {
    if (this._$closable) {
        var _ui = this.get_ui();
        if (_ui !== null) {
            _ui.hide();
        }
        if ($.is_function(this._$onclose)) {
            this._$onclose(this._ui);
        }
        if ($.is_function(_callback)) {
            _callback(this._ui);
        }
            
        //跟Modal_controller註冊關閉
        if (typeof(KALS_context) === 'object' 
                && typeof(KALS_context.modal) === 'object') {
            KALS_context.modal.delete_opened(this);
        }
    }
    return this;
};

/**
 * 關閉UI之後的callback
 * 肯定已經完成get_ui()
 * 參數會傳入this._ui。
 * @type {function} = function (_ui) {}
 */
KALS_modal.prototype._$onclose = null;

/**
 * 畫面移動時候的callback。
 * 只有在this.has_setup_ui() === true的時候啟動。
 * 參數會傳入this._ui。
 * @type {function} = function (_ui) {}
 */
KALS_modal.prototype._$onviewportmove = null;

/**
 * 即使被隱藏了，也能夠使用viewportmove
 * @type {function} = function (_ui) {}
 */
KALS_modal.prototype._$viewportmove_visible_enable = false;


/**
 * 暫存用的回呼函數
 * @type {null|function}
 */
KALS_modal.prototype._$temp_callback = null;

/**
 * 呼叫暫存用的回呼函數，然後刪除。在open與close的時候會用到
 * @param {jQuery} _ui
 */
KALS_modal.prototype.call_temp_callback = function (_ui) {
    
    //$.test_msg('call temp callback', [this.get_modal_name(), ($.is_function(this._$temp_callback))
    //    , this._$temp_callback]);
    
    if ($.is_function(this._$temp_callback)) {
        //$.test_msg('is funciton');
        this._$temp_callback(_ui);
        this._$temp_callback = null;
    }
};

/**
 * 取得Modal Name
 * @type {string}
 */
KALS_modal.prototype.get_modal_name = function () {
    return this._$modal_name;
};

// ---------
// 設定jQuery Tools特效
// ---------
$(function () {
    $.tools.overlay.addEffect("fade", function(position, done) {
          this.getOverlay().css(position).fadeIn(this.getConf().speed, done);
       },// close function
       function(done) {
          // fade out the overlay
          this.getOverlay().fadeOut(this.getConf().closeSpeed, done);
       }
    );    
});

/* End of file KALS_modal */
/* Location: ./system/application/views/web_apps/KALS_modal.js *//**
 * Overlay_modal
 * 這個Overlay是指jQuery TOOLS的Overlay
 * 
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/26 下午 04:00:31
 * @extends {KALS_modal}
 * @memberOf {Overlay_modal}
 */
function Overlay_modal() {
    
    KALS_modal.call(this);
    
}

/**
 * @type {KALS_modal}
 */
Overlay_modal.prototype = new KALS_modal();

/**
 * 統一的模型名稱
 * @type {string}
 */
Overlay_modal.prototype._$modal_name = 'Overlay_modal';

/**
 * 是否需要使用jQuery Tools中的expose功能
 */
Overlay_modal.prototype._$need_expose = true;

/**
 * 此Overlay是否需要Mask的設定
 * @type {boolean}
 */
Overlay_modal.prototype._$exposable = false;

/**
 * Overlay的共通輸入參數。實際上設定是在建構子時設定的。
 * @type {object}
 */
Overlay_modal.prototype._$get_config = function () {
    
    //$.test_msg('Overlay_modal._$get_config()', this._$modal_name);
    
    var _this = this;
    
    var _config = {
        //top: '10%',
        left: 'center',
        closeOnClick: false,
        load: false,
        onBeforeLoad: function() {
            //跟Modal_controller註冊開啟
            if (typeof(KALS_context) == 'object' && typeof(KALS_context.overlay) == 'object') {
				KALS_context.overlay.add_opened(_this);
			}
            
            var _ui = _this.get_ui();
            if ($.is_function(_this._$onviewportmove)) {
				_this._$onviewportmove(_ui);
			}
        },
        onLoad: function () {
            
            //$.test_msg('Overlay_modal._$get_config() onLoad', [_this._$temp_callback, _this.call_temp_callback]);
            
            var _ui = _this.get_ui();
            
            //2010.10.16 將定位移至onBeforeLoad執行
            //if ($.is_function(_this._$onviewportmove))
            //    _this._$onviewportmove(_ui);
            
            _ui.animate({}, {
                complete: function () {
                    setTimeout(function () {
                        if ($.is_function(_this._$onopen)) {
							_this._$onopen(_ui);
						}
                        _this.call_temp_callback(_ui);    
                    }, 1000);
                       
                }
            });
        },
        onBeforeClose: function () {
            //跟Modal_controller註冊關閉
            if (typeof(KALS_context) == 'object' && typeof(KALS_context.overlay) == 'object') {
				KALS_context.overlay.delete_opened(_this);
			}
            
        },
        onClose: function () {
            
            var _ui = _this.get_ui();
            if ($.is_function(_this._$onclose)) {
				_this._$onclose(_ui);
			}
            _this.call_temp_callback(_ui);
            
            
            //$.test_msg('Overlay_modal._$get_config() onClose 應該已經關閉了吧？');
            _ui.hide();
        },
        oneInstance: false
    };   
    return _config; 
};

/**
 * 設定好effect
 */
Overlay_modal.prototype._setup_effect = function () {
	$.tools.overlay.addEffect("fade", function(position, done) {
	      this.getOverlay().css(position).fadeIn(this.getConf().speed, done);
	   },// close function
	   function(done) {
	      // fade out the overlay
	      this.getOverlay().fadeOut(this.getConf().closeSpeed, done);
	   }
	); 
};

/**
 * Overlay的開啟動作
 * @param {function|null} _callback
 */
Overlay_modal.prototype.open = function (_callback) {
    
    if (this.is_opened() === false) {
        var _ui = this.get_ui();
        var _this = this;
        
        //$.test_msg('Overlay_modal.open() check _ui', [(_ui != null), (typeof(_ui.overlay) == 'function'), _callback]);
        
        if (_ui !== null) {
            if (typeof(_ui.overlay) === 'function') {
                //$.test_msg('Overlay_modal.open() 設置this._$temp_callback', _callback);
                this._$temp_callback = _callback;
                //$.test_msg('Overlay_modal.open() 設置了this._$temp_callback', this._$temp_callback);
                
                //此處的callback會在load的時候就呼叫了
                var _api = _ui.data("overlay");
				//$.test_msg('Overlay_modal.open() 有API嗎?', $.isset(_api));
				
                if ($.isset(_api)) {
                    _api.setOpened(false);
					try {
						_api.load();
					}
					catch (_e) {
						_this._setup_effect();
						try {
							//再試著讀取一次
							_api.load();
						}
						catch (_final_e) {
							$.test_msg('open Overlay failed: ' , _final_e);
						}
					}
                      
                }
                _ui.show();
                
                if (this.is_exposable() && typeof(this.expose) == "function") {
                    this.expose();
                }
            }
            else {
                _ui.show();
                
                //$.test_msg('Overlay_modal.open() after show');
                
                if ($.is_function(_callback)) {
					_callback(_ui);
				}
            }
        }
    }
    else {
        $.trigger_callback(_callback);
    }
    
    return this;
};

/**
 * Overlay的關閉動作
 * @param {function|null} _callback
 */
Overlay_modal.prototype.close = function (_callback) {
    if (this._$closable && this.is_opened()) {
        var _ui = this.get_ui();
        
        var _this = this;
        
        if (_ui !== null) {
            if (typeof(_ui.overlay) === 'function') {
                //$.test_msg('close set temp callback', [this.get_modal_name(), typeof(_callback)]);
                //$.test_msg('close set temp callback', _ui.overlay().close);
                this._$temp_callback = _callback;
                
                //if (typeof(_ui.overlay().isOpened()) != 'undefined')
                var _api = _ui.data("overlay");
                if ($.isset(_api)) {
                    _api.setOpened(true);
                    _api.close();    
                }
                _ui.hide();
                //else
                //{
                    
                //}
            }
            else {
                _ui.hide();
                if ($.is_function(_callback)) {
					_callback(_ui);
				}
            }
        }
    }
    return this;
};

/**
 * 此Overlay是否需要Mask
 * @type {boolean}
 */
Overlay_modal.prototype.is_exposable = function () {
    return this._$exposable;
};

/**
 * Mask的z-index
 * @type {number}
 * @property
 * @private
 */
Overlay_modal.prototype._mask_z_index = 9998;

/**
 * 讓此Overlay背後顯示mask
 * @param {Object} _callback
 */
Overlay_modal.prototype.expose = function (_callback) {
    if (this._$exposable === false) {
		return this;
	}
    
    var _ui = this.get_ui();
    
    if ($.isset(_ui) && typeof(_ui.expose) === "function") {
        _ui.expose({
            color: '#333333',
            loadSpeed: 200,
            opacity: 0.5,
            zIndex: this._mask_z_index,
            closeOnClick: false,
            closeOnEsc: false
        });
        _ui.css('z-index', (this._mask_z_index+1));
    }
    
    setTimeout(function () {
        $.trigger_callback(_callback);
    }, 200);
    return this;
};

/**
 * 讓此Overlay隱藏到Mask之後
 * @param {function} _callback
 */
Overlay_modal.prototype.cover = function (_callback) {
    if (this._$exposable === false) {
        return this;
    }
    
    var _ui = this.get_ui();
    
    if ($.isset(_ui)) {
        _ui.css('z-index', (this._mask_z_index-1));
    }
    
    $.trigger_callback(_callback);
    
    return this;
};

//var a = new Overlay_modal();


/* End of file Overlay_modal */
/* Location: ./system/application/views/web_apps/Overlay_modal.js *//**
 * Tooltip_modal
 * 這個Tooltip是指jQuery TOOLS的tooltip
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/26 下午 04:00:43
 * @extends {KALS_modal}
 */
function Tooltip_modal() {
    
    KALS_modal.call(this);
    
}

Tooltip_modal.prototype = new KALS_modal();

Tooltip_modal.prototype._$modal_name = 'Tooltip_modal';

Tooltip_modal.prototype._$tooltip_id = null;

/**
 * trigger的classname，跟this._$modal_name一起運作
 * @type {String}
 */
Tooltip_modal.prototype.get_trigger_classname = function () {
    var _trigger_classname = this._$modal_name + '_trigger';
    return _trigger_classname;
};

/**
 * 取得tooltip的設定
 * @param {string} _selector 指定此物件當做tip
 */
Tooltip_modal.prototype._$get_config = function (_selector) {
    
    var _this = this;
    var _trigger_classname = this.get_trigger_classname();
    
    var _config = {
        onBeforeShow: function () {
            var _trigger = this.getTrigger();
            _trigger.addClass(_trigger_classname);
        },
        onBeforeHide: function () {
            $('.' + _trigger_classname).removeClass(_trigger_classname);
        },
        onShow: function () {
            var _ui = _this.get_ui();
            
            //2010.9.4 因為Tooltip可能會跟著trigger的位置跑，所以我想應該是不需要_$onviewportmove
            //if ($.is_function(_this._$onviewportmove))
            //    _this._$onviewportmove(_ui);
            
            if ($.is_function(_this._$onopen)) {
                _this._$onopen(_ui);
            }
                
            _this.call_temp_callback(_ui);
        },
        onHide: function () {
            var _ui = _this.get_ui();
            if ($.is_function(_this._$onclose)) {
				_this._$onclose(_ui);
			}
            _this.call_temp_callback(_ui);
        },
        delay: 30,
        predelay: 100,
        events: { def: 'mouseenter, mouseleave' }
        //, effect: 'fade'        
    };
    
    if ($.is_null(_selector) && $.isset(this._$tooltip_id)) {
        _selector = '#' + this._$tooltip_id;
    }
    
    if ($.isset(_selector)) {
		_config.tip = _selector;
	}
    
    return _config;  
};


Tooltip_modal.prototype.get_trigger = function () {
    
    var _trigger_classname = this.get_trigger_classname();
    
    var _trigger = $('.' + _trigger_classname);
    return _trigger;
};

/**
 * 建立tip原形
 * @param {Object} _config = {
 *     id: ID,
 *     classname: CLASSNAME,
 *     content: 內容
 * }
 */
Tooltip_modal.prototype._create_tooltip_prototype = function (_config) {
    
    var _id = $.get_parameter(_config, 'id');
    if ($.is_null(_id) && $.isset(this._$tooltip_id)) {
		_id = this._$tooltip_id;
	}
    
    var _content = $.get_parameter(_config, 'content');
    var _classname = $.get_parameter(_config, 'classname');
    
    if ($.is_string(_content)) {
        _content = $(_content);
    }
    else if ($.is_null(_content)) {
        _content = $('<div></div>');
    }
    
    var _tooltip = null;
    var _tooltip_existed = false;
    
    if ($.isset(_id)) {
        _tooltip = $('div#' + _id);
        _tooltip_existed = (_tooltip.length > 0);
    }
    
    //$.test_msg('Tooltip_modal._create_tooltip.prototype()', _tooltip_existed);
    
    if (_tooltip_existed === false) {  
        _tooltip = _content
            .addClass('tooltip')
			.addClass("KALS")
            .appendTo($('body'));
        
        if ($.isset(_id)) {
			_tooltip.attr('id', _id);
		}
        
        if ($.isset(_classname)) {
			_tooltip.addClass(_classname);
		}
        
        //$.test_msg('Tooltip_modal._create_tooltip.prototype()', _tooltip.length);
    }
    
    return _tooltip;
};

/**
 * Tooltip的開啟動作
 * @param {Function} _callback
 */
Tooltip_modal.prototype.open = function (_callback) {
    var _ui = this.get_trigger();
    
    var _this = this;
    
    if (_ui !== null) {
        if (typeof(_ui.tooltip) == 'function') {
            this._$temp_callback = _callback;
            _ui.tooltip().show();
        }
        else {
            _ui.show();
            if ($.is_function(_callback)) {
				_callback(_ui);
			}
        }
    }
    
    return this;
};

/**
 * Tooltip的關閉動作
 * @param {function|null} _callback
 */
Tooltip_modal.prototype.close = function (_callback) {
    if (this._$closable && this.is_opened()) {
        //var _ui = this.get_ui();
        var _ui = this.get_trigger();
        
        var _this = this;
        
        if (_ui !== null) {
            if (typeof(_ui.tooltip) == 'function') {
                 this._$temp_callback = _callback;
                 _ui.tooltip().hide();
            }
            else {
                _ui.hide();
                if ($.is_function(_callback)) {
					_callback(_ui);
				}
            }
        }
    }
    return this;
};


/**
 * 利用tooltip的isShown()來偵測是否開啟
 * 2010.10.18 那要設置在trigger上才對，目前這個無法這樣做，所以取消
 * @param {boolean} _fully = false。如果_fully === true，則會在tooltip完全顯示且定位完成之後才會回傳true
 * @type {boolean}
 */
/*
Tooltip_modal.prototype.is_opened = function (_fully) {
    var _ui = this.get_trigger();
    if (_ui != null) {
        return _ui.tooltip().isShown(_fully);
        
    }
    else {
        return false;
    }
};
*/
/* End of file Tooltip_modal */
/* Location: ./system/application/views/web_apps/Tooltip_modal.js *//**
 * Dialog_modal
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/26 下午 08:27:46
 * @extends {Overlay_modal}
 */
function Dialog_modal() {
    
    Overlay_modal.call(this);
    
}

Dialog_modal.prototype = new Overlay_modal();

Dialog_modal.prototype._$modal_name = 'Dialog_modal';
    
Dialog_modal.prototype._$create_ui = function () {
    
    var _ui = this._$create_ui_prototype();
    
    _ui.addClass('dialog-modal')
		.addClass('KALS').addClass('window')
        .html('<table align="center" class="dialog-table" height="100%" width="100%" cellpadding="0" cellspacing="0" border="0"><tbody>'
        + '<tr class="dialog-toolbar-tr"><th class="dialog-toolbar" valign="middle">'
            + '<table class="dialog-toolbar-table" width="100%" align="center" cellpadding="0" cellspacing="0" border="0"><tbody><tr>'
            + '<td class="toolbar-options toolbar-backward"></td>'
            + '<td class="dialog-heading"></td>'
            + '<td class="toolbar-options toolbar-forward"></td>'
            + '</tr></tbody></table>'
        + '</th></tr>' 
        + '<tr class="dialog-content-tr"><td class="dialog-content-td">'
            + '<div class="dialog-content"></div></td></tr>'
        + '</tbody></table>');
    
    if ($.browser.msie6) {
        _ui.css('width', '480px');
        //_ui.css('font-size', '1.5em');
    }
    
    //$.test_msg('Dialog_modal._$create_ui()', this._$modal_name);
 
    var _config = this._$get_config();
    _ui.overlay(_config);	//jQuery TOOL Overlay
    
    if ($.is_mobile_mode()) {
        _ui.addClass('mobile');
        //var _el = _ui.find('.dialog-content');  
        //this.enable_touch_scroll(_el);
        this.enable_touch_scroll(_ui);
    }
    
    return _ui;
};

Dialog_modal.prototype._$onviewportmove = function (_ui) {
    if ($.browser.msie6) {
        return;
    }
    
    if ($.is_small_width()) {
        _ui.fullscreen_width();
        _ui.addClass('compact-width');
    }
    else {
        _ui.restore();
        _ui.removeClass('compact-width');
    }
    
    if ($.is_small_height()) {
        _ui.addClass('compact-height');
    }
    else {
        _ui.removeClass('compact-height');
    }
    
    _ui.ready(function () {
        
        if ($.is_small_height() 
            && (_ui.height() > $.get_viewport_height() || _ui.height() == $.get_viewport_height())) {
            _ui.valign('top');
        }
        else {
            _ui.css('top', '10%');
        }
        
        _ui.align('center');
    });
};

/**
 * Dialog專用的setup_modal方法
 * @param {Object} _config = {
 *     heading: '標頭語言索引',    //Lang
 *     backword_option: _option,
 *     forword_option: _option,
 *     message: '內文語言索引',    //KALS_language_param
 *     content: '內文UI',    //jQuery，如果同時有message，則會以content為主
 *     display_content: true,    //是否顯示content
 *     options: [_option1, _option2]
 * }
 */
Dialog_modal.prototype.setup_modal = function (_config) {
    
    //2010.10.1 不採用Base用法，而用Prototype往上call
    //this.base(_config);
    Overlay_modal.prototype.setup_modal.call(this, _config);
    
    var _heading = $.get_parameter(_config, 'heading');
    
    if (_heading !== null) {
		this.set_heading(_heading);
	}
    var _backword_option = $.get_parameter(_config, 'backword_option');
    if (_backword_option !== null) {
		this.set_backward_option(_backword_option);
	}
    
    var _forword_option = $.get_parameter(_config, 'forword_option');
    if (_forword_option !== null) {
		this.set_forward_option(_forword_option);
	}
    
    var _message = $.get_parameter(_config, 'message');
    var _content = $.get_parameter(_config, 'content');
    if ($.is_jquery(_content)) {
        this.set_content(_content);
    }
    else if ($.is_string(_message)) {
        this.set_message(_message);
    }
    
    var _display_content = $.get_parameter(_config, 'display_content', true);
    if (_display_content === false) {
        this.toggle_content(false);
    }
    
    var _options = $.get_parameter(_config, 'option');
    if (_options !== null) {
		this.set_options(_options);
	}
    
    return this;  
};

/**
 * 設定標頭
 * @param {string|KALS_language_param} _lang_param
 */
Dialog_modal.prototype.set_heading = function (_lang_param) {
    var _container = this.get_heading();
    if (_container.length == 1) {
        if ($.is_string(_lang_param)) {
            _container.html(_lang_param);
        }
        else {
           KALS_context.lang.add_listener(_container, _lang_param);
        }
    }
    return this;
};

/**
 * 取得標頭
 * @type (jQuery)
 */
Dialog_modal.prototype.get_heading = function () {
    var _ui = this.get_ui();
    var _container = _ui.find('.dialog-heading:first');
    return _container;
};

/**
 * 設定toolbar上的左方按鈕
 * @param {Dialog_option} _option
 */
Dialog_modal.prototype.set_backward_option = function (_option) {
    var _ui = this.get_ui();
    
    var _option_ui = _option;
    if ($.is_jquery(_option) === false) {
        if (typeof(_option.get_ui) != 'function') {
			return this;
		}
        _option_ui = _option.get_ui();
    }
    
    var _container = _ui.find('.toolbar-backward:first');
        
    _container
        .show()
        .append(_option_ui);    
    
     _option_ui.ready(function() {
        
        setTimeout(function () {
            var _width = _option_ui.width();
            if (_width !== 0) {
				_ui.find('.toolbar-options').css('max-width', _width + 'px').show();
			}    
        }, 100);
    });
    
    //同時擁有.with-backward-option.with-forward-option的.dialog-modal，會改變min-width
    _ui.addClass('with-backward-option');
    
    return this;
};

/**
 * 設定toolbar上的右方按鈕
 * @param {Dialog_option} _option
 */
Dialog_modal.prototype.set_forward_option = function (_option) {
    var _ui = this.get_ui();
    
    if (typeof(_option.get_ui) != 'function') {
		return this;
	}
    
    var _option_ui = _option.get_ui();
    var _container = _ui.find('.toolbar-forward:first');
    
    _container
        .show()
        .append(_option_ui);
    
    /*
    _option_ui.ready(function() {
        
        setTimeout(function () {
            var _width = _option_ui.width();
            if (_width != 0)
                _ui.find('.toolbar-options').css('max-width', _width + 'px').show();    
        }, 100);
    });
    */
   
    this.set_backward_option(_option_ui.clone().css('visibility', 'hidden'));
    
    
    //同時擁有.with-backward-option.with-forward-option的.dialog-modal，會改變min-width
    _ui.addClass('with-forward-option');
    
    return this;
};

/**
 * 切換顯示工具列的按鈕
 * @param {boolean} _display
 * @returns {Dialog_modal}
 */
Dialog_modal.prototype.toggle_toolbar_option = function(_display) {
    
    var _toolbar = this.get_ui('.dialog-toolbar:first');
    
    var _classname = 'hide-option';
    if ($.is_null(_display)) {
        _toolbar.toggleClass(_classname);
    }
    else if (_display) {
        _toolbar.removeClass(_classname);
    }
    else {
        _toolbar.addClass(_classname);
    }
        
    return this;
};

/**
 * 設定內文
 * @param {string|KALS_language_param|jQuery} _lang
 */
Dialog_modal.prototype.set_content = function (_lang) {
    var _container = this.get_content();
    
    if (_container.length == 1) {
        this.toggle_content(true);
        this.get_ui().addClass('with-content');
        if ($.is_null(_lang)) {
            //如果是空物件，則隱藏
            _container.empty();
            this.toggle_content(false);
            this.get_ui().removeClass('with-content');  
        }
        else if ($.is_string(_lang)) {
            _container.html(_lang);
        }
        else if ($.is_class(_lang, 'KALS_language_param')) {
            if (typeof(KALS_context) != 'undefined') {
                KALS_context.lang.add_listener(_container, _lang);
            }
        }
        else {
            _container.empty();
            
            if ($.isset(_lang)) {
                _container.append(_lang);
                _lang.show();
            }
        }
        
    }
    return this;
};

Dialog_modal.prototype.set_content_temp = function () {
    var _container = this.get_content();
    
    var _content = _container.children();
    
    if (_content.length > 0) {
        _content.hide()
            .appendTo($('body'));
    }
    
    return this;
};

Dialog_modal.prototype.get_content = function () {
    var _ui = this.get_ui();
    
    var _container = _ui.find('.dialog-content:first');
    return _container;
};

Dialog_modal.prototype.toggle_content = function (_display, _callback) {
    if ($.is_function(_display) && $.is_null(_callback)) {
        _callback = _display;
        _display = null;
    }
    
    var _ui = this.get_ui();
    
    //var _container = _ui.find('.dialog-content-tr:first');
    var _container = _ui.find('.dialog-content:first');
    
    if (_display === null) {
        _container.toggle();
    }
    else if (_display === true) {
        _container.show();
    }
    else {
        _container.hide();
    }
    
    $.trigger_callback(_callback);
    return this;
};

/**
 * 設置下方按鈕
 * @param {Array|Dialog_option} _options
 * @param {boolean} _double_col = true
 */
Dialog_modal.prototype.set_options = function (_options, _double_col) {
    
    if ($.is_null(_options)) {
		_options = [];
	}
	else 
		if (false == $.is_array(_options)) {
			_options = [_options];
		}
        
    //$.test_msg('set_options', _options.length);
    
    if ($.is_null(_double_col)) {
		_double_col = true;
	}
    
    var _ui = this.get_ui();
    
    _tbody = _ui.find('tbody:first');
    
    //_tbody.find('.dialog-options').remove();
    _tbody.find('.dialog-options').hide().appendTo($('body'));
    
    _ui.removeClass('with-options');
    
    for (var _index = 0; _index < _options.length; _index++) {
        //$.test_msg('set_options forloop', [$.get_class(_options[_index]), (typeof(_options[_index].get_ui))]);
        
        if (typeof(_options[_index].get_ui) != 'function') {
			continue;
		}
        
        var _option_ui = _options[_index].get_ui();
        
        
        
        if (_index === 0) {
            _ui.addClass('with-options');
        }
        
        if (_index < _options.length -1
            && _double_col === true) {
            var _option_left = _option_ui;
            _index++;
            var _option_right = _options[_index].get_ui();
            
            var _tr = $('<tr class="dialog-options"><td></td></tr>')
                .appendTo(_tbody);
                
            _tr.find('td').append(_option_left)
                .append(_option_right);
            _option_left.addClass('option-left');
            _option_right.addClass('option-right');
        }
        else {
            var _option = _option_ui;
            _tr = $('<tr class="dialog-options"><td></td></tr>')
                .appendTo(_tbody);
                
            _tr.find('td:first').append(_option);
        }
        
    }
    return this;
};

/**
 * 決定是否顯示Options
 * @param {null|boolean} _display
 */
Dialog_modal.prototype.toggle_options = function (_display) {
    
    var _ui = this.get_ui();
    
    if ($.is_null(_display)) {
        _ui.toggleClass('hide-options');
    }
    else if (_display === true) {
        _ui.removeClass('hide-options');
    }
    else {
        _ui.addClass('hide-options');
    }
    
    //$.test_msg('toggle_options', _ui.attr('className'));
    
    return this;
};

/**
 * 將焦點鎖定在第一個按鈕上
 * @param {number} _offset = 0;
 */
Dialog_modal.prototype.focus_option = function (_offset) {
    if (this._setted_focus === true) {
		return this;
	}
    
    var _ui = this.get_ui();
    
    if (_ui !== null) {
        if ($.is_null(_offset)) {
			_offset = 0;
		}
            
        var _option = _ui.find('.dialog-options .dialog-option').eq(_offset);
        
        if (_option.length == 1) {
			_option.focus();
		}
        
        this._setted_focus = true;
    }
    return this;
};

Dialog_modal.prototype._setted_focus = false;

/**
 * 將有捲軸的物件轉換成可以碰觸捲軸
 * @param {jQuery} _el 要設定成可以碰觸捲軸的物件 
 */
Dialog_modal.prototype.enable_touch_scroll = function (_el) {
    
    //_el.css('cursor', 'pointer');
    
    var _get_event_pageY = this.get_event_pageY;
    var _setup_message = function () {
		var _scrollStartPos=0;
        
        //安裝捲軸
        var _el_height = _el.height() 
            + $.strip_unit(_el.css('padding-top'))
            + $.strip_unit(_el.css('padding-bottom'));
        var _el_scroll_height = _el.attr('scrollHeight');
        
        var _scroll = null;
        
        if (_el_height < _el_scroll_height) {
            
            /*
            var _el_position = _el.css('position').toLowerCase();
            if (_el_position == 'absolute' || _el_position == 'fixed') {
                //加入wrapper!
                var _scroll_wrapper = $('<div class="scroll-wrapper"></div>').appendTo($('body'));
                var _el_offset = _el.offset();
                
                _scroll_wrapper.css({
                    position: _el_position,
                    top: _el_offset.top + 'px',
                    left: _el_offset.left + 'px',
                    zIndex: _el.css('z-index')
                });
                
                _scroll_wrapper.append(_el);
                _el.css('position', 'static');
            }
            */
           
            var _scroll_container = $('<div class="scroll-container"><div class="scroll">&nbsp;</div></div>').css({
                    height: _el_height + 'px'
                })
                .prependTo(_el);
                //.insertBefore(_el);
            
            _scroll_container.ready(function () {
                //var _el_offset = _el.offset();
                var _el_offset = $.get_offset(_el);
                
                //_scroll_container.css('top', _el_offset.top + 'px');
                _scroll_container.css('position', 'fixed');
                _scroll_container.css('top', 0);
                if ($.is_mobile_mode()) {   
                    //_scroll_container.css('top', _el_offset.top + 'px');
                }
                else {   
                    _scroll_container.css('top', 0);    
                }
                _scroll_container.css('right', '5px');
                _scroll_container.css('z-index', _el.css('z-index'));
                //_scroll_container.css('left', (_el_offset.left + _el.width() - _scroll_container.width() - 5) + 'px' );
                //_scroll_container.
                
                $(function () {
                    KALS_context.view.add_listener(function () {
                        /*
                        _scroll_container.valign('top');
                        _scroll_container.align({
                            option: 'right',
                            offset: '5px'
                        });
                        */
                        _scroll_container.css('position', 'fixed');
                        _scroll_container.css('top', 0);    
                    });    
                });
                    
            });
            
            //_scroll_container.hide();
            
            _scroll_height = _el_height / _el.attr('scrollHeight') * _el_height;
            _scroll = _scroll_container.find('.scroll');
            _scroll.css({
                height: _scroll_height + 'px',
                position: 'relative'
            });
            _el.css('overflow-y', 'hidden');
            _el.css('cursor', 'n-resize');
            
            setTimeout(function () {
                _el.attr('scrollTop', 0);
            }, 1000);
        }

        var _start_event = function(_event) {
            //_el.css('color', 'red');    //偵測用功能
            _event.preventDefault();
            var _pageY = _get_event_pageY(_event);
			_scrollStartPos = _el.attr('scrollTop') + _pageY;
            
            var _listen_object=  window;
            if ($.browser.msie || $.is_mobile_mode()) {
				_listen_object = document;
			}
            
			$(_listen_object).bind("touchmove", _move_event);
            $(_listen_object).bind("mousemove", _move_event);
            
            $(_listen_object).bind("touchend", _end_event);
            $(_listen_object).bind("mouseup", _end_event);
            $(_listen_object).bind("mouseout", _end_event);
		};
        
        var END_TIMER;
        var _move_event = function(_event) {
            if (_scrollStartPos === null) {
				return;
			}
            
            //_el.css('color', 'blue');    //偵測用功能
            _event.preventDefault();
            
            var _origin_scroll_top = _el.attr('scrollTop'); 
            var _pageY = _get_event_pageY(_event);
            var _target_top = (_scrollStartPos - _pageY);
            _el.attr('scrollTop', _target_top);
            var _max_height = _el.attr('scrollHeight');
            
            if (_scroll !== null
                && _el.attr('scrollTop') == _origin_scroll_top) {
                
                if (_origin_scroll_top > 0) {
                
                    _target_top = _target_top - _el.attr('scrollTop');
                    if (_target_top > 50) {
						_target_top = 50;
					}
                    var _bottom_padding = _el.find('.bottom-padding:first');
                    if (_bottom_padding.length === 0) {
                        _bottom_padding = $('<div class="bottom-padding"></div>').appendTo(_el);
                    }
                    if (_bottom_padding.height() < _target_top) {
						_bottom_padding.css('height', _target_top + 'px');
					}
                    _bottom_padding.css('height', _target_top + 'px');
                    
                    if (_scroll !== null) {
                        var _max_top = _el_height - _scroll.css_number('height');
                        _scroll.css({
                                top: _max_top + 'px'
                        });
                    }
                }
                else {
                    _el.attr('scrollTop', 0);
                    _target_top = _target_top * -1;
                    if (_target_top > 50) {
						_target_top = 50;
					}
                    var _top_padding = _el.find('.top-padding:first');
                    if (_top_padding.length === 0) {
                        _top_padding = $('<div class="top-padding"></div>').prependTo(_el);
                    }
                    
                    if (_top_padding.height() < _target_top) {
						_top_padding.css('height', _target_top + 'px');
					} 
                        
                    if (_scroll !== null) {
                        _scroll.css({
                                top: 0 + 'px'
                        });
                    }   
                }
            }
            else if (_target_top > 0 && _target_top < _max_height + 1) {
                _el.attr('scrollTop', _target_top);
                
                if (_scroll !== null) {
                    var _scroll_top = _el.attr('scrollTop') / _el.attr('scrollHeight') * _el_height;
                    _max_top = _el_height - _scroll.css_number('height');
                    if (_scroll_top < _max_top) {
                        _scroll.css({
                            top: _scroll_top + 'px'
                        });
                    }
                }
            }
            //_ti.html(_scrollStartPos + ', ' + _el.attr('scrollTop')+ ', ' + _pageY]);
			
            clearTimeout(END_TIMER);
            
            END_TIMER = setTimeout(function () {
                
                _end_event();
                
            }, 1000);
		};
        
        var _end_event = function(_event) {
            
            clearTimeout(END_TIMER);
            
            _scrollStartPos = null;
            //_el.css('color', 'black');    //偵測用功能
            
            var _listen_object=  window;
            if ($.browser.msie || $.is_mobile_mode()) {
				_listen_object = document;
			}
            $(_listen_object).unbind("touchmove", _move_event);
            $(_listen_object).unbind("mousemove", _move_event);
            
            $(_listen_object).unbind("touchend", _end_event);
            $(_listen_object).unbind("mouseup", _end_event);
            
            setTimeout(function () {
                var _top_padding = _el.find('.top-padding:first');
                if (_top_padding.length === 1) {
                    var _option = {};
                    _option.height = 0;
                    _top_padding.animate(_option, {
                        queue: false,
                        complete: function () { _top_padding.remove(); }
                    });
                }
                
                var _bottom_padding = _el.find('.bottom-padding:first');
                if (_bottom_padding.length == 1) {
                    _option = {};
                    _option.height = 0;
                    _bottom_padding.animate(_option, {
                        queue: false,
                        complete: function () { _bottom_padding.remove(); }
                    });
                    var _el_option = {};
                    _el_option.scrollTop = _el.attr('scrollTop') - _bottom_padding.height();
                    _el.animate(_el_option, {
                        queue: false
                    });
                }
            }, 0);
            
		};
        _el.bind("touchstart", _start_event);
        _el.bind("mousedown", _start_event);  
        
        var _wheel_event = function (_event, _delta) {
            if (_event.preventDefault) {
				_event.preventDefault();
			}
            if (_delta) {
                _delta = -_delta;
                var _scroll_top = _el.attr('scrollTop');
                
                _el.attr('scrollTop', _scroll_top + (_delta * 30));
                
                if (_scroll !== null) {
                    _scroll_top = _el.attr('scrollTop') / _el.attr('scrollHeight') * _el_height;
                    var _max_top = _el_height - _scroll.css_number('height');
                    if (_scroll_top < _max_top) {
                        _scroll.css({
                            top: _scroll_top + 'px'
                        });
                    }
                }
            }
        };    //var _wheel_event
        
        _el.mousewheel(_wheel_event);  
    };
    
    _el.ready(function () {
        setTimeout(_setup_message, 500);
    });
};

Dialog_modal.prototype.get_event_pageY = function (_event) {
    if (typeof(_event.touches) != 'undefined' &&
	typeof(_event.touches[0]) != 'undefined' &&
	typeof(_event.touches[0].pageY) != 'undefined') {
		return _event.touches[0].pageY;
	}
	else {
		//alert(_event.pageY);
		return _event.pageY;
	}
};

/**
 * open的時候，focus在第一顆按鈕上
 * @param {Object} _callback
 */
Dialog_modal.prototype.open = function (_callback) {
    
    var _this = this;
    this._setted_focus = false;
    var _open_callback = function (_ui) {
        
        //$.test_msg('Dialog_modal.open() _open_callback');
        
        _this.focus_option();
        
        if ($.is_function(_callback)) {
			_callback(_ui);
		}
    };
    
    //2010.10.1 不使用Base庫
    //return this.base(_open_callback);
    
    //$.test_msg('檢查Dialog_modal.open的_callback', [ this._$modal_name ,_open_callback]);
    return Overlay_modal.prototype.open.call(this, _open_callback);
};

/**
 * 曝光
 * 
 * 背後加上深色背景的Mask
 * @param {Object} _callback
 */
Dialog_modal.prototype.expose = function (_callback) {
    var _this = this;
    var _expose_callback = function () {
        _this.focus_option();
        $.trigger_callback(_callback);   
    };
    
    //2010.10.1 不使用Base庫
    //return this.base(_expose_callback);
    return Overlay_modal.prototype.expose.call(this, _expose_callback);
};
/* End of file Dialog_modal */
/* Location: ./system/application/views/web_apps/Dialog_modal.js *//**
 * Dialog_option
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/31 下午 09:46:08
 * @extends {KALS_user_interface}
 * @param {KALS_language_param} _lang
 * @param {function} _callback
 * @param {Object} _arg
 */
function Dialog_option(_lang, _callback, _arg) {
    
    KALS_user_interface.call(this);
    
    if ($.is_function(_lang)) {
        _arg = _callback;
        _callback = _lang;
        _lang = null;
    }
    
    if ($.is_class(_lang, 'KALS_language_param')) {
		this.lang = _lang;
	}
    if ($.is_function(_callback)) {
		this.callback = _callback;
	}
    this.arg = _arg;
}

Dialog_option.prototype = new KALS_user_interface();

Dialog_option.prototype._$multi_instence = true;

Dialog_option.prototype.lang = null;
Dialog_option.prototype.callback = null;
Dialog_option.prototype.arg = null;

Dialog_option.prototype._default_lang = new KALS_language_param(
    'BUTTON',
    'dialog.option.button'
);

/**
 * 建立按鈕
 * @type {jQuery}
 */
Dialog_option.prototype._$create_option = function () {
    return $('<button class="button"></button>');
}; 
Dialog_option.prototype._$create_ui = function () {
    
    var _button = this._$create_option()
        .addClass('dialog-option');
    
    var _lang = this.lang;
    if ($.is_null(_lang)) {
		_lang = this._default_lang;
	}
    
    KALS_context.lang.add_listener(_button, _lang);
    
    if ($.is_function(this.callback)) {
        var _this = this;
        _button.click(function () {
            _this.callback(_this.arg);
            return false;
        });
    }
    
    _button.hover(function () {
        $(this).addClass('hover');
    }, function () {
        
        if ($(this).hasClass('focus') === false) {
			$(this).removeClass('hover');
		}
    });
    
    _button.focus(function () {
        var _other_button = $('.dialog-option.hover.focus')
            .removeClass('hover')
            .removeClass('focus');
        
        $(this).addClass('hover');
        $(this).addClass('focus');
    });
    
    _button.blur(function () {
        $(this).removeClass('hover');
        $(this).removeClass('focus');
    });
    
    return _button;
};

/* End of file Dialog_option */
/* Location: ./system/application/views/web_apps/Dialog_option.js *//**
 * Dialog_link
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/10/5 下午 11:08:42
 * @extends {Dialog_option}
 */
function Dialog_link(_lang, _callback, _arg) {
    
    Dialog_option.call(this, _lang, _callback, _arg);
    
}

Dialog_link.prototype = new Dialog_option();

Dialog_link.prototype._$create_option = function () {
    //$.test_msg('Dialog_link._$create_option()');
    return $('<a href="#" class="link"></a>');
};


/* End of file Dialog_link */
/* Location: ./system/application/views/web_apps/Dialog_link.js *//**
 * Dialog_close_option
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/31 下午 09:58:04
 * @extends {Dialog_option}
 * @param {KALS_language_param} _lang
 * @param {function} _callback
 */
function Dialog_close_option(_lang, _callback, _arg) {
    
    Dialog_option.call(this, _lang, _callback, _arg);
    
}

Dialog_close_option.prototype = new Dialog_option();

/**
 * 預設的關閉語系參數
 * @type {KALS_language_param}
 */
Dialog_close_option.prototype._default_lang = new KALS_language_param(
    'CLOSE',
    'dialog.option.close'
);

Dialog_close_option.prototype._$create_ui = function () {
    
    var _ui = Dialog_option.prototype._$create_ui.call(this);
    
    _ui.addClass('dialog-close');
    
    var _this = this;
    _ui.click(function () {
        var _ui = this;
        _this.close_handle(_ui);
        return false;
    });
    
    return _ui;
};

Dialog_close_option.prototype.close_handle = function (_ui, _callback) {
    
    setTimeout(function () {
            
        var _overlay = $(_ui).parents('.dialog-modal:first').overlay();
        if (typeof(_overlay.close) == 'function') {
			_overlay.close();
		}
        
        $.trigger_callback(_callback);
        
    }, 300);
    
};
    
/* End of file Dialog_close_option */
/* Location: ./system/application/views/web_apps/Dialog_close_option.js *//**
 * Dialog_close_link
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/10/5 下午 11:13:03
 * @extends {Dialog_close_option}
 */
function Dialog_close_link(_lang, _callback, _arg) {
    
    Dialog_close_option.call(this, _lang, _callback, _arg);
    
    //$.test_msg('Dialog_close_link()', [this._$option_prototype, Dialog_link.prototype._$option_prototype]);
}

Dialog_close_link.prototype = new Dialog_close_option();

Dialog_close_link.prototype._$create_option = function () {
    return Dialog_link.prototype._$create_option.call(this);
};

/* End of file Dialog_close_link */
/* Location: ./system/application/views/web_apps/Dialog_close_link.js *//**
 * Notify_modal
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/27 下午 10:25:27
 * @extends {Overlay_modal}
 */
function Notify_modal() {
    
    Overlay_modal.call(this);
    
}

Notify_modal.prototype = new Overlay_modal();

Notify_modal.prototype._$modal_name = "Notify";

Notify_modal.prototype._$exposable = false;

Notify_modal.prototype._$create_ui = function () {
    
    var _ui = this._$create_ui_prototype();
    
    _ui.addClass('notify-modal')
        .removeClass( this.class_name )
        .attr('id', 'notify_modal')
		.addClass("KALS")
        .html('<div class="wrapper"></div>');
    
    var _config = this._$get_config();
    
    _config.speed = 1000;
    _config.closeSpeed = 1000;
    
    //_config.left = 'center';
    _config.mask = null;
    _config.effect = 'fade';
    
    var _onbeforeload;
    if (typeof(_config.onBeforeLoad) == 'function') {
        _onbeforeload = _config.onBeforeLoad;
    }
    
    _config.onBeforeLoad = function () {
        
        if ($.is_function(_onbeforeload)) {
            _onbeforeload();
        }
    };
    
    var _onclose;
    if (typeof(_config.onClose) == 'function') {
        _onclose = _config.onClose;   
    }
     
    _config.onClose = function () {
        if ($.is_function(_onclose)) {
			_onclose();
		}
        this.getOverlay().find('.wrapper').empty();
        //_ui.css('top', '0px');
    };
    
    //2010.9.10 在此決定Notify
    //_config.top = '10%';
    _config.top = 40;
    
    _ui.overlay(_config);
    _ui.css('z-index', 19999);
    //_ui.css('top', '0px');
    
    //$.test_msg('Notify_modal._$create_ui() 確認_ui是否建立', $('#notify_modal').length);
        
    return _ui;
};

Notify_modal.prototype._$onviewportmove = function (_ui) {
    _ui.align({
        option: 'center'
    });
};

/**
 * Notify_modal的setup_modal
 * @param {Object} _config = {
 *     timeout_close: _time,
 *     message: _lang,    //KALS_language_param,
 *     timeout_close_message: _lang_time 
 * }
 */
Notify_modal.prototype.setup_modal = function (_config) {
    
    //先使用KALS_modal.setup_modal()來設置吧
    Notify_modal.prototype.setup_modal.call(this, _config);
    
    var _time = $.get_parameter(_config, 'timeout_close');
    if ($.isset(_time)) {
        this.set_timeout_close(_time);
    }
    
    var _lang = $.get_parameter(_config, 'message');
    var _lang_time = $.get_parameter(_config, 'timeout_close_message');
    if ($.isset(_lang)) {
        this.set_message(_lang, _lang_time);
    } 
    
    return this;
};

/**
 * 設定關閉的指示物
 * @type {Object} 由setTimeout()回傳
 */
Notify_modal.prototype._close_lock = null;

/**
 * 設定時間關閉整個Notification_modal
 * @param {number} _time 單位是毫秒(1000ms = 1s)
 * @deprecated
 */
/*
Notify_modal.prototype.set_timeout_close = function (_time) {
    if (false == this.has_setup_ui())
        return this;
        
    var _ui = this.get_ui();
    _ui.attr('timeout_close', _time);
    
    if (this._close_lock != null) {
        clearTimeout(this._close_lock);
    }
    
    var _this = this;
    this._close_lock = setTimeout(function () {
        _this.close(function () {
            clearTimeout(_this._close_lock);
            _this._close_lock = null;
        });
    }, _time);
    return this;
};
*/

Notify_modal.prototype.close = function (_callback) {
    
    //先確認UI裡面有沒有還沒準備關掉
    var _ui = this.get_ui();
    var _this = this;
	
    var _ui_fade_out = function (_callback) {
        _ui.fadeOut("slow", function () {
            if ($.is_function(_callback)) {
                _callback();
            }
        });
    };
	
	var _close_action = function () {
		if (_this._$closable && _this.is_opened()) {
	        
	        if (_ui !== null) {
	            if (typeof(_ui.overlay) == 'function') {
	                _this._$temp_callback = _callback;
	                
	                //if (typeof(_ui.overlay().isOpened()) != 'undefined')
	                var _api = _ui.data("overlay");
	                if ($.isset(_api)) {
	                    _api.setOpened(true);
	                    _api.close();    
	                }
	                
	            }
				
				_ui_fade_out(_callback);
	        }
	    }
	    return this;
	};
	
    var _display_message = _ui.find('.' + this._message_classname + ':not(.' + this._close_classname + ')');
    
    if (_display_message.length === 0) {
        _close_action(function () {
            try {
                clearTimeout(_this._close_lock);    
            }
            catch (e) { }
            _this._close_lock = null;
            
            $.trigger_callback(_callback);
        });
    }
    else {
        $.trigger_callback(_callback);
    }
};

Notify_modal.prototype._close_classname = 'ready-close';
Notify_modal.prototype._message_classname = 'message';

/**
 * 設置留言訊息
 * @param {KALS_language_param|String} _lang
 * @param {Number} _lang_time
 */
Notify_modal.prototype.set_message = function (_lang, _lang_time) {
    
    if ($.is_null(_lang)) {
		return this;
	}
    
    var _ui = this.get_ui();
	var _this = this;
    
    if ($.is_null(_lang_time)) {
        _lang_time = _this.attr('timeout_close');
        _lang_time = parseInt(_lang_time, 10);
    }
	
    if (typeof(_lang_time) == 'undefined') {
		_lang_time = 11000;
	}
	else {
		_lang_time = _lang_time + 1000;
	}
    
    var _container = $('<div class="' + this._message_classname + '"></div>')
        .hide();
    
    KALS_context.lang.add_listener(_container, _lang);
    
    _ui.find('.wrapper:first')
        .prepend(_container);
    
	if (_ui.hasClass("fadeout")) {
		//$.test_msg("ui fadeout");
		_ui.removeClass("fadeout");
		//_ui.fadeIn().stop(false, true);
		_ui.stop(true, false).fadeIn();
	}
	
	//$.test_msg("container fadeIn", _lang_time);
    _container.fadeIn(function () {
		
		_this.open();
		
		var _container = $(this);
		
		var _timer = setTimeout(function () {
            _this._close_message(_container);
        }, _lang_time);
		
        _container.attr("timer", _timer);
		
		_container.click(function () {
            var _timer = $(this).attr("timer");
            clearTimeout(_timer);
            _this._close_message($(this));
        }); 
	});
    
    //加入新留言之後，就要重新對齊一下
    this._$onviewportmove(_ui);
    
    //this.set_timeout_close(_lang_time);
    
    this.open();
    
    return this;
};

/**
 * 關閉整個模型的動作
 */
Notify_modal.prototype._close_message = function (_container) {
    // @20130603 Pudding Chen
    // 先確認是否可關閉？
    if (typeof(this.close) != "function") {
        return;
    }
    
	var _this = this;
	var _ui = this.get_ui();
    _container.addClass(_this._close_classname);
    
	// 先檢查其他的message
	var _count = this.count_message();
	//$.test_msg("close message count", _count);
	
	if (_count > 1) {
		_container.fadeOut('slow', function () {
            $(this).remove();
			
			_count = _this.count_message();
			if (_count === 0) {
				_ui.hide();
			}
			
            _this._$onviewportmove(_ui);
        });
	}
	else {
		_ui.addClass("fadeout");
        //$.test_msg("close message add fadeout");
		this.close(function () {
			//$.test_msg("close message remove fadeout");
			_ui.removeClass("fadeout");
			
			//_this.clear_message();
			_container.fadeOut("slow", function () {
				_container.remove();
			});
            _this._$onviewportmove(_ui);
	    });
	}
};

/**
 * 計算通知欄裡面的訊息數量
 * @type number
 */
Notify_modal.prototype.count_message = function () {
	var _ui = this.get_ui();
	return _ui.find("."+this._message_classname).length;
};

/**
 * 清理訊息
 */
Notify_modal.prototype.clear_message = function () {
    this.get_ui().find("." + this._message_classname).remove();
    return this;
};

/**
 * 整個物件的顯示狀態
 */
Notify_modal.prototype._modal_timer = null;

/* End of file Notify_modal */
/* Location: ./system/application/views/web_apps/Notify_modal.js *//**
 * Event_dispatcher
 *
 * 實作觀察者模式
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/7/28 下午 03:36:17
 * @extends {KALS_user_interface}
 */
function Event_dispatcher() {
    
    KALS_user_interface.call(this);
    
    this._listeners = [];
    this._once_listeners = [];
}

Event_dispatcher.prototype = new KALS_user_interface();

/**
 * 監聽者
 * @type {function[]|object[]}
 */
Event_dispatcher.prototype._listeners = [];

/**
 * 只有一次的監聽者
 * @type {function[]|object[]}
 */
Event_dispatcher.prototype._once_listeners = [];

/**
 * 是否有改變
 */
Event_dispatcher.prototype._change = false;

Event_dispatcher.prototype._$enable_changed_lock = false;

Event_dispatcher.prototype._$event_name = 'update';

/**
 * 新增觀察者
 * 
 * 輸入參數可以為：
 * add_listener(_obj, _function, _trigger)
 * add_listener(_obj, _function)
 * add_listener(_obj)
 * add_listener(_obj, _trigger)
 * add_listener(_function, _trigger)
 * add_listener(_function)
 * 
 * @param {Object} _obj
 * @param {Object} _function
 * @param {Object} _trigger
 */
Event_dispatcher.prototype.add_listener = function (_obj, _function, _trigger) {
    if ($.is_function(_obj) 
        && ($.is_null(_function) || $.is_boolean(_function))) {
        _trigger = _function;
        //_function = _obj;
        //_obj = new Object;
    }
    else if ($.is_object(_obj) && $.is_boolean(_function) && $.is_null(_trigger)) {
        _trigger = _function;
        _function = null;
    }
    
    if ($.is_null(_trigger)) {
		_trigger = false;
	}
    
    if ($.inArray(_obj, this._listeners) == -1) {
        if ($.isset(_function)) {
            _obj[this._$event_name] = _function;
        }
        
        this._listeners.push(_obj);
        
        if (_trigger === true) {
            this._notify_listener(_obj);
        }
    }
    return this;
};

/**
 * 新增一次觀察者
 * 
 * 輸入參數可以為：
 * add_listener(_obj, _function, _trigger)
 * add_listener(_obj, _function)
 * add_listener(_obj)
 * add_listener(_obj, _trigger)
 * add_listener(_function, _trigger)
 * add_listener(_function)
 * 
 * @param {Object} _obj
 * @param {Object} _function
 * @param {Object} _trigger
 */
Event_dispatcher.prototype.add_once_listener = function (_obj, _function, _trigger) {
    //參數初始化
    if ($.is_function(_obj) 
        && ($.is_null(_function) || $.is_boolean(_function))) {
        _trigger = _function;
        //_function = _obj;
        //_obj = new Object;
    }
    else if ($.is_object(_obj) && $.is_boolean(_function) && $.is_null(_trigger)) {
        _trigger = _function;
        _function = null;
    }
    
    if ($.is_null(_trigger)) {
		_trigger = false;
	}
    
    //接下來開始進行事件觸發
    if ($.inArray(_obj, this._once_listeners) == -1) {
        if ($.isset(_function)) {
            _obj[this._$event_name] = _function;
        }
        
        this._once_listeners.push(_obj);
        
        if (_trigger === true) {
            this._notify_once_listener(_obj);
        }
    }
    return this;
};

Event_dispatcher.prototype._notify_once_listener = function(_obj, _complate) {
    var _complete = this._notify_listener(_obj);
            
    if (!(typeof(_complete) == 'boolean'
        && _complete === false)) {
        //除非回傳false，否則一律刪除
        this.delete_once_listener(_obj);
    }
};

Event_dispatcher.prototype._trigger_listener = function (_listener) {
    if ($.is_object(_listener)) {
		return _listener[this._$event_name](this);
	}
	else {
		return _listener(this);
	}
};

/**
 * 刪除觀察者
 * @param {Object|function} _obj
 */
Event_dispatcher.prototype.delete_listener = function (_obj) {
    this._listeners = this._delete_listener_data(
        this._listeners,
        _obj
    );
    return this;
};

/**
 * 刪除一次觀察者
 * @param {Object} _obj
 */
Event_dispatcher.prototype.delete_once_listener = function (_obj) {
    this._once_listeners = this._delete_listener_data(
        this._once_listeners,
        _obj
    );
    return this;
};

/**
 * 依據觀察者跟參數來刪除資料的動作
 * @param {function[]|Object[]} _listeners
 * @param {Object|function} _obj
 */
Event_dispatcher.prototype._delete_listener_data = function (_listeners, _obj) {
    var _key;
    if ($.is_object(_obj)) {
        _key = $.inArray(_obj, _listeners);
        //if (_key > -1)
        //    delete _listeners[_key];
        if (_key > -1) {
			_listeners = $.array_remove(_listeners, _key);
		}
    }
    else if ($.is_function(_obj)) {
        var _func = _obj;
        for (_key in _listeners) {
            _obj = _listeners[_key];
            
            if ($.is_object(_obj)) {
                if (typeof(_obj[this._$event_name] == 'function')
                    && _obj[this._$event_name] == _func) {
                    //delete _listeners[_key];
                    _listeners = $.array_remove(_listeners, _key);
                }
                    
            }
            else if ($.is_function(_obj)) {
                if (_obj == _func) {
                    //delete _listeners[_key];
                    _listeners = $.array_remove(_listeners, _key);
                }
            }
        }
    }
    return _listeners;
};

/**
 * 通知所有觀察者
 * @param {Object} _arg
 */
Event_dispatcher.prototype.notify_listeners = function (_arg) {
    if (this._$enable_changed_lock === false 
        || (this._$enable_changed_lock === true && this._changed)) {
        var _event_name = this._$event_name;
        
        //$.test_msg('Event_dispatcher.notify_listeners()', this._listeners.length);
        
        for (var _i in this._listeners) {
            var _listener = this._listeners[_i];
            this._notify_listener(_listener, _arg);
        }
        
        for (_i in this._once_listeners) {
            _listener = this._once_listeners[_i];
            this._notify_once_listener(_listener, _arg);
        }
        
        if (this._$enable_changed_lock === true) {
			this._changed = false;
		}
    }
    return this;
};

Event_dispatcher.prototype._notify_listener = function (_listener, _arg) {
    
    var _event_name = this._$event_name;
    var _result;
    
    if ($.is_function(_listener)) {
        if ($.isset(_arg)) {
			_result = _listener(this, _arg);
		}
		else {
			_result = _listener(this);
		}
    }
    else if (typeof(_listener[_event_name]) == 'function') {
        //$.test_msg('Event_dispatcher.notify_listeners() has event', _event_name);
        
        if ($.isset(_arg)) {
			_result = _listener[_event_name](this, _arg);
		}
		else {
			_result = _listener[_event_name](this);
		}    
    }
    
    return _result;
};

/**
 * 設定已變更
 * 
 * 如果this._$enable_changed_lock有開啟，那麼在作notify_lis
 */
Event_dispatcher.prototype.set_changed = function () {
    this._changed = true;
    return this;
};

/* End of file Event_dispatcher */
/* Location: ./system/application/views/web_apps/Event_dispatcher.js *//**
 * Multi_event_dispatcher
 *
 * 實作觀察者模式，多重模式
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/7/28 下午 03:36:17
 * @extends {KALS_user_interface}
 */
function Multi_event_dispatcher(){
    
    KALS_user_interface.call(this);
    
    this._types = [];
    this._type_listeners = {};
    this._$enable_types = [];
}

Multi_event_dispatcher.prototype = new KALS_user_interface();
        
/**
 * 監聽類型
 * @type {Array}
 */
Multi_event_dispatcher.prototype._types = [];

/**
 * 該監聽類型的監聽者
 * @type {Object}
 * @example 
 * _type_listeners = {
 *   'trigger': [function1, function2, function3]
 * };
 */
Multi_event_dispatcher.prototype._type_listeners = {};

/**
 * 允許的監聽類型
 * @type {String[]}
 */
Multi_event_dispatcher.prototype._$enable_types = [];

/**
 * 預設的監聽類型
 * @type {string}
 */
Multi_event_dispatcher.prototype._default_type = 'trigger';

/**
 * 增加監聽者
 * 
 * @param {string} _type 監聽類型
 * @param {function} _function 回呼函數。
 * _function = function (_dispatcher) { //... }
 * @param {boolean} _trigger 是否立刻啟動
 */
Multi_event_dispatcher.prototype.add_listener = function (_type, _function, _trigger) {
    if ($.is_function(_type) 
        && ($.is_null(_function) || $.is_boolean(_function))) {
        _trigger = _function;
        _type = _function;
        _type = this._default_type;
    }
    
    if ($.is_null(_trigger)) {
		_trigger = false;
	}
    
    if ($.inArray(_type, this._types) == -1) {
        this._types.push(_type);
        this._type_listeners[_type] = [];
        
        //if (_type == 'select')
        //    $.test_msg('Multi_event_dispatcher.add_listener() create new type', this._type_listeners[_type].length);
    } 
    
    if ($.inArray(_function, this._type_listeners[_type]) == -1) {
        
        this._type_listeners[_type].push(_function);
        
        if (_trigger === true) {
			_function(this);
		}
    }
    return this;
};

/**
 * 是否擁有此類型的監聽者
 * @param {string} _type
 */
Multi_event_dispatcher.prototype.has_type = function (_type) {
    if ($.is_null(_type)) {
		_type = this._default_type;
	}
    
    return ($.inArray(_type, this._types) > -1);
};

/**
 * 刪除監聽者
 * @param {string} _type
 * @param {function} _function
 */
Multi_event_dispatcher.prototype.delete_listener = function (_type, _function) {
    if ($.is_function(_type) && $.is_null(_function)) {
        _function = _type;
        _type = this._default_type;
    }
    
    if (false == this.has_type(_type)) {
		return this;
	}
    
    var _key = $.inArray(_function, this._type_listeners[_type]);
    if (_key > -1) {
		delete this._type_listeners[_type][_key];
	}
    return this;
};

/**
 * 通知監聽者
 * @param {function} _type
 */
Multi_event_dispatcher.prototype.notify_listeners = function (_type, _arg) {
    if (false == this.has_type(_type)) {
		return this;
	}
    
    var _this = this;
    
    var _listeners = this._type_listeners[_type];
    
    for (var _i in _listeners) {       
        var _listener = _listeners[_i];
        if ($.is_function(_listener)) {
            _listener(_this, _arg);
        }
    }
    return _this;
};

/* End of file Multi_event_dispatcher */
/* Location: ./system/application/views/web_apps/toolkit/Multi_event_dispatcher.js *//**
 * Attribute_event_dispatcher
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/11 下午 09:43:22
 * @extends {Multi_event_dispatcher}
 */
function Attribute_event_dispatcher(){
    
    this._attributes = {};
    
}

Attribute_event_dispatcher.prototype = new Multi_event_dispatcher(); 

/**
 * 屬性保存
 * @type {Object}
 */
Attribute_event_dispatcher.prototype._attributes = {};

/**
 * 設定屬性
 * @param {string} _type 屬性類型
 * @param {Object} _value 值
 * @returns {Attribute_event_dispatcher}
 */
Attribute_event_dispatcher.prototype.set_attr = function (_type, _value) {
    
    if ($.is_string(_type)) {
        this._attributes[_type] = _value;
        //$.test_msg('Attr .set_attr', _type, _value);
        return this.notify_listeners(_type, _value);
    }
    else if ($.is_object(_type) && _value === undefined) {
        for (var _t in _type) {
            this.set_attr(_t, _type[_t]);
        }
        return this;
    }
};

/**
 * 設定屬性，調整值
 * 
 * 只有屬性是數值的時候才有用處
 * @param {string} _type 屬性類型
 * @param {Object} _value 值
 * @returns {Attribute_event_dispatcher}
 */
Attribute_event_dispatcher.prototype.set_attr_adjust = function (_type, _value) {
    var _attr_value = this.get_attr(_type, 0);
    //$.test_msg("attr.set_attr_adjust 1", [$.is_number(_attr_value), $.is_number(_value)]);
    if ($.is_number(_attr_value) 
            && $.is_number(_value)) {
        //$.test_msg("attr.set_attr_adjust", [_type, _value, _attr_value, (_attr_value + _value)]);
        _attr_value = _attr_value + _value;
        return this.set_attr(_type, _attr_value);
    }
    
    return this;
};

/**
 * 設定屬性，增加值
 * 
 * 只有屬性是數值的時候才有用處
 * @param {string} _type 屬性類型
 * @param {Object} _value 值
 * @returns {Attribute_event_dispatcher}
 */
Attribute_event_dispatcher.prototype.set_attr_add = function (_type, _value) {
    if (_value === undefined) {
        _value = 1;
    }
    return this.set_attr_adjust(_type, _value);
};

/**
 * 設定屬性，減少值
 * 
 * 只有屬性是數值的時候才有用處
 * @param {string} _type 屬性類型
 * @param {Object} _value 值
 * @return {Attribute_event_dispatcher}
 */
Attribute_event_dispatcher.prototype.set_attr_reduce = function (_type, _value) {
    if (_value === undefined) {
        _value = 1;
    }
    if ($.is_number(_value)) {
        // 轉換成負值
        _value = -1 * _value;
    }
    return this.set_attr_adjust(_type, _value);
};

/**
 * 取消屬性
 * @param {string} _type 屬性類型
 */
Attribute_event_dispatcher.prototype.unset_attr = function (_type) {
    this._attributes[_type] = null;
    return this.notify_listeners(_type);
};

Attribute_event_dispatcher.prototype.reset = function () {
    for (var _type in this._attributes) {
        this.unset_attr(_type);
    }
    return this;
};

/**
 * 取得屬性
 * @param {string} _type 屬性類型
 * @param {Object} _default 預設值
 * @param {number|null} _length 最大長度
 */
Attribute_event_dispatcher.prototype.get_attr = function (_type, _default, _length) {
    if ($.is_null(_type)
        || typeof(this._attributes[_type]) === 'undefined') {
        if ($.is_null(_default)) {
            return null;
        }
        else {
            return _default;
        }
    }   
    else {
        var _value = this._attributes[_type];
        
        //$.test_msg('Atrr get_attr()', [_type, _default, _length]);
        
        if ($.isset(_value)
            && $.is_number(_length)
            && _value.length > _length) {
            _value = _value.substr(0, _length) + '...';
        }
        return _value;
    }
        
};

/**
 * 增加屬性監聽者
 * @param {string} _type
 * @param {function} _attr_function 屬性回呼函數。會回傳屬性的值。
 * _attr_function = function (_dispatcher, _attr) { //... }
 * @param {boolean} _trigger 是否立即啟動，預設是true。
 */
Attribute_event_dispatcher.prototype.add_attr_listener = function (_type, _attr_function, _trigger) {
    if ($.is_null(_trigger)) {
		_trigger = true;
	}
    
    var _function = function(_dispatcher) {
        var _attr = _dispatcher.get_attr(_type);
        
        if ($.is_function(_attr_function)) {
            _attr_function(_dispatcher, _attr);
        }
        else if (typeof(_attr_function.innerHTML)) {
            _attr_function.innerHTML = _attr;
        }
        else if ($.is_function(_attr_function.html)) {
            _attr_function.html(_attr);
        }
    };
    
    return this.add_listener(_type, _function, _trigger);
};

/**
 * 通知所有監聽者
 */
Attribute_event_dispatcher.prototype.notify_total_listeners = function () {
    for (var _type in this._attributes) {
        this.notify_listeners(_type);
    }
    return this;
};

/**
 * 取得參數的索引名稱
 * @type {string}
 * @property
 */
Attribute_event_dispatcher.prototype._$data_key = 'data';

/**
 * 更新資料
 * 
 * 通常其他人利用JSONP_dispatcher.add_listener來訂閱資料
 * @param {JSONP_dispatcher} _dispatcher
 * @param {Object} _data 從伺服器回傳的JSON資料
 */
Attribute_event_dispatcher.prototype.update = function (_dispatcher, _data) {
    
    var _data_key = this._$data_key;
    if (_data_key === null) {
        return this;
    }
    
    //$.test_msg('Attribute_event_dispatcher.update()', _data);
    //$.test_msg('Attribute_event_dispatcher.update()', [_data_key, typeof(_data[_data_key])]);
    
    if (typeof(_data[_data_key]) !== 'undefined') {
        //$.test_msg('Attribute_event_dispatcher.update()', _data);
        //$.test_msg('Attribute_event_dispatcher.update()', [_data_key, typeof(_data[_data_key])]);
    
        for (var _key in _data[_data_key]) {
            //$.test_msg('Attribute_event_dispatcher.update()', [_key, _data[_data_key][_key]]);
            this.set_attr(_key, _data[_data_key][_key]);
        }
    }
    else {
        this.reset();
    }
    
    //$.test_msg('attr name' , this.get_attr('name', 'NULL'));
    return this;
};

/* End of file Attribute_event_dispatcher */
/* Location: ./system/application/views/web_apps/Attribute_event_dispatcher.js *//**
 * JSONP_dispatcher
 *
 * 以JSONP實作觀察者模式
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/7/28 下午 03:36:17
 * @extends {Event_dispatcher}
 */
function JSONP_dispatcher(_url) {
    
    Event_dispatcher.call(this);
    
    this._default_reset_data = null;
    
    //this._data = null;
    if ($.isset(_url)) {
        this.set_load_url(_url);
    }

    this._register_context();
}

JSONP_dispatcher.prototype = new Event_dispatcher();

/**
 * 取得資料之後，保存在這個屬性中。請讓他留空。
 * @type {Object}
 * @private
 */
//JSONP_dispatcher.prototype._data = {};

/**
 * 此類別要讀取的url網址。
 * 
 * 要注意的是，前置基本網址會在KALS_util.ajax_get當中自動加入，所以此處並不需要前置網址
 * 例如：load_url = 'login';
 * 實際上送出時會變成 'http://192.168.11.2/CodeIgniter_1.7.2/web_apps/login'
 * @type {string}
 * @protected
 */
JSONP_dispatcher.prototype._$load_url = null;

/**
 * 指定此類別要讀取的網址
 * @param {string} _url
 * 要注意的是，前置基本網址會在KALS_util.ajax_get當中自動加入，所以此處並不需要前置網址
 * 例如：_url = 'login';
 * 實際上送出時會變成 'http://192.168.11.2/CodeIgniter_1.7.2/web_apps/login'
 */
JSONP_dispatcher.prototype.set_load_url = function (_url) {
    this._$load_url = _url;
    return this;
};

JSONP_dispatcher.prototype.get_load_url = function () {
	var _url = this._$load_url;
	if ($.is_null(_url)) {
		return _url;
	}
	
	if ($.ends_with(_url, '/')) {
		_url = _url.substr(0, _url.length-1);
	}
	return _url;
};

/**
 * 開始讀取資料
 * @param {Object} _arg
 * @param {Function} _callback 可以指定參數
 * _callback = function (_dispatcher, _data) {
 *     //可以利用_data跟_dispatcher來做點事情，像是_dispatcher.get_data()
 * };
 */
JSONP_dispatcher.prototype.load = function (_arg, _callback) {
    
    if ($.is_function(_arg) && $.is_null(_callback)) {
        _callback = _arg;
        _arg = null;
    }
    var _this = this;
    
    //$.test_msg('JSONP_dispatcher load', this._$load_url);
    
    var _config = {
        url: this._$load_url, 
        data: _arg, 
        callback: function(_data){
            
            //$.test_msg('JSONP_dispatcher.load() ajax_get', _data);
            
            if ($.is_function(_callback)) {
                    _callback(_this, _data);
            }
                
            _this.set_data(_data);
        },
        retry: 1
    };
    
    if ($.is_function(this._$exception_handle)) {
        _config.exception_handle = function (_data) {
            _this._$exception_handle(_data);    
        }; 
    }
    
    KALS_util.ajax_get(_config);
    return this;
};

JSONP_dispatcher.prototype._$exception_handle = null;

JSONP_dispatcher.prototype._notify_listener = function (_obj, _arg) {
    if ($.is_null(_arg)) {
		_arg = this.get_data();
	}
    return Event_dispatcher.prototype._notify_listener.call(this, _obj, _arg);
};

/**
 * 在回傳資料時，設定資料
 * 
 * 設定資料的同時，會告知所有監聽者
 * @param {Object} _data
 */
JSONP_dispatcher.prototype.set_data = function (_data) {
    
    this._data = _data;
    this.set_changed();
    
    //$.test_msg('JSONP set_data ('+this._listeners.length+' listeners)', _data);
    
    this.notify_listeners(_data);
    return this;
};

/**
 * 取得資料
 * @type {Object} JSON資料
 */
JSONP_dispatcher.prototype.get_data = function () {
    return this._data;
};

/**
 * 重置取得的資料
 */
JSONP_dispatcher.prototype.reset_data = function () {
    this._data = this._default_reset_data;
    return this._data;
};

/**
 * 取得指定欄位的資料
 * @param {String} _field
 * @type {Object}
 */
JSONP_dispatcher.prototype.get_field = function (_field) {
	if (this._data !== null && typeof(this._data[_field]) !== 'undefind') {
		return this._data[_field];
	}
	else {
		return;
	}
};

/**
 * 如果要向KALS_context註冊，則填入自己的Class Name
 * 設定null表示不註冊
 */
JSONP_dispatcher.prototype._$context_register = null;

/**
 * 向KALS_context註冊，索取資料
 */
JSONP_dispatcher.prototype._register_context = function () {
	if (this._$context_register !== null) {
		
		var _register = this._$context_register;
		var _this = this;
		//Context訂閱一下
	    if (typeof(KALS_context) != 'undefined') {
	        KALS_context.add_listener(function (_dispatcher, _data) {
	            if (typeof(_data[_register]) != 'undefined') {
	                _this.set_data(_data[_register]);
	            }
	        });
	    }
	};
};

JSONP_dispatcher.prototype._default_reset_data = null;

/* End of file JSONP_dispatcher */
/* Location: ./system/application/views/web_apps/JSONP_dispatcher.js *//**
 * Task_event_dispatcher
 * 
 * 可以設定很多任務，然後任務完成時，再觸發事件
 * 
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/12 下午 07:39:25
 * @extends {Event_dispatcher}
 */
function Task_event_dispatcher(_onstart, _oncomplete) {
    
    Event_dispatcher.call(this);
    
    this._$schedule_task = [];
    this._task_state = {};
    this.completed = false;
    
    if ($.is_function(_onstart)) {
		this._$onstart = _onstart;
	}
    
    if ($.is_function(_oncomplete)) {
		this._$oncomplete = _oncomplete;
	}
}

Task_event_dispatcher.prototype = new Event_dispatcher();

/**
 * 預定要做的任務名稱
 * @type {Array}
 * @example ['task1', 'task2', 'task3']
 */
Task_event_dispatcher.prototype._$schedule_task = [];

/**
 * 任務狀態。在執行reset()之後，會成設定下面的範例
 * @example {
 *     task1: false,
 *     task2: false,
 *     task3: false
 * }
 */
Task_event_dispatcher.prototype._task_state = {};

/**
 * 任務完成之後呼叫監聽者的method名稱
 * @type {string}
 */
Task_event_dispatcher.prototype._$event_name = 'complete';

/**
 * 任務完成之後的呼叫函式
 * @type {funciton}
 */
Task_event_dispatcher.prototype._$oncomplete = null;

/**
 * 設定完成之後的動作
 * @param {function} _oncomplete
 */
Task_event_dispatcher.prototype.set_oncomplete = function (_oncomplete) {
    this._$oncomplete = _oncomplete;
    return this;
};

/**
 * 開始進行任務時呼叫的函式
 * @type {function}
 */
Task_event_dispatcher.prototype._$onstart = null;

/**
 * 設定開始的動作
 * @param {function} _onstart
 */
Task_event_dispatcher.prototype.set_onstart = function (_onstart) {
    this._$onstart = _onstart;
    return this;
};

/**
 * 標註是否已經完成
 * @type {boolean}
 */
Task_event_dispatcher.prototype.completed = false;

/**
 * 設定任務_task完成
 * @param {string} _task
 * @param {boolean} _boolean
 */
Task_event_dispatcher.prototype.complete = function(_task, _boolean) {
    //$.test_msg('檢查任務', _task);
    //$.test_msg('目前所有任務', this._$schedule_task);
    
    var _this = this;
    
    setTimeout(function () {
        
        if ($.is_null(_task)) {
			return;
		}
        if ($.is_null(_boolean)) {
			_boolean = true;
		}
            
        if (_this._task_state === null) {
			_this.reset();
		}
        
        if ($.inArray(_task, _this._$schedule_task) > -1) {
            //$.test_msg('設定任務', [_task, _boolean]);
            _this._task_state[_task] = _boolean;
        }
        
        if (_this.completed === true) {
			return; //表示全部已經完成
		}
        
        //$.test_msg('是否完成全部任務', [_task, _this.is_completed(), '[', _this._$schedule_task, ']']);
        if (_this.is_completed()) {
            $(function () {
                _this.notify_listeners();
                if ($.is_function(_this._$oncomplete)) {
                    _this._$oncomplete();
                    
                    _this.completed = true;
                }
            });   
                
        }
        
    }, 0);
    
    return this;
};

/**
 * 將所有任務的狀態設置為未完成
 */
Task_event_dispatcher.prototype.reset = function() {
    
    this._task_state = {};
    for (var _t in this._$schedule_task) {
        var _task = this._$schedule_task[_t];
        this._task_state[_task] = false;
    }
    
    this.completed = false;
    return this;
};

/**
 * 確認任務是否完成
 * @param {string} _task
 * 如果沒有輸入_task，則確認是否全部任務都已經完成
 */
Task_event_dispatcher.prototype.is_completed = function (_task) {
    
    if (this._task_state === null) {
		return false;
	}
    
    if ($.isset(_task)) {
        if (typeof(this._task_state[_task]) == 'undefined') {
			return false;
		}
		else {
			return this._task_state[_task];
		}
    }
    else {
        for (var _t in this._$schedule_task) {
            _task = this._$schedule_task[_t];
            if (typeof(this._task_state[_task]) == 'undefined') {
				return false;
			}
			else 
				if (false == this._task_state[_task]) {
					return false;
				}
        }
        return true;
    }
};

/**
 * 開始進行任務
 */
Task_event_dispatcher.prototype.start = function (_callback) {
    if ($.is_function(this._$onstart)) {
        var _this = this;
        //隔一下再開始進行
        setTimeout(function () {
            _this._$onstart(_callback);    
        }, 0);
    }
        
    return this;
};

/* End of file Task_event_dispatcher */
/* Location: ./system/application/views/web_apps/Task_event_dispatcher.js *//**
 * KALS_exception
 * 丟出例外錯誤
 *
 * @package		KALS
 * @category		Webpage Application Libraries
 * @author		Pudding Chen <puddingchen.35@gmail.com>
 * @copyright		Copyright (c) 2010, Pudding Chen
 * @license		http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link		http://sites.google.com/site/puddingkals/
 * @version		1.0 2010/8/5 下午 07:24:29
 * @param {Object|string} _class 物件本身
 * @param {string|null} _message 錯誤訊息
 * @type {string} 例外錯誤敘述
 */
function KALS_exception(_class, _message) {
    
    if ($.is_object(_class) 
        && (typeof(_class.heading) !== 'undefined' 
        || typeof(_class.message) !== 'undefined'
        || typeof(_class.request_uri) !== 'undefined')) {
        var _server_error = _class;
        if (typeof(_server_error.heading) !== 'undefined') {
            this.heading = _server_error.heading;
        }
        if (typeof(_server_error.message) !== 'undefined') {
            this.message = _server_error.message;
        }
        if (typeof(_server_error.request_uri) !== 'undefined') {
            this.request_uri = _server_error.request_uri;
        }
    }
    else {
        if ($.is_null(_message) && $.is_string(_class)) {
            _message = _class;
            _class = null;
        }
        
		var _base_url = KALS_context.get_base_url();
		if ($.is_string(_class) && _class.substr(0, _base_url.length) === _base_url) {
			_message = KALS_context.lang.line(_message);
			
			var _url = _class;
			//_message = _message + '\n <br /><a href="'+_url+'" target="_blank">'+_url+'</a>';
			this.request_uri = _url;
		}
		else {
			var _class_name = false;
            if ($.isset(_class)) {
                _class_name = $.get_class(_class);
            }
                
            if (false !== _class_name) {
                _message = '[' + _class_name + '] ' + _message;
            }
			
	        //_message = new KALS_language_param(_message, _message);
	        _message = KALS_context.lang.line(_message);
		}   
        
        this.message = _message;
		
        //return _message;   
    }
}

/**
 * 錯誤的標頭
 */
KALS_exception.prototype.heading = null;

/**
 * 錯誤的訊息
 */
KALS_exception.prototype.message = null;

/**
 * 錯誤的請求網址。如果沒有此項，則不會顯示。
 */
KALS_exception.prototype.request_uri = null;

/* End of file KALS_exception */
/* Location: ./system/application/views/web_apps/KALS_exception.js *//**
 * Name_value_pair
 *
 * 名值配對
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/8/21 下午 01:47:12
 * @param {String} _string_data 要輸入的解序列化資料
 */
function Name_value_pair(_string_data) {
    
    this._data = {};
    
    this.unserialize(_string_data);
        
}

/**
 * 保存名值對的資料
 * @memberOf {Name_value_pair}
 * @type {Object}
 */
Name_value_pair.prototype._data = {};

/**
 * 分割字串的指示符號
 * @type {string}
 */
Name_value_pair.prototype._splitter = '&';

/**
 * 指定值的符號
 * @type {string}
 */
Name_value_pair.prototype._indicator = '=';

/**
 * 解序列
 * @memberOf {Name_value_pair}
 * @param {string} _string_data 要解序列化的字串資料
 * @type {Object} 解序列化之後的物件資料 
 */
Name_value_pair.prototype.unserialize = function (_string_data) {
    if (false == $.is_string(_string_data)) {
        return this.reset();
    }
    
    var _string_array = _string_data.split(this._splitter);
    var _object_data = {};
    for (var _i in _string_array) {
        var _data = _string_array[_i];
        var _pos = _data.indexOf(this._indicator);
        
        if (_pos == -1) {
			continue;
		}
            
        var _key = _data.substring(0, _pos);
        var _value = _data.substring((_pos+1), _data.length);
        
        _object_data[_key] = _value;
    }
    
    this._data = _object_data;
    
    return _object_data;
};

/**
 * 將this._data序列化成字串之後回傳
 * @type {string}
 */
Name_value_pair.prototype.serialize = function () {
    var _object_data = this._data;
    var _string_data = '';
    
    for (var _key in _object_data) {
        var _value = _object_data[_key];
        
        _string_data = _string_data + _key + this._indicator + _value + this._splitter;
    }
    
    _string_data = _string_data.substring(0, _string_data.length-1);
    
    return _string_data;
};

/**
 * 等同this.serialize
 * @type {string}
 */
Name_value_pair.prototype.to_string = function () {
    return this.serialize();
};

/**
 * 取得this._data欄位的值
 * @param {String} _key
 * @param {Object} _default
 * @type {Object}
 */
Name_value_pair.prototype.get_field = function (_key, _default) {
    if (typeof(this._data[_key]) !== undefined) {
        return this._data[_key];
    }
    else {
        return _default;
    }
};

Name_value_pair.prototype.has_field = function (_key) {
    return (typeof(this._data[_key]) != 'undefined');
};

/**
 * 設置欄位的值
 * @param {String} _key
 * @param {Object} _value
 */
Name_value_pair.prototype.set_field = function (_key, _value) {
    this._data[_key] = _value;
    return this;
};

/**
 * 刪除欄位
 * @param {String} _key
 */
Name_value_pair.prototype.delete_field = function (_key) {
    if (typeof(this._data[_key]) != 'undefined') {
		delete this._data[_key];
	}
    return this;
};

/**
 * 取得this._data
 * @type {Object}
 */
Name_value_pair.prototype.get_data = function () {
    return this._data;
};

/**
 * 清除this._data
 */
Name_value_pair.prototype.reset = function () {
    this._data = {};
    return this;
};

/**
 * 回傳this._data
 * @type {Object}
 */
Name_value_pair.prototype.get_data = function () {
    return this._data;
};

/* End of file Name_value_pair */
/* Location: ./system/application/views/web_apps/Name_value_pair.js *//**
 * KALS_util
 *
 * KALS程式使用到的工具箱，KALS_util
 *
 * @package    KALS
 * @category   JavaScript Libraries
 * @author     Pudding Chen <puddingchen.35@gmail.com>
 * @copyright  Copyright (c) 2010, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       http://sites.google.com/site/puddingkals/
 * @version    1.0 2010/7/20 下午 10:17:42
 */
KALS_util = {};

/**
 *  改寫jQuery的$.getJSON方法
 *
 * @param _config = {
 *   url: String (without base_url),
 *   data: JSON,
 *   callback: function (_data),
 *   exception_handle: function (_data), //可省略，省略則自動使用KALS_util.show_exception來處理
 *   retry: 3, //可省略，預設嘗試次數
 *   retry_wait: 60 * 1000, //預設嘗試等待時間，單位是毫秒
 *   fixed_callback: "fixed_callback"   //預設省略，固定callback的參數
 * };
 */
KALS_util.ajax_get = function (_config) {
    var _url = $.get_parameter(_config, 'url');
    var _data = $.get_parameter(_config, 'data');
    var _callback = $.get_parameter(_config, 'callback', function() {});
    var _exception_handle = $.get_parameter(_config, 'exception_handle');
    
    var _retry = $.get_parameter(_config, 'retry', 3);
    var _retry_wait = $.get_parameter(_config, 'retry_wait', 60 * 1000);
    var _retry_counter = 0;
    
    _url = $.appends_with(_url, '/');
    
    var _callback_parameter = $.get_parameter(_config, "fixed_callback", "?");
    if (_callback_parameter === true) {
        _callback_parameter = "_";
    }
    
    if (_data !== null) {
        if ($.is_object(_data)) {
            _data = $.json_encode(_data);
            _data = encodeURIComponent(_data);
            _data = escape(_data);
        }
        else if ($.is_string(_data)) {
            _data = encodeURIComponent(_data);
            _data = escape(_data);
        }
		
        _url = _url + _data + '/callback=' + _callback_parameter;
    }
    else {
        _url = _url + 'callback=' + _callback_parameter;
    }
    
	if (_url.indexOf('http') === 0 
                || _url.indexOf('%22') === 0) {
            $.test_msg('ajax get exception', 'KALS_util.ajax_get try to load exception url: ' + _url);
            //throw ;
            return this;
	}
	
    if (typeof(KALS_context) !== 'undefined') {
        //while ($.starts_with(_url, '/'))
        //    _url = _url.substring(1, _url.length);
        //_url = KALS_context.get_base_url() + _url;
        
        //$.test_msg('KALS_util.ajax_get()'
        //    , [_url, KALS_context.get_base_url(), KALS_context.base_url, KALS_context.get_base_url(_url)]);
        
        _url = KALS_context.get_base_url(_url);
    }
    var _this = this;
    
    //檢查網址是否超過最大長度
    if (_url.length > 2000) {
        if ($.is_function(_exception_handle)) {
            _exception_handle();
        }
        else {
			
            $.test_msg('KALS_util.ajax_get()'+'超過最大長度囉', _url.length);
			
            this.show_exception({
                heading: KALS_context.lang.line(new KALS_language_param(
                    'Data error.',
                    'exception.url_too_large.heading'
                )),
                message: KALS_context.lang.line(new KALS_language_param(
                    'Request-URL too large.',
                    'exception.url_too_large.message'
                )),
                request_uri: _url
            });
        }
        return this;
    }
    
    if (KALS_CONFIG.debug.ajax_get_message) {
        $.test_msg('ajax_get', _url);
    }
    
    var _retry_timer;
    //var _retry_exception = function () {
    //    $.test_msg('retry exception', [_url, KALS_context.get_base_url()]);
    //    var _exception = new KALS_exception('exception.retry_exception');
    //    _this.show_exception(_exception, _url);
    //};
    //var _retry_exception = this.re
    
    
    var _get_callback = function (_data) {
    //$.getJSON(_url, function (_data) {

        if (KALS_context !== undefined
                && KALS_context.completed === true) {
            if (KALS_CONFIG.debug.ajax_get_message) {			
                $.test_msg('ajax_get from ' + _url + ' \n return data', _data);
            }
        }


        if (typeof(_retry_timer) === 'undefined' 
                || _retry_timer === null) {
            return this;
        }
        else if ($.isset(_retry_timer)) {
            clearInterval(_retry_timer);
            _retry_timer = null;
            delete _retry_timer;
        }

        if (typeof(_data.exception) !== 'undefined') {            
            if ($.is_function(_exception_handle)) {
                _exception_handle(_data.exception);
            }
            else {
                _this.show_exception(_data.exception);
            }
        }
        else {
            _callback(_data);
        }
    };
    
    if (_callback_parameter !== "?") {
        window[_callback_parameter] = function (_data) {
            _get_callback(_data);
        };
    }
    
    var _get_json = function() {
        
        //if (_retry_counter == 999)
        //    return;
        
        if (_callback_parameter === "?") {
            $.getJSON(_url, _get_callback); 
        }
        else {
            //$.getJSON(_url);
            $.getScript(_url);
        }
    };
    
    try {
        _get_json();
        
        if (_retry !== null && _retry > 0) {
            
            if (_callback_parameter !== "?") {
                //$.test_msg("開始計時", _retry_wait);
            }
            _retry_timer = setInterval(function () {
                //$.test_msg("時間到了");
                if (_retry_counter === _retry || _retry_counter > _retry
                    || typeof(_retry_timer) === 'undefined') {
                    if (typeof(_retry_timer) !== 'undefined') {
                        clearInterval(_retry_timer);
                        _retry_timer = null;
                        delete _retry_timer;
                    }
                    _this._retry_exception(_url);
                    return this;
                }
                
                _get_json();
                
                _retry_counter++;
                
            }, _retry_wait);    
        }
    }
    catch (e) {
        if ($.isset(_retry_timer)) {
            clearInterval(_retry_timer);
            _retry_timer = null;
            delete _retry_timer;
        }
        
        if ($.is_function(_exception_handle)) {
            _exception_handle(e);
        }
        else {
            _this.show_exception(e);
        }
    }
    
    return this;
};

/**
 *  改寫jQuery的$.getJSON方法，變成可以傳遞大量資料的POST寫法
 *
 * @param _config = {
 *   url: String (without base_url),
 *   data: JSON,
 *   callback: function (_data),
 *   exception_handle: function (_data) //可省略，省略則自動使用KALS_util.show_exception來處理
 * };
 */	
KALS_util.ajax_post = function (_config) {
    //如果要檢查資料，請將_debug設為true
    var _debug = KALS_CONFIG.debug.ajax_post;
    //_debug = true;
    
    var _url = $.get_parameter(_config, 'url');
    var _data = $.get_parameter(_config, 'data');
    var _callback = $.get_parameter(_config, 'callback', function() {});
    var _exception_handle = $.get_parameter(_config, 'exception_handle');
    
    _action = $.appends_with(_url, '/');
    
    if (typeof(KALS_context) !== 'undefined') {   
        _action = KALS_context.get_base_url(_action);
    }
    //$.test_msg('ajax_post action: ' + '<a href="'+_action+'" target="_blank">' + _action + '</a>', _data);
    
    //取得現在時間作為id
    var _id = $.create_id();
    var _name = 'name_' + _id;
    
    var _layer = $('<div></div>')
        .css('position', 'absolute')
        .css('top', '-1000px')
        .appendTo($('body'));
    
    //建立一個暫存的iframe
    var _iframe = $('<iframe></iframe')
        .css('width', '0')
        .css('height', '0')
        .id(_id)
        .attr('name', _name)
        .appendTo(_layer);
    
    if (_debug === true) {
        _iframe.css('width', '640px')
            .css('height', '480px');
        _layer.css('top', '50px')
            .css('position', 'fixed')
            .css('background-color', 'white');
    }

    //建立一個FORM
    //然後讓form target到該iframe
    var _form = $('<form></form>')
        .attr('target', _name)
        .attr('method', 'post')
        .attr('action', _action)
        .attr('enctype', 'multipart/form-data')
        .appendTo(_layer);
        
    //擺放檔案input並指定成_file_path，
    //建立一個json的input
    if ($.isset(_data)) {
        _data = $.json_encode(_data);
        //_data = encodeURIComponent(_data);
        //_data = escape(_data);
        
        var _input = $('<input type="text" name="json" />')
            .attr('value', _data)
            .appendTo(_form);
    }
    
    
    var _this = this;
    var _post_retry_count = 0;
    var _post_retry_max = 3;
    
    var _iframe_load_callback = function () {
        //以同樣路徑，用ajax_get去取得資料，並回傳給callback
        _this.ajax_get({
            url: _url, 
            callback: function (_data) {
                
                // 如果回傳了false，表示要重新讀取一次
                if (_data === false) {
                    _post_retry_count++;
                    if (_post_retry_count > _post_retry_max) {
                        _this._retry_exception(_url);
                    }
                    else {
                        _form.submit();
                    }
                    return;
                }

                if (_debug === false) {
                    _layer.remove();
                }

                if ($.is_function(_callback)) {
                    _callback(_data);
                }
            },
            exception_handle: _exception_handle 
        });
    };
    
    _iframe.load(function () {
        setTimeout(function () {
            _iframe_load_callback();
        }, 500);
    });    //_iframe.load(function () {
    
    //準備完畢，遞交
    _form.submit();
    
    return this;
};

KALS_util._retry_exception = function (_url) {
    $.test_msg('retry exception', [_url, KALS_context.get_base_url()]);
    var _exception = new KALS_exception('exception.retry_exception');
    this.show_exception(_exception, _url);
};

/**
 * 跨網域檔案上傳的方法
 * 
 * @param {Object} _config = {
 *   url: String (without base_url),
 *   userfile: jQuery //<input type="file">的表單
 *   userdata: JSON,
 *   callback: function (_data),
 *   exception_handle: function (_data) //可省略，省略則自動使用KALS_util.show_exception來處理
 * };
 */
KALS_util.ajax_upload = function (_config) {
    
    var _url = $.get_parameter(_config, 'url');
    var _userfile = $.get_parameter(_config, 'userfile');
    var _userdata = $.get_parameter(_config, 'userdata');
    var _callback = $.get_parameter(_config, 'callback');
    var _exception_handle = $.get_parameter(_config, 'exception_handle');
    
    _url = $.appends_with(_url, '/');
    
    var _action = _url;
    if (typeof(KALS_context) != 'undefined') {
        _action = KALS_context.get_base_url(_action);
    }
    
    //取得現在時間作為id
    var _id = $.create_id();
    var _name = 'name_' + _id;
    
    var _layer = $('<div></div>')
        .css('position', 'absolute')
        .css('top', '-1000px')
        .appendTo($('body'));
    
    //建立一個暫存的iframe
    var _iframe = $('<iframe></iframe')
        .css('width', '0')
        .css('height', '0')
        .id(_id)
        .attr('name', _name)
        .appendTo(_layer);
    
    //建立一個FORM
    //然後讓form target到該iframe
    var _form = $('<form></form>')
        .attr('target', _name)
        .attr('method', 'post')
        .attr('action', _action)
        .attr('enctype', 'multipart/form-data')
        .appendTo(_layer);
        
    //擺放檔案input並指定成_file_path，
    //建立一個json的input
    var _file = $(_userfile).clone()
        .attr('name', 'userfile')
        .appendTo(_form);
        
    var _check = $('<input name="fileupload" value="true" type="hidden" />')
        .appendTo(_form);
    
    if ($.isset(_userdata)) {
        _userdata = $.json_encode(_userdata);
        var _input = $('<input type="text" name="userdata" />')
            .attr('value', _userdata)
            .appendTo(_form);
    }
    
    var _this = this;
    //當iframe讀取完畢時，等待三秒鐘
    _iframe.load(function () {
        
        setTimeout(function () {
    
            //以同樣路徑，用ajax_get去取得資料，並回傳給callback
            _this.ajax_get({
                url: _url, 
                callback: function (_data) {
                    
                    _layer.remove();
                    
                    var _exception = {
                        'heading': 'Upload File Failed',
                        'request_uri': _url
                    };
                    
                    if (typeof(_data) == 'undefined'
                        || typeof(_data.completed) == 'undefined') {
					    $.test_msg("show_exception 1");
                        _this.show_exception(_exception, _url);
                    }
                    else if (_data.completed === false) {
                        if (_data.data !== false) {
							_exception.message = _data.data;
						}
						$.test_msg("show_exception 2");
                        _this.show_exception(_exception, _url);
                    }
                    
                    if ($.is_function(_callback)) {
						_callback(_data);
					}
                },
                exception_handle: _exception_handle 
            });
            
        }, 3000);    //setTimeout(function () {
        
    });    //_iframe.load(function () {
    
    //準備完畢，遞交
    _form.submit();
};

/**
 * 顯示錯誤參數
 * @param {KALS_exception} _exception 這個是來自於伺服器回傳_data中的exception屬性。
 * 在ajax_get()的時候發生錯誤時，會自動將_data.exception送到此方法。
 * 這是處理例外的預設方法，您可以在ajax_get()當中設定exception_handle
 */
KALS_util.show_exception = function (_exception, _uri) {
    //var _heading = $.get_parameter(_exception, 'heading');
    //var _message = $.get_parameter(_exception, 'message');
    //var _request_uri = $.get_parameter(_exception, 'request_uri');
    
    if ($.is_class(_exception, 'KALS_exception') === false) {
        _exception = new KALS_exception(_exception);
    }
        
    var _heading = _exception.heading;
    var _message = _exception.message;
    var _request_uri = _exception.request_uri;
    if (_request_uri === null || _request_uri === undefined) {
        _request_uri = _uri;
    }
    if (_request_uri !== undefined
            && _request_uri.substr(0,4) !== "http" 
            && _request_uri.substr(0,1) !== "/") {
        _request_uri = KALS_context.get_base_url(_request_uri);
    }
    
    $.test_msg('KALS_util.show_exception()', [_heading, _message, '<a href="'+_request_uri+'" target="_blank">' + _request_uri + '</a>']);
    
    var _exception_heading = new KALS_language_param('Sorry! System has got some trouble!', 'exception.alert.heading');
    var _exception_content = $('<dl></dl>').addClass('exception');
    
    //先加入關閉視窗提示吧
    var _dt = $('<dt>Hint: </dt>')
        .appendTo(_exception_content);
    KALS_context.lang.add_listener(_dt, new KALS_language_param('Hint: ', 'exception.hint.heading'));
    
    var _dd = $('<dd></dd>')
            .appendTo(_exception_content);
    KALS_context.lang.add_listener(_dd, new KALS_language_param('You can press "ESC" key to close message.', 'exception.hint.message'));
        
    
    if ($.isset(_heading)) {
        _dt = $('<dt>HEADING: </dt>')    //.html(_lang.create_listener('exception.message_heading.heading'))
            .appendTo(_exception_content);
        KALS_context.lang.add_listener(_dt, new KALS_language_param('HEADING: ', 'exception.message_heading.heading'));
        
        _dd = $('<dd></dd>')
            .appendTo(_exception_content)
            .html(_heading);
    }
    
    if ($.isset(_message)) {
        _dt = $('<dt>MESSAGE: </dt>')    //.html(_lang.create_listener('exception.message_heading.message'))
            .appendTo(_exception_content);
        KALS_context.lang.add_listener(_dt, new KALS_language_param('MESSAGE: ', 'exception.message_heading.message'));
        _dd = $('<dd></dd>')
            .html(_message)
            .appendTo(_exception_content);
    }
    
    if ($.isset(_request_uri)) {
        _dt = $('<dt>REQUEST URI: </dt>')    //.html(_lang.create_listener('exception.message_heading.request_uri'))
            .appendTo(_exception_content);
        KALS_context.lang.add_listener(_dt, new KALS_language_param('REQUEST URI: ', 'exception.message_heading.request_uri'));
        _dd = $('<dd></dd>')
            .appendTo(_exception_content)
            .html('<a href="' + _request_uri + '" target="_blank">' + _request_uri + '</a>');
    }
    
    
    var _this = this;
    setTimeout(function () {
        var _alert = _this.alert(_exception_heading, _exception_content);
        _alert.get_ui().addClass('exception');    
    }, 1000);
	
	throw _message;
    //$.test_msg('KALS_util.show_exception() end');
    
    //return _alert;
};

/**
 * @type {Dialog_modal}
 * @memberOf {KALS_util}
 * @property
 */
KALS_util._alert_modal = null;

/**
 * @type {Dialog_modal}
 * @memberOf {KALS_util}
 * @property
 */
KALS_util._confirm_modal = null;

/**
 * @method [_get_alert_modal]
 * @memberOf {KALS_util}
 * @type {Dialog_modal}
 */
KALS_util._get_alert_modal = function () {
    if ($.is_null(this._alert_modal)) {
        var _modal = new Dialog_modal();
        //var _close_option = _modal.create_close_option();
        var _close_option = new Dialog_close_option();
        _modal.set_options(_close_option);
        _modal.get_ui().addClass('alert');
        
        this._alert_modal = _modal;
    }
    
    //this._alert_modal.set_modal_name('Alert_' + $.create_id());
    var _id = 'Alert_' + $.create_id();
    this._alert_modal.set_modal_name(_id);
    this._alert_modal.get_ui().attr('id', _id);
    
    return this._alert_modal;
};

/**
 * KALS專案使用的Alter用法
 * @param {KALS_language_param|string} _heading
 * @param {KALS_language_param|string|jQuery} _content
 * @param {function} _callback
 * @memberOf {KALS_util}
 * @method [alert]
 */
KALS_util.alert = function (_heading, _content, _callback) {
    var _modal = this._get_alert_modal();
    _modal.set_heading(_heading);
    _modal.set_content(_content);
    
    if ($.is_function(_callback)) {
		_modal.set_onclose(_callback);
	}
	else {
		_modal.set_onclose(false);
	}
    _modal.open();
    
    return _modal;
};

/**
 * @method [_get_alert_modal]
 * @memberOf {KALS_util}
 * @type {Dialog_modal}
 */
KALS_util._get_confirm_modal = function () {
    if ($.is_null(this._confirm_modal)) {
        var _modal = new Dialog_modal();
        /**
         * 用來擺放回呼函數使用
         * @type {function}
         */
        _modal.confirm_callback = null;
        
        var _yes_lang = new KALS_language_param('YES', 'dialog.option.yes');
        var _no_lang = new KALS_language_param('NO', 'dialog.option.no');
        
        var _yes_option = new Dialog_close_option(_yes_lang, function () {
            if (typeof(_modal.confirm_callback) == 'function') {
				_modal.confirm_callback(true);
			}
        });
        
        var _no_option = new Dialog_close_option(_no_lang, function () {
            if (typeof(_modal.confirm_callback) == 'function') {
				_modal.confirm_callback(true);
			}
        });
        
        _modal.set_options([_yes_option, _no_option]);
        _modal.get_ui().addClass('confirm');
        
        this._confirm_modal = _modal;
    }
    
    var _id = 'Confirm_' + $.create_id();
    this._confirm_modal.set_modal_name(_id);
    this._confirm_modal.get_ui().attr('id', _id);
    
    return this._confirm_modal;
};

/**
 * KALS專案使用的confirm用法
 * @param {KALS_language_param|string} _heading
 * @param {KALS_language_param|string|jQuery} _content
 * @param {function} _callback
 * @memberOf {KALS_util}
 * @method [confirm]
 */
KALS_util.confirm = function (_heading, _content, _callback) {   
    var _modal = this._get_confirm_modal();
    _modal.set_heading(_heading);
    _modal.set_content(_content);
    
    if ($.is_function(_callback)) {
		_modal.confirm_callback = _callback;
	}
	else {
		_modal.confirm_callback = null;
	}
        
    _modal.open();
    
    return _modal;
};

/**
 * 通知功能的Modal
 * @type {Notify_modal}
 * @memberOf {KALS_util}
 * @property
 */
KALS_util._notify_modal = null;

KALS_util._get_notify_modal = function () {
    if (this._notify_modal === null) {
        this._notify_modal = new Notify_modal();
        
        //$.test_msg('KALS_util._get_notify_modal() 有建立Modal嗎？', this._notify_modal);
    }
    return this._notify_modal;
};

/**
 * KALS專案使用的通知功能
 * @param {KALS_language_param|String} _message
 */
KALS_util.notify = function (_message, _wait) {
    var _notify_modal = this._get_notify_modal();
    
	if (_wait === undefined) {
		_wait = 10000;
	}
	
	// @20130610 Pudding Chen
	// 修正不知道為什麼不會自動關閉的問題
	//_notify_modal.set_message(_message, 10000);
	_notify_modal.set_message(_message, _wait);
    
    //$.test_msg('KALS_util.notify()', _message);
    
    return _notify_modal;
};

/**
 * 選單的對話視窗
 * 
 * 選項可省略_content:
 * @param {Object} _config = {
 *     heading: 'KALS_language_param|String|jQuery',
 *     content: 'KALS_language_param|String|jQuery',
 *     options: 'Array|Dialog_close_option',
 *     onclose: 'function',
 *     heading_close: true
 * };
 * @type {Dialog_modal}
 */
KALS_util.select_menu = function (_config) {
    
    var _heading = $.get_parameter(_config, 'heading');
    var _content = $.get_parameter(_config, 'content');
    var _options = $.get_parameter(_config, 'options');
    var _onclose = $.get_parameter(_config, 'onclose');
    var _heading_close = $.get_parameter(_config, 'heading_close', true);
    
    var _menu = new Dialog_modal();
    _menu.set_heading(_heading);
    _menu.set_content(_content);
    _menu.set_options(_options, false);
    _menu.set_onclose(_onclose);
    
    if (_heading_close === true) {
        var _close_option = new Dialog_close_option();
        _menu.set_forward_option(_close_option);    
    }
    
    _menu.add_class('select-menu');
    _menu.open();
    
    return _menu;
};

/**
 * 顯示說明視窗
 * @param {String} _url 未含base_url，未含help的網址
 * @type {Object} Window物件
 * @memberOf {KALS_util}
 */
KALS_util.help = function (_url) {
    
    if ($.is_null(_url)) {
		_url = '';
	}
    
    if (_url.substr(0, 1) == '/') {
		_url = _url.substr(1, _url.length);
	}
    
    var _base_url = KALS_CONFIG.help_base_url;
    var _needle = 'http';
    var _help_url = KALS_context.get_base_url([KALS_CONFIG.help_base_url, _url]);
    if (_base_url.substr(0, _needle.length) == _needle) {
        if (_base_url.substr(_base_url.length - 1, _base_url.length) != '/') {
			_base_url = _base_url + '/';
		}
        _help_url = _base_url + _url;
    }
    
    var _help_win = window.open(_help_url, '_blank', 'width=480,height=640,scrollbars=1');
    
    return _help_win;
};

/**
 * 改良原本的decodeURIComponent
 * @deprecated 20130222 不採用，請用jQuery.decodeURIComponent()
 * @param  {String} _str 要轉換的字串
 * @return {String}      轉換完成的字串
 */
KALS_util.decodeURIComponent = function (_str) {
    var _result;
    /*
    try {
        _result = decodeURIComponent(_str);
    }
    catch (_e) {
        _str = $.str_replace("%", "%25", _str);
        _result = decodeURIComponent(_str);
    }
    */
    _str = $.str_replace("%", "%25", _str);
    _result = decodeURIComponent(_str);
    return _result;
};

/**
 * 將log傳到伺服器
 * 
 * @author Pulipuli Chen <pulipuli.chen@gmail.com>
 * 20131225 將傳遞資料改成用Post傳遞
 * @param number _action 動作的ID。關於動作的編號，請查看[KALS]/applications/controllers/web_apps/log.php
 * @param JSON _note 任意要儲存的資料
 * @param function _callback 回呼函數 
 */
KALS_util.log = function (_action, _note, _callback) {
    
    //_note = null;
    var _data = {
        "action": _action,
        "note": _note
    };

    //$.test_msg("KALS_util.log", _data);

    var _config = {
        "url": "log/create",
        "data": _data,
        "callback": _callback,
        "exception_handle": function () {
            // 不做任何事情
        }
    };
    //KALS_util.ajax_get(_config);
    
    //KALS_util.ajax_post(_config);
};

/* End of file KALS_unit */
/* Location: ./libraries/helpers/kals_unit.js *//**
 * KALS_controller
 *
 * 結合樣板的控制器
 *
 * @package    KALS
 * @category   Webpage Application Libraries
 * @author     Pudding Chen <pulipuli.chen@gmail.com>
 * @copyright  Copyright (c) 2013, Pudding Chen
 * @license    http://opensource.org/licenses/gpl-license.php GNU Public License
 * @link       https://github.com/pulipulichen/kals/
 * @version    1.0 2011/11/19 下午 03:36:17
 * @extends {JSON_dispatcher}
 * @extends {KALS_modal}
 * @constructor
 * @class {KALS_controller}
 */
function KALS_controller() {
    
    JSONP_dispatcher.call(this);
    
    var _this = this;
    
    if (this._$enable_auth_check === true) {
        //this.debug('init view data', 'check auth');
        
        if (typeof(KALS_context) === 'object') {
            KALS_context.auth.add_listener(function () {
                _this._auth_check();
            });
        }
        _this._auth_check();
    }
}

/**
 * ===========================
 * 開頭宣告
 * ===========================
 */

KALS_controller.prototype = new JSONP_dispatcher();

/**
 * 繼承自KALS_modal，要結合起來
 */
var _modal_prototype = new KALS_modal();
for (var _i in _modal_prototype) {
    KALS_controller.prototype[_i] = _modal_prototype[_i];
}

/**
 * ===========================
 * 請覆寫的屬性
 * ===========================
 */

/**
 * 使用要使用的VIEW
 * ※ 請覆寫這個類別
 * 
 * @type {string}
 * @protected
 * @class {KALS_controller}
 */
KALS_controller.prototype._$view = null;

/**
 * 指定要使用的MODEL
 * ※ 請覆寫這個類別
 * 
 * @type {string}
 * @protected
 */
KALS_controller.prototype._$model = null;

KALS_controller.prototype._$enable_debug = true;

/**
 * 啟用權限檢查機制
 * @type {Boolean}
 */
KALS_controller.prototype._$enable_auth_check = true;

/**
 * 初始化要執行的action
 * @type {String} null表示不做初始化
 */
KALS_controller.prototype._$init_request_action = null;

/**
 * 開啟要執行的action
 * @type {String} null表示不做初始化
 */
KALS_controller.prototype._$open_request_action = null;

/**
 * 關閉時要執行的action
 * @type {String} null表示不做初始化
 */
KALS_controller.prototype._$close_request_action = null;


/**
 * 權限檢查
 * @param {boolean} _is_login
 * @param {User_param} _user
 * @returns {boolean} true=通過;false=未通過
 */
KALS_controller.prototype._$auth_check = function (_is_login, _user) {
    //this.debug('auth check', _is_login);
    return true;
};

/**
 * 初始化View
 * 
 * 如果要在Controller啟動時為UI做設定，請覆寫這個方法
 * 這個方法只會執行一次
 * 
 * 請覆寫這個方法
 * @return {KALS_controller}
 */
KALS_controller.prototype._$initialize_view = function () {
    return this;
};

/**
 * ===========================
 * 允許讓外部可用的方法
 * ===========================
 */

/**
 * 取得request_url
 * @type {String}
 */
KALS_controller.prototype.get_request_url = function () {
	var _url = this._$model;
    
	if ($.is_null(_url)) {
        return _url;
    }
    
	if ($.ends_with(_url, '/')) {
        _url = _url.substr(0, _url.length-1);
    }
    return _url;
};

/**
 * ===========================
 * 內部設定的方法
 * ===========================
 */

/**
 * 送出請求
 * @param {string} _method get|post
 * @param {string} _action
 * @param {JSON} _data
 * @param {function} _callback
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.request = function (_method, _action, _data, _callback) {
    
    if (typeof(_data) === "function" 
            && _callback === undefined) {
        _callback = _data;
        _data = {};
    }
    
    if (this._enable_controller_flag === false) {
        //this.debug('request', 'enable flag is false');
        $.trigger_callback(_callback);
        return this;
    }
    
    var _url = this.get_request_url();

    if ($.is_null(_url)) {
        //$.test_msg('temp', 'url is null');
        return $.trigger_callback(_callback);
    }

    if (_method === 'get') {
        _url = _url + '/request_get';        
    }
    else {
        _url = _url + '/request_post/' + _action;
    }

    if (this._enable_debug_flag === true) {
        _data["_enable_debug"] = true;
        this._enable_debug_flag = false;
    }
    if (this._enable_cache_flag === true) {
        _data["_enable_cache"] = true;
        this._enable_cache_flag = false;
    }
    
    _data["_action"] = _action;

    var _this = this;
    var _ajax_config = {
        url: _url,
        data: _data,
        callback: function (_data) {
            if (typeof(_callback) === 'function') {
                _callback(_data);
            }
        }
    };

    //this.debug('request', _callback);
    //return;
    if (_method === 'get') {
        KALS_util.ajax_get(_ajax_config);
    }
    else {
        KALS_util.ajax_post(_ajax_config);
    }

    return this;
};

/**
 * 送出請求GET請求，快取起來
 * 
 * @param {string} _action
 * @param {JSON} _data
 * @param {function} _callback
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.request_get_cache = function (_action, _data, _callback) {
    
    var _method = "get";
    
    if (typeof(_data) === "function" 
            && _callback === undefined) {
        _callback = _data;
        _data = {};
    }
    
    if (this._enable_controller_flag === false) {
        //this.debug('request', 'enable flag is false');
        $.trigger_callback(_callback);
        return this;
    }
    
    var _url = this.get_request_url();

    if ($.is_null(_url)) {
        //$.test_msg('temp', 'url is null');
        return $.trigger_callback(_callback);
    }

    _url = _url + '/request_get';

    if (this._enable_debug_flag === true) {
        _data["_enable_debug"] = true;
        this._enable_debug_flag = false;
    }
    if (this._enable_cache_flag === true) {
        _data["_enable_cache"] = true;
        this._enable_cache_flag = false;
    }
    
    _data["_action"] = _action;

    var _this = this;
    var _ajax_config = {
        url: _url,
        data: _data,
        callback: function (_data) {
            if (typeof(_callback) === 'function') {
                _callback(_data);
            }
        },
        fixed_callback: true,
        retry_wait: 3000
    };
    
    KALS_util.ajax_get(_ajax_config);
    
    return this;
};

/**
 * 開啟偵錯模式
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.enable_debug = function () {
    this._enable_debug_flag = true;
    return this;
};

KALS_controller.prototype._enable_debug_flag = false;

/**
 * 開啟快取模式
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.enable_cache = function () {
    this._enable_cache_flag = true;
    return this;
};

KALS_controller.prototype._enable_cache_flag = false;


/**
 * 在回傳資料時，設定資料
 * 
 * 設定資料的同時，會告知所有監聽者
 * @param {Object} _data
 */
KALS_controller.prototype.set_data = function (_data) {
    //JSONP_dispatcher.prototype.set_data.call(this, _data);
    
    //this._data = _data;
    //this.set_sub_field(_data);
    
    this.set_field(_data);
    return this;
};

/**
 * 重置取得的資料
 */
KALS_controller.prototype.reset_data = function () {
    this._data = this._default_reset_data;
    return this._data;
};


/**
 * 開啟UI
 * @param {function|null} _callback
 */
/*
KALS_controller.prototype.open = function (_callback) {
	var _this = this;
	
	if (this._$model !== null) {
		//this.request_get(function() {
	        KALS_modal.prototype.open.call(_this, _callback);
	    });
	}
	else {
		$.trigger_callback(_callback);
	}
	
	//http://localhost/kals/help/config_annotation_scope.html#modal=Dashboard&select=69,127
    return this;
};
*/

/**
 * 初始化樣板資料，覆寫KALS_user_interface的作法
 * @param {jQuery} _view
 */
KALS_controller.prototype._initialize_view_data = function (_view) {
    var _this = this;
	
    if (this._$model !== null
        && this._$init_request_action !== null) {
        this.request('get', this._$init_request_action, this.get_data(), function (_data) {
                _this.debug('VIEW, init data', _data);
                _this.set_data(_data);
                KALS_user_interface.prototype._initialize_view_data.call(_this, _view);
        });
    }
    else {
        KALS_user_interface.prototype._initialize_view_data.call(_this, _view);
    }
    
    //this.debug('KALS context', typeof(KALS_context));
    if (this._$enable_auth_check === true) {
        //this.debug('init view data', 'check auth');
        
        if (typeof(KALS_context) === 'object') {
            KALS_context.auth.add_listener(function () {
                _this._auth_check();
            });
        }
        _this._auth_check();
    }
    
    return _view;
};

/**
 * 覆寫開啟時的動作
 * @param {funciton} _callback
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.open = function (_callback) {
    //this.debug('open');
    if (this._enable_controller_flag === false) {
        //this.debug('open', 'controller disabled');
        return $.trigger_callback(_callback);
    }
    
    //this.debug('open', this._enable_flag);
    if (this._$model !== null
        && this._$open_request_action !== null) {
        var _this = this;
        //this.debug('open', [this._$open_request_action, this.get_data()]);
        //return;
        this.request('get', this._$open_request_action, {}, function (_data) {
            //_this.debug('VIEW, open data', _data);
            _this.set_data(_data);
            KALS_modal.prototype.open.call(_this, _callback);
        });
    }
    else {
        KALS_modal.prototype.open.call(this, _callback);
    }
    return this;
};

/**
 * 覆寫關閉時的動作
 * @param {funciton} _callback
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.close = function (_callback) {
    if (this._enable_controller_flag === false) {
        //this.debug('close', 'controller disabled');
        return $.trigger_callback(_callback);
    }
    
    if (this._$model !== null
        && this._$close_request_action !== null) {
        var _this = this;
        this.request('get', this._$close_request_action, this.get_data(), function (_data) {
                //_this.debug('VIEW, close data', _data);
                _this.set_data(_data);
                KALS_modal.prototype.close.call(_this, _callback);
        });
    }
    else {
        KALS_modal.prototype.close.call(this, _callback);
    }
    return this;
};

/**
 * 以GET方式，跟伺服器取得資料
 * @param {String} _action
 * @param {JSON} _data
 * @param {function} _callback
 * @returns {KALS_controller.prototype@call;request}
 */
KALS_controller.prototype.request_get = function(_action, _data, _callback) {
    return this.request('get', _action, _data, _callback);
};

/**
 * 以POST方式
 * @param {String} _action
 * @param {JSON} _data
 * @param {function} _callback
 * @returns {KALS_controller.prototype@call;request}
 */
KALS_controller.prototype.request_post = function(_action, _data, _callback) {
    return this.request('post', _action, _data, _callback);
};

// --------------------------
// 內部方法
// --------------------------

/**
 * 取得現在的使用者
 * @type {User_param}
 */
KALS_controller.prototype.get_user = function () {
    return KALS_context.user.get_user_param();
};

/**
 * 設定快速鍵
 * @param {int} _hotkey
 * 請參考 http://unixpapa.com/js/key.html
 * @param {function} _callback
 */
KALS_controller.prototype.set_hotkey = function (_hotkey, _callback) {
    KALS_context.hotkey.add_listener(_hotkey, _callback);
};

/**
 * 輸入搜尋條件，開啟搜尋視窗搜尋標註
 * @param {JSON} _param
 * _param = {
 *      range: "note","author","annotation_type","annotation_anchor",
 *      keyword:"keyword",
 *      order_by: "update|create"
 * }
 * @returns {KALS_controller.protoype}
 */
KALS_controller.prototype.search_annotation = function (_param) {
    KALS_context.search.search(_param);
    return this;
};

/**
 * 取得現在使用的標註類型
 * @returns {Array|Annotation_type_param} 包含標註類型的陣列
 */
KALS_controller.prototype.get_annotation_types = function () {
    var _type_param_list = KALS_context.create_type_param_list();
    return _type_param_list;
};

/**
 * 觀看標註的詳細資料
 * @param {int} _annotation_id
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.view_annotation = function (_annotation_id) {
    KALS_text.load_annotation(_annotation_id);
    return this;
};

/**
 * 選擇頁面上指定的標註
 * @param {int} _annotation_id
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.select_annotation = function (_annotation_id) {
    if (_annotation_id === undefined) {
        //KALS_util.show_exception('KALS_controller.select_annotation');
        return this;
    }
    
    KALS_util.ajax_get({
        url: 'kals_model/get_annotation',
        data: {
            'annotation_id': _annotation_id
        },
        callback: function (_data) {
            var _annotation_json = _data.annotation;
            var _param = new Annotation_param(_annotation_json);
            var _scope = _param.scope;
            KALS_text.selection.select.set_scope_coll(_scope);
        }
    });
    
    return this;
};

/**
 * 偵錯
 * @param {String} _header
 * @param {Object} _message
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.debug = function (_header, _message) {
    if (this._$enable_debug === true) {
        $.test_msg(_header, _message);
    }
    return this;
};

// ----------------------

/**
 * 檢查權限
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype._auth_check = function () {
    if (this._$enable_auth_check === false) {
        return;
    }
    
    //this.debug('_auth_check 1', this._enable_controller_flag);
    //this._$auth_check();
    //this._enable_controller_flag = false;
    
    var _is_login = false; 
    var _user = null;
    if (typeof(KALS_context) === 'object') {
        _is_login = KALS_context.auth.is_login();
        _user = KALS_context.user.get_user_param();
    }
        
    if (this._$auth_check(_is_login, _user)) {
        if (this._enable_controller_flag === false) {
            this.enable_controller();
        }
    }
    else {
        if (this._enable_controller_flag === true) {
            this.disable_controller();
        }
    }
    //this.debug('_auth_check 2', this._enable_controller_flag);
};

/**
 * 關閉控制器
 * 
 * 一旦關閉，則不能使用open(), close(), request()等方法
 * @param {function} _callback
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.disable_controller = function (_callback) {
    //this.addClass('controller-disable');
    this._enable_controller_flag = false;
    $.trigger_callback(_callback);
    //this.debug('disable_controller');
    
    var _this = this;
    setTimeout(function () {
        _this.addClass('controller-disable');
    }, 0);
    return this;
    
};

/**
 * 開啟控制器
 * @param {function} _callback
 * @returns {KALS_controller.prototype}
 */
KALS_controller.prototype.enable_controller = function (_callback) {
    this._enable_controller_flag = true;
    //this.debug('enable_controller');
    $.trigger_callback(_callback);
    
    var _this = this;
    setTimeout(function () {
        _this.removeClass('controller-disable');
    }, 0);
    return this;
};


KALS_controller.prototype._enable_controller_flag = true;

// ------------------

/**
 * 檢查是否有欄位
 * @param {String} _field
 * @returns {Boolean}
 */
KALS_controller.prototype.has_field = function (_field) {
    return (typeof(this._data[_field]) !== 'undefined');
};

/**
 * 根據view樣板的語系檔來取得語系
 * @param {String} _view_line
 * @returns {KALS_language_param}
 */
KALS_controller.prototype.get_view_lang = function (_view_line) {
    if (KALS_context.lang.has_line(_view_line)) {
        //KALS_context.lang.add_listener(_ele, new KALS_language_param(_text, _line));
        return new KALS_language_param("", _view_line);
    }
    
    // 先取得key
    var _view_classname = this._$view;
    _view_classname = _view_classname.replace(/[\W|\_]/g, "_").toLowerCase();
    _view_classname = 'view.' + _view_classname;
    _view_classname = _view_classname + "." + _view_line;
    
    //$.test_msg("_view_classname", _view_classname);
    
    if (KALS_context.lang.has_line(_view_classname)) {
        //KALS_context.lang.add_listener(_ele, new KALS_language_param(_text, _line));
        return new KALS_language_param("", _view_classname);
    }
    else {
        return new KALS_language_param(_view_line);
    }
};

/**
 * 根據view樣板的語系檔來取得語系，直接輸出結果
 * @param {String} _view_line
 * @returns {String}
 */
KALS_controller.prototype.get_view_lang_line = function (_view_line) {
    var _lang = this.get_view_lang(_view_line);
    return KALS_context.lang.line(_lang);
}

/* End of file KALS_controller */
/* Location: ./system/application/views/web_apps/toolkit/KALS_controller.js */